# 🛠️ 系統安裝與設定指南

本指南將引導您從零開始完成 **THE FOCUS ENFORCER v1.0** 的環境建置。

---

## 📋 需求清單

### 軟體需求
- **Python 3.10+**: 後端邏輯與自動化腳本。
- **Node.js 18+**: 前端介面開發與運行。
- **VS Code**: 建議使用的開發編輯器。
- **PlatformIO**: VS Code 擴充功能，用於燒錄硬體韌體。

### 硬體需求 (v1.0)
| 元件 | 數量 | 用途 | 備註 |
|------|------|------|------|
| **Wemos D1 Mini (ESP8266)** | 1 | 主控板 | 4MB Flash |
| **1602 I2C LCD** | 1 | 狀態顯示 | PCF8574 背板 |
| **霍爾感測器** | 1 | 盒蓋偵測 | KY-033 |
| **LD2410 mmWave 雷達** | 1 | 人體偵測 | 24GHz |
| **18650 鋰電池** | 1 | 電源 | 3.7V 2000mAh+ |
| **TP4056 充電模組** | 1 | 充電管理 | 帶保護板版本 |
| **100KΩ 電阻** | 2 | 分壓電路 | 1% 精度佳 |
| **強力磁鐵** | 1 | 盒蓋觸發 | 釹鐵硼 N35+ |
| 杜邦線若干 | - | 連接用 | - |

---

## 🔌 硬體接線指南 (v1.0 完整版)

### GPIO 分配總表

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Wemos D1 Mini GPIO 分配表 (v1.0)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  模組              │ 功能       │ D1-mini │ GPIO  │ 備註                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  1602 LCD (I2C)    │ SDA        │ D2      │ GPIO4 │ I2C 資料線 (共用)       │
│                    │ SCL        │ D1      │ GPIO5 │ I2C 時脈線 (共用)       │
│                    │ VCC        │ 5V      │ -     │ ⚠️ 需 5V 供電           │
│                    │ GND        │ GND     │ -     │                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  霍爾感測器        │ OUT        │ D3      │ GPIO0 │ ⚡ 中斷腳位 (CHANGE)    │
│  (KY-033)           │ VCC        │ 3V3     │ -     │ 3.3V 供電               │
│                    │ GND        │ GND     │ -     │ 磁鐵靠近 = LOW          │
├─────────────────────────────────────────────────────────────────────────────┤
│  LD2410 mmWave     │ TX         │ D5      │ GPIO14│ SoftwareSerial RX       │
│                    │ RX         │ D6      │ GPIO12│ SoftwareSerial TX       │
│                    │ VCC        │ 5V      │ -     │ ⚠️ 需 5V 供電           │
│                    │ GND        │ GND     │ -     │                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  電池電壓監測      │ VBAT       │ A0      │ ADC   │ 分壓後輸入 (見電路圖)   │
│  (TP4056 + 18650)  │            │         │       │ R1=100K, R2=100K        │
├─────────────────────────────────────────────────────────────────────────────┤
│  TP4056 充電偵測   │ CHRG       │ D7      │ GPIO13│ LOW = 充電中            │
│                    │ STDBY      │ D8      │ GPIO15│ LOW = 充電完成          │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 電池電壓分壓電路

ESP8266 的 ADC 只能接受 0-1V 輸入，而 18650 鋰電池電壓範圍是 3.0V-4.2V。
需要使用分壓電路將電壓降到安全範圍。

```
        VBAT (4.2V max, 從電池正極)
              │
              │
             [R1] 100KΩ
              │
              ├───────────────► A0 (測量點，最大 1V)
              │
             [R2] 100KΩ
              │
              │
             GND
```

**計算公式：**
- 分壓比：`V_A0 = VBAT × R2/(R1+R2) = VBAT × 0.5`
- 反推：`VBAT = V_A0 × 2`
- 當電池 4.2V 時，A0 讀到 2.1V... 等等，這還是超過了！

**⚠️ 重要修正：** 應該使用 **220KΩ + 100KΩ** 分壓：
```
        VBAT (4.2V max)
              │
             [R1] 220KΩ (或 200KΩ)
              │
              ├───────► A0 (最大 ~0.97V ✓)
              │
             [R2] 100KΩ
              │
             GND

分壓比: 100K / (220K + 100K) = 0.3125
4.2V × 0.3125 = 1.3V ... 還是稍微高了

最佳方案: R1=330KΩ, R2=100KΩ
分壓比: 100K / (330K + 100K) = 0.232
4.2V × 0.232 = 0.975V ✓ 安全!
```

**建議使用 330KΩ + 100KΩ 分壓電路！**
韌體中的 `VBAT_DIVIDER_RATIO` 需相應調整為 `4.3`。

### 霍爾感測器安裝位置

```
┌────────────────────────────────────┐
│           盒蓋 (頂部)              │
│    ┌──────────────────────┐        │
│    │      磁鐵 (N極朝下)  │        │  ← 強力磁鐵黏貼於此
│    └──────────────────────┘        │
└────────────────────────────────────┘
                 ↓ 關閉時磁鐵靠近
┌────────────────────────────────────┐
│           盒體 (底部)              │
│    ┌──────────────────────┐        │
│    │   霍爾感測器 (正面)  │        │  ← 感測器安裝於此
│    └──────────────────────┘        │
│                                    │
│    ┌─────────┐                     │
│    │ D1 Mini │                     │
│    └─────────┘                     │
└────────────────────────────────────┘
```

**霍爾感測器邏輯：**
- 磁鐵靠近 (盒蓋關閉)：OUT = **LOW** → 正常
- 磁鐵遠離 (盒蓋開啟)：OUT = **HIGH** → 觸發違規

### TP4056 充電模組接線

```
     USB 輸入 (5V)
          │
    ┌─────┴─────┐
    │  TP4056   │
    │           │
    │ B+    OUT+├──────► 5V (系統供電)
    │ B-    OUT-├──────► GND
    │           │
    │ CHRG  STBY│
    └──┬─────┬──┘
       │     │
       │     └─────────► D8 (GPIO15) - 充電完成
       └───────────────► D7 (GPIO13) - 充電中
       
    B+/B- 接 18650 電池
```

**LED 指示燈狀態：**
| CHRG (紅) | STDBY (藍) | 狀態 |
|-----------|------------|------|
| 亮 | 滅 | 充電中 |
| 滅 | 亮 | 充電完成 |
| 滅 | 滅 | 無電池/待機 |

---

## 📂 1. 後端設定 (Backend)

1. **進入後端目錄**:
   ```powershell
   cd backend
   ```

2. **建立並啟用虛擬環境**:
   ```powershell
   python -m venv venv
   .\venv\Scripts\activate
   ```

3. **安裝相依套件**:
   ```powershell
   pip install -r requirements.txt
   ```

4. **安裝 Playwright 瀏覽器 (用於 Threads 自動化)**:
   ```powershell
   playwright install chromium
   ```

5. **設定憑證檔案**:
   - 將 `credentials.example.json` 重新命名為 `credentials.json`。
   - 填入您的社交平台資訊（詳見 [USAGE.md](USAGE.md)）。

---

## 💻 2. 前端設定 (Frontend)

1. **進入前端目錄**:
   ```powershell
   cd frontend
   ```

2. **安裝相依套件**:
   ```powershell
   npm install
   ```

3. **啟動開發伺服器**:
   ```powershell
   npm run dev
   ```
   - 預設開啟地址：`http://localhost:5173`

---

## 🔌 3. 硬體韌體設定

### 韌體設定修改

1. 開啟 `src/main.cpp`
2. 修改以下設定：

```cpp
// WiFi 設定
const char* WIFI_SSID = "你的WiFi名稱";
const char* WIFI_PASS = "你的WiFi密碼";

// 後端伺服器 IP (執行 ipconfig 查看)
const char* WS_HOST = "192.168.x.x";

// LCD I2C 地址 (常見: 0x27 或 0x3F)
#define LCD_ADDR 0x27
```

3. **如果使用不同的分壓電阻**，修改：
```cpp
#define VBAT_DIVIDER_RATIO  4.3f  // 330K+100K 分壓
```

### 燒錄韌體

1. 在 VS Code 中開啟專案根目錄
2. 等待 PlatformIO 自動下載依賴庫
3. 點擊 VS Code 下方狀態列的 **PlatformIO: Upload** 圖示
4. 等待編譯與燒錄完成

### 除錯技巧

- 開啟 Serial Monitor (115200 baud) 查看啟動日誌
- 確認 WiFi 連線成功
- 確認 WebSocket 連線至後端
- 檢查 LCD 是否顯示 "READY TO GO"

---

## 🏃 4. 啟動系統

您可以手動啟動，或使用根目錄提供的腳本：

### 快速啟動 (Windows)
在根目錄執行：
```powershell
.\start.bat
```

### 手動啟動
1. **啟動後端**:
   ```powershell
   cd backend
   python run.py
   ```
2. **啟動前端**:
   ```powershell
   cd frontend
   npm run dev
   ```

---

## ⚠️ 常見問題
- **Q: 為什麼硬體連不上 WebSocket？**
  - A: 請確保電腦與 D1 Mini 連接在同一個 WiFi 下，且防火牆已允許 8000 埠。
- **Q: Threads 自動化失敗？**
  - A: 確保已執行 `playwright install`，且 `credentials.json` 中的帳密正確。

