This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
backend/app/__init__.py
backend/app/automation/__init__.py
backend/app/automation/social_manager.py
backend/app/config.py
backend/app/credential_store.py
backend/app/logger.py
backend/app/main.py
backend/app/models.py
backend/app/routers/__init__.py
backend/app/routers/hardware.py
backend/app/routers/hostage.py
backend/app/routers/sessions.py
backend/app/routers/social.py
backend/app/socket_manager.py
backend/credentials.example.json
backend/instagram_debug.png
backend/requirements.txt
backend/run.py
Check-GitSecurity.ps1
Check-Health.ps1
frontend/index.html
frontend/package.json
frontend/postcss.config.js
frontend/public/socket-test.html
frontend/public/sounds/README.md
frontend/public/vite.svg
frontend/src/App.tsx
frontend/src/components/Dashboard/DashboardPage.tsx
frontend/src/components/Dashboard/DevPanel.tsx
frontend/src/components/Dashboard/Header.tsx
frontend/src/components/Dashboard/HostageManager.tsx
frontend/src/components/Dashboard/HostageUpload.tsx
frontend/src/components/Dashboard/PenaltyConfigPanel.tsx
frontend/src/components/Dashboard/PenaltyProgress.tsx
frontend/src/components/Dashboard/SensorChart.tsx
frontend/src/components/Dashboard/SocialSettings.tsx
frontend/src/components/Dashboard/StateTransitionOverlay.tsx
frontend/src/components/Dashboard/StatusPanel.tsx
frontend/src/components/Dashboard/Timer.tsx
frontend/src/components/ErrorBoundary.tsx
frontend/src/components/Landing/CustomCursor.tsx
frontend/src/components/Landing/MagneticButton.tsx
frontend/src/components/ui/animated-number.tsx
frontend/src/components/ui/badge.tsx
frontend/src/components/ui/button.tsx
frontend/src/components/ui/card.tsx
frontend/src/components/ui/checkbox.tsx
frontend/src/components/ui/input.tsx
frontend/src/components/ui/label.tsx
frontend/src/components/ui/progress.tsx
frontend/src/components/ui/slider.tsx
frontend/src/components/ui/SmoothScroll.tsx
frontend/src/components/ui/switch.tsx
frontend/src/components/ui/tabs.tsx
frontend/src/components/ui/textarea.tsx
frontend/src/hooks/useAudio.ts
frontend/src/hooks/usePhysics.ts
frontend/src/hooks/useSocket.ts
frontend/src/index.css
frontend/src/lib/animation.ts
frontend/src/lib/utils.ts
frontend/src/main.tsx
frontend/src/vite-env.d.ts
frontend/tailwind.config.js
frontend/tsconfig.json
frontend/tsconfig.node.json
frontend/vite.config.ts
GIT_SECURITY_README.md
Git-QuickPush.ps1
Git-SafePush.ps1
GITä½¿ç”¨èªªæ˜.md
MARKDOWN/CHECKLIST.md
MARKDOWN/OVERVIEW.md
MARKDOWN/SETUP.md
MARKDOWN/SOCKET_COMMUNICATION.md
MARKDOWN/STRUCTURE.md
MARKDOWN/TROUBLESHOOTING.md
MARKDOWN/USAGE.md
package.json
platformio.ini
README.md
Setup-GitRemote.ps1
Setup.ps1
src/main.cpp
Start-FocusEnforcer.ps1
Stop-FocusEnforcer.ps1
test_socket_client.py
test-socket.html
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="backend/app/logger.py">
"""
Safe logging module for Focus Enforcer.
Handles broken pipe errors that occur when running in detached windows on Windows.
"""
import sys
import logging


def safe_print(*args, **kwargs):
    """Safe print that handles broken pipe errors on Windows."""
    try:
        print(*args, **kwargs)
        sys.stdout.flush()
    except (OSError, IOError, BrokenPipeError):
        # Stdout is broken (e.g., running in detached window), ignore
        pass


# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(message)s',
    handlers=[logging.StreamHandler(sys.stdout)]
)

logger = logging.getLogger('focus_enforcer')


def log_info(message: str):
    """Log info message safely."""
    safe_print(message)


def log_error(message: str):
    """Log error message safely."""
    safe_print(f"[ERROR] {message}")


def log_debug(message: str):
    """Log debug message safely."""
    safe_print(f"[DEBUG] {message}")
</file>

<file path="frontend/public/socket-test.html">
<!DOCTYPE html>
<html>
<head>
    <title>Socket.IO Direct Test</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: #fff; }
        #status { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .connected { background: #16a34a; }
        .disconnected { background: #dc2626; }
        #log { background: #0f0f23; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”Œ Socket.IO Direct Connection Test</h1>
    <div id="status" class="disconnected">âŒ Disconnected</div>
    <button onclick="testConnection()">Reconnect</button>
    <h3>Event Log:</h3>
    <div id="log"></div>
    
    <script>
        const logEl = document.getElementById('log');
        const statusEl = document.getElementById('status');
        let socket = null;
        
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML = `[${time}] ${msg}\n` + logEl.innerHTML;
            console.log(msg);
        }
        
        function testConnection() {
            if (socket) {
                socket.disconnect();
            }
            
            log('Initializing Socket.IO client...');
            log('Connecting to http://localhost:8000');
            
            socket = io('http://localhost:8000', {
                path: '/socket.io/',
                transports: ['polling', 'websocket'],
                reconnection: true,
                timeout: 20000,
            });
            
            socket.on('connect', () => {
                log('âœ… CONNECTED! Socket ID: ' + socket.id);
                statusEl.textContent = 'âœ… Connected - Socket ID: ' + socket.id;
                statusEl.className = 'connected';
            });
            
            socket.on('disconnect', (reason) => {
                log('âŒ Disconnected: ' + reason);
                statusEl.textContent = 'âŒ Disconnected: ' + reason;
                statusEl.className = 'disconnected';
            });
            
            socket.on('connect_error', (err) => {
                log('âŒ Connection error: ' + err.message);
            });
            
            socket.on('system_state', (data) => {
                log('ğŸ“¡ Received system_state - Session: ' + (data.session ? data.session.status : 'null'));
            });
            
            socket.on('hardware_status', (data) => {
                log('ğŸ”§ Received hardware_status - Connected: ' + data.connected + ', Mock: ' + data.mock_mode);
            });
            
            socket.on('sensor_data', (data) => {
                log('ğŸ“Š Received sensor_data');
            });
        }
        
        // Auto-connect on page load
        testConnection();
    </script>
</body>
</html>
</file>

<file path="frontend/src/components/Dashboard/StateTransitionOverlay.tsx">
import { useEffect, useRef } from 'react'
import gsap from 'gsap'
import { cn } from '@/lib/utils'

interface StateTransitionOverlayProps {
  state: string // e.g., 'IDLE', 'PREPARING', 'ACTIVE', 'PENALTY'
}

export function StateTransitionOverlay({ state }: StateTransitionOverlayProps) {
  const overlayRef = useRef<HTMLDivElement>(null)
  const previousState = useRef(state)

  useEffect(() => {
    if (state === previousState.current) return

    // Don't animate on initial load if it's just IDLE
    if (previousState.current === undefined && state === 'IDLE') {
      previousState.current = state
      return
    }

    const ctx = gsap.context(() => {
      const tl = gsap.timeline()

      // Reset
      gsap.set(overlayRef.current, {
        opacity: 1,
        scale: 0,
        backdropFilter: "blur(0px)",
      })

      // Animation: Expand from center with blur
      tl.to(overlayRef.current, {
        scale: 2, // Expand beyond screen
        backdropFilter: "blur(20px)",
        duration: 0.6,
        ease: "power2.inOut",
      })
      .to(overlayRef.current, {
        opacity: 0,
        duration: 0.4,
        ease: "power2.out",
      })
      .set(overlayRef.current, {
        scale: 0, // Reset
        backdropFilter: "blur(0px)",
      })

    }, overlayRef)

    previousState.current = state
    return () => ctx.revert()
  }, [state])

  return (
    <div 
      ref={overlayRef}
      className={cn(
        "fixed inset-0 z-50 pointer-events-none flex items-center justify-center",
        "bg-white/5" // Subtle flash
      )}
      style={{
        opacity: 0,
        transform: "scale(0)",
        borderRadius: "50%", // Circular expansion
      }}
    />
  )
}
</file>

<file path="frontend/src/components/ui/animated-number.tsx">
import React, { useEffect, useRef, useState } from 'react';
import { cn } from '@/lib/utils';
import gsap from 'gsap';

interface AnimatedNumberProps {
  value: number;
  precision?: number;
  className?: string;
  format?: (val: number) => string;
}

const Digit = ({ char, height }: { char: string; height: number }) => {
  const containerRef = useRef<HTMLDivElement>(null);
  const isNumber = !isNaN(parseInt(char));

  useEffect(() => {
    if (!containerRef.current || !isNumber) return;

    const targetIndex = parseInt(char);
    gsap.to(containerRef.current, {
      y: -targetIndex * height,
      duration: 0.8,
      ease: "back.out(1.7)", // Physics-based springy feel
    });
  }, [char, height, isNumber]);

  if (!isNumber) {
    return (
      <div 
        style={{ height, lineHeight: `${height}px` }} 
        className="flex items-center justify-center"
      >
        {char}
      </div>
    );
  }

  return (
    <div className="overflow-hidden relative" style={{ height, width: '0.6em' }}>
      <div ref={containerRef} className="flex flex-col items-center absolute w-full top-0 left-0">
        {[0, 1, 2, 3, 4, 5, 6, 7, 8, 9].map((n) => (
          <div 
            key={n} 
            style={{ height, lineHeight: `${height}px` }} 
            className="flex items-center justify-center w-full"
          >
            {n}
          </div>
        ))}
      </div>
    </div>
  );
};

export const AnimatedNumber: React.FC<AnimatedNumberProps> = ({
  value,
  precision = 0,
  className,
  format
}) => {
  const containerRef = useRef<HTMLDivElement>(null);
  const [digitHeight, setDigitHeight] = useState(0);
  const measureRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (measureRef.current) {
      setDigitHeight(measureRef.current.clientHeight);
    }
  }, []);

  // Format the value
  const formatted = format ? format(value) : value.toFixed(precision);
  const chars = formatted.split('');

  return (
    <div 
      ref={containerRef} 
      className={cn("flex flex-row items-center font-mono relative", className)}
    >
      {/* Invisible measurement element */}
      <div 
        ref={measureRef} 
        className="absolute opacity-0 pointer-events-none"
        aria-hidden="true"
      >
        0
      </div>

      {digitHeight > 0 && chars.map((char, index) => (
        // Use index as key to maintain component identity for animation
        <Digit key={index} char={char} height={digitHeight} />
      ))}
      
      {/* Fallback while measuring */}
      {digitHeight === 0 && <span>{formatted}</span>}
    </div>
  );
};

// Simpler version for just tweening the number text if the rolling effect is too heavy or breaks layout
export const TweenNumber: React.FC<AnimatedNumberProps> = ({
  value,
  precision = 0,
  className,
}) => {
  const ref = useRef<HTMLSpanElement>(null);
  const prevValue = useRef(value);

  useEffect(() => {
    if (!ref.current) return;

    gsap.to(prevValue, {
      current: value,
      duration: 1,
      ease: "power3.out",
      onUpdate: () => {
        if (ref.current) {
          ref.current.innerText = prevValue.current.toFixed(precision);
        }
      },
    });
  }, [value, precision]);

  return <span ref={ref} className={className}>{value.toFixed(precision)}</span>;
};
</file>

<file path="frontend/src/components/ui/SmoothScroll.tsx">
import { useEffect } from 'react'
import Lenis from 'lenis'

export function SmoothScroll() {
  useEffect(() => {
    const lenis = new Lenis({
      duration: 1.2,
      easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
      orientation: 'vertical',
      gestureOrientation: 'vertical',
      smoothWheel: true,
      wheelMultiplier: 1,
      touchMultiplier: 2,
    })

    function raf(time: number) {
      lenis.raf(time)
      requestAnimationFrame(raf)
    }

    requestAnimationFrame(raf)

    return () => {
      lenis.destroy()
    }
  }, [])

  return null
}
</file>

<file path="frontend/src/hooks/usePhysics.ts">
import { useEffect, useRef, RefObject } from 'react';
import gsap from 'gsap';
import { EASES, ANIMATION_CONFIG } from '@/lib/animation';

interface PhysicsConfig {
  damping?: number;
  stiffness?: number;
  mass?: number;
}

/**
 * Simulates a physical spring interaction for hover/active states.
 * Gives elements a "weighty" feel when pressed or hovered.
 */
export const useSpring = (
  ref: RefObject<HTMLElement>,
  options: { 
    scale?: number; 
    active?: boolean;
    stiffness?: number; // 0-1, higher is stiffer
  } = { scale: 0.95, active: true, stiffness: 0.5 }
) => {
  useEffect(() => {
    if (!ref.current || !options.active) return;
    const element = ref.current;
    const scale = options.scale || 0.95;

    const handleMouseDown = () => {
      gsap.to(element, {
        scale: scale,
        duration: 0.1, // Fast compression
        ease: "power2.out"
      });
    };

    const handleMouseUp = () => {
      gsap.to(element, {
        scale: 1,
        duration: 0.6, // Slower release with bounce
        ease: "elastic.out(1, 0.5)"
      });
    };

    const handleMouseEnter = () => {
      gsap.to(element, {
        y: -2, // Slight lift
        boxShadow: "0 10px 30px -10px rgba(0,0,0,0.3)",
        duration: 0.4,
        ease: "power2.out"
      });
    };

    const handleMouseLeave = () => {
      gsap.to(element, {
        y: 0,
        scale: 1,
        boxShadow: "0 4px 6px -1px rgba(0, 0, 0, 0.1)",
        duration: 0.6,
        ease: "power2.out"
      });
    };

    element.addEventListener('mousedown', handleMouseDown);
    element.addEventListener('mouseup', handleMouseUp);
    element.addEventListener('mouseenter', handleMouseEnter);
    element.addEventListener('mouseleave', handleMouseLeave);

    return () => {
      element.removeEventListener('mousedown', handleMouseDown);
      element.removeEventListener('mouseup', handleMouseUp);
      element.removeEventListener('mouseenter', handleMouseEnter);
      element.removeEventListener('mouseleave', handleMouseLeave);
    };
  }, [ref, options.active, options.scale]);
};

export const useMagnetic = (
  ref: RefObject<HTMLElement>,
  options: { active: boolean; strength?: number } = { active: true, strength: 1 }
) => {
  useEffect(() => {
    if (!ref.current || !options.active) return;

    const element = ref.current;
    const strength = options.strength || 1;

    const handleMouseMove = (e: MouseEvent) => {
      const rect = element.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      
      // Calculate distance from center
      const distanceX = e.clientX - centerX;
      const distanceY = e.clientY - centerY;

      // Magnetic pull with physics ease
      gsap.to(element, {
        x: distanceX * 0.1 * strength,
        y: distanceY * 0.1 * strength,
        rotationX: (distanceY / rect.height) * -10 * strength, // Tilt X
        rotationY: (distanceX / rect.width) * 10 * strength,   // Tilt Y
        duration: 0.5,
        ease: "power2.out"
      });

      // Spotlight effect variables
      element.style.setProperty('--mouse-x', `${e.clientX - rect.left}px`);
      element.style.setProperty('--mouse-y', `${e.clientY - rect.top}px`);
    };

    const handleMouseLeave = () => {
      gsap.to(element, {
        x: 0,
        y: 0,
        rotationX: 0,
        rotationY: 0,
        duration: 1.2,
        ease: "elastic.out(1, 0.3)"
      });
    };

    element.addEventListener('mousemove', handleMouseMove);
    element.addEventListener('mouseleave', handleMouseLeave);

    return () => {
      element.removeEventListener('mousemove', handleMouseMove);
      element.removeEventListener('mouseleave', handleMouseLeave);
    };
  }, [ref, options.active, options.strength]);
};

export const useSystemLock = (
  ref: RefObject<HTMLElement>,
  isLocked: boolean
) => {
  useEffect(() => {
    if (!ref.current) return;

    if (isLocked) {
      // Lock-in animation: Tighten, dim, focus
      gsap.to(ref.current, {
        scale: 0.98,
        borderColor: "rgba(255, 50, 50, 0.5)", // Red tint
        boxShadow: "0 0 30px rgba(255, 0, 0, 0.1), inset 0 0 20px rgba(0,0,0,0.5)",
        duration: 0.6,
        ease: "expo.out"
      });
    } else {
      // Release
      gsap.to(ref.current, {
        scale: 1,
        borderColor: "rgba(255, 255, 255, 0.1)",
        boxShadow: "0 10px 30px -10px rgba(0,0,0,0.5)",
        duration: 0.8,
        ease: "elastic.out(1, 0.75)"
      });
    }
  }, [isLocked, ref]);
};

export const useStaggerEntrance = (
  containerRef: RefObject<HTMLElement>,
  selector: string
) => {
  useEffect(() => {
    if (!containerRef.current) return;
    
    const ctx = gsap.context(() => {
      gsap.from(selector, {
        y: 30,
        opacity: 0,
        duration: 0.8,
        stagger: 0.05,
        ease: "back.out(1.7)",
        clearProps: "all"
      });
    }, containerRef);

    return () => ctx.revert();
  }, [containerRef, selector]);
};
</file>

<file path="frontend/src/lib/animation.ts">
import gsap from 'gsap';

// Global GSAP Configuration
gsap.defaults({
  ease: "power2.out",
  duration: 0.6,
});

// Custom Eases (Simulating CustomEase if not available, or defining standard complex eases)
export const EASES = {
  // Heavy physical object starting to move
  heavyStart: "power4.in",
  // Heavy physical object coming to a stop
  heavyStop: "power4.out",
  // Springy mechanical bounce
  spring: "elastic.out(1, 0.5)",
  // Smooth Apple-like transition
  smooth: "expo.out",
  // Precision mechanical movement
  precision: "back.out(1.7)",
};

export const ANIMATION_CONFIG = {
  // Duration for standard UI transitions
  duration: {
    fast: 0.2,
    normal: 0.4,
    slow: 0.8,
    long: 1.2,
  },
  // Stagger delays
  stagger: {
    fast: 0.05,
    normal: 0.1,
  },
};
</file>

<file path="frontend/src/vite-env.d.ts">
/// <reference types="vite/client" />

interface ImportMetaEnv {
  readonly DEV: boolean
  readonly PROD: boolean
  readonly MODE: string
  readonly BASE_URL: string
  readonly VITE_API_URL?: string
}

interface ImportMeta {
  readonly env: ImportMetaEnv
}
</file>

<file path="GITä½¿ç”¨èªªæ˜.md">
# Git æ¨é€å·¥å…·ä½¿ç”¨èªªæ˜

## å¿«é€Ÿé–‹å§‹

### æ–¹æ³• 1ï¼šå¿«é€Ÿæ¨é€ï¼ˆæ¨è–¦ï¼‰

```powershell
.\Git-QuickPush.ps1
```

äº’å‹•å¼æ“ä½œï¼Œæœƒè‡ªå‹•æª¢æŸ¥å®‰å…¨æ€§ï¼Œç„¶å¾Œå¼•å°ä½ å®Œæˆ commit å’Œ pushã€‚

### æ–¹æ³• 2ï¼šå®Œæ•´åŠŸèƒ½

```powershell
# åŸºæœ¬ä½¿ç”¨
.\Git-SafePush.ps1 -Message "ä½ çš„ commit è¨Šæ¯"

# åª commitï¼Œä¸ push
.\Git-SafePush.ps1 -Message "ä½ çš„ commit è¨Šæ¯" -NoPush
```

### æ–¹æ³• 3ï¼šåƒ…æª¢æŸ¥å®‰å…¨

```powershell
.\Check-GitSecurity.ps1
```

åªæª¢æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿè³‡æ–™ï¼Œä¸åŸ·è¡Œä»»ä½• git æ“ä½œã€‚

## ä¿è­·çš„æ•æ„Ÿè³‡æ–™

ä»¥ä¸‹æª”æ¡ˆå·²è¢« .gitignore ä¿è­·ï¼Œ**ä¸æœƒä¸Šå‚³åˆ° GitHub**ï¼š

- âœ… `backend/credentials.json` - åŒ…å«å¯†ç¢¼å’Œ token
- âœ… `backend/browser_contexts/` - ç€è¦½å™¨ç‹€æ…‹
- âœ… `backend/hostage_evidence/` - ä¸Šå‚³çš„åœ–ç‰‡
- âœ… `.env` - ç’°å¢ƒè®Šæ•¸
- âœ… `*.key, *.pem` - å¯†é‘°æª”æ¡ˆ

## ç·Šæ€¥ï¼šç§»é™¤å·²è¿½è¹¤çš„æ•æ„Ÿæª”æ¡ˆ

å¦‚æœæ•æ„Ÿæª”æ¡ˆå·²ç¶“è¢« git è¿½è¹¤ï¼š

```powershell
# å¾ git ç§»é™¤ä½†ä¿ç•™æœ¬åœ°æª”æ¡ˆ
git rm --cached backend/credentials.json

# Commit é€™å€‹è®Šæ›´
git commit -m "Remove sensitive file"

# æ¨é€
git push
```

## æ¸¬è©¦çµæœ

å‰›æ‰çš„æª¢æŸ¥é¡¯ç¤ºï¼š
- âœ… .gitignore è¨­å®šæ­£ç¢º
- âœ… æ²’æœ‰æ•æ„Ÿæª”æ¡ˆåœ¨ staging area
- âœ… æ²’æœ‰æ•æ„Ÿæª”æ¡ˆåœ¨ repository ä¸­
- âœ… æœ¬åœ°æ•æ„Ÿæª”æ¡ˆå·²è¢«ä¿è­·

ä½ çš„å°ˆæ¡ˆæ˜¯å®‰å…¨çš„ï¼å¯ä»¥æ”¾å¿ƒæ¨é€ã€‚

## å®Œæ•´æ–‡æª”

è©³ç´°èªªæ˜è«‹åƒè€ƒï¼š[GIT_SECURITY_README.md](GIT_SECURITY_README.md)
</file>

<file path="package.json">
{
  "dependencies": {
    "lenis": "^1.3.16"
  }
}
</file>

<file path="backend/app/__init__.py">
"""
The Focus Enforcer Backend Application
Initializes Windows event loop policy for Playwright compatibility
"""
import sys
import asyncio

# CRITICAL: Set Windows event loop policy for Playwright
# This must run on every process import, including uvicorn reload subprocesses
if sys.platform == 'win32':
    try:
        asyncio.set_event_loop_policy(asyncio.WindowsProactorEventLoopPolicy())
    except Exception:
        pass  # Already set or not needed
</file>

<file path="backend/app/automation/__init__.py">

</file>

<file path="backend/app/automation/social_manager.py">
import asyncio
import httpx
import aiosmtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.image import MIMEImage
from pathlib import Path
from typing import Optional, List
from datetime import datetime
from playwright.async_api import async_playwright, Browser, BrowserContext
import random
from ..config import settings
from ..models import SocialPlatform, SystemState


class SocialManager:
    def __init__(self):
        self.client = httpx.AsyncClient(timeout=30.0)
        self.playwright = None
        self.browser: Optional[Browser] = None
        self.threads_context: Optional[BrowserContext] = None
        self.threads_state_file = Path("backend/browser_contexts/threads_state.json")

    async def shutdown(self):
        """æ¸…ç†æ‰€æœ‰è³‡æº"""
        try:
            await self.client.aclose()
        except Exception as e:
            print(f"[SocialManager] é—œé–‰ HTTP å®¢æˆ¶ç«¯æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        
        try:
            if self.threads_context:
                await self.threads_context.close()
        except Exception as e:
            print(f"[SocialManager] é—œé–‰ Threads ä¸Šä¸‹æ–‡æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        
        try:
            if self.browser:
                await self.browser.close()
        except Exception as e:
            print(f"[SocialManager] é—œé–‰ç€è¦½å™¨æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        
        try:
            if self.playwright:
                await self.playwright.stop()
        except Exception as e:
            print(f"[SocialManager] åœæ­¢ Playwright æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")

    def _check_platform_credentials(self, platform: SocialPlatform) -> bool:
        """çµ±ä¸€çš„å¹³å°æ†‘è­‰æª¢æŸ¥æ–¹æ³•"""
        if platform == SocialPlatform.DISCORD:
            return bool(settings.DISCORD_WEBHOOK_URL)
        elif platform == SocialPlatform.THREADS:
            has_api = bool(settings.THREADS_USER_ID and settings.THREADS_ACCESS_TOKEN)
            has_browser = self.threads_state_file.exists()
            return has_api or has_browser
        elif platform == SocialPlatform.GMAIL:
            return bool(settings.GMAIL_USER and settings.GMAIL_APP_PASSWORD)
        return False

    def get_login_status(self) -> dict[str, bool]:
        """æª¢æŸ¥æ‰€æœ‰å¹³å°çš„ç™»å…¥ç‹€æ…‹"""
        return {
            platform.value: self._check_platform_credentials(platform)
            for platform in SocialPlatform
        }

    def is_platform_logged_in(self, platform: SocialPlatform) -> bool:
        """æª¢æŸ¥æŒ‡å®šå¹³å°æ˜¯å¦å·²ç™»å…¥/è¨­å®š"""
        return self._check_platform_credentials(platform)

    async def send_shame_email(
        self, 
        message: str, 
        recipients: List[str],
        image_path: Optional[str] = None
    ) -> bool:
        """
        é€é Gmail SMTP ç™¼é€ç¾è¾±éƒµä»¶ï¼ˆæ”¯æ´åœ–ç‰‡é™„ä»¶ï¼‰
        
        Args:
            message: éƒµä»¶å…§å®¹
            recipients: æ”¶ä»¶äººéƒµç®±åˆ—è¡¨
            image_path: å¯é¸çš„åœ–ç‰‡è·¯å¾‘
        """
        if not settings.GMAIL_USER or not settings.GMAIL_APP_PASSWORD:
            print("[SocialManager] Gmail æ†‘è­‰æœªè¨­å®šï¼Œè·³éç™¼é€éƒµä»¶")
            return False
            
        if not recipients:
            print("[SocialManager] æœªæŒ‡å®šæ”¶ä»¶äººï¼Œè·³éç™¼é€éƒµä»¶")
            return False

        try:
            # å»ºç«‹éƒµä»¶
            msg = MIMEMultipart()
            msg['From'] = settings.GMAIL_USER
            msg['To'] = ', '.join(recipients)
            msg['Subject'] = "ğŸš¨ Focus Violation Alert ğŸš¨"

            # æ–°å¢æ–‡å­—å…§å®¹
            msg.attach(MIMEText(message, 'plain', 'utf-8'))

            # é™„åŠ åœ–ç‰‡ï¼ˆå¦‚æœæä¾›ï¼‰
            if image_path:
                image_file = Path(image_path)
                if image_file.exists():
                    try:
                        with open(image_file, 'rb') as f:
                            img_data = f.read()
                        image = MIMEImage(img_data, name=image_file.name)
                        msg.attach(image)
                        print(f"[SocialManager] å·²é™„åŠ åœ–ç‰‡: {image_file.name}")
                    except Exception as e:
                        print(f"[SocialManager] åœ–ç‰‡è®€å–å¤±æ•—: {e}")
                else:
                    print(f"[SocialManager] åœ–ç‰‡æª”æ¡ˆä¸å­˜åœ¨: {image_path}")

            # é€é Gmail SMTP ç™¼é€
            await aiosmtplib.send(
                msg,
                hostname="smtp.gmail.com",
                port=587,
                start_tls=True,
                username=settings.GMAIL_USER,
                password=settings.GMAIL_APP_PASSWORD,
            )
            
            print(f"[SocialManager] âœ… éƒµä»¶å·²æˆåŠŸç™¼é€çµ¦ {len(recipients)} ä½æ”¶ä»¶äºº")
            return True
            
        except Exception as e:
            print(f"[SocialManager] âŒ ç™¼é€éƒµä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
            return False

    async def _init_playwright(self):
        """åˆå§‹åŒ– Playwright ç€è¦½å™¨"""
        if not self.playwright:
            self.playwright = await async_playwright().start()
            self.browser = await self.playwright.chromium.launch(headless=True)
            print("[SocialManager] Playwright ç€è¦½å™¨å·²åˆå§‹åŒ–")

    async def login_threads_browser(self, username: str, password: str) -> bool:
        """
        ä½¿ç”¨ç€è¦½å™¨è‡ªå‹•åŒ–ç™»å…¥ Threadsï¼ˆç°¡åŒ–ç‰ˆï¼‰
        
        âš ï¸ å®‰å…¨è­¦å‘Šï¼š
        æ­¤æ–¹æ³•ä½¿ç”¨ç€è¦½å™¨è‡ªå‹•åŒ–ï¼Œå¯èƒ½è¢« Instagram/Threads åµæ¸¬ç‚ºæ©Ÿå™¨äººè¡Œç‚ºã€‚
        å»ºè­°åƒ…ç”¨æ–¼æ¸¬è©¦ç’°å¢ƒæˆ–ä½é »ä½¿ç”¨ã€‚æ­£å¼ç’°å¢ƒè«‹ä½¿ç”¨å®˜æ–¹ API (post_to_threads_api)ã€‚
        
        Args:
            username: Instagram/Threads å¸³è™Ÿï¼ˆå¯ä»¥æ˜¯ç”¨æˆ¶åæˆ–ä¿¡ç®±ï¼‰
            password: å¯†ç¢¼
        """
        print("\n" + "="*60)
        print("âš ï¸  å®‰å…¨è­¦å‘Šï¼šç€è¦½å™¨è‡ªå‹•åŒ–ç™»å…¥")
        print("="*60)
        print("æ­¤æ–¹æ³•å¯èƒ½è¢«åµæ¸¬ç‚ºæ©Ÿå™¨äººï¼Œæœ‰å¸³è™Ÿè¢«é™åˆ¶çš„é¢¨éšªã€‚")
        print("å»ºè­°ï¼šåƒ…ç”¨æ–¼æ¸¬è©¦ï¼Œæ­£å¼ç’°å¢ƒè«‹ä½¿ç”¨å®˜æ–¹ Threads APIã€‚")
        print("="*60 + "\n")
        
        try:
            await self._init_playwright()
            
            # ç¢ºä¿ç›®éŒ„å­˜åœ¨
            self.threads_state_file.parent.mkdir(parents=True, exist_ok=True)
            
            print("[SocialManager] æ­£åœ¨ç™»å…¥ Threads...")
            
            # å»ºç«‹æ–°çš„ç€è¦½å™¨ç’°å¢ƒ
            context = await self.browser.new_context()
            page = await context.new_page()
            
            # å‰å¾€ Threads ç™»å…¥é é¢
            await page.goto("https://www.threads.net/login", wait_until="networkidle")
            await asyncio.sleep(2)
            
            # å¡«å¯«å¸³è™Ÿå¯†ç¢¼
            await page.fill('input[name="username"]', username)
            await page.fill('input[name="password"]', password)
            
            # é»æ“Šç™»å…¥æŒ‰éˆ•
            await page.click('button[type="submit"]')
            await asyncio.sleep(5)
            
            # æª¢æŸ¥æ˜¯å¦ç™»å…¥æˆåŠŸï¼ˆæª¢æŸ¥ URL æˆ–ç‰¹å®šå…ƒç´ ï¼‰
            current_url = page.url
            if "login" not in current_url.lower():
                # å„²å­˜ç™»å…¥ç‹€æ…‹
                await context.storage_state(path=str(self.threads_state_file))
                await context.close()
                
                print("[SocialManager] âœ… Threads ç™»å…¥æˆåŠŸï¼")
                print("[SocialManager] âš ï¸  æé†’ï¼šè«‹ç›¡å¿«åˆ‡æ›åˆ°å®˜æ–¹ API ä»¥é™ä½é¢¨éšª")
                return True
            else:
                await context.close()
                print("[SocialManager] âŒ Threads ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼")
                return False
                
        except Exception as e:
            print(f"[SocialManager] âŒ Threads ç™»å…¥éŒ¯èª¤: {e}")
            return False

    async def post_to_threads_browser(self, message: str, image_path: Optional[str] = None) -> bool:
        """
        ä½¿ç”¨ç€è¦½å™¨è‡ªå‹•åŒ–ç™¼æ–‡åˆ° Threadsï¼ˆç°¡åŒ–ç‰ˆï¼‰
        
        âš ï¸ å®‰å…¨è­¦å‘Šï¼š
        æ­¤æ–¹æ³•ä½¿ç”¨ç€è¦½å™¨è‡ªå‹•åŒ–ï¼Œå¯èƒ½è¢«åµæ¸¬ç‚ºæ©Ÿå™¨äººã€‚
        å»ºè­°ä½¿ç”¨å®˜æ–¹ API (post_to_threads_api) ä»¥ç¢ºä¿å¸³è™Ÿå®‰å…¨ã€‚
        
        Args:
            message: è²¼æ–‡å…§å®¹
            image_path: å¯é¸çš„åœ–ç‰‡è·¯å¾‘
        """
        print("[SocialManager] âš ï¸  ä½¿ç”¨ç€è¦½å™¨æ¨¡å¼ç™¼æ–‡ï¼ˆæœ‰é¢¨éšªï¼‰")
        
        try:
            await self._init_playwright()
            
            if not self.threads_state_file.exists():
                print("[SocialManager] âŒ Threads æœªç™»å…¥ï¼Œè«‹å…ˆä½¿ç”¨å¸³è™Ÿå¯†ç¢¼ç™»å…¥")
                return False
            
            print("[SocialManager] æ­£åœ¨ä½¿ç”¨ç€è¦½å™¨ç™¼å¸ƒ Threads è²¼æ–‡...")
            
            # ä½¿ç”¨å·²å„²å­˜çš„ç™»å…¥ç‹€æ…‹
            context = await self.browser.new_context(
                storage_state=str(self.threads_state_file)
            )
            page = await context.new_page()
            
            # å‰å¾€ Threads é¦–é 
            await page.goto("https://www.threads.net/", wait_until="networkidle")
            await asyncio.sleep(2)
            
            # é»æ“Šã€Œæ–°è²¼æ–‡ã€æŒ‰éˆ•ï¼ˆå¯èƒ½éœ€è¦æ ¹æ“šå¯¦éš› DOM çµæ§‹èª¿æ•´ï¼‰
            try:
                # å˜—è©¦å¤šç¨®å¯èƒ½çš„é¸æ“‡å™¨
                selectors = [
                    'button[aria-label*="new thread"]',
                    'button[aria-label*="New thread"]',
                    'svg[aria-label="Create"]',
                    'a[href="/new"]'
                ]
                
                clicked = False
                for selector in selectors:
                    try:
                        await page.click(selector, timeout=3000)
                        clicked = True
                        break
                    except:
                        continue
                
                if not clicked:
                    # å¦‚æœæ²’æœ‰æ‰¾åˆ°æŒ‰éˆ•ï¼Œå˜—è©¦ç›´æ¥è¨ªå•å‰µå»ºé é¢
                    await page.goto("https://www.threads.net/new", wait_until="networkidle")
                
                await asyncio.sleep(2)
                
                # å¡«å¯«è²¼æ–‡å…§å®¹
                textarea_selectors = [
                    'div[contenteditable="true"]',
                    'textarea[placeholder*="Start"]',
                    'textarea'
                ]
                
                for selector in textarea_selectors:
                    try:
                        await page.fill(selector, message, timeout=3000)
                        break
                    except:
                        continue
                
                await asyncio.sleep(1)
                
                # å¦‚æœæœ‰åœ–ç‰‡ï¼Œä¸Šå‚³åœ–ç‰‡
                if image_path and Path(image_path).exists():
                    try:
                        file_input = await page.query_selector('input[type="file"]')
                        if file_input:
                            await file_input.set_input_files(str(image_path))
                            await asyncio.sleep(2)
                            print("[SocialManager] å·²é™„åŠ åœ–ç‰‡")
                    except Exception as e:
                        print(f"[SocialManager] åœ–ç‰‡ä¸Šå‚³å¤±æ•—: {e}")
                
                # é»æ“Šç™¼å¸ƒæŒ‰éˆ•
                post_selectors = [
                    'button:has-text("Post")',
                    'div[role="button"]:has-text("Post")',
                    'button[type="submit"]'
                ]
                
                for selector in post_selectors:
                    try:
                        await page.click(selector, timeout=3000)
                        break
                    except:
                        continue
                
                await asyncio.sleep(3)
                
                await context.close()
                print("[SocialManager] âœ… Threads è²¼æ–‡ç™¼å¸ƒæˆåŠŸï¼")
                return True
                
            except Exception as e:
                await context.close()
                print(f"[SocialManager] âŒ ç™¼å¸ƒè²¼æ–‡æ™‚å‡ºéŒ¯: {e}")
                return False
                
        except Exception as e:
            print(f"[SocialManager] âŒ Threads ç™¼æ–‡éŒ¯èª¤: {e}")
            return False

    async def post_to_threads_api(
        self, 
        message: str, 
        image_path: Optional[str] = None
    ) -> bool:
        """
        ä½¿ç”¨ Meta API ç™¼æ–‡åˆ° Threadsï¼ˆé€²éšç‰ˆï¼Œéœ€è¦ API tokenï¼‰
        
        Args:
            message: è²¼æ–‡å…§å®¹
            image_path: å¯é¸çš„åœ–ç‰‡è·¯å¾‘ï¼ˆç›®å‰ä¸æ”¯æ´ï¼‰
        """
        if not settings.THREADS_USER_ID or not settings.THREADS_ACCESS_TOKEN:
            print("[SocialManager] Threads API æ†‘è­‰æœªè¨­å®š")
            return False

        try:
            base_url = "https://graph.threads.net/v1.0"
            
            # Step 1: Create container
            create_url = f"{base_url}/{settings.THREADS_USER_ID}/threads"
            create_params = {
                "media_type": "TEXT",
                "text": message,
                "access_token": settings.THREADS_ACCESS_TOKEN
            }
            
            print(f"[SocialManager] æ­£åœ¨å»ºç«‹ Threads è²¼æ–‡å®¹å™¨...")
            create_response = await self.client.post(create_url, params=create_params)
            
            if create_response.status_code not in (200, 201):
                print(f"[SocialManager] âŒ å»ºç«‹å®¹å™¨å¤±æ•—: {create_response.status_code}")
                print(f"[SocialManager] Response: {create_response.text}")
                return False
            
            creation_data = create_response.json()
            creation_id = creation_data.get("id")
            
            if not creation_id:
                print(f"[SocialManager] âŒ ç„¡æ³•å–å¾— creation_id: {creation_data}")
                return False
            
            # Step 2: Publish the container
            publish_url = f"{base_url}/{settings.THREADS_USER_ID}/threads_publish"
            publish_params = {
                "creation_id": creation_id,
                "access_token": settings.THREADS_ACCESS_TOKEN
            }
            
            print(f"[SocialManager] æ­£åœ¨ç™¼å¸ƒ Threads è²¼æ–‡...")
            publish_response = await self.client.post(publish_url, params=publish_params)
            
            if publish_response.status_code not in (200, 201):
                print(f"[SocialManager] âŒ ç™¼å¸ƒå¤±æ•—: {publish_response.status_code}")
                print(f"[SocialManager] Response: {publish_response.text}")
                return False
            
            publish_data = publish_response.json()
            thread_id = publish_data.get("id")
            
            print(f"[SocialManager] âœ… Threads è²¼æ–‡ç™¼å¸ƒæˆåŠŸï¼Post ID: {thread_id}")
            return True
            
        except Exception as e:
            print(f"[SocialManager] âŒ Threads API éŒ¯èª¤: {e}")
            return False

    async def post_to_threads(
        self, 
        message: str, 
        image_path: Optional[str] = None
    ) -> bool:
        """
        ç™¼å¸ƒè²¼æ–‡åˆ° Threadsï¼ˆè‡ªå‹•é¸æ“‡æœ€ä½³æ–¹å¼ï¼‰
        å„ªå…ˆä½¿ç”¨å®˜æ–¹ APIï¼ˆå®‰å…¨ã€ç©©å®šï¼‰ï¼Œå¦å‰‡ä½¿ç”¨ç€è¦½å™¨æ¨¡å¼ï¼ˆæœ‰é¢¨éšªï¼‰
        """
        # å„ªå…ˆä½¿ç”¨å®˜æ–¹ APIï¼ˆæ¨è–¦ï¼‰
        if settings.THREADS_USER_ID and settings.THREADS_ACCESS_TOKEN:
            print("[SocialManager] ä½¿ç”¨å®˜æ–¹ API ç™¼å¸ƒ Threads è²¼æ–‡ï¼ˆå®‰å…¨æ¨¡å¼ï¼‰")
            return await self.post_to_threads_api(message, image_path)
        
        # å‚™é¸ï¼šä½¿ç”¨ç€è¦½å™¨æ¨¡å¼ï¼ˆæœ‰é¢¨éšªï¼‰
        elif self.threads_state_file.exists():
            print("[SocialManager] ä½¿ç”¨ç€è¦½å™¨æ¨¡å¼ç™¼å¸ƒï¼ˆå»ºè­°åˆ‡æ›è‡³ APIï¼‰")
            return await self.post_to_threads_browser(message, image_path)
        
        else:
            print("[SocialManager] âŒ Threads æœªè¨­å®šï¼Œè«‹å…ˆç™»å…¥æˆ–è¨­å®š API token")
            return False

    async def post_to_discord(self, message: str) -> bool:
        """é€é Webhook ç™¼å¸ƒè¨Šæ¯åˆ° Discord"""
        if not settings.DISCORD_WEBHOOK_URL:
            print("[SocialManager] Discord webhook URL æœªè¨­å®šï¼Œè·³éç™¼å¸ƒ")
            return False
        
        try:
            payload = {"content": message}
            response = await self.client.post(
                settings.DISCORD_WEBHOOK_URL,
                json=payload
            )
            
            if response.status_code in (200, 204):
                print(f"[SocialManager] âœ… å·²æˆåŠŸç™¼å¸ƒåˆ° Discordï¼")
                return True
            else:
                print(f"[SocialManager] âŒ Discord ç™¼å¸ƒå¤±æ•—: {response.status_code}")
                print(f"[SocialManager] å›æ‡‰: {response.text}")
                return False
                
        except Exception as e:
            print(f"[SocialManager] âŒ Discord ç™¼å¸ƒéŒ¯èª¤: {e}")
            return False

    async def execute_penalty(self, state: SystemState, hostage_path: Optional[str] = None):
        """
        åœ¨æ‰€æœ‰å•Ÿç”¨çš„å¹³å°åŸ·è¡Œæ‡²ç½°
        
        Args:
            state: ç•¶å‰ç³»çµ±ç‹€æ…‹ï¼ˆåŒ…å«æœƒè©±å’Œæ‡²ç½°è¨­å®šï¼‰
            hostage_path: å¯é¸çš„äººè³ªç…§ç‰‡è·¯å¾‘ï¼ˆå·²æ£„ç”¨ï¼Œæ”¹ç”¨å¤šå¼µç…§ç‰‡ç³»çµ±ï¼‰
        """
        if not state.penalty_settings:
            print("[SocialManager] æœªè¨­å®šæ‡²ç½°é…ç½®")
            return
        
        enabled = state.penalty_settings.enabled_platforms
        if not enabled:
            print("[SocialManager] æœªå•Ÿç”¨ä»»ä½•æ‡²ç½°å¹³å°")
            return
        
        print(f"\n[SocialManager] ğŸ”¥ æ­£åœ¨ {len(enabled)} å€‹å¹³å°åŸ·è¡Œæ‡²ç½°...")
        
        # å¾å·²é¸å–çš„ç…§ç‰‡ä¸­éš¨æ©Ÿé¸æ“‡ä¸€å¼µ
        selected_image = await self._get_random_selected_image()
        if selected_image:
            print(f"[SocialManager] ğŸ“¸ å·²é¸å–éš¨æ©Ÿç…§ç‰‡: {Path(selected_image).name}")
        else:
            print("[SocialManager] ğŸ“¸ ç„¡é¸å–çš„ç…§ç‰‡ï¼Œå°‡åƒ…ç™¼é€æ–‡å­—è¨Šæ¯")
        
        # æº–å‚™ä¸¦è¡ŒåŸ·è¡Œçš„ä»»å‹™
        tasks = []
        
        for platform in enabled:
            # å–å¾—è‡ªè¨‚è¨Šæ¯æˆ–ä½¿ç”¨é è¨­è¨Šæ¯
            message = state.penalty_settings.custom_messages.get(
                platform.value,
                "ğŸš¨ å°ˆæ³¨é•è¦åµæ¸¬ï¼ ğŸš¨"
            )
            
            # æ–°å¢æ™‚é–“æˆ³è¨˜ï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
            if state.penalty_settings.include_timestamp:
                timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                message = f"{message}\n\nâ° æ™‚é–“: {timestamp}"
            
            # æ–°å¢é•è¦æ¬¡æ•¸ï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
            if state.penalty_settings.include_violation_count and state.session:
                message = f"{message}\n\nğŸ”¢ é•è¦ #{state.session.violations}"
            
            # ç‚ºæ¯å€‹å¹³å°å»ºç«‹å°æ‡‰çš„ä»»å‹™
            if platform == SocialPlatform.GMAIL:
                recipients = state.penalty_settings.gmail_recipients
                if recipients:
                    tasks.append(
                        self.send_shame_email(message, recipients, image_path=selected_image)
                    )
            elif platform == SocialPlatform.THREADS:
                tasks.append(
                    self.post_to_threads(message, image_path=selected_image)
                )
            elif platform == SocialPlatform.DISCORD:
                tasks.append(
                    self.post_to_discord(message)
                )
        
        # ä¸¦è¡ŒåŸ·è¡Œæ‰€æœ‰æ‡²ç½°ä»»å‹™
        if tasks:
            results = await asyncio.gather(*tasks, return_exceptions=True)
            success_count = sum(1 for r in results if r is True)
            print(f"[SocialManager] ğŸ“Š æ‡²ç½°åŸ·è¡Œå®Œæˆ: {success_count}/{len(tasks)} æˆåŠŸ")
        else:
            print("[SocialManager] æ²’æœ‰æœ‰æ•ˆçš„æ‡²ç½°ä»»å‹™å¯åŸ·è¡Œ")

    async def _get_random_selected_image(self) -> Optional[str]:
        """å¾å·²é¸å–çš„ç…§ç‰‡ä¸­éš¨æ©Ÿé¸æ“‡ä¸€å¼µ"""
        try:
            # è®€å– metadata æª”æ¡ˆ - use path relative to this file
            base_path = Path(__file__).parent.parent.parent / "hostage_evidence"
            metadata_file = base_path / "metadata.json"
            if not metadata_file.exists():
                print(f"[SocialManager] metadata file not found: {metadata_file}")
                return None
            
            import json
            with open(metadata_file, 'r', encoding='utf-8') as f:
                metadata = json.load(f)
            
            # ç¯©é¸å‡ºå·²é¸å–çš„ç…§ç‰‡
            selected_images = []
            for image_id, data in metadata.items():
                if data.get('selected', False):
                    image_path = base_path / data['filename']
                    if image_path.exists():
                        selected_images.append(str(image_path))
            
            # éš¨æ©Ÿé¸æ“‡ä¸€å¼µ
            if selected_images:
                return random.choice(selected_images)
            
            return None
            
        except Exception as e:
            print(f"[SocialManager] è®€å–ç…§ç‰‡é¸æ“‡æ¸…å–®æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
            return None


    # ç›¸å®¹æ€§æ–¹æ³•ï¼ˆä¿ç•™èˆŠç‰ˆä»‹é¢ï¼‰
    async def initialize(self):
        """åˆå§‹åŒ–ç®¡ç†å™¨ï¼ˆAPI æ•´åˆæ¨¡å¼ç„¡éœ€é¡å¤–åˆå§‹åŒ–ï¼‰"""
        pass

    async def open_login_page(self, platform: SocialPlatform):
        """ä¸éœ€è¦é–‹å•Ÿç™»å…¥é é¢ï¼ˆä½¿ç”¨ API é©—è­‰ï¼‰"""
        print(f"[SocialManager] ç›´æ¥ API æ•´åˆ - è«‹åœ¨ .env æª”æ¡ˆè¨­å®šæ†‘è­‰")
        pass

    async def save_session(self, platform: SocialPlatform) -> bool:
        """æª¢æŸ¥å¹³å°æ˜¯å¦å·²è¨­å®š"""
        return self.is_platform_logged_in(platform)

    async def logout_platform(self, platform: SocialPlatform) -> bool:
        """ç„¡æ³•ç™»å‡º API æ†‘è­‰ï¼ˆéœ€æ‰‹å‹•ç§»é™¤ .env è¨­å®šï¼‰"""
        return True


# å…¨åŸŸå¯¦ä¾‹
social_manager = SocialManager()
</file>

<file path="backend/app/config.py">
from pydantic_settings import BaseSettings
from typing import Optional
from pathlib import Path


class Settings(BaseSettings):
    APP_NAME: str = "The Focus Enforcer v1.0"
    DEBUG: bool = False
    
    # Server
    HOST: str = "0.0.0.0"
    PORT: int = 8000
    
    # Mock Hardware Mode - Default to False, real hardware takes priority
    MOCK_HARDWARE: bool = False
    MOCK_INTERVAL_MS: int = 500
    
    # Gmail Configuration (Direct Integration)
    GMAIL_USER: Optional[str] = None
    GMAIL_APP_PASSWORD: Optional[str] = None
    
    # Threads API Configuration (Direct Integration)
    THREADS_USER_ID: Optional[str] = None
    THREADS_ACCESS_TOKEN: Optional[str] = None
    
    # Discord Configuration
    DISCORD_WEBHOOK_URL: Optional[str] = None
    
    # Penalty Thresholds
    PERSON_AWAY_THRESHOLD_SEC: int = 10
    MOTION_THRESHOLD: float = 0.5
    
    class Config:
        env_file = ".env"
        env_file_encoding = 'utf-8'
        extra = "ignore"  # Ignore extra fields in .env file
    
    def load_from_credential_store(self):
        """å¾æ†‘è­‰å„²å­˜ä¸­è¼‰å…¥è¨­å®šï¼ˆå„ªå…ˆæ–¼ .envï¼‰"""
        try:
            from .credential_store import credential_store
            
            # Gmail
            gmail_user, gmail_pass = credential_store.get_gmail_credentials()
            if gmail_user:
                self.GMAIL_USER = gmail_user
            if gmail_pass:
                self.GMAIL_APP_PASSWORD = gmail_pass
            
            # Threads
            threads_id, threads_token = credential_store.get_threads_credentials()
            if threads_id:
                self.THREADS_USER_ID = threads_id
            if threads_token:
                self.THREADS_ACCESS_TOKEN = threads_token
            
            # Discord
            discord_webhook = credential_store.get_discord_credentials()
            if discord_webhook:
                self.DISCORD_WEBHOOK_URL = discord_webhook
        except Exception as e:
            print(f"[CONFIG] Warning: Could not load credentials from store: {e}")
            print("[CONFIG] Using configuration from .env file only")


# Initialize settings
settings = Settings()

# Check if .env exists, if not warn user
env_path = Path(__file__).parent.parent / ".env"
if not env_path.exists():
    print("[CONFIG] Warning: .env file not found. Using default settings.")
    print("[CONFIG] Copy .env.example to .env and configure your settings.")

# è¼‰å…¥ä½¿ç”¨è€…å„²å­˜çš„æ†‘è­‰ï¼ˆå„ªå…ˆæ–¼ .envï¼‰
settings.load_from_credential_store()
</file>

<file path="backend/app/credential_store.py">
"""
æ†‘è­‰å„²å­˜ç®¡ç†å™¨
è² è²¬å„²å­˜å’Œè¼‰å…¥ä½¿ç”¨è€…è¼¸å…¥çš„ç¤¾äº¤å¹³å°æ†‘è­‰
"""
import json
from pathlib import Path
from typing import Optional
from pydantic import BaseModel


class PlatformCredentials(BaseModel):
    """å–®ä¸€å¹³å°çš„æ†‘è­‰"""
    gmail_user: Optional[str] = None
    gmail_app_password: Optional[str] = None
    threads_user_id: Optional[str] = None
    threads_access_token: Optional[str] = None
    discord_webhook_url: Optional[str] = None


class CredentialStore:
    """æ†‘è­‰å„²å­˜ç®¡ç†å™¨"""
    
    def __init__(self, storage_path: str = "credentials.json"):
        self.storage_path = Path(storage_path)
        self.credentials: PlatformCredentials = self._load()
    
    def _load(self) -> PlatformCredentials:
        """å¾æª”æ¡ˆè¼‰å…¥æ†‘è­‰"""
        if not self.storage_path.exists():
            return PlatformCredentials()
        
        try:
            with open(self.storage_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
                return PlatformCredentials(**data)
        except Exception as e:
            print(f"[CredentialStore] è¼‰å…¥æ†‘è­‰å¤±æ•—: {e}")
            return PlatformCredentials()
    
    def save(self):
        """å„²å­˜æ†‘è­‰åˆ°æª”æ¡ˆ"""
        try:
            # ç¢ºä¿ç›®éŒ„å­˜åœ¨
            self.storage_path.parent.mkdir(parents=True, exist_ok=True)
            
            with open(self.storage_path, 'w', encoding='utf-8') as f:
                json.dump(
                    self.credentials.model_dump(exclude_none=False), 
                    f, 
                    indent=2, 
                    ensure_ascii=False
                )
            print(f"[CredentialStore] æ†‘è­‰å·²å„²å­˜åˆ° {self.storage_path}")
        except Exception as e:
            print(f"[CredentialStore] å„²å­˜æ†‘è­‰å¤±æ•—: {e}")
            raise
    
    def update_gmail(self, user: str, app_password: str):
        """æ›´æ–° Gmail æ†‘è­‰"""
        self.credentials.gmail_user = user
        self.credentials.gmail_app_password = app_password
        self.save()
    
    def update_threads(self, user_id: str, access_token: str):
        """æ›´æ–° Threads æ†‘è­‰"""
        self.credentials.threads_user_id = user_id
        self.credentials.threads_access_token = access_token
        self.save()
    
    def update_discord(self, webhook_url: str):
        """æ›´æ–° Discord æ†‘è­‰"""
        self.credentials.discord_webhook_url = webhook_url
        self.save()
    
    def clear_gmail(self):
        """æ¸…é™¤ Gmail æ†‘è­‰"""
        self.credentials.gmail_user = None
        self.credentials.gmail_app_password = None
        self.save()
    
    def clear_threads(self):
        """æ¸…é™¤ Threads æ†‘è­‰"""
        self.credentials.threads_user_id = None
        self.credentials.threads_access_token = None
        self.save()
    
    def clear_discord(self):
        """æ¸…é™¤ Discord æ†‘è­‰"""
        self.credentials.discord_webhook_url = None
        self.save()
    
    def get_gmail_credentials(self) -> tuple[Optional[str], Optional[str]]:
        """å–å¾— Gmail æ†‘è­‰"""
        return self.credentials.gmail_user, self.credentials.gmail_app_password
    
    def get_threads_credentials(self) -> tuple[Optional[str], Optional[str]]:
        """å–å¾— Threads æ†‘è­‰"""
        return self.credentials.threads_user_id, self.credentials.threads_access_token
    
    def get_discord_credentials(self) -> Optional[str]:
        """å–å¾— Discord æ†‘è­‰"""
        return self.credentials.discord_webhook_url


# å…¨åŸŸæ†‘è­‰å„²å­˜å¯¦ä¾‹
credential_store = CredentialStore()
</file>

<file path="backend/app/routers/__init__.py">

</file>

<file path="backend/app/routers/hostage.py">
from fastapi import APIRouter, HTTPException, UploadFile, File
from pydantic import BaseModel
from typing import List
import os
import shutil
import json
import uuid
from pathlib import Path

from ..logger import safe_print

router = APIRouter(prefix="/api/hostage", tags=["hostage"])

HOSTAGE_DIR = Path(__file__).parent.parent.parent / "hostage_evidence"
HOSTAGE_DIR.mkdir(parents=True, exist_ok=True)

METADATA_FILE = HOSTAGE_DIR / "metadata.json"
MAX_IMAGES = 30


class HostageImage(BaseModel):
    id: str
    filename: str
    selected: bool
    url: str


class HostageListResponse(BaseModel):
    images: List[HostageImage]
    total: int
    selected_count: int


def load_metadata() -> dict:
    """è¼‰å…¥åœ–ç‰‡ä¸­ç¹¼è³‡æ–™"""
    if METADATA_FILE.exists():
        with open(METADATA_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    return {}


def save_metadata(metadata: dict):
    """å„²å­˜åœ–ç‰‡ä¸­ç¹¼è³‡æ–™"""
    with open(METADATA_FILE, 'w', encoding='utf-8') as f:
        json.dump(metadata, f, ensure_ascii=False, indent=2)


def get_selected_images() -> List[str]:
    """å–å¾—å·²é¸å–çš„åœ–ç‰‡è·¯å¾‘åˆ—è¡¨"""
    metadata = load_metadata()
    selected = []
    for image_id, data in metadata.items():
        if data.get('selected', False):
            image_path = HOSTAGE_DIR / data['filename']
            if image_path.exists():
                selected.append(str(image_path))
    return selected


@router.get("/images", response_model=HostageListResponse)
async def list_images():
    """åˆ—å‡ºæ‰€æœ‰å·²ä¸Šå‚³çš„åœ–ç‰‡"""
    metadata = load_metadata()
    images = []
    selected_count = 0
    
    for image_id, data in metadata.items():
        image_path = HOSTAGE_DIR / data['filename']
        if image_path.exists():
            images.append(HostageImage(
                id=image_id,
                filename=data['filename'],
                selected=data.get('selected', False),
                url=f"/api/hostage/image/{image_id}"
            ))
            if data.get('selected', False):
                selected_count += 1
    
    return HostageListResponse(
        images=images,
        total=len(images),
        selected_count=selected_count
    )


@router.post("/upload")
async def upload_image(file: UploadFile = File(...)):
    """ä¸Šå‚³æ–°çš„äººè³ªç…§ç‰‡"""
    # æª¢æŸ¥æª”æ¡ˆé¡å‹
    if not file.content_type or not file.content_type.startswith('image/'):
        raise HTTPException(status_code=400, detail="åªèƒ½ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ")
    
    # æª¢æŸ¥æ•¸é‡é™åˆ¶
    metadata = load_metadata()
    if len(metadata) >= MAX_IMAGES:
        raise HTTPException(status_code=400, detail=f"æœ€å¤šåªèƒ½ä¸Šå‚³ {MAX_IMAGES} å¼µç…§ç‰‡")
    
    # ç”Ÿæˆå”¯ä¸€ ID å’Œæª”å
    image_id = str(uuid.uuid4())
    file_ext = Path(file.filename).suffix if file.filename else '.jpg'
    filename = f"{image_id}{file_ext}"
    file_path = HOSTAGE_DIR / filename
    
    # å„²å­˜æª”æ¡ˆ
    try:
        with open(file_path, "wb") as buffer:
            shutil.copyfileobj(file.file, buffer)
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"å„²å­˜æª”æ¡ˆå¤±æ•—: {str(e)}")
    
    # æ›´æ–°ä¸­ç¹¼è³‡æ–™ï¼ˆæ–°ä¸Šå‚³çš„é è¨­ç‚ºé¸å–ï¼‰
    metadata[image_id] = {
        'filename': filename,
        'original_name': file.filename,
        'selected': True
    }
    save_metadata(metadata)
    
    safe_print(f"[äººè³ªå”å®š] æ–°ç…§ç‰‡å·²ä¸Šå‚³: {filename} (ID: {image_id})")
    
    return {
        "success": True,
        "image_id": image_id,
        "filename": filename,
        "message": "ä¸Šå‚³æˆåŠŸ"
    }


@router.post("/toggle/{image_id}")
async def toggle_selection(image_id: str):
    """åˆ‡æ›åœ–ç‰‡çš„é¸å–ç‹€æ…‹"""
    metadata = load_metadata()
    
    if image_id not in metadata:
        raise HTTPException(status_code=404, detail="åœ–ç‰‡ä¸å­˜åœ¨")
    
    # åˆ‡æ›é¸å–ç‹€æ…‹
    metadata[image_id]['selected'] = not metadata[image_id].get('selected', False)
    save_metadata(metadata)
    
    return {
        "success": True,
        "image_id": image_id,
        "selected": metadata[image_id]['selected']
    }


@router.delete("/delete/{image_id}")
async def delete_image(image_id: str):
    """åˆªé™¤æŒ‡å®šçš„åœ–ç‰‡"""
    metadata = load_metadata()
    
    if image_id not in metadata:
        raise HTTPException(status_code=404, detail="åœ–ç‰‡ä¸å­˜åœ¨")
    
    # åˆªé™¤æª”æ¡ˆ
    image_path = HOSTAGE_DIR / metadata[image_id]['filename']
    if image_path.exists():
        try:
            os.remove(image_path)
        except Exception as e:
            raise HTTPException(status_code=500, detail=f"åˆªé™¤æª”æ¡ˆå¤±æ•—: {str(e)}")
    
    # å¾ä¸­ç¹¼è³‡æ–™ç§»é™¤
    del metadata[image_id]
    save_metadata(metadata)
    
    safe_print(f"[äººè³ªå”å®š] ç…§ç‰‡å·²åˆªé™¤: {image_id}")
    
    return {
        "success": True,
        "message": "åˆªé™¤æˆåŠŸ"
    }


@router.get("/image/{image_id}")
async def get_image(image_id: str):
    """å–å¾—åœ–ç‰‡æª”æ¡ˆ"""
    from fastapi.responses import FileResponse
    
    metadata = load_metadata()
    
    if image_id not in metadata:
        raise HTTPException(status_code=404, detail="åœ–ç‰‡ä¸å­˜åœ¨")
    
    image_path = HOSTAGE_DIR / metadata[image_id]['filename']
    
    if not image_path.exists():
        raise HTTPException(status_code=404, detail="åœ–ç‰‡æª”æ¡ˆä¸å­˜åœ¨")
    
    return FileResponse(image_path)


@router.get("/selected")
async def get_selected():
    """å–å¾—æ‰€æœ‰å·²é¸å–çš„åœ–ç‰‡åˆ—è¡¨ï¼ˆç”¨æ–¼è™•ç½°åŸ·è¡Œï¼‰"""
    selected = get_selected_images()
    
    return {
        "count": len(selected),
        "images": selected
    }
</file>

<file path="backend/app/routers/sessions.py">
from fastapi import APIRouter, HTTPException, UploadFile, File, Form
from pydantic import BaseModel
from typing import Optional
import os
import shutil
from pathlib import Path

from ..socket_manager import socket_manager
from ..models import SessionStatus
from ..logger import safe_print

router = APIRouter(prefix="/api/sessions", tags=["sessions"])

HOSTAGE_DIR = Path(__file__).parent.parent.parent / "hostage_evidence"
HOSTAGE_DIR.mkdir(parents=True, exist_ok=True)


class StartSessionRequest(BaseModel):
    duration_minutes: int = 25


class SessionResponse(BaseModel):
    success: bool
    message: str
    session_id: Optional[str] = None


def get_hostage_path() -> Path:
    """Get the path to the current hostage image."""
    return HOSTAGE_DIR / "hostage.jpg"


def save_hostage_image(file: UploadFile) -> str:
    """Save the uploaded hostage image and return its path."""
    hostage_path = get_hostage_path()
    with open(hostage_path, "wb") as buffer:
        shutil.copyfileobj(file.file, buffer)
    safe_print(f"[äººè³ªå”å®š] äººè³ªç…§ç‰‡å·²å„²å­˜: {hostage_path}")
    return str(hostage_path)


def delete_hostage_image():
    """Delete the hostage image after successful session completion."""
    hostage_path = get_hostage_path()
    if hostage_path.exists():
        os.remove(hostage_path)
        safe_print("[äººè³ªå”å®š] ä»»å‹™å®Œæˆï¼Œäººè³ªç…§ç‰‡å·²éŠ·æ¯€")


def get_hostage_image_if_exists() -> Optional[str]:
    """Return the hostage image path if it exists."""
    hostage_path = get_hostage_path()
    if hostage_path.exists():
        return str(hostage_path)
    return None


@router.post("/start", response_model=SessionResponse)
async def start_session(
    duration_minutes: int = Form(default=25),
    hostage_image: Optional[UploadFile] = File(default=None)
):
    """Start a new focus session with optional hostage image upload."""
    if socket_manager.state.session and socket_manager.state.session.status == SessionStatus.ACTIVE:
        raise HTTPException(status_code=400, detail="å°ˆæ³¨å”å®šåŸ·è¡Œä¸­ï¼Œç„¡æ³•å•Ÿå‹•æ–°ä»»å‹™")
    
    hostage_path = None
    if hostage_image and hostage_image.filename:
        hostage_path = save_hostage_image(hostage_image)
    
    await socket_manager.start_focus_session(duration_minutes, hostage_path)
    
    return SessionResponse(
        success=True,
        message=f"å°ˆæ³¨å”å®šå·²å•Ÿå‹•ï¼š{duration_minutes} åˆ†é˜",
        session_id=socket_manager.state.session.id if socket_manager.state.session else None
    )


@router.post("/stop", response_model=SessionResponse)
async def stop_session():
    """Stop the current focus session."""
    if not socket_manager.state.session:
        raise HTTPException(status_code=400, detail="ç„¡é€²è¡Œä¸­çš„å°ˆæ³¨å”å®š")
    
    session_completed = socket_manager.state.session.status != SessionStatus.VIOLATED
    await socket_manager.stop_focus_session()
    
    if session_completed:
        delete_hostage_image()
    
    return SessionResponse(
        success=True,
        message="å°ˆæ³¨å”å®šå·²çµ‚æ­¢" if session_completed else "å°ˆæ³¨å”å®šå·²ä¸­æ­¢ï¼ˆé•è¦ç‹€æ…‹ï¼‰"
    )


@router.post("/pause", response_model=SessionResponse)
async def pause_session():
    """Pause the current focus session (v1.0 new feature)."""
    if not socket_manager.state.session:
        raise HTTPException(status_code=400, detail="ç„¡é€²è¡Œä¸­çš„å°ˆæ³¨å”å®š")
    
    if socket_manager.state.session.status != SessionStatus.ACTIVE:
        raise HTTPException(status_code=400, detail="å°ˆæ³¨å”å®šä¸åœ¨åŸ·è¡Œç‹€æ…‹")
    
    await socket_manager.pause_focus_session()
    
    return SessionResponse(
        success=True,
        message="å°ˆæ³¨å”å®šå·²æš«åœ",
        session_id=socket_manager.state.session.id if socket_manager.state.session else None
    )


@router.post("/resume", response_model=SessionResponse)
async def resume_session():
    """Resume a paused focus session (v1.0 new feature)."""
    if not socket_manager.state.session:
        raise HTTPException(status_code=400, detail="ç„¡é€²è¡Œä¸­çš„å°ˆæ³¨å”å®š")
    
    if socket_manager.state.session.status != SessionStatus.PAUSED:
        raise HTTPException(status_code=400, detail="å°ˆæ³¨å”å®šä¸åœ¨æš«åœç‹€æ…‹")
    
    await socket_manager.resume_focus_session()
    
    return SessionResponse(
        success=True,
        message="å°ˆæ³¨å”å®šå·²æ¢å¾©",
        session_id=socket_manager.state.session.id if socket_manager.state.session else None
    )


@router.get("/current")
async def get_current_session():
    """Get the current session state."""
    return {
        "session": socket_manager.state.session.model_dump() if socket_manager.state.session else None,
        "phone_status": socket_manager.state.phone_status,
        "presence_status": socket_manager.state.presence_status,
        "current_db": socket_manager.state.current_db,
        "hardware_state": socket_manager.state.hardware_state.value,
        "hostage_uploaded": get_hostage_image_if_exists() is not None
    }


@router.get("/hostage-status")
async def get_hostage_status():
    """Check if a hostage image is currently uploaded."""
    hostage_path = get_hostage_image_if_exists()
    return {
        "has_hostage": hostage_path is not None,
        "message": "äººè³ªç…§ç‰‡å·²å°±ä½" if hostage_path else "å°šæœªä¸Šå‚³äººè³ªç…§ç‰‡"
    }
</file>

<file path="backend/app/routers/social.py">
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from typing import List

from ..models import SocialPlatform, PenaltySettings
from ..socket_manager import socket_manager
from ..automation.social_manager import social_manager
from ..credential_store import credential_store
from ..config import settings

router = APIRouter(prefix="/api/social", tags=["social"])


class PenaltySettingsRequest(BaseModel):
    enabled_platforms: List[str]
    custom_messages: dict
    gmail_recipients: List[str] = []
    include_timestamp: bool = True
    include_violation_count: bool = True


class TestPostRequest(BaseModel):
    platform: str
    message: str


class GmailCredentialsRequest(BaseModel):
    email: str
    app_password: str


class ThreadsCredentialsRequest(BaseModel):
    user_id: str
    access_token: str


class ThreadsBrowserLoginRequest(BaseModel):
    """Threads ç€è¦½å™¨ç™»å…¥è«‹æ±‚ï¼ˆç°¡åŒ–ç‰ˆï¼‰"""
    username: str
    password: str


class DiscordCredentialsRequest(BaseModel):
    webhook_url: str


@router.get("/settings")
async def get_penalty_settings():
    """Get current penalty settings."""
    return socket_manager.state.penalty_settings.model_dump()


@router.post("/settings")
async def update_penalty_settings(request: PenaltySettingsRequest):
    """Update penalty settings."""
    try:
        platforms = [SocialPlatform(p) for p in request.enabled_platforms]
        socket_manager.state.penalty_settings = PenaltySettings(
            enabled_platforms=platforms,
            custom_messages=request.custom_messages,
            gmail_recipients=request.gmail_recipients,
            include_timestamp=request.include_timestamp,
            include_violation_count=request.include_violation_count
        )
        await socket_manager.broadcast_state(force=True)
        return {"success": True, "message": "Settings updated"}
    except ValueError as e:
        raise HTTPException(status_code=400, detail=f"Invalid platform: {str(e)}")
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/login-status")
async def get_login_status():
    """Get login status for all platforms."""
    return social_manager.get_login_status()


@router.get("/login-status/{platform}")
async def get_platform_login_status(platform: str):
    """Get login status for a specific platform."""
    try:
        plat = SocialPlatform(platform)
        if plat == SocialPlatform.DISCORD:
            return {"platform": platform, "logged_in": bool(settings.DISCORD_WEBHOOK_URL)}
        is_logged_in = social_manager.is_platform_logged_in(plat)
        return {"platform": platform, "logged_in": is_logged_in}
    except ValueError:
        raise HTTPException(status_code=400, detail=f"Unknown platform: {platform}")


@router.post("/login/{platform}")
async def open_login(platform: str):
    """Open browser for manual login to a platform."""
    try:
        plat = SocialPlatform(platform)
        if plat == SocialPlatform.DISCORD:
            return {"success": True, "message": f"{platform} uses webhook URL configuration. Please enter credentials below"}
        return {"success": False, "message": f"{platform} uses direct integration. Please configure credentials in .env"}
    except ValueError:
        raise HTTPException(status_code=400, detail=f"Unknown platform: {platform}")
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Failed to open login page: {str(e)}")


@router.post("/save-session/{platform}")
async def save_platform_session(platform: str):
    """Save browser session after manual login."""
    try:
        plat = SocialPlatform(platform)
        if social_manager.is_platform_logged_in(plat):
             return {"success": True, "message": f"Integration active for {platform}", "logged_in": True}
        else:
             return {"success": False, "message": f"{platform} credentials not configured in .env"}
    except ValueError:
        raise HTTPException(status_code=400, detail=f"Unknown platform: {platform}")


@router.post("/logout/{platform}")
async def logout_platform(platform: str):
    """Logout from a platform (delete saved credentials)."""
    try:
        plat = SocialPlatform(platform)
        
        # Clear credentials based on platform
        if plat == SocialPlatform.GMAIL:
            credential_store.clear_gmail()
            settings.GMAIL_USER = None
            settings.GMAIL_APP_PASSWORD = None
        elif plat == SocialPlatform.THREADS:
            credential_store.clear_threads()
            settings.THREADS_USER_ID = None
            settings.THREADS_ACCESS_TOKEN = None
        elif plat == SocialPlatform.DISCORD:
            credential_store.clear_discord()
            settings.DISCORD_WEBHOOK_URL = None
        
        return {"success": True, "message": f"Successfully logged out from {platform}", "logged_in": False}
    except ValueError:
        raise HTTPException(status_code=400, detail=f"Unknown platform: {platform}")


@router.post("/test-post")
async def test_post(request: TestPostRequest):
    """Test posting to a platform."""
    try:
        platform = SocialPlatform(request.platform)
        success = False
        
        # Get hostage image if exists (might be used for threads)
        from .sessions import get_hostage_image_if_exists
        hostage_path = get_hostage_image_if_exists()
        
        if platform == SocialPlatform.DISCORD:
            success = await social_manager.post_to_discord(request.message)
        elif platform == SocialPlatform.THREADS:
            success = await social_manager.post_to_threads(request.message, hostage_path)
        elif platform == SocialPlatform.GMAIL:
            # Get recipients from current penalty settings
            recipients = socket_manager.state.penalty_settings.gmail_recipients
            success = await social_manager.send_shame_email(request.message, recipients)
        
        return {"success": success, "platform": request.platform, "hostage_used": hostage_path}
    except Exception as e:
        import traceback
        traceback.print_exc()
        raise HTTPException(status_code=500, detail=str(e))


# ========== æ†‘è­‰ç®¡ç† API ==========

@router.post("/credentials/gmail")
async def set_gmail_credentials(request: GmailCredentialsRequest):
    """è¨­å®š Gmail æ†‘è­‰"""
    try:
        # å„²å­˜åˆ°æ†‘è­‰å„²å­˜
        credential_store.update_gmail(request.email, request.app_password)
        
        # æ›´æ–°åŸ·è¡Œæ™‚è¨­å®š
        settings.GMAIL_USER = request.email
        settings.GMAIL_APP_PASSWORD = request.app_password
        
        return {
            "success": True,
            "message": "Gmail æ†‘è­‰å·²è¨­å®š",
            "logged_in": True
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"è¨­å®š Gmail æ†‘è­‰å¤±æ•—: {str(e)}")


@router.post("/credentials/threads")
async def set_threads_credentials(request: ThreadsCredentialsRequest):
    """è¨­å®š Threads API æ†‘è­‰ï¼ˆé€²éšç‰ˆï¼‰"""
    try:
        # å„²å­˜åˆ°æ†‘è­‰å„²å­˜
        credential_store.update_threads(request.user_id, request.access_token)
        
        # æ›´æ–°åŸ·è¡Œæ™‚è¨­å®š
        settings.THREADS_USER_ID = request.user_id
        settings.THREADS_ACCESS_TOKEN = request.access_token
        
        return {
            "success": True,
            "message": "Threads API æ†‘è­‰å·²è¨­å®š",
            "logged_in": True
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"è¨­å®š Threads æ†‘è­‰å¤±æ•—: {str(e)}")


@router.post("/credentials/threads/browser")
async def login_threads_browser(request: ThreadsBrowserLoginRequest):
    """ä½¿ç”¨å¸³è™Ÿå¯†ç¢¼ç™»å…¥ Threadsï¼ˆç°¡åŒ–ç‰ˆï¼‰"""
    try:
        success = await social_manager.login_threads_browser(
            request.username,
            request.password
        )
        
        if success:
            # å»£æ’­ç‹€æ…‹æ›´æ–°
            await socket_manager.broadcast_state(force=True)
            
            return {
                "success": True,
                "message": "Threads ç™»å…¥æˆåŠŸï¼",
                "logged_in": True
            }
        else:
            raise HTTPException(
                status_code=400, 
                detail="ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼æ˜¯å¦æ­£ç¢º"
            )
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"Threads ç™»å…¥éŒ¯èª¤: {str(e)}")


@router.post("/credentials/discord")
async def set_discord_credentials(request: DiscordCredentialsRequest):
    """è¨­å®š Discord Webhook URL"""
    try:
        # å„²å­˜åˆ°æ†‘è­‰å„²å­˜
        credential_store.update_discord(request.webhook_url)
        
        # æ›´æ–°åŸ·è¡Œæ™‚è¨­å®š
        settings.DISCORD_WEBHOOK_URL = request.webhook_url
        
        return {
            "success": True,
            "message": "Discord Webhook å·²è¨­å®š",
            "logged_in": True
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"è¨­å®š Discord Webhook å¤±æ•—: {str(e)}")


@router.get("/credentials/{platform}")
async def get_credentials_status(platform: str):
    """å–å¾—å¹³å°æ†‘è­‰ç‹€æ…‹ï¼ˆä¸è¿”å›å¯¦éš›æ†‘è­‰ï¼‰"""
    try:
        plat = SocialPlatform(platform)
        is_configured = social_manager.is_platform_logged_in(plat)
        
        # è¿”å›éƒ¨åˆ†è³‡è¨Šï¼ˆä¸è¿”å›å®Œæ•´æ†‘è­‰ï¼‰
        info = {"configured": is_configured}
        
        if plat == SocialPlatform.GMAIL and is_configured:
            info["email"] = settings.GMAIL_USER
        elif plat == SocialPlatform.THREADS and is_configured:
            info["user_id"] = settings.THREADS_USER_ID
        elif plat == SocialPlatform.DISCORD and is_configured:
            info["webhook_configured"] = True
        
        return info
    except ValueError:
        raise HTTPException(status_code=400, detail=f"Unknown platform: {platform}")
</file>

<file path="backend/credentials.example.json">
{
  "gmail_user": "your-email@gmail.com",
  "gmail_app_password": "your-app-password",
  "threads_user_id": null,
  "threads_access_token": null,
  "discord_webhook_url": null
}
</file>

<file path="backend/requirements.txt">
# FastAPI & Server
fastapi==0.109.0
uvicorn[standard]==0.27.0
python-socketio==5.11.0
python-multipart==0.0.6

# WebSocket & Async
aiohttp>=3.9.0
websockets>=12.0

# Email Integration (Gmail)
aiosmtplib>=3.0.0

# HTTP Client (for Threads API)
httpx>=0.26.0

# Browser Automation (for Threads web posting)
playwright>=1.40.0
playwright-stealth>=0.1.0

# Utilities
python-dotenv>=1.0.0
pydantic>=2.5.0
pydantic-settings>=2.1.0
</file>

<file path="backend/run.py">
"""
Startup script for The Focus Enforcer backend
Sets Windows event loop policy before starting uvicorn
"""
import sys
import asyncio
import os

# Safe print function for startup
def safe_print(*args, **kwargs):
    try:
        print(*args, **kwargs)
        sys.stdout.flush()
    except (OSError, IOError, BrokenPipeError):
        pass

# CRITICAL: Set event loop policy BEFORE any async operations
if sys.platform == 'win32':
    asyncio.set_event_loop_policy(asyncio.WindowsProactorEventLoopPolicy())
    # Also set environment variable so child processes inherit this
    os.environ['PYTHONASYNCIODEBUG'] = '0'

if __name__ == "__main__":
    import uvicorn
    from app.config import settings
    
    safe_print("=" * 65)
    safe_print(f"Starting {settings.APP_NAME}")
    safe_print(f"Host: {settings.HOST}:{settings.PORT}")
    safe_print(f"Debug Mode: {settings.DEBUG}")
    safe_print(f"Mock Hardware: {settings.MOCK_HARDWARE}")
    safe_print("=" * 65)
    
    # Use --reload-dir to avoid watching unnecessary files
    uvicorn.run(
        "app.main:app",
        host=settings.HOST,
        port=settings.PORT,
        reload=settings.DEBUG,
        reload_dirs=["./app"] if settings.DEBUG else None,
        loop="asyncio",
        # Use single process mode to avoid subprocess issues
        workers=1,
        # Log configuration
        log_level="info" if not settings.DEBUG else "debug",
        access_log=True
    )
</file>

<file path="Check-GitSecurity.ps1">
# Git Security Check Script
# Scans repository for sensitive files and potential security issues

Write-Host "======================================" -ForegroundColor Cyan
Write-Host "  Git Sensitive Data Check Tool" -ForegroundColor Cyan
Write-Host "======================================" -ForegroundColor Cyan
Write-Host ""

# Check if in git repository
if (-not (Test-Path ".git")) {
    Write-Host "[X] Not in a Git repository!" -ForegroundColor Red
    exit 1
}

# Define sensitive file patterns
$sensitivePatterns = @(
    "credentials.json",
    "*.key",
    "*.pem",
    "*.env",
    ".env.local",
    "*password*",
    "*secret*",
    "*token*",
    "browser_contexts/*",
    "hostage_evidence/*"
)

$issues = 0

# 1. Check .gitignore
Write-Host "[1] Checking .gitignore..." -ForegroundColor Yellow
if (Test-Path ".gitignore") {
    Write-Host "   [OK] .gitignore exists" -ForegroundColor Green
    
    $gitignoreContent = Get-Content ".gitignore" -Raw
    $requiredPatterns = @(
        "credentials.json",
        "browser_contexts",
        "hostage_evidence",
        ".env",
        "*.key",
        "*.pem"
    )
    
    $missing = @()
    foreach ($pattern in $requiredPatterns) {
        if ($gitignoreContent -notmatch [regex]::Escape($pattern)) {
            $missing += $pattern
        }
    }
    
    if ($missing.Count -gt 0) {
        Write-Host "   [!] Missing sensitive patterns:" -ForegroundColor Yellow
        $missing | ForEach-Object { Write-Host "     - $_" -ForegroundColor Yellow }
        $issues++
    } else {
        Write-Host "   [OK] Sensitive patterns configured" -ForegroundColor Green
    }
} else {
    Write-Host "   [X] .gitignore does not exist!" -ForegroundColor Red
    $issues++
}

Write-Host ""

# 2. Check staged files
Write-Host "[2] Checking Staged Files..." -ForegroundColor Yellow
$stagedFiles = git diff --cached --name-only

if ($stagedFiles) {
    $dangerousStaged = @()
    foreach ($file in $stagedFiles) {
        foreach ($pattern in $sensitivePatterns) {
            if ($file -like $pattern -or $file -match $pattern.Replace('*', '.*')) {
                $dangerousStaged += $file
                break
            }
        }
    }
    
    if ($dangerousStaged.Count -gt 0) {
        Write-Host "   [X] Found sensitive files in staging area:" -ForegroundColor Red
        $dangerousStaged | ForEach-Object { Write-Host "     - $_" -ForegroundColor Red }
        $issues++
    } else {
        Write-Host "   [OK] Staged files are safe" -ForegroundColor Green
    }
} else {
    Write-Host "   [i] No staged files" -ForegroundColor Cyan
}

Write-Host ""

# 3. Check tracked sensitive files
Write-Host "[3] Checking Repository for Sensitive Files..." -ForegroundColor Yellow
$allTrackedFiles = git ls-files

$trackedSensitive = @()
foreach ($file in $allTrackedFiles) {
    foreach ($pattern in $sensitivePatterns) {
        if ($file -like $pattern -or $file -match $pattern.Replace('*', '.*')) {
            $trackedSensitive += $file
            break
        }
    }
}

if ($trackedSensitive.Count -gt 0) {
    Write-Host "   [X] Found sensitive files in repository:" -ForegroundColor Red
    $trackedSensitive | ForEach-Object { Write-Host "     - $_" -ForegroundColor Red }
    Write-Host ""
    Write-Host "   Recommended action:" -ForegroundColor Yellow
    $trackedSensitive | ForEach-Object { 
        Write-Host "     git rm --cached `"$_`"" -ForegroundColor Yellow 
    }
    $issues++
} else {
    Write-Host "   [OK] No sensitive files in repository" -ForegroundColor Green
}

Write-Host ""

# 4. List protected files
Write-Host "[4] Checking Protected Files..." -ForegroundColor Yellow
$protectedFiles = @(
    "backend/credentials.json",
    "backend/browser_contexts/",
    "backend/hostage_evidence/",
    ".env",
    ".env.local"
)

$existingProtected = @()
foreach ($file in $protectedFiles) {
    if (Test-Path $file) {
        $existingProtected += $file
    }
}

if ($existingProtected.Count -gt 0) {
    Write-Host "   [i] Sensitive files exist and are protected:" -ForegroundColor Cyan
    $existingProtected | ForEach-Object { Write-Host "     - $_" -ForegroundColor Cyan }
} else {
    Write-Host "   [i] No local sensitive files found" -ForegroundColor Cyan
}

Write-Host ""
Write-Host "======================================" -ForegroundColor Cyan

# Summary
if ($issues -eq 0) {
    Write-Host "[OK] Check complete: No security issues found" -ForegroundColor Green
} else {
    Write-Host "[X] Found $issues security issue(s), please fix before pushing" -ForegroundColor Red
    exit 1
}

Write-Host ""
</file>

<file path="Check-Health.ps1">
# Focus Enforcer - Health Check Script
# This script checks if all services are running correctly

Write-Host ""
Write-Host "============================================" -ForegroundColor Cyan
Write-Host "  Focus Enforcer - Health Check" -ForegroundColor Cyan
Write-Host "============================================" -ForegroundColor Cyan
Write-Host ""

$AllHealthy = $true

# Check Backend
Write-Host "[1/2] Checking Backend Server..." -ForegroundColor Yellow
try {
    $BackendResponse = Invoke-WebRequest -Uri "http://localhost:8000/api/hardware/status" -Method GET -TimeoutSec 5 -ErrorAction Stop
    if ($BackendResponse.StatusCode -eq 200) {
        Write-Host "      âœ“ Backend is running (Port 8000)" -ForegroundColor Green
        
        # Parse response to check status
        $BackendData = $BackendResponse.Content | ConvertFrom-Json
        Write-Host "      - Mock Mode: $($BackendData.mock_mode)" -ForegroundColor Gray
        Write-Host "      - Connected Clients: $($BackendData.connected_clients)" -ForegroundColor Gray
    }
} catch {
    Write-Host "      âœ— Backend is NOT running or not responding" -ForegroundColor Red
    Write-Host "        Expected URL: http://localhost:8000" -ForegroundColor Gray
    $AllHealthy = $false
}

# Check Frontend
Write-Host "[2/2] Checking Frontend Server..." -ForegroundColor Yellow
try {
    $FrontendResponse = Invoke-WebRequest -Uri "http://localhost:5173" -Method GET -TimeoutSec 5 -ErrorAction Stop
    if ($FrontendResponse.StatusCode -eq 200) {
        Write-Host "      âœ“ Frontend is running (Port 5173)" -ForegroundColor Green
    }
} catch {
    Write-Host "      âœ— Frontend is NOT running or not responding" -ForegroundColor Red
    Write-Host "        Expected URL: http://localhost:5173" -ForegroundColor Gray
    $AllHealthy = $false
}

# Check Ports
Write-Host ""
Write-Host "Port Status:" -ForegroundColor Yellow
$Ports = @(8000, 5173)
foreach ($Port in $Ports) {
    $Connection = Get-NetTCPConnection -LocalPort $Port -ErrorAction SilentlyContinue
    if ($Connection) {
        $Process = Get-Process -Id $Connection.OwningProcess -ErrorAction SilentlyContinue
        if ($Process) {
            Write-Host "  Port $Port`: In use by $($Process.ProcessName) (PID: $($Process.Id))" -ForegroundColor Gray
        } else {
            Write-Host "  Port $Port`: In use" -ForegroundColor Gray
        }
    } else {
        Write-Host "  Port $Port`: Available (not in use)" -ForegroundColor Yellow
    }
}

Write-Host ""
Write-Host "============================================" -ForegroundColor $(if ($AllHealthy) { "Green" } else { "Red" })
if ($AllHealthy) {
    Write-Host "  All Services Running âœ“" -ForegroundColor Green
    Write-Host "============================================" -ForegroundColor Green
    Write-Host ""
    Write-Host "Access URLs:" -ForegroundColor White
    Write-Host "  Frontend: http://localhost:5173" -ForegroundColor Cyan
    Write-Host "  Backend:  http://localhost:8000" -ForegroundColor Cyan
    Write-Host "  API Docs: http://localhost:8000/docs" -ForegroundColor Cyan
} else {
    Write-Host "  Some Services Not Running âœ—" -ForegroundColor Red
    Write-Host "============================================" -ForegroundColor Red
    Write-Host ""
    Write-Host "To start services, run:" -ForegroundColor Yellow
    Write-Host "  .\Start-FocusEnforcer.ps1" -ForegroundColor White
}
Write-Host ""
</file>

<file path="frontend/index.html">
<!DOCTYPE html>
<html lang="zh-TW" class="dark">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å°ˆæ³¨åŸ·æ³•è€… v3.2 | é›¶ä¿¡ä»»ç›£æ§ç³»çµ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700;900&family=Orbitron:wght@400;500;600;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
</file>

<file path="frontend/package.json">
{
  "name": "focus-enforcer-dashboard",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "preview": "vite preview"
  },
  "dependencies": {
    "@radix-ui/react-checkbox": "^1.0.4",
    "@radix-ui/react-dialog": "^1.0.5",
    "@radix-ui/react-label": "^2.0.2",
    "@radix-ui/react-progress": "^1.0.3",
    "@radix-ui/react-select": "^2.0.0",
    "@radix-ui/react-separator": "^1.0.3",
    "@radix-ui/react-slider": "^1.1.2",
    "@radix-ui/react-slot": "^1.0.2",
    "@radix-ui/react-switch": "^1.0.3",
    "@radix-ui/react-tabs": "^1.0.4",
    "@radix-ui/react-toast": "^1.1.5",
    "@radix-ui/react-tooltip": "^1.0.7",
    "@types/react-router-dom": "^5.3.3",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.0",
    "gsap": "^3.14.2",
    "lucide-react": "^0.312.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^7.11.0",
    "recharts": "^2.10.4",
    "socket.io-client": "^4.7.4",
    "tailwind-merge": "^2.2.0",
    "tailwindcss-animate": "^1.0.7"
  },
  "devDependencies": {
    "@types/node": "^20.11.5",
    "@types/react": "^18.2.48",
    "@types/react-dom": "^18.2.18",
    "@typescript-eslint/eslint-plugin": "^6.19.0",
    "@typescript-eslint/parser": "^6.19.0",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.17",
    "eslint": "^8.56.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.5",
    "postcss": "^8.4.33",
    "tailwindcss": "^3.4.1",
    "typescript": "^5.3.3",
    "vite": "^5.0.12"
  }
}
</file>

<file path="frontend/postcss.config.js">
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
</file>

<file path="frontend/public/sounds/README.md">
# éŸ³æ•ˆæª”æ¡ˆ (Sound Effects)

è«‹å°‡ä»¥ä¸‹éŸ³æ•ˆæª”æ¡ˆæ”¾ç½®æ–¼æ­¤ç›®éŒ„ï¼š

| æª”æ¡ˆåç¨± | ç”¨é€” | å»ºè­°é¢¨æ ¼ |
|---------|------|---------|
| `start.mp3` | å°ˆæ³¨å”å®šå•Ÿå‹•æ™‚æ’­æ”¾ | ç§‘å¹»å•Ÿå‹•/é›»æºé–‹å•ŸéŸ³æ•ˆ |
| `warning.mp3` | é•è¦è­¦å‘Šå€åŸŸæ™‚æ’­æ”¾ | é›·é”å—¶è²/è­¦å ±è² |
| `penalty.mp3` | æ‡²ç½°åŸ·è¡Œæ™‚æ’­æ”¾ | æ•…éšœ/å¤±æ•—éŸ³æ•ˆ |
| `complete.mp3` | ä»»å‹™å®Œæˆæ™‚æ’­æ”¾ | æˆåŠŸ/è§£é–éŸ³æ•ˆ |

## æ¨è–¦éŸ³æ•ˆä¾†æº

- [Freesound.org](https://freesound.org/) - å…è²»éŸ³æ•ˆåº«
- [Pixabay](https://pixabay.com/sound-effects/) - å…è²»éŸ³æ•ˆ
- [Zapsplat](https://www.zapsplat.com/) - å…è²»éŸ³æ•ˆï¼ˆéœ€è¨»å†Šï¼‰

## éŸ³æ•ˆé¢¨æ ¼å»ºè­°

ç‚ºäº†ç¬¦åˆè³½åšé¾å…‹ä¸»é¡Œï¼Œå»ºè­°é¸æ“‡ï¼š
- é›»å­/åˆæˆå™¨é¢¨æ ¼
- ç§‘å¹»/æœªä¾†æ„Ÿ
- æ•…éšœè—è¡“ (Glitch) é¢¨æ ¼
</file>

<file path="frontend/public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
  <defs>
    <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#ff0040;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#00ff88;stop-opacity:1" />
    </linearGradient>
  </defs>
  <polygon points="50,5 95,50 50,95 5,50" fill="none" stroke="url(#grad)" stroke-width="4"/>
  <circle cx="50" cy="50" r="15" fill="url(#grad)"/>
  <text x="50" y="56" text-anchor="middle" fill="white" font-size="14" font-family="monospace" font-weight="bold">FE</text>
</svg>
</file>

<file path="frontend/src/App.tsx">
import { Dashboard } from '@/components/Dashboard/DashboardPage'
import { CustomCursor } from '@/components/Landing/CustomCursor'
import { SmoothScroll } from '@/components/ui/SmoothScroll'
import { BrowserRouter, Routes, Route } from 'react-router-dom'

function App() {
  return (
    <>
      <SmoothScroll />
      <CustomCursor />
      <BrowserRouter>
        <Routes>
          <Route path="/" element={<Dashboard />} />
        </Routes>
      </BrowserRouter>
    </>
  )
}

export default App
</file>

<file path="frontend/src/components/Dashboard/Header.tsx">
import { Switch } from '@/components/ui/switch'
import { Label } from '@/components/ui/label'
import { MagneticButton } from '@/components/Landing/MagneticButton'
import { Cpu, Zap, Shield, Loader2 } from 'lucide-react'
import { useState, useEffect } from 'react'

interface HeaderProps {
  connected: boolean
  hardwareConnected: boolean
  isMock: boolean
  mockModeLoading?: boolean
  onToggleMock: (enabled: boolean) => void
}

export function Header({ connected, hardwareConnected, isMock, mockModeLoading, onToggleMock }: HeaderProps) {
  // Optimistic UI state - show intended state while loading
  const [optimisticMockState, setOptimisticMockState] = useState(isMock)
  
  // Update optimistic state when actual state changes
  useEffect(() => {
    if (!mockModeLoading) {
      setOptimisticMockState(isMock)
    }
  }, [isMock, mockModeLoading])
  
  const handleToggle = (enabled: boolean) => {
    setOptimisticMockState(enabled)
    onToggleMock(enabled)
  }
  
  return (
    <header className="glass border-b border-white/10 sticky top-0 z-50 backdrop-blur-xl animate-slide-down">
      <div className="container mx-auto px-4 py-4">
        <div className="flex items-center justify-between">
          {/* Logo & Title */}
          <MagneticButton 
            as="div" 
            className="flex items-center gap-4 group"
            strength={0.3}
          >
            <div className="relative hover-lift transition-all duration-500">
              <Shield className="w-10 h-10 text-neon-red group-hover:scale-110 transition-all duration-500" />
              <Zap className="w-4 h-4 text-neon-green absolute -bottom-1 -right-1 animate-pulse-glow" />
            </div>
            <div>
              <h1 className="text-2xl font-semibold tracking-tight">
                <span className="text-neon-red transition-all duration-300">å°ˆæ³¨</span>
                <span className="text-white transition-all duration-300">åŸ·æ³•è€…</span>
              </h1>
              <p className="hidden sm:block text-xs text-mac-textSecondary font-medium transition-all duration-300">
                é›¶ä¿¡ä»»ç›£æ§ç³»çµ± v1.0
              </p>
            </div>
          </MagneticButton>

          {/* Status & Controls */}
          <div className="flex items-center gap-3 sm:gap-6">
            {/* Connection Status */}
            <MagneticButton 
              as="div"
              className="flex items-center gap-2 px-3 py-1.5 rounded-lg glass-light transition-all duration-300 hover:bg-white/10"
              strength={0.25}
            >
              <div className={`w-2 h-2 rounded-full transition-all duration-500 ${
                connected ? 'bg-neon-green animate-pulse-glow shadow-glow-green' : 'bg-neon-red shadow-glow-red'
              }`} />
              <span className="hidden sm:inline text-xs text-mac-textSecondary font-medium">
                {connected ? 'é€šè¨Šé€£ç·šä¸­' : 'é€šè¨Šä¸­æ–·'}
              </span>
            </MagneticButton>

            {/* Mock Hardware Toggle */}
            <MagneticButton
              as="div"
              className={`flex items-center gap-2 sm:gap-3 px-2 sm:px-3 py-1.5 rounded-lg glass-light border transition-all duration-300 ${
                mockModeLoading 
                  ? 'border-neon-yellow/50 bg-neon-yellow/10' 
                  : 'border-white/10 hover:border-white/20 hover:bg-white/5'
              }`}
              strength={0.3}
            >
              {mockModeLoading ? (
                <Loader2 className="w-3.5 h-3.5 text-neon-yellow animate-spin" />
              ) : (
                <Cpu className={`w-3.5 h-3.5 transition-all duration-500 ${
                  hardwareConnected ? 'text-neon-green' : 'text-mac-textSecondary'
                }`} />
              )}
              <Label className={`hidden sm:inline text-xs cursor-pointer font-medium ${
                mockModeLoading ? 'text-neon-yellow' : 'text-white'
              }`}>
                {mockModeLoading ? 'æº–å‚™ä¸­...' : 'æ¨¡æ“¬ç¡¬é«”'}
              </Label>
              <Switch 
                checked={optimisticMockState}
                onCheckedChange={handleToggle}
                disabled={mockModeLoading}
                className="scale-75"
              />
            </MagneticButton>
          </div>
        </div>
      </div>
    </header>
  )
}
</file>

<file path="frontend/src/components/Dashboard/HostageManager.tsx">
import { useState, useRef, useCallback, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs'
import { Checkbox } from '@/components/ui/checkbox'
import { ImageIcon, Upload, AlertTriangle, Shield, Trash2, Check } from 'lucide-react'

interface HostageImage {
  id: string
  filename: string
  selected: boolean
  url?: string
}

interface HostageManagerProps {
  disabled?: boolean
  sessionActive?: boolean
  onUploadComplete?: (files: string[]) => void
}

export function HostageManager({ disabled, sessionActive, onUploadComplete }: HostageManagerProps) {
  const [dragActive, setDragActive] = useState(false)
  const [images, setImages] = useState<HostageImage[]>([])
  const [uploading, setUploading] = useState(false)
  const inputRef = useRef<HTMLInputElement>(null)

  // å¾å¾Œç«¯è¼‰å…¥å·²ä¸Šå‚³çš„åœ–ç‰‡åˆ—è¡¨
  useEffect(() => {
    fetchImages()
  }, [])

  const fetchImages = async () => {
    try {
      const response = await fetch('/api/hostage/images')
      if (response.ok) {
        const data = await response.json()
        setImages(data.images || [])
      }
    } catch (error) {
      console.error('[äººè³ªç®¡ç†] è¼‰å…¥åœ–ç‰‡åˆ—è¡¨å¤±æ•—:', error)
    }
  }

  const handleFiles = useCallback(async (files: FileList) => {
    const validFiles = Array.from(files).filter(file => file.type.startsWith('image/'))
    
    if (validFiles.length === 0) {
      alert('è«‹ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ')
      return
    }

    // æª¢æŸ¥æ˜¯å¦è¶…é 30 å¼µ
    if (images.length + validFiles.length > 30) {
      alert(`æœ€å¤šåªèƒ½ä¸Šå‚³ 30 å¼µç…§ç‰‡ï¼ˆç›®å‰å·²æœ‰ ${images.length} å¼µï¼‰`)
      return
    }

    setUploading(true)

    try {
      for (const file of validFiles) {
        const formData = new FormData()
        formData.append('file', file)

        const response = await fetch('/api/hostage/upload', {
          method: 'POST',
          body: formData,
        })

        if (!response.ok) {
          throw new Error(`ä¸Šå‚³å¤±æ•—: ${file.name}`)
        }
      }

      // é‡æ–°è¼‰å…¥åœ–ç‰‡åˆ—è¡¨
      await fetchImages()
    } catch (error) {
      console.error('[äººè³ªç®¡ç†] ä¸Šå‚³å¤±æ•—:', error)
      alert('éƒ¨åˆ†åœ–ç‰‡ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦')
    } finally {
      setUploading(false)
      if (inputRef.current) {
        inputRef.current.value = ''
      }
    }
  }, [images.length])

  const handleDrag = useCallback((e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
    if (e.type === 'dragenter' || e.type === 'dragover') {
      setDragActive(true)
    } else if (e.type === 'dragleave') {
      setDragActive(false)
    }
  }, [])

  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
    setDragActive(false)
    
    if (e.dataTransfer.files) {
      handleFiles(e.dataTransfer.files)
    }
  }, [handleFiles])

  const handleChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      handleFiles(e.target.files)
    }
  }, [handleFiles])

  const toggleSelection = async (imageId: string) => {
    try {
      const response = await fetch(`/api/hostage/toggle/${imageId}`, {
        method: 'POST',
      })

      if (response.ok) {
        setImages(prev => prev.map(img => 
          img.id === imageId ? { ...img, selected: !img.selected } : img
        ))
      }
    } catch (error) {
      console.error('[äººè³ªç®¡ç†] åˆ‡æ›é¸å–å¤±æ•—:', error)
    }
  }

  const deleteImage = async (imageId: string) => {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ')) return

    try {
      const response = await fetch(`/api/hostage/delete/${imageId}`, {
        method: 'DELETE',
      })

      if (response.ok) {
        setImages(prev => prev.filter(img => img.id !== imageId))
      }
    } catch (error) {
      console.error('[äººè³ªç®¡ç†] åˆªé™¤å¤±æ•—:', error)
    }
  }

  const selectedCount = images.filter(img => img.selected).length

  return (
    <Card className="mac-card p-5 border-2 border-neon-purple/30">
      <CardHeader className="p-0 mb-4">
        <CardTitle className="flex items-center gap-2 text-neon-purple text-sm font-semibold">
          <Shield className="w-4 h-4" />
          <span className="uppercase tracking-wide">äººè³ªå”å®š</span>
        </CardTitle>
        <p className="text-xs text-mac-textSecondary mt-1">
          ä¸Šå‚³å°·å°¬ç…§ç‰‡ä½œç‚ºäººè³ªï¼Œé•è¦æ™‚å°‡éš¨æ©Ÿå…¬é–‹è™•åˆ‘
        </p>
      </CardHeader>

      <CardContent className="p-0">
        <Tabs defaultValue="upload" className="w-full">
          <TabsList className="grid w-full grid-cols-2 bg-cyber-gray/50">
            <TabsTrigger value="upload" className="text-xs">
              ğŸ“¤ ä¸Šå‚³ç…§ç‰‡
            </TabsTrigger>
            <TabsTrigger value="manage" className="text-xs">
              ğŸ—‚ï¸ ç®¡ç†ç…§ç‰‡ ({images.length}/30)
            </TabsTrigger>
          </TabsList>

          {/* ä¸Šå‚³ Tab */}
          <TabsContent value="upload" className="mt-4">
            <div
              className={`relative border-2 border-dashed rounded-xl p-6 transition-all cursor-pointer
                ${dragActive 
                  ? 'border-neon-purple bg-neon-purple/10 scale-105' 
                  : 'border-white/20 hover:border-neon-purple/50 hover:bg-white/5'
                }
                ${disabled || uploading ? 'opacity-50 cursor-not-allowed' : ''}
              `}
              onDragEnter={handleDrag}
              onDragLeave={handleDrag}
              onDragOver={handleDrag}
              onDrop={handleDrop}
              onClick={() => !disabled && !uploading && inputRef.current?.click()}
            >
              <input
                ref={inputRef}
                type="file"
                accept="image/*"
                multiple
                onChange={handleChange}
                className="hidden"
                disabled={disabled || uploading}
              />
              <div className="flex flex-col items-center gap-3 text-center">
                <div className="w-14 h-14 rounded-full glass-light flex items-center justify-center">
                  <Upload className="w-7 h-7 text-mac-textSecondary" />
                </div>
                <div>
                  <p className="text-sm font-medium text-white mb-1">
                    {uploading ? 'ä¸Šå‚³ä¸­...' : 'æ‹–æ”¾æˆ–é»æ“Šä¸Šå‚³äººè³ªç…§ç‰‡'}
                  </p>
                  <p className="text-xs text-mac-textSecondary">
                    æ”¯æ´ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤š 30 å¼µ
                  </p>
                  <p className="text-xs text-neon-purple mt-2">
                    ç›®å‰å·²ä¸Šå‚³ï¼š{images.length}/30 å¼µ
                  </p>
                </div>
              </div>
            </div>

            {images.length > 0 && (
              <div className="mt-4 p-3 rounded-lg bg-neon-red/10 border border-neon-red/30">
                <div className="flex items-center gap-2">
                  <AlertTriangle className="w-4 h-4 text-neon-red flex-shrink-0" />
                  <div className="text-xs">
                    <p className="text-neon-red font-medium">
                      å·²é¸å– {selectedCount} å¼µç…§ç‰‡ç”¨æ–¼è™•ç½°
                    </p>
                    <p className="text-neon-red/70 mt-0.5">
                      é•è¦æ™‚å°‡å¾é¸å–çš„ç…§ç‰‡ä¸­éš¨æ©Ÿé¸æ“‡ä¸€å¼µå…¬é–‹
                    </p>
                  </div>
                </div>
              </div>
            )}
          </TabsContent>

          {/* ç®¡ç† Tab */}
          <TabsContent value="manage" className="mt-4">
            {images.length === 0 ? (
              <div className="text-center py-8 text-muted-foreground">
                <ImageIcon className="w-12 h-12 mx-auto mb-3 opacity-50" />
                <p className="text-sm">å°šæœªä¸Šå‚³ä»»ä½•ç…§ç‰‡</p>
                <p className="text-xs mt-1">è«‹åˆ‡æ›åˆ°ã€Œä¸Šå‚³ç…§ç‰‡ã€é é¢</p>
              </div>
            ) : (
              <div className="space-y-4">
                <div className="flex items-center justify-between text-xs">
                  <span className="text-muted-foreground">
                    å·²é¸å– {selectedCount} / {images.length} å¼µç…§ç‰‡
                  </span>
                  <span className="text-neon-purple">
                    è™•ç½°æ™‚éš¨æ©Ÿä½¿ç”¨é¸å–çš„ç…§ç‰‡
                  </span>
                </div>

                <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-96 overflow-y-auto">
                  {images.map((image) => (
                    <div
                      key={image.id}
                      className={`relative group rounded-lg overflow-hidden border-2 transition-all ${
                        image.selected
                          ? 'border-neon-red shadow-glow-red'
                          : 'border-border hover:border-neon-purple/50'
                      }`}
                    >
                      {/* åœ–ç‰‡é è¦½ */}
                      <div className="aspect-square bg-cyber-gray/50 relative">
                        {image.url ? (
                          <img
                            src={image.url}
                            alt={image.filename}
                            className="w-full h-full object-cover"
                          />
                        ) : (
                          <div className="w-full h-full flex items-center justify-center">
                            <ImageIcon className="w-8 h-8 text-muted-foreground" />
                          </div>
                        )}
                        
                        {/* é¸å–æ¨™è¨˜ */}
                        {image.selected && (
                          <div className="absolute top-2 right-2 w-6 h-6 rounded-full bg-neon-red flex items-center justify-center">
                            <Check className="w-4 h-4 text-white" />
                          </div>
                        )}

                        {/* æ‡¸åœæ™‚é¡¯ç¤ºæ“ä½œæŒ‰éˆ• */}
                        <div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                          <Button
                            size="sm"
                            variant={image.selected ? "default" : "outline"}
                            className="h-8 px-3 text-xs"
                            onClick={() => toggleSelection(image.id)}
                          >
                            {image.selected ? 'å·²é¸å–' : 'é¸å–'}
                          </Button>
                          <Button
                            size="sm"
                            variant="outline"
                            className="h-8 w-8 p-0 text-red-400 hover:bg-red-400/20"
                            onClick={() => deleteImage(image.id)}
                          >
                            <Trash2 className="w-4 h-4" />
                          </Button>
                        </div>
                      </div>

                      {/* æª”å */}
                      <div className="p-2 bg-cyber-darker/80">
                        <p className="text-xs text-white truncate" title={image.filename}>
                          {image.filename}
                        </p>
                      </div>

                      {/* å¿«é€Ÿé¸å–checkbox */}
                      <div className="absolute top-2 left-2">
                        <div
                          className="w-5 h-5 rounded bg-black/50 backdrop-blur-sm flex items-center justify-center cursor-pointer hover:bg-black/70 transition-colors"
                          onClick={(e) => {
                            e.stopPropagation()
                            toggleSelection(image.id)
                          }}
                        >
                          <Checkbox
                            checked={image.selected}
                            onCheckedChange={() => toggleSelection(image.id)}
                            className="w-3.5 h-3.5"
                          />
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                <div className="mt-4 p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/30">
                  <p className="text-xs text-yellow-300">
                    ğŸ’¡ æç¤ºï¼šè«‹è‡³å°‘é¸å–ä¸€å¼µç…§ç‰‡ï¼Œé•è¦æ™‚ç³»çµ±æœƒå¾é¸å–çš„ç…§ç‰‡ä¸­éš¨æ©ŸæŒ‘é¸
                  </p>
                </div>
              </div>
            )}
          </TabsContent>
        </Tabs>

        <p className="mt-4 text-xs text-mac-textSecondary/60 text-center">
          ï¼ˆå¯é¸ï¼‰ä¸ä¸Šå‚³ç…§ç‰‡å°‡åƒ…ç™¼å¸ƒæ–‡å­—æ‡²ç½°
        </p>
      </CardContent>
    </Card>
  )
}
</file>

<file path="frontend/src/components/Dashboard/HostageUpload.tsx">
import { useState, useRef, useCallback } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { ImageIcon, Upload, X, AlertTriangle, Shield } from 'lucide-react'

interface HostageUploadProps {
  onFileSelect: (file: File | null) => void
  selectedFile: File | null
  disabled?: boolean
}

export function HostageUpload({ onFileSelect, selectedFile, disabled }: HostageUploadProps) {
  const [dragActive, setDragActive] = useState(false)
  const [previewUrl, setPreviewUrl] = useState<string | null>(null)
  const inputRef = useRef<HTMLInputElement>(null)

  const handleFile = useCallback((file: File | null) => {
    if (file) {
      if (!file.type.startsWith('image/')) {
        alert('è«‹ä¸Šå‚³åœ–ç‰‡æª”æ¡ˆ')
        return
      }
      const url = URL.createObjectURL(file)
      setPreviewUrl(url)
      onFileSelect(file)
    } else {
      if (previewUrl) {
        URL.revokeObjectURL(previewUrl)
      }
      setPreviewUrl(null)
      onFileSelect(null)
    }
  }, [onFileSelect, previewUrl])

  const handleDrag = useCallback((e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
    if (e.type === 'dragenter' || e.type === 'dragover') {
      setDragActive(true)
    } else if (e.type === 'dragleave') {
      setDragActive(false)
    }
  }, [])

  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault()
    e.stopPropagation()
    setDragActive(false)
    
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      handleFile(e.dataTransfer.files[0])
    }
  }, [handleFile])

  const handleChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      handleFile(e.target.files[0])
    }
  }, [handleFile])

  const clearFile = useCallback(() => {
    handleFile(null)
    if (inputRef.current) {
      inputRef.current.value = ''
    }
  }, [handleFile])

  return (
    <div className={`mac-card p-5 border-2 ${dragActive ? 'border-neon-purple/50 glow-blue' : 'border-neon-purple/30'} interactive`}>
      <div className="mb-4">
        <h3 className="flex items-center gap-2 text-neon-purple text-sm font-semibold mb-1">
          <Shield className="w-4 h-4" />
          <span className="uppercase tracking-wide">äººè³ªå”å®š</span>
        </h3>
        <p className="text-xs text-mac-textSecondary">
          ä¸Šå‚³ä¸€å¼µå°·å°¬ç…§ç‰‡ä½œç‚ºäººè³ªï¼Œé•è¦æ™‚å°‡è¢«å…¬é–‹è™•åˆ‘
        </p>
      </div>
      
      <div>
        {!selectedFile ? (
          <div
            className={`relative border-2 border-dashed rounded-xl p-6 transition-all cursor-pointer
              ${dragActive 
                ? 'border-neon-purple bg-neon-purple/10 scale-105' 
                : 'border-white/20 hover:border-neon-purple/50 hover:bg-white/5'
              }
              ${disabled ? 'opacity-50 cursor-not-allowed' : ''}
            `}
            onDragEnter={handleDrag}
            onDragLeave={handleDrag}
            onDragOver={handleDrag}
            onDrop={handleDrop}
            onClick={() => !disabled && inputRef.current?.click()}
          >
            <input
              ref={inputRef}
              type="file"
              accept="image/*"
              onChange={handleChange}
              className="hidden"
              disabled={disabled}
            />
            <div className="flex flex-col items-center gap-3 text-center">
              <div className="w-14 h-14 rounded-full glass-light flex items-center justify-center">
                <Upload className="w-7 h-7 text-mac-textSecondary" />
              </div>
              <div>
                <p className="text-sm font-medium text-white mb-1">
                  æ‹–æ”¾æˆ–é»æ“Šä¸Šå‚³äººè³ªç…§ç‰‡
                </p>
                <p className="text-xs text-mac-textSecondary">
                  æ”¯æ´ JPGã€PNGã€GIF æ ¼å¼
                </p>
              </div>
            </div>
          </div>
        ) : (
          <div className="relative animate-scale-in">
            <div className="relative rounded-xl overflow-hidden border-2 border-neon-red/50 shadow-glow-red">
              {previewUrl && (
                <img 
                  src={previewUrl} 
                  alt="äººè³ªé è¦½" 
                  className="w-full h-36 object-cover"
                />
              )}
              <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent" />
              <div className="absolute bottom-3 left-3 right-3 flex items-center justify-between">
                <div className="flex items-center gap-2 flex-1 min-w-0">
                  <ImageIcon className="w-4 h-4 text-neon-red flex-shrink-0" />
                  <span className="text-xs text-white font-medium truncate">
                    {selectedFile.name}
                  </span>
                </div>
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={clearFile}
                  disabled={disabled}
                  className="h-7 w-7 p-0 hover:bg-neon-red/20 rounded-lg flex-shrink-0 ml-2"
                >
                  <X className="w-4 h-4 text-neon-red" />
                </Button>
              </div>
            </div>
            <div className="mt-3 flex items-center gap-2 px-3 py-2 rounded-lg bg-neon-red/10 border border-neon-red/30">
              <AlertTriangle className="w-4 h-4 text-neon-red flex-shrink-0" />
              <span className="text-xs text-neon-red font-medium">
                äººè³ªå·²å°±ä½ï¼Œé•è¦æ™‚å°‡è¢«å…¬é–‹
              </span>
            </div>
          </div>
        )}

        <p className="mt-4 text-xs text-mac-textSecondary/60 text-center">
          ï¼ˆå¯é¸ï¼‰ä¸ä¸Šå‚³ç…§ç‰‡å°‡åƒ…ç™¼å¸ƒæ–‡å­—æ‡²ç½°
        </p>
      </div>
    </div>
  )
}
</file>

<file path="frontend/src/components/Dashboard/PenaltyProgress.tsx">
import { useEffect, useState } from 'react'
import { CheckCircle2, Circle, Loader2 } from 'lucide-react'

interface PenaltyStep {
  id: string
  label: string
  status: 'pending' | 'in-progress' | 'completed' | 'error'
}

interface PenaltyProgressProps {
  isExecuting: boolean
  currentStep?: string
}

export function PenaltyProgress({ isExecuting, currentStep }: PenaltyProgressProps) {
  const [steps, setSteps] = useState<PenaltyStep[]>([
    { id: 'auth', label: 'æ­£åœ¨ç™»å…¥å¸³è™Ÿ', status: 'pending' },
    { id: 'prepare', label: 'æº–å‚™æ‡²ç½°å…§å®¹', status: 'pending' },
    { id: 'upload_image', label: 'ä¸Šå‚³äººè³ªç…§ç‰‡', status: 'pending' },
    { id: 'post', label: 'ç™¼å¸ƒç¾è¾±è²¼æ–‡', status: 'pending' },
    { id: 'email', label: 'ç™¼é€é“æ­‰éƒµä»¶', status: 'pending' },
    { id: 'complete', label: 'åŸ·è¡Œå®Œæˆ', status: 'pending' },
  ])

  useEffect(() => {
    if (!isExecuting) {
      // Reset all steps when not executing
      setSteps(prev => prev.map(step => ({ ...step, status: 'pending' })))
      return
    }

    // Update step status based on currentStep
    setSteps(prev => {
      const currentIndex = prev.findIndex(s => s.id === currentStep)
      return prev.map((step, index) => {
        if (index < currentIndex) {
          return { ...step, status: 'completed' }
        } else if (index === currentIndex) {
          return { ...step, status: 'in-progress' }
        } else {
          return { ...step, status: 'pending' }
        }
      })
    })
  }, [isExecuting, currentStep])

  if (!isExecuting) return null

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-md">
      <div className="glass rounded-3xl p-8 max-w-md w-full shadow-mac-lg animate-scale-in">
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-neon-red/20 mb-4 animate-pulse-glow">
            <Loader2 className="w-8 h-8 text-neon-red animate-spin" />
          </div>
          <h2 className="text-2xl font-semibold text-white mb-2">æ‡²ç½°å”å®šåŸ·è¡Œä¸­</h2>
          <p className="text-mac-textSecondary text-sm">
            æ­£åœ¨åŸ·è¡Œç¤¾äº¤ç¾è¾±åˆ¶è£...
          </p>
        </div>

        <div className="space-y-4">
          {steps.map((step, index) => (
            <div
              key={step.id}
              className={`flex items-center gap-3 p-3 rounded-xl transition-all duration-300 ${
                step.status === 'in-progress'
                  ? 'bg-mac-accent/10 scale-105'
                  : step.status === 'completed'
                  ? 'bg-neon-green/10'
                  : 'bg-white/5'
              }`}
            >
              <div className="flex-shrink-0">
                {step.status === 'completed' && (
                  <CheckCircle2 className="w-6 h-6 text-neon-green animate-scale-in" />
                )}
                {step.status === 'in-progress' && (
                  <Loader2 className="w-6 h-6 text-mac-accent animate-spin" />
                )}
                {step.status === 'pending' && (
                  <Circle className="w-6 h-6 text-mac-textSecondary/30" />
                )}
                {step.status === 'error' && (
                  <Circle className="w-6 h-6 text-neon-red" />
                )}
              </div>

              <div className="flex-1 min-w-0">
                <p
                  className={`text-sm font-medium transition-colors ${
                    step.status === 'in-progress'
                      ? 'text-mac-accent'
                      : step.status === 'completed'
                      ? 'text-neon-green'
                      : step.status === 'error'
                      ? 'text-neon-red'
                      : 'text-mac-textSecondary'
                  }`}
                >
                  {step.label}
                </p>
              </div>

              <div className="flex-shrink-0">
                <span className="text-xs text-mac-textSecondary">
                  {step.status === 'completed' && 'âœ“'}
                  {step.status === 'in-progress' && `${index + 1}/${steps.length}`}
                </span>
              </div>
            </div>
          ))}
        </div>

        <div className="mt-6 pt-6 border-t border-white/10">
          <div className="flex items-center justify-between text-xs text-mac-textSecondary">
            <span>æ‡²ç½°åŸ·è¡Œé€²åº¦</span>
            <span>
              {steps.filter(s => s.status === 'completed').length} / {steps.length}
            </span>
          </div>
          <div className="mt-2 h-1.5 bg-white/10 rounded-full overflow-hidden">
            <div
              className="h-full bg-gradient-to-r from-neon-red to-mac-accent transition-all duration-500 ease-out"
              style={{
                width: `${(steps.filter(s => s.status === 'completed').length / steps.length) * 100}%`,
              }}
            />
          </div>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="frontend/src/components/Dashboard/SensorChart.tsx">
import { 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  ResponsiveContainer,
  Area,
  AreaChart
} from 'recharts'
import { Activity } from 'lucide-react'
import React from 'react'

interface SensorData {
  mic_db: number
  timestamp: number
  nfc_detected?: boolean
  ldr_detected?: boolean
  box_open?: boolean
}

interface SensorChartProps {
  data: SensorData[]
  nfcDetected?: boolean
  ldrDetected?: boolean
  hardwareConnected?: boolean
}

export function SensorChart({ data, nfcDetected = false, ldrDetected = false, hardwareConnected = false }: SensorChartProps) {
  const [displayData, setDisplayData] = React.useState(data);
  const [isUpdating, setIsUpdating] = React.useState(false);
  const updateTimerRef = React.useRef<NodeJS.Timeout | null>(null);

  React.useEffect(() => {
    // Clear any pending update
    if (updateTimerRef.current) {
      clearTimeout(updateTimerRef.current);
    }

    // Skip update if hardware is disconnected
    if (!hardwareConnected) {
      return;
    }

    // Only update if data has actually changed
    const dataChanged = data.length !== displayData.length || 
      (data.length > 0 && displayData.length > 0 && 
       data[data.length - 1]?.timestamp !== displayData[displayData.length - 1]?.timestamp);
    
    if (dataChanged) {
      setIsUpdating(true);
      
      // Debounce the update to prevent rapid flickering
      updateTimerRef.current = setTimeout(() => {
        setDisplayData(data);
        setIsUpdating(false);
      }, 100);
    }

    return () => {
      if (updateTimerRef.current) {
        clearTimeout(updateTimerRef.current);
      }
    };
  }, [data, hardwareConnected]);

  // Only compute chart data when hardware is connected
  const chartData = React.useMemo(() => {
    if (!hardwareConnected) return [];
    
    return displayData.map((d, i) => ({
      index: i,
      db: d.mic_db,
      time: new Date(d.timestamp).toLocaleTimeString()
    }));
  }, [displayData, hardwareConnected]);

  // Determine sensor connection states
  const micConnected = hardwareConnected; // Microphone is part of the main board

  return (
    <div className="mac-card p-5 interactive hover-lift animate-fade-in">
      <div className="mb-4">
        <h3 className="text-sm font-semibold text-white flex items-center gap-2 uppercase tracking-wide">
          <Activity className={`w-4 h-4 text-neon-green transition-all duration-300 ${isUpdating ? 'animate-bounce-subtle' : ''}`} />
          å³æ™‚æ„Ÿæ¸¬å™¨æ•¸æ“š
        </h3>
      </div>
      
      <div className="grid grid-cols-1 gap-6">
        {/* Noise Level Chart */}
        <div className="transition-opacity duration-500" style={{ opacity: isUpdating ? 0.7 : 1 }}>
          <div className="flex items-center justify-between mb-3">
            <p className="text-xs text-mac-textSecondary font-medium">ç’°å¢ƒå™ªéŸ³ (dB)</p>
            {!micConnected && (
              <span className="text-xs text-gray-400 flex items-center gap-1">
                <span className="w-2 h-2 rounded-full bg-gray-500"></span>
                æœªé€£æ¥
              </span>
            )}
          </div>
          <div className={`h-32 glass-light rounded-xl p-2 transition-all duration-500 ${!micConnected ? 'opacity-50 bg-gray-900/20' : ''}`}>
            {!micConnected ? (
              <div className="h-full flex items-center justify-center">
                <p className="text-sm text-gray-400">éº¥å…‹é¢¨æ„Ÿæ¸¬å™¨æœªé€£æ¥</p>
              </div>
            ) : (
              <ResponsiveContainer width="100%" height="100%">
                <AreaChart data={chartData}>
                  <defs>
                    <linearGradient id="noiseGradient" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#ff9f0a" stopOpacity={0.4}/>
                      <stop offset="95%" stopColor="#ff9f0a" stopOpacity={0}/>
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" />
                  <XAxis 
                    dataKey="index" 
                    tick={false}
                    stroke="rgba(255,255,255,0.1)"
                  />
                  <YAxis 
                    stroke="rgba(255,255,255,0.1)"
                    tick={{ fill: '#a0a0a0', fontSize: 10 }}
                    domain={[30, 100]}
                  />
                  <Tooltip 
                    contentStyle={{ 
                      background: 'rgba(45, 45, 45, 0.95)', 
                      border: '1px solid rgba(255, 159, 10, 0.5)',
                      borderRadius: '12px',
                      backdropFilter: 'blur(10px)'
                    }}
                    labelStyle={{ color: '#ff9f0a' }}
                    formatter={(value: number) => [`${value} dB`, 'å™ªéŸ³']}
                  />
                  <Area 
                    type="monotone" 
                    dataKey="db" 
                    stroke="#ff9f0a" 
                    fill="url(#noiseGradient)"
                    strokeWidth={2}
                    animationDuration={600}
                    animationEasing="ease-out"
                  />
                </AreaChart>
              </ResponsiveContainer>
            )}
          </div>
        </div>
      </div>
    </div>
  )
}
</file>

<file path="frontend/src/components/Dashboard/SocialSettings.tsx">
import { useState, useEffect, useCallback } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Checkbox } from '@/components/ui/checkbox'
import { Textarea } from '@/components/ui/textarea'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Switch } from '@/components/ui/switch'
import { Badge } from '@/components/ui/badge'
import { Tabs, TabsList, TabsTrigger, TabsContent } from '@/components/ui/tabs'
import { Skull, Save, LogIn, KeyRound, LogOut, CheckCircle, XCircle, AlertCircle, X, ChevronDown, ChevronUp, HelpCircle } from 'lucide-react'

interface PenaltySettings {
  enabled_platforms: string[]
  custom_messages: Record<string, string>
  gmail_recipients: string[]
  include_timestamp: boolean
  include_violation_count: boolean
}

interface SocialSettingsProps {
  settings: PenaltySettings
  onSave: (settings: PenaltySettings) => void
}

const PLATFORMS = [
  { id: 'discord', name: 'Discord', icon: 'ğŸ®', color: 'text-indigo-400', description: 'Webhook è¨Šæ¯' },
  { id: 'gmail', name: 'Gmail', icon: 'ğŸ“§', color: 'text-red-400', description: 'é›»å­éƒµä»¶' },
]

const DEFAULT_MESSAGES: Record<string, string> = {
  discord: 'ğŸš¨ è­¦å ±ï¼šæˆ‘é•åäº†å°ˆæ³¨å”å®šï¼Œå‰›æ‰çš„å°ˆæ³¨æŒ‘æˆ°å¤±æ•—äº†ã€‚è«‹å¤§å®¶ç›£ç£æˆ‘æ”¹é€²ï¼ ğŸš¨',
  threads: 'ğŸ“¢ ç³»çµ±å…¬å‘Šï¼šæˆ‘æœªèƒ½å®Œæˆå°ˆæ³¨ä»»å‹™ï¼Œé•åäº†è‡ªå¾‹å”å®šã€‚æˆ‘æœƒç¹¼çºŒåŠªåŠ›æ”¹é€²ã€‚',
  gmail: 'ğŸ“§ å°ˆæ³¨åŸ·æ³•è€…é€šå ±ï¼šæˆ‘æœªèƒ½å®Œæˆå°ˆæ³¨ä»»å‹™ï¼Œå°‡åŠ å¼·è‡ªæˆ‘ç®¡ç†ã€‚'
}

export function SocialSettings({ settings, onSave }: SocialSettingsProps) {
  const [localSettings, setLocalSettings] = useState<PenaltySettings>(settings)
  const [hasChanges, setHasChanges] = useState(false)
  const [loginLoading, setLoginLoading] = useState<string | null>(null)
  const [loginStatus, setLoginStatus] = useState<Record<string, boolean>>({})
  const [loginError, setLoginError] = useState<string | null>(null)
  const [newRecipient, setNewRecipient] = useState<string>('')
  const [expandedGuide, setExpandedGuide] = useState<string | null>(null)
  
  // ç™»å…¥è¡¨å–®ç‹€æ…‹
  const [showLoginForm, setShowLoginForm] = useState<string | null>(null)
  const [gmailForm, setGmailForm] = useState({ email: '', appPassword: '' })
  const [threadsForm, setThreadsForm] = useState({ userId: '', accessToken: '' })
  const [threadsBrowserForm, setThreadsBrowserForm] = useState({ username: '', password: '' })
  const [threadsLoginMode, setThreadsLoginMode] = useState<'simple' | 'advanced'>('advanced')
  const [discordForm, setDiscordForm] = useState({ webhookUrl: '' })

  // Fetch login status for all platforms
  const fetchLoginStatus = useCallback(async () => {
    try {
      const response = await fetch('/api/social/login-status')
      if (response.ok) {
        const status = await response.json()
        setLoginStatus(status)
      }
    } catch (error) {
      console.error('[ç¤¾äº¤ç™»å…¥] ç„¡æ³•ç²å–ç™»å…¥ç‹€æ…‹:', error)
    }
  }, [])

  // Fetch login status on mount and periodically
  useEffect(() => {
    fetchLoginStatus()
    const interval = setInterval(fetchLoginStatus, 10000) // Refresh every 10 seconds
    return () => clearInterval(interval)
  }, [fetchLoginStatus])

  // é–‹å•Ÿç¤¾ç¾¤å¹³å°ç™»å…¥é é¢
  const handleLogin = async (platformId: string) => {
    // æ”¹ç‚ºé¡¯ç¤ºç™»å…¥è¡¨å–®è€Œéé–‹å•Ÿå¤–éƒ¨é é¢
    setShowLoginForm(platformId)
    // åŒæ™‚å±•é–‹æ•™å­¸æŒ‡å—ï¼Œè®“ä½¿ç”¨è€…å¯ä»¥åŒæ™‚çœ‹åˆ°èªªæ˜å’Œè¼¸å…¥æ¬„ä½
    setExpandedGuide(platformId)
    setLoginError(null)
  }

  // æäº¤ç™»å…¥æ†‘è­‰
  const handleSubmitCredentials = async (platformId: string) => {
    setLoginLoading(platformId)
    setLoginError(null)
    
    try {
      let response
      
      if (platformId === 'gmail') {
        if (!gmailForm.email || !gmailForm.appPassword) {
          setLoginError('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½')
          setLoginLoading(null)
          return
        }
        response = await fetch('/api/social/credentials/gmail', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: gmailForm.email,
            app_password: gmailForm.appPassword
          })
        })
      } else if (platformId === 'threads') {
        if (threadsLoginMode === 'simple') {
          // ç°¡å–®æ¨¡å¼ï¼šä½¿ç”¨å¸³è™Ÿå¯†ç¢¼
          if (!threadsBrowserForm.username || !threadsBrowserForm.password) {
            setLoginError('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½')
            setLoginLoading(null)
            return
          }
          response = await fetch('/api/social/credentials/threads/browser', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              username: threadsBrowserForm.username,
              password: threadsBrowserForm.password
            })
          })
        } else {
          // é€²éšæ¨¡å¼ï¼šä½¿ç”¨ API token
          if (!threadsForm.userId || !threadsForm.accessToken) {
            setLoginError('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½')
            setLoginLoading(null)
            return
          }
          response = await fetch('/api/social/credentials/threads', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_id: threadsForm.userId,
              access_token: threadsForm.accessToken
            })
          })
        }
      } else if (platformId === 'discord') {
        if (!discordForm.webhookUrl) {
          setLoginError('è«‹å¡«å¯« Webhook URL')
          setLoginLoading(null)
          return
        }
        response = await fetch('/api/social/credentials/discord', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            webhook_url: discordForm.webhookUrl
          })
        })
      }
      
      if (response && response.ok) {
        console.log(`[ç¤¾äº¤ç™»å…¥] ${platformId} æ†‘è­‰å·²è¨­å®š`)
        
        // Add delay to allow socket state to update
        await new Promise(resolve => setTimeout(resolve, 1000))
        
        setLoginStatus(prev => ({ ...prev, [platformId]: true }))
        setShowLoginForm(null)
        setExpandedGuide(null) // é—œé–‰æ•™å­¸æŒ‡å—
        
        // Clear form
        if (platformId === 'gmail') setGmailForm({ email: '', appPassword: '' })
        if (platformId === 'threads') {
          setThreadsForm({ userId: '', accessToken: '' })
          setThreadsBrowserForm({ username: '', password: '' })
        }
        if (platformId === 'discord') setDiscordForm({ webhookUrl: '' })
        
        // Refresh login status with retry
        let retries = 3
        while (retries > 0) {
          try {
            await fetchLoginStatus()
            break
          } catch (error) {
            retries--
            if (retries === 0) {
              console.error(`[ç¤¾äº¤ç™»å…¥] ç²å–ç‹€æ…‹å¤±æ•—:`, error)
            } else {
              await new Promise(resolve => setTimeout(resolve, 1000))
            }
          }
        }
      } else {
        const data = await response?.json()
        setLoginError(data?.detail || data?.message || 'è¨­å®šæ†‘è­‰å¤±æ•—')
      }
    } catch (error) {
      setLoginError(`ç¶²è·¯éŒ¯èª¤: ${error}`)
      console.error(`[ç¤¾äº¤ç™»å…¥] éŒ¯èª¤:`, error)
    } finally {
      setLoginLoading(null)
    }
  }

  // ç™»å‡ºå¹³å°
  const handleLogout = async (platformId: string) => {
    setLoginLoading(`logout-${platformId}`)
    try {
      const response = await fetch(`/api/social/logout/${platformId}`, {
        method: 'POST',
      })
      const data = await response.json()
      if (response.ok && data.success) {
        console.log(`[ç¤¾äº¤ç™»å…¥] å·²ç™»å‡º ${platformId}`)
        setLoginStatus(prev => ({ ...prev, [platformId]: false }))
        // Remove from enabled platforms if logged out
        if (localSettings.enabled_platforms.includes(platformId)) {
          setLocalSettings(prev => ({
            ...prev,
            enabled_platforms: prev.enabled_platforms.filter(p => p !== platformId)
          }))
          setHasChanges(true)
        }
      }
    } catch (error) {
      console.error(`[ç¤¾äº¤ç™»å…¥] ç™»å‡ºéŒ¯èª¤:`, error)
    } finally {
      setLoginLoading(null)
    }
  }

  useEffect(() => {
    // åªåœ¨ä½¿ç”¨è€…æ²’æœ‰æœªå„²å­˜è®Šæ›´æ™‚ï¼Œæ‰åŒæ­¥å¾Œç«¯è¨­å®š
    // é¿å… WebSocket é »ç¹æ›´æ–°è¦†è“‹ä½¿ç”¨è€…çš„æœ¬åœ°ä¿®æ”¹
    if (!hasChanges && settings) {
      setLocalSettings(settings)
    }
  }, [settings, hasChanges])

  const handlePlatformToggle = (platformId: string, checked: boolean) => {
    // Prevent enabling if not logged in
    if (checked && !loginStatus[platformId]) {
      setLoginError(`è«‹å…ˆç™»å…¥ ${platformId} æ‰èƒ½å•Ÿç”¨æ­¤å¹³å°`)
      return
    }
    
    const newPlatforms = checked 
      ? [...localSettings.enabled_platforms, platformId]
      : localSettings.enabled_platforms.filter(p => p !== platformId)
    
    setLocalSettings(prev => ({ ...prev, enabled_platforms: newPlatforms }))
    setHasChanges(true)
    setLoginError(null)
  }

  const handleMessageChange = (platform: string, message: string) => {
    setLocalSettings(prev => ({
      ...prev,
      custom_messages: { ...prev.custom_messages, [platform]: message }
    }))
    setHasChanges(true)
  }

  const handleSave = () => {
    onSave(localSettings)
    setHasChanges(false)
  }

  const handleAddRecipient = () => {
    if (newRecipient && newRecipient.includes('@')) {
      setLocalSettings(prev => ({
        ...prev,
        gmail_recipients: [...(prev.gmail_recipients || []), newRecipient]
      }))
      setNewRecipient('')
      setHasChanges(true)
    }
  }

  const handleRemoveRecipient = (email: string) => {
    setLocalSettings(prev => ({
      ...prev,
      gmail_recipients: (prev.gmail_recipients || []).filter(e => e !== email)
    }))
    setHasChanges(true)
  }

  const getPlatformById = (id: string) => {
    return PLATFORMS.find(p => p.id === id)
  }

  const renderGuideContent = (platformId: string) => {
    if (platformId === 'gmail') {
      return (
        <div className="space-y-3 text-xs text-muted-foreground">
          <div>
            <p className="font-semibold text-white mb-1">ğŸ“§ å¦‚ä½•å–å¾— Gmail æ‡‰ç”¨ç¨‹å¼å¯†ç¢¼ï¼š</p>
            <ol className="list-decimal list-inside space-y-1 ml-2">
              <li>å‰å¾€ <a href="https://myaccount.google.com/" target="_blank" rel="noopener noreferrer" className="text-neon-blue hover:underline">Google å¸³æˆ¶</a></li>
              <li>é»æ“Šã€Œå®‰å…¨æ€§ã€â†’ã€Œå…©æ­¥é©Ÿé©—è­‰ã€ï¼ˆéœ€å…ˆå•Ÿç”¨ï¼‰</li>
              <li>ä¸‹æ»¾è‡³ã€Œæ‡‰ç”¨ç¨‹å¼å¯†ç¢¼ã€</li>
              <li>é¸æ“‡ã€Œéƒµä»¶ã€å’Œã€Œå…¶ä»–è£ç½®ã€</li>
              <li>è¼¸å…¥è‡ªè¨‚åç¨±ï¼ˆå¦‚ï¼šIoTå°ˆæ³¨ç³»çµ±ï¼‰</li>
              <li>è¤‡è£½ç”¢ç”Ÿçš„ 16 ä½å¯†ç¢¼</li>
            </ol>
          </div>
          <div className="p-2 bg-yellow-500/10 border border-yellow-500/30 rounded">
            <p className="text-yellow-300">ğŸ’¡ æç¤ºï¼šæ‡‰ç”¨ç¨‹å¼å¯†ç¢¼åªæœƒé¡¯ç¤ºä¸€æ¬¡ï¼Œè«‹å¦¥å–„ä¿å­˜</p>
          </div>
        </div>
      )
    } else if (platformId === 'threads') {
      return (
        <div className="space-y-3 text-xs text-muted-foreground">
          <div>
            <p className="font-semibold text-white mb-1">ğŸ”§ é€²éšæ¨¡å¼ - å®˜æ–¹ APIï¼ˆæ¨è–¦ï¼‰ï¼š</p>
            <ol className="list-decimal list-inside space-y-1 ml-2">
              <li>å‰å¾€ <a href="https://developers.facebook.com/" target="_blank" rel="noopener noreferrer" className="text-neon-blue hover:underline">Meta for Developers</a></li>
              <li>å»ºç«‹æ‡‰ç”¨ç¨‹å¼ï¼ˆé¡å‹é¸æ“‡ã€Œå•†æ¥­ã€ï¼‰</li>
              <li>åœ¨æ‡‰ç”¨ç¨‹å¼ä¸­æ–°å¢ã€ŒThreadsã€ç”¢å“</li>
              <li>å‰å¾€ã€ŒThreads APIã€â†’ã€Œé–‹å§‹ä½¿ç”¨ã€</li>
              <li>å–å¾— User ID å’Œ Access Token</li>
              <li>å°‡å…©è€…è²¼å…¥ä¸‹æ–¹æ¬„ä½</li>
            </ol>
          </div>
          <div className="p-2 bg-green-500/10 border border-green-500/30 rounded">
            <p className="text-green-300">âœ… å„ªé»ï¼š100% å®‰å…¨ï¼Œä¸æœƒè¢«å°é–ï¼Œé•·æœŸç©©å®š</p>
          </div>
          <div className="border-t border-border/30 pt-3 mt-3">
            <p className="font-semibold text-white mb-1">âš ï¸ ç°¡å–®æ¨¡å¼ - å¸³è™Ÿå¯†ç¢¼ï¼ˆæœ‰é¢¨éšªï¼‰ï¼š</p>
            <p className="text-red-300">ä½¿ç”¨ Instagram/Threads å¸³è™Ÿå¯†ç¢¼ç™»å…¥ï¼Œå¯èƒ½è¢«åµæ¸¬ç‚ºæ©Ÿå™¨äººè¡Œç‚ºï¼Œå»ºè­°åƒ…ç”¨æ–¼æ¸¬è©¦ã€‚</p>
          </div>
        </div>
      )
    } else if (platformId === 'discord') {
      return (
        <div className="space-y-3 text-xs text-muted-foreground">
          <div>
            <p className="font-semibold text-white mb-1">ğŸ® å¦‚ä½•å–å¾— Discord Webhook URLï¼š</p>
            <ol className="list-decimal list-inside space-y-1 ml-2">
              <li>é–‹å•Ÿ Discordï¼Œå‰å¾€æ‚¨è¦ç™¼é€è¨Šæ¯çš„é »é“</li>
              <li>é»æ“Šé »é“è¨­å®šï¼ˆé½’è¼ªåœ–ç¤ºï¼‰â†’ã€Œæ•´åˆã€</li>
              <li>é»æ“Šã€Œå»ºç«‹ Webhookã€æˆ–é¸æ“‡ç¾æœ‰ Webhook</li>
              <li>è‡ªè¨‚ Webhook åç¨±å’Œé ­åƒï¼ˆå¯é¸ï¼‰</li>
              <li>é»æ“Šã€Œè¤‡è£½ Webhook URLã€</li>
              <li>å°‡ URL è²¼å…¥ä¸‹æ–¹æ¬„ä½</li>
            </ol>
          </div>
          <div className="p-2 bg-blue-500/10 border border-blue-500/30 rounded">
            <p className="text-blue-300">ğŸ’¡ æç¤ºï¼šWebhook URL æ ¼å¼ç‚º https://discord.com/api/webhooks/...</p>
          </div>
        </div>
      )
    }
    return null
  }


  const renderPlatformCard = (platform: typeof PLATFORMS[0]) => {
    const isLoggedIn = loginStatus[platform.id] || false
    const isEnabled = localSettings.enabled_platforms.includes(platform.id)
    const showForm = showLoginForm === platform.id
    
    return (
      <div 
        key={platform.id}
        className={`p-4 rounded-lg border transition-all ${
          isEnabled
            ? 'border-border bg-cyber-gray/50'
            : isLoggedIn 
              ? 'border-border bg-cyber-gray/50 hover:border-muted-foreground'
              : 'border-yellow-500/50 bg-yellow-500/5'
        }`}
      >
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center gap-2">
            <span className="text-xl">{platform.icon}</span>
            <div>
              <span className={`text-base font-medium ${platform.color} block`}>
                {platform.name}
              </span>
              <span className="text-xs text-muted-foreground">{platform.description}</span>
            </div>
          </div>
          <Badge 
            variant={isLoggedIn ? "default" : "secondary"}
            className={`text-xs px-2 py-1 ${
              isLoggedIn 
                ? 'bg-green-500/20 text-green-400 border border-green-500/50' 
                : 'bg-gray-500/20 text-gray-400 border border-gray-500/50'
            }`}
          >
            {isLoggedIn ? (
              <><CheckCircle className="w-3 h-3 mr-1" />å·²è¨­å®š</>
            ) : (
              <><XCircle className="w-3 h-3 mr-1" />æœªè¨­å®š</>
            )}
          </Badge>
        </div>
        
        <div 
          className={`flex items-center gap-3 py-2 px-2 rounded ${isLoggedIn ? 'cursor-pointer hover:bg-white/5' : 'cursor-not-allowed bg-yellow-500/10'}`}
          onClick={() => isLoggedIn && handlePlatformToggle(platform.id, !isEnabled)}
        >
          <Checkbox 
            checked={isEnabled}
            disabled={!isLoggedIn}
            onCheckedChange={(checked) => handlePlatformToggle(platform.id, !!checked)}
          />
          <span className={`text-sm font-medium ${
            isLoggedIn ? 'text-white' : 'text-yellow-300'
          }`}>
            {isLoggedIn ? 'å•Ÿç”¨æ­¤å¹³å°' : 'âš ï¸ è«‹å…ˆè¨­å®šæ†‘è­‰æ‰èƒ½å•Ÿç”¨'}
          </span>
        </div>
        
        {/* æ•™å­¸æŒ‡å— - æœªç™»å…¥æ™‚é¡¯ç¤ºï¼Œé–‹å§‹è¨­å®šæ™‚è‡ªå‹•å±•é–‹ */}
        {!isLoggedIn && (
          <div className="space-y-3 mt-4 pt-3 border-t border-border/50">
            <div>
              <button
                onClick={() => setExpandedGuide(expandedGuide === platform.id ? null : platform.id)}
                className="w-full flex items-center justify-between p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 hover:bg-blue-500/20 transition-colors"
              >
                <span className="flex items-center gap-2 text-sm font-medium text-blue-300">
                  <HelpCircle className="w-4 h-4" />
                  ğŸ“– {platform.name} è¨­å®šæ•™å­¸ï¼ˆé»æ“Šå±•é–‹/æ”¶åˆï¼‰
                </span>
                {expandedGuide === platform.id ? (
                  <ChevronUp className="w-4 h-4 text-blue-300" />
                ) : (
                  <ChevronDown className="w-4 h-4 text-blue-300" />
                )}
              </button>
              {expandedGuide === platform.id && (
                <div className="mt-3 p-4 bg-cyber-darker/50 rounded-lg border border-border/30 animate-in slide-in-from-top-2">
                  {renderGuideContent(platform.id)}
                </div>
              )}
            </div>
          </div>
        )}
        
        {/* è¨­å®šæŒ‰éˆ• - åªåœ¨æœªç™»å…¥ä¸”æœªé¡¯ç¤ºè¡¨å–®æ™‚é¡¯ç¤º */}
        {!isLoggedIn && !showForm && (
            <div className="flex flex-col sm:flex-row gap-3 mt-4">
              <Button
                size="sm"
                variant="outline"
                className="text-sm h-9 px-3 flex-1 w-full sm:w-auto border-blue-500/50 text-blue-300 hover:bg-blue-500/10"
                onClick={(e) => {
                  e.stopPropagation()
                  handleLogin(platform.id)
                }}
                disabled={loginLoading === platform.id}
              >
                <LogIn className="w-4 h-4 mr-2" />
                ğŸ”§ é–‹å§‹è¨­å®šæ†‘è­‰
              </Button>
            </div>
        )}
        
        {/* é¡¯ç¤ºç™»å…¥è¡¨å–® */}
        {showForm && (
          <div className="mt-4 pt-4 space-y-3 bg-cyber-darker/30 p-4 rounded-lg border border-blue-500/20">
            {platform.id === 'gmail' && (
              <>
                <div>
                  <Label className="text-sm mb-2 block text-white font-medium">Gmail å¸³è™Ÿ</Label>
                  <Input
                    type="email"
                    value={gmailForm.email}
                    onChange={(e) => setGmailForm(prev => ({ ...prev, email: e.target.value }))}
                    placeholder="your-email@gmail.com"
                  />
                </div>
                <div>
                  <Label className="text-sm mb-2 block text-white font-medium">æ‡‰ç”¨ç¨‹å¼å¯†ç¢¼</Label>
                  <Input
                    type="password"
                    value={gmailForm.appPassword}
                    onChange={(e) => setGmailForm(prev => ({ ...prev, appPassword: e.target.value }))}
                    placeholder="æ‡‰ç”¨ç¨‹å¼å¯†ç¢¼ï¼ˆ16ä½ï¼‰"
                  />
                  <p className="text-xs text-blue-300 mt-2 flex items-start gap-1">
                    <span>ğŸ’¡</span>
                    <span>åœ¨ Google å¸³æˆ¶è¨­å®šä¸­ç”Ÿæˆæ‡‰ç”¨ç¨‹å¼å¯†ç¢¼ï¼ˆåƒè€ƒä¸Šæ–¹æ•™å­¸ï¼‰</span>
                  </p>
                </div>
              </>
            )}
            
            {platform.id === 'threads' && (
              <>
                {/* é‡è¦å®‰å…¨æç¤º */}
                <div className="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/30 mb-3">
                  <div className="flex items-start gap-2">
                    <AlertCircle className="w-4 h-4 text-yellow-400 mt-0.5 flex-shrink-0" />
                    <div className="text-xs space-y-1">
                      <p className="text-yellow-200 font-medium">âš ï¸ å®‰å…¨å»ºè­°</p>
                      <p className="text-yellow-200/80">
                        <strong className="text-yellow-300">æ¨è–¦ä½¿ç”¨ã€Œé€²éšæ¨¡å¼ã€ï¼ˆå®˜æ–¹ APIï¼‰</strong><br/>
                        â€¢ ç°¡å–®æ¨¡å¼å¯èƒ½è¢« Meta åµæ¸¬ç‚ºæ©Ÿå™¨äºº<br/>
                        â€¢ æœ‰å¸³è™Ÿè¢«é™åˆ¶æˆ–å°é–çš„é¢¨éšª<br/>
                        â€¢ å®˜æ–¹ API æ˜¯ 100% å®‰å…¨åˆæ³•çš„æ–¹å¼
                      </p>
                    </div>
                  </div>
                </div>

                {/* æ¨¡å¼åˆ‡æ›æŒ‰éˆ• */}
                <div className="flex items-center gap-2 p-2 bg-cyber-darker/50 rounded border border-border/30">
                  <button
                    onClick={() => setThreadsLoginMode('advanced')}
                    className={`flex-1 px-3 py-1.5 text-xs rounded transition-all ${
                      threadsLoginMode === 'advanced'
                        ? 'bg-green-500/20 text-green-300 border border-green-500/50'
                        : 'text-muted-foreground hover:text-foreground'
                    }`}
                  >
                    âœ… é€²éšæ¨¡å¼ï¼ˆæ¨è–¦ï¼‰
                  </button>
                  <button
                    onClick={() => setThreadsLoginMode('simple')}
                    className={`flex-1 px-3 py-1.5 text-xs rounded transition-all ${
                      threadsLoginMode === 'simple'
                        ? 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/50'
                        : 'text-muted-foreground hover:text-foreground'
                    }`}
                  >
                    âš ï¸ ç°¡å–®æ¨¡å¼ï¼ˆæœ‰é¢¨éšªï¼‰
                  </button>
                </div>

                {threadsLoginMode === 'simple' ? (
                  <>
                    {/* ç°¡å–®æ¨¡å¼çš„é¡å¤–è­¦å‘Š */}
                    <div className="p-2.5 rounded bg-red-500/10 border border-red-500/30">
                      <p className="text-xs text-red-300">
                        <strong>âš ï¸ é¢¨éšªè­¦å‘Šï¼š</strong>ä½¿ç”¨å¸³è™Ÿå¯†ç¢¼ç™»å…¥å¯èƒ½å°è‡´å¸³è™Ÿè¢« Instagram/Threads ç³»çµ±åˆ¤å®šç‚ºæ©Ÿå™¨äººã€‚
                        å»ºè­°åƒ…ç”¨æ–¼æ¸¬è©¦ï¼Œæˆ–ä½¿ç”¨æ¸¬è©¦å¸³è™Ÿã€‚æ­£å¼ä½¿ç”¨è«‹é¸æ“‡ã€Œé€²éšæ¨¡å¼ã€ã€‚
                      </p>
                    </div>
                    <div>
                      <Label className="text-sm mb-2 block text-white font-medium">Instagram/Threads å¸³è™Ÿ</Label>
                      <Input
                        type="text"
                        value={threadsBrowserForm.username}
                        onChange={(e) => setThreadsBrowserForm(prev => ({ ...prev, username: e.target.value }))}
                        placeholder="ç”¨æˆ¶å æˆ– é›»å­éƒµä»¶"
                      />
                    </div>
                    <div>
                      <Label className="text-sm mb-2 block text-white font-medium">å¯†ç¢¼</Label>
                      <div className="relative">
                        <Input
                          type="password"
                          value={threadsBrowserForm.password}
                          onChange={(e) => setThreadsBrowserForm(prev => ({ ...prev, password: e.target.value }))}
                          placeholder="å¯†ç¢¼"
                          className="pr-10"
                        />
                        <button 
                          type="button" 
                          className="absolute right-3 top-1/2 transform -translate-y-1/2 text-muted-foreground hover:text-foreground"
                          onClick={() => {
                            const input = document.querySelector('input[type="password"]') as HTMLInputElement;
                            if (input) {
                              input.type = input.type === 'password' ? 'text' : 'password';
                            }
                          }}
                        >
                          ğŸ‘ï¸
                        </button>
                      </div>
                      <p className="text-xs text-red-300 mt-2 flex items-start gap-1">
                        <span>âš ï¸</span>
                        <span>ä¸å»ºè­°ç”¨æ–¼é‡è¦å¸³è™Ÿï¼ˆåƒè€ƒä¸Šæ–¹æ•™å­¸ä½¿ç”¨é€²éšæ¨¡å¼ï¼‰</span>
                      </p>
                    </div>
                  </>
                ) : (
                  <>
                    <div className="p-2.5 rounded bg-green-500/10 border border-green-500/30 mb-2">
                      <p className="text-xs text-green-300">
                        âœ… <strong>å®‰å…¨æ¨è–¦ï¼š</strong>ä½¿ç”¨ Meta å®˜æ–¹ API æ˜¯æœ€å®‰å…¨çš„æ–¹å¼ï¼Œä¸æœƒæœ‰å°é–é¢¨éšªã€‚
                        <a 
                          href="https://developers.facebook.com/docs/threads" 
                          target="_blank" 
                          rel="noopener noreferrer"
                          className="underline ml-1 hover:text-green-200"
                        >
                          æŸ¥çœ‹è¨­å®šæ•™å­¸
                        </a>
                      </p>
                    </div>
                    <div>
                      <Label className="text-sm mb-2 block text-white font-medium">User ID</Label>
                      <Input
                        type="text"
                        value={threadsForm.userId}
                        onChange={(e) => setThreadsForm(prev => ({ ...prev, userId: e.target.value }))}
                        placeholder="Threads User ID"
                      />
                    </div>
                    <div>
                      <Label className="text-sm mb-2 block text-white font-medium">Access Token</Label>
                      <Textarea
                        value={threadsForm.accessToken}
                        onChange={(e) => setThreadsForm(prev => ({ ...prev, accessToken: e.target.value }))}
                        placeholder="Threads API Access Token"
                        className="min-h-[80px]"
                      />
                      <p className="text-xs text-green-300 mt-2 flex items-start gap-1">
                        <span>âœ…</span>
                        <span>å®˜æ–¹èªå¯æ–¹å¼ï¼Œå®‰å…¨å¯é ï¼Œå¾ Meta Developer å¾Œå°å–å¾—ï¼ˆåƒè€ƒä¸Šæ–¹æ•™å­¸ï¼‰</span>
                      </p>
                    </div>
                  </>
                )}
              </>
            )}
            
            {platform.id === 'discord' && (
              <div>
                <Label className="text-sm mb-2 block text-white font-medium">Webhook URL</Label>
                <Textarea
                  value={discordForm.webhookUrl}
                  onChange={(e) => setDiscordForm({ webhookUrl: e.target.value })}
                  placeholder="https://discord.com/api/webhooks/..."
                  className="min-h-[80px]"
                />
                <p className="text-xs text-blue-300 mt-2 flex items-start gap-1">
                  <span>ğŸ’¡</span>
                  <span>åœ¨ Discord é »é“è¨­å®šä¸­å»ºç«‹ Webhookï¼ˆåƒè€ƒä¸Šæ–¹æ•™å­¸ï¼‰</span>
                </p>
              </div>
            )}
            
            <div className="flex gap-2">
              <Button
                size="sm"
                onClick={() => handleSubmitCredentials(platform.id)}
                disabled={loginLoading === platform.id}
                className="flex-1"
              >
                <KeyRound className="w-4 h-4 mr-2" />
                {loginLoading === platform.id ? 'è¨­å®šä¸­...' : 'ç¢ºèªè¨­å®š'}
              </Button>
              <Button
                size="sm"
                variant="outline"
                onClick={() => {
                  setShowLoginForm(null)
                  setExpandedGuide(null)
                  // æ¸…ç†è¡¨å–®
                  if (platform.id === 'gmail') setGmailForm({ email: '', appPassword: '' })
                  if (platform.id === 'threads') {
                    setThreadsForm({ userId: '', accessToken: '' })
                    setThreadsBrowserForm({ username: '', password: '' })
                  }
                  if (platform.id === 'discord') setDiscordForm({ webhookUrl: '' })
                }}
                disabled={loginLoading === platform.id}
              >
                å–æ¶ˆ
              </Button>
            </div>
          </div>
        )}
        
        {/* å·²ç™»å…¥æ™‚çš„æ“ä½œå€åŸŸï¼šé¡¯ç¤ºæˆåŠŸæç¤ºå’Œç™»å‡ºæŒ‰éˆ• */}
        {isLoggedIn && (
          <div className="mt-4 pt-3 border-t border-border/50 space-y-3">
            {/* æˆåŠŸæç¤º */}
            <div className="p-3 rounded-lg bg-green-500/10 border border-green-500/30 flex items-center gap-2">
              <CheckCircle className="w-4 h-4 text-green-400 flex-shrink-0" />
              <div className="flex-1">
                <p className="text-sm text-green-300 font-medium">âœ… {platform.name} å·²æˆåŠŸè¨­å®š</p>
                <p className="text-xs text-green-300/70 mt-0.5">æ‚¨å¯ä»¥åœ¨ä¸Šæ–¹å‹¾é¸ã€Œå•Ÿç”¨æ­¤å¹³å°ã€ä¾†é–‹å•ŸåŠŸèƒ½</p>
              </div>
            </div>
            
            {/* ç™»å‡ºæŒ‰éˆ• */}
            <div className="flex flex-col sm:flex-row gap-2">
              <Button
                size="sm"
                variant="outline"
                className="text-sm h-9 px-3 w-full text-red-400 border-red-400/50 hover:bg-red-400/10"
                onClick={(e) => {
                  e.stopPropagation()
                  handleLogout(platform.id)
                }}
                disabled={loginLoading === `logout-${platform.id}`}
              >
                <LogOut className="w-4 h-4 mr-2" />
                {loginLoading === `logout-${platform.id}` ? 'ç™»å‡ºä¸­...' : 'ğŸ”“ ç™»å‡ºä¸¦æ¸…é™¤æ†‘è­‰'}
              </Button>
            </div>
            
            {/* é‡æ–°è¨­å®šæç¤º */}
            <p className="text-xs text-muted-foreground/70 italic">
              ğŸ’¡ æç¤ºï¼šå¦‚éœ€é‡æ–°è¨­å®šæ†‘è­‰ï¼Œè«‹å…ˆç™»å‡ºå¾Œå†é€²è¡Œè¨­å®š
            </p>
          </div>
        )}
      </div>
    )
  }

  return (
    <Card className="cyber-card border-neon-red/30">
      <CardHeader>
        <CardTitle className="flex items-center gap-2 text-neon-red">
          <Skull className="w-5 h-5" />
          <span className="uppercase tracking-wider font-chinese">ç¤¾æ­»å”å®šè¨­å®š</span>
        </CardTitle>
        <p className="text-xs text-muted-foreground font-chinese">
          è¨­å®šé•è¦æ™‚å°‡ç™¼ä½ˆç¾æ¥è²¼æ–‡çš„å¹³å° - ä¾ App åˆ†é¡ç®¡ç†
        </p>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* ç›´æ¥ API æ•´åˆè³‡è¨Š */}
        <div className="bg-cyber-darker/50 border border-neon-blue/20 rounded-lg p-4">
          <div className="flex items-start gap-3">
            <AlertCircle className="w-5 h-5 text-neon-blue mt-0.5 flex-shrink-0" />
            <div className="text-sm space-y-1">
              <p className="text-muted-foreground font-chinese">
                ğŸ’¡ <strong className="text-neon-blue">ç›´æ¥åœ¨ç¶²é è¨­å®šæ†‘è­‰</strong>
              </p>
              <p className="text-xs text-muted-foreground/70 font-chinese">
                é»æ“Šã€Œè¨­å®šæ†‘è­‰ã€æŒ‰éˆ•ï¼Œè¼¸å…¥å„å¹³å°çš„ API èªè­‰è³‡è¨Šã€‚ç³»çµ±æœƒè‡ªå‹•å„²å­˜ï¼Œä¸‹æ¬¡å•Ÿå‹•æ™‚è‡ªå‹•è¼‰å…¥ã€‚
              </p>
            </div>
          </div>
        </div>

        {loginError && (
          <div className="p-3 rounded-lg bg-red-500/20 border border-red-500/50 flex items-center gap-2">
            <AlertCircle className="w-4 h-4 text-red-400" />
            <span className="text-sm text-red-300">{loginError}</span>
            <button 
              onClick={() => setLoginError(null)}
              className="ml-auto text-red-400 hover:text-red-300"
            >
              âœ•
            </button>
          </div>
        )}

        <Tabs defaultValue="discord" className="w-full">
          <TabsList className="flex w-full overflow-x-auto sm:grid sm:grid-cols-3 bg-cyber-gray/50 pb-1 sm:pb-0 scrollbar-hide">
            <TabsTrigger value="discord" className="flex items-center gap-1 px-3 sm:px-2 min-w-[60px]">
              <span>ğŸ®</span>
              <span className="hidden sm:inline text-xs">Discord</span>
            </TabsTrigger>
            <TabsTrigger value="gmail" className="flex items-center gap-1 px-3 sm:px-2 min-w-[60px]">
              <span>ğŸ“§</span>
              <span className="hidden sm:inline text-xs">Gmail</span>
            </TabsTrigger>
          </TabsList>

          {/* Discord Tab */}
          <TabsContent value="discord" className="space-y-4">
            <div className="space-y-4">
              {getPlatformById('discord') && renderPlatformCard(getPlatformById('discord')!)}
              <div className="mt-4">
                <Label className="text-xs text-muted-foreground font-chinese mb-2 block">è‡ªè¨‚è¨Šæ¯</Label>
                <Textarea
                  value={localSettings.custom_messages['discord'] || DEFAULT_MESSAGES['discord']}
                  onChange={(e) => handleMessageChange('discord', e.target.value)}
                  placeholder="è¼¸å…¥ Discord è¨Šæ¯..."
                  className="min-h-[100px] bg-[#1a1a1a] border-border/70 font-chinese text-white placeholder:text-gray-500"
                />
              </div>
            </div>
          </TabsContent>

          {/* Gmail Tab */}
          <TabsContent value="gmail" className="space-y-4">
            <div className="space-y-4">
              {getPlatformById('gmail') && renderPlatformCard(getPlatformById('gmail')!)}
              
              <div className="mt-4 space-y-4">
                <div>
                  <Label className="text-xs text-muted-foreground font-chinese mb-2 block">æ”¶ä»¶äººåˆ—è¡¨</Label>
                  <div className="flex gap-2 mb-3">
                    <Input
                      type="email"
                      value={newRecipient}
                      onChange={(e) => setNewRecipient(e.target.value)}
                      placeholder="è¼¸å…¥é›»å­éƒµä»¶åœ°å€..."
                      className="flex-1"
                      onKeyPress={(e) => e.key === 'Enter' && handleAddRecipient()}
                    />
                    <Button
                      size="sm"
                      onClick={handleAddRecipient}
                      disabled={!newRecipient || !newRecipient.includes('@')}
                    >
                      æ–°å¢
                    </Button>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {(localSettings.gmail_recipients || []).map((email) => (
                      <Badge
                        key={email}
                        variant="secondary"
                        className="px-3 py-1 bg-cyber-gray/50 text-sm dark:bg-gray-100 dark:text-gray-800"
                      >
                        {email}
                        <button
                          onClick={() => handleRemoveRecipient(email)}
                          className="ml-2 text-red-400 hover:text-red-300"
                        >
                          <X className="w-3 h-3" />
                        </button>
                      </Badge>
                    ))}
                    {(!localSettings.gmail_recipients || localSettings.gmail_recipients.length === 0) && (
                      <span className="text-xs text-muted-foreground">å°šæœªæ–°å¢æ”¶ä»¶äºº</span>
                    )}
                  </div>
                </div>

                <div>
                  <Label className="text-xs text-muted-foreground font-chinese mb-2 block">è‡ªè¨‚éƒµä»¶å…§å®¹</Label>
                  <Textarea
                    value={localSettings.custom_messages['gmail'] || DEFAULT_MESSAGES['gmail']}
                    onChange={(e) => handleMessageChange('gmail', e.target.value)}
                    placeholder="è¼¸å…¥éƒµä»¶å…§å®¹..."
                    className="min-h-[100px] bg-[#1a1a1a] border-border/70 font-chinese text-white placeholder:text-gray-500"
                  />
                </div>
              </div>
            </div>
          </TabsContent>
        </Tabs>

        {/* Options */}
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <div>
              <Label className="font-chinese">åŒ…å«æ™‚é–“æˆ³</Label>
              <p className="text-xs text-muted-foreground font-chinese">
                åœ¨è²¼æ–‡ä¸­åŠ å…¥é•è¦æ™‚é–“
              </p>
            </div>
            <Switch 
              checked={localSettings.include_timestamp}
              onCheckedChange={(checked) => {
                setLocalSettings(prev => ({ ...prev, include_timestamp: checked }))
                setHasChanges(true)
              }}
            />
          </div>
          
          <div className="flex items-center justify-between">
            <div>
              <Label className="font-chinese">åŒ…å«é•è¦æ¬¡æ•¸</Label>
              <p className="text-xs text-muted-foreground font-chinese">
                é¡¯ç¤ºä½ å¤±æ•—äº†å¹¾æ¬¡
              </p>
            </div>
            <Switch 
              checked={localSettings.include_violation_count}
              onCheckedChange={(checked) => {
                setLocalSettings(prev => ({ ...prev, include_violation_count: checked }))
                setHasChanges(true)
              }}
            />
          </div>
        </div>

        {/* Save Button */}
        <Button 
          onClick={handleSave}
          disabled={!hasChanges}
          className="w-full font-chinese"
          variant={hasChanges ? "default" : "outline"}
        >
          <Save className="w-4 h-4 mr-2" />
          {hasChanges ? 'å„²å­˜è®Šæ›´' : 'ç„¡è®Šæ›´'}
        </Button>
      </CardContent>
    </Card>
  )
}
</file>

<file path="frontend/src/components/ErrorBoundary.tsx">
import { Component, ErrorInfo, ReactNode } from 'react'
import { Button } from '@/components/ui/button'

interface Props {
  children: ReactNode
}

interface State {
  hasError: boolean
  error: Error | null
  errorInfo: ErrorInfo | null
}

class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props)
    this.state = {
      hasError: false,
      error: null,
      errorInfo: null,
    }
  }

  static getDerivedStateFromError(error: Error): Partial<State> {
    return { hasError: true, error }
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('éŒ¯èª¤é‚Šç•Œæ•ç²åˆ°éŒ¯èª¤:', error, errorInfo)
    this.setState({
      error,
      errorInfo,
    })
  }

  handleReload = () => {
    window.location.reload()
  }

  handleReset = () => {
    this.setState({
      hasError: false,
      error: null,
      errorInfo: null,
    })
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen bg-cyber-darker flex items-center justify-center p-4">
          <div className="max-w-2xl w-full bg-card border-2 border-destructive rounded-lg p-8 shadow-2xl">
            <div className="text-center mb-6">
              <h1 className="text-4xl font-bold text-destructive neon-red mb-2 font-orbitron">
                ç³»çµ±éŒ¯èª¤
              </h1>
              <p className="text-muted-foreground font-chinese">
                æ‡‰ç”¨ç¨‹å¼é‡åˆ°äº†ä¸€å€‹ç„¡æ³•æ¢å¾©çš„éŒ¯èª¤
              </p>
            </div>

            {this.state.error && (
              <div className="bg-background/50 rounded p-4 mb-6 border border-border">
                <h2 className="text-sm font-semibold text-destructive mb-2">éŒ¯èª¤è¨Šæ¯ï¼š</h2>
                <pre className="text-xs text-foreground/80 overflow-auto">
                  {this.state.error.toString()}
                </pre>
              </div>
            )}

            {this.state.errorInfo && (
              <details className="bg-background/50 rounded p-4 mb-6 border border-border">
                <summary className="text-sm font-semibold text-muted-foreground cursor-pointer hover:text-foreground">
                  è©³ç´°å †ç–Šè³‡è¨Šï¼ˆé»æ“Šå±•é–‹ï¼‰
                </summary>
                <pre className="text-xs text-foreground/60 overflow-auto mt-2 max-h-64">
                  {this.state.errorInfo.componentStack}
                </pre>
              </details>
            )}

            <div className="flex gap-4 justify-center">
              <Button
                onClick={this.handleReset}
                variant="outline"
                className="font-chinese"
              >
                å˜—è©¦æ¢å¾©
              </Button>
              <Button
                onClick={this.handleReload}
                className="bg-destructive hover:bg-destructive/90 font-chinese"
              >
                é‡æ–°è¼‰å…¥é é¢
              </Button>
            </div>

            <div className="mt-6 text-center text-xs text-muted-foreground font-chinese">
              <p>å¦‚æœå•é¡ŒæŒçºŒç™¼ç”Ÿï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°ä»¥ç²å–æ›´å¤šè³‡è¨Š</p>
            </div>
          </div>
        </div>
      )
    }

    return this.props.children
  }
}

export default ErrorBoundary
</file>

<file path="frontend/src/components/Landing/CustomCursor.tsx">
import { useEffect, useRef, useState } from 'react'

export const CustomCursor = () => {
  const cursorRef = useRef<HTMLDivElement>(null)
  const cursorInnerRef = useRef<HTMLDivElement>(null)
  const [isHovering, setIsHovering] = useState(false)
  const mousePos = useRef({ x: 0, y: 0 })
  const cursorPos = useRef({ x: 0, y: 0 })
  const cursorInnerPos = useRef({ x: 0, y: 0 })

  useEffect(() => {
    const cursor = cursorRef.current
    const cursorInner = cursorInnerRef.current
    if (!cursor || !cursorInner) return

    // Hide default cursor
    document.body.style.cursor = 'none'
    
    // Use RAF for butter-smooth 60fps animations
    let rafId: number

    const updateCursor = () => {
      // Smooth interpolation for outer cursor (heavy lag)
      cursorPos.current.x += (mousePos.current.x - cursorPos.current.x) * 0.15
      cursorPos.current.y += (mousePos.current.y - cursorPos.current.y) * 0.15

      // Faster interpolation for inner cursor (light lag)
      cursorInnerPos.current.x += (mousePos.current.x - cursorInnerPos.current.x) * 0.25
      cursorInnerPos.current.y += (mousePos.current.y - cursorInnerPos.current.y) * 0.25

      // Apply transforms directly for best performance
      cursor.style.transform = `translate(${cursorPos.current.x}px, ${cursorPos.current.y}px) translate(-50%, -50%)`
      cursorInner.style.transform = `translate(${cursorInnerPos.current.x}px, ${cursorInnerPos.current.y}px) translate(-50%, -50%)`

      rafId = requestAnimationFrame(updateCursor)
    }

    const handleMouseMove = (e: MouseEvent) => {
      mousePos.current = { x: e.clientX, y: e.clientY }
    }

    const handleMouseEnter = () => setIsHovering(true)
    const handleMouseLeave = () => setIsHovering(false)

    // MutationObserver to watch for dynamically added elements
    const setupInteractiveListeners = () => {
      const interactiveElements = document.querySelectorAll(
        'button, a, [data-magnetic], input, textarea, [role="button"], select'
      )

      interactiveElements.forEach((el) => {
        el.addEventListener('mouseenter', handleMouseEnter)
        el.addEventListener('mouseleave', handleMouseLeave)
      })

      return interactiveElements
    }

    let currentElements = setupInteractiveListeners()

    // Watch for DOM changes
    const observer = new MutationObserver(() => {
      // Remove old listeners
      currentElements.forEach((el) => {
        el.removeEventListener('mouseenter', handleMouseEnter)
        el.removeEventListener('mouseleave', handleMouseLeave)
      })
      // Setup new ones
      currentElements = setupInteractiveListeners()
    })

    observer.observe(document.body, {
      childList: true,
      subtree: true,
    })

    window.addEventListener('mousemove', handleMouseMove)
    rafId = requestAnimationFrame(updateCursor)

    return () => {
      cancelAnimationFrame(rafId)
      window.removeEventListener('mousemove', handleMouseMove)
      observer.disconnect()
      currentElements.forEach((el) => {
        el.removeEventListener('mouseenter', handleMouseEnter)
        el.removeEventListener('mouseleave', handleMouseLeave)
      })
      document.body.style.cursor = ''
    }
  }, [])

  return (
    <>
      {/* Outer cursor ring */}
      <div
        ref={cursorRef}
        className="fixed top-0 left-0 pointer-events-none z-[10000] mix-blend-difference"
        style={{
          width: isHovering ? '60px' : '40px',
          height: isHovering ? '60px' : '40px',
          transition: 'width 0.3s ease, height 0.3s ease',
        }}
      >
        <div
          className="w-full h-full rounded-full border-2 border-white"
          style={{
            opacity: isHovering ? 0.6 : 0.5,
            transition: 'opacity 0.3s ease',
          }}
        />
      </div>

      {/* Inner cursor dot */}
      <div
        ref={cursorInnerRef}
        className="fixed top-0 left-0 pointer-events-none z-[10000] mix-blend-difference"
        style={{
          width: isHovering ? '12px' : '8px',
          height: isHovering ? '12px' : '8px',
          transition: 'width 0.3s ease, height 0.3s ease',
        }}
      >
        <div
          className="w-full h-full rounded-full bg-white"
          style={{
            opacity: isHovering ? 1 : 0.8,
            transition: 'opacity 0.3s ease',
          }}
        />
      </div>
    </>
  )
}
</file>

<file path="frontend/src/components/Landing/MagneticButton.tsx">
import { useRef, ReactNode, useEffect } from 'react'
import { gsap } from 'gsap'

interface MagneticButtonProps {
  children: ReactNode
  className?: string
  onClick?: () => void
  strength?: number
  distance?: number
  as?: 'button' | 'div' | 'a'
  href?: string
}

export const MagneticButton = ({ 
  children, 
  className = '', 
  onClick,
  strength = 0.5,
  distance = 100,
  as: Component = 'button',
  href,
}: MagneticButtonProps) => {
  const buttonRef = useRef<HTMLElement>(null)
  const magneticRef = useRef<HTMLDivElement>(null)
  const rafId = useRef<number>()

  useEffect(() => {
    return () => {
      if (rafId.current) {
        cancelAnimationFrame(rafId.current)
      }
    }
  }, [])

  const handleMouseMove = (e: React.MouseEvent<HTMLElement>) => {
    const button = buttonRef.current
    const magnetic = magneticRef.current
    if (!button || !magnetic) return

    const rect = button.getBoundingClientRect()
    const centerX = rect.left + rect.width / 2
    const centerY = rect.top + rect.height / 2

    const distanceX = e.clientX - centerX
    const distanceY = e.clientY - centerY
    const distanceFromCenter = Math.sqrt(distanceX ** 2 + distanceY ** 2)

    // Only apply magnetic effect if within distance threshold
    if (distanceFromCenter < distance) {
      // Exponential easing for more natural feel
      const intensity = Math.pow((distance - distanceFromCenter) / distance, 1.5)
      
      const moveX = distanceX * strength * intensity
      const moveY = distanceY * strength * intensity

      // Use GSAP for smooth, hardware-accelerated animation
      // Round to prevent subpixel rendering blur
      gsap.to(magnetic, {
        x: Math.round(moveX),
        y: Math.round(moveY),
        duration: 0.5,
        ease: 'power3.out',
        force3D: true, // Hardware acceleration
      })
    }
  }

  const handleMouseLeave = () => {
    const magnetic = magneticRef.current
    if (!magnetic) return

    // Snap back with elastic spring physics
    gsap.to(magnetic, {
      x: 0,
      y: 0,
      duration: 0.8,
      ease: 'elastic.out(1, 0.4)', // Heavy, premium feel
      force3D: true,
    })
  }

  const props = {
    ref: buttonRef as any,
    className,
    onClick,
    onMouseMove: handleMouseMove,
    onMouseLeave: handleMouseLeave,
    'data-magnetic': 'true',
    ...(Component === 'a' && href ? { href } : {}),
  }

  return (
    <Component {...props}>
      <div 
        ref={magneticRef} 
        style={{ 
          display: 'inline-block',
          willChange: 'transform',
        }}
      >
        {children}
      </div>
    </Component>
  )
}
</file>

<file path="frontend/src/components/ui/badge.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground hover:bg-primary/80",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",
        destructive:
          "border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",
        outline: "text-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

export interface BadgeProps
  extends React.HTMLAttributes<HTMLDivElement>,
    VariantProps<typeof badgeVariants> {}

function Badge({ className, variant, ...props }: BadgeProps) {
  return (
    <div className={cn(badgeVariants({ variant }), className)} {...props} />
  )
}

export { Badge, badgeVariants }
</file>

<file path="frontend/src/components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"
import { MagneticButton } from "@/components/Landing/MagneticButton"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center text-center rounded-xl text-sm font-medium ring-offset-background transition-all duration-400 ease-luxury focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 break-words active:scale-95 backface-hidden",
  {
    variants: {
      variant: {
        default: "glass bg-mac-accent text-white hover:bg-mac-accentHover shadow-mac hover:shadow-mac-lg",
        destructive:
          "bg-neon-red text-white hover:bg-neon-red/90 shadow-glow-red hover:shadow-glow-red",
        outline:
          "glass border-2 border-white/20 hover:border-white/40 hover:bg-white/5",
        secondary:
          "glass bg-white/10 text-white hover:bg-white/20",
        ghost: "hover:bg-white/10 hover:text-white",
        link: "text-mac-accent underline-offset-4 hover:underline",
        success: "bg-neon-green text-white hover:bg-neon-green/90 shadow-glow-green hover:shadow-glow-green",
      },
      size: {
        default: "h-auto min-h-10 px-5 py-2.5",
        sm: "h-auto min-h-9 rounded-lg px-4 py-2 text-xs",
        lg: "h-auto min-h-12 rounded-xl px-8 py-3.5 text-base",
        xl: "h-auto min-h-14 rounded-2xl px-10 py-4 text-lg font-semibold",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {
  asChild?: boolean
  magnetic?: boolean
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, asChild = false, magnetic = true, children, ...props }, ref) => {
    const Comp = asChild ? Slot : "button"
    
    // Wrap in MagneticButton unless disabled or it's a link variant
    if (magnetic && variant !== 'link' && !asChild) {
      return (
        <MagneticButton 
          as="div" 
          className="inline-block"
          strength={0.35}
          distance={80}
        >
          <Comp
            className={cn(buttonVariants({ variant, size, className }))}
            ref={ref}
            {...props}
          >
            {children}
          </Comp>
        </MagneticButton>
      )
    }

    return (
      <Comp
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      >
        {children}
      </Comp>
    )
  }
)
Button.displayName = "Button"

export { Button, buttonVariants }
</file>

<file path="frontend/src/components/ui/card.tsx">
import * as React from "react"
import { cn } from "@/lib/utils"
import { useSpring } from "@/hooks/usePhysics"

const Card = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => {
  const divRef = React.useRef<HTMLDivElement>(null)
  
  React.useImperativeHandle(ref, () => divRef.current!)

  // Apply physics spring effect
  useSpring(divRef, { scale: 0.98, active: true });

  const handleMouseMove = (e: React.MouseEvent<HTMLDivElement>) => {
    if (!divRef.current) return
    const rect = divRef.current.getBoundingClientRect()
    const x = e.clientX - rect.left
    const y = e.clientY - rect.top
    
    divRef.current.style.setProperty("--mouse-x", `${x}px`)
    divRef.current.style.setProperty("--mouse-y", `${y}px`)

    // Enhanced Tilt logic with depth
    const centerX = rect.width / 2
    const centerY = rect.height / 2
    const rotateX = ((y - centerY) / centerY) * -5 // Increased tilt range
    const rotateY = ((x - centerX) / centerX) * 5

    divRef.current.style.setProperty("--rotate-x", `${rotateX}deg`)
    divRef.current.style.setProperty("--rotate-y", `${rotateY}deg`)
  }

  const handleMouseLeave = () => {
    if (!divRef.current) return
    divRef.current.style.setProperty("--rotate-x", "0deg")
    divRef.current.style.setProperty("--rotate-y", "0deg")
  }

  return (
    <div
      ref={divRef}
      onMouseMove={handleMouseMove}
      onMouseLeave={handleMouseLeave}
      className={cn(
        "mac-card group relative overflow-hidden transition-all duration-500 ease-out",
        "hover:shadow-[0_20px_40px_-12px_rgba(0,0,0,0.5)]", // Deep shadow on hover
        "transform-gpu perspective-1000",
        "border border-white/5", // Subtle border
        className
      )}
      style={{
        transform: "perspective(1000px) rotateX(var(--rotate-x, 0deg)) rotateY(var(--rotate-y, 0deg)) translateZ(0)",
        transition: "transform 0.1s ease-out, box-shadow 0.5s ease",
      } as React.CSSProperties}
      {...props}
    >
      {/* Border Follow Effect */}
      <div 
        className="pointer-events-none absolute -inset-px opacity-0 transition-opacity duration-500 group-hover:opacity-100"
        style={{
          background: `radial-gradient(600px circle at var(--mouse-x) var(--mouse-y), rgba(255,255,255,0.15), transparent 40%)`,
          zIndex: 1,
        }}
      />
      
      {/* Inner Glow */}
      <div
        className="pointer-events-none absolute inset-0 opacity-0 transition-opacity duration-500 group-hover:opacity-100"
        style={{
          background: `radial-gradient(800px circle at var(--mouse-x) var(--mouse-y), rgba(255,255,255,0.03), transparent 40%)`,
          zIndex: 2,
        }}
      />

      {/* Content Wrapper to ensure it sits above effects */}
      <div className="relative z-10">
        {props.children}
      </div>
    </div>
  )
})
Card.displayName = "Card"

const CardHeader = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex flex-col space-y-1.5 p-6", className)}
    {...props}
  />
))
CardHeader.displayName = "CardHeader"

const CardTitle = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLHeadingElement>
>(({ className, ...props }, ref) => (
  <h3
    ref={ref}
    className={cn(
      "text-2xl font-semibold leading-none tracking-tight",
      className
    )}
    {...props}
  />
))
CardTitle.displayName = "CardTitle"

const CardDescription = React.forwardRef<
  HTMLParagraphElement,
  React.HTMLAttributes<HTMLParagraphElement>
>(({ className, ...props }, ref) => (
  <p
    ref={ref}
    className={cn("text-sm text-muted-foreground", className)}
    {...props}
  />
))
CardDescription.displayName = "CardDescription"

const CardContent = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
))
CardContent.displayName = "CardContent"

const CardFooter = React.forwardRef<
  HTMLDivElement,
  React.HTMLAttributes<HTMLDivElement>
>(({ className, ...props }, ref) => (
  <div
    ref={ref}
    className={cn("flex items-center p-6 pt-0", className)}
    {...props}
  />
))
CardFooter.displayName = "CardFooter"

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }
</file>

<file path="frontend/src/components/ui/checkbox.tsx">
import * as React from "react"
import * as CheckboxPrimitive from "@radix-ui/react-checkbox"
import { Check } from "lucide-react"

import { cn } from "@/lib/utils"

const Checkbox = React.forwardRef<
  React.ElementRef<typeof CheckboxPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>
>(({ className, ...props }, ref) => (
  <CheckboxPrimitive.Root
    ref={ref}
    className={cn(
      "peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground transition-all duration-300 ease-luxury hover:scale-110 active:scale-95 backface-hidden",
      className
    )}
    {...props}
  >
    <CheckboxPrimitive.Indicator
      className={cn("flex items-center justify-center text-current animate-scale-in")}
    >
      <Check className="h-4 w-4" />
    </CheckboxPrimitive.Indicator>
  </CheckboxPrimitive.Root>
))
Checkbox.displayName = CheckboxPrimitive.Root.displayName

export { Checkbox }
</file>

<file path="frontend/src/components/ui/input.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

export interface InputProps
  extends React.InputHTMLAttributes<HTMLInputElement> {}

const Input = React.forwardRef<HTMLInputElement, InputProps>(  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-lg bg-[#1a1a1a] border border-white/20 px-4 py-2 text-sm text-white placeholder:text-gray-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:border-blue-500 disabled:cursor-not-allowed disabled:opacity-50 transition-all duration-300 ease-luxury hover:border-white/30 hover:bg-[#222222] backface-hidden",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Input.displayName = "Input"

export { Input }
</file>

<file path="frontend/src/components/ui/label.tsx">
import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const labelVariants = cva(
  "text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
)

const Label = React.forwardRef<
  React.ElementRef<typeof LabelPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &
    VariantProps<typeof labelVariants>
>(({ className, ...props }, ref) => (
  <LabelPrimitive.Root
    ref={ref}
    className={cn(labelVariants(), className)}
    {...props}
  />
))
Label.displayName = LabelPrimitive.Root.displayName

export { Label }
</file>

<file path="frontend/src/components/ui/progress.tsx">
import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

const Progress = React.forwardRef<
  React.ElementRef<typeof ProgressPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>
>(({ className, value, ...props }, ref) => (
  <ProgressPrimitive.Root
    ref={ref}
    className={cn(
      "relative h-4 w-full overflow-hidden rounded-full bg-secondary/20",
      className
    )}
    {...props}
  >
    <ProgressPrimitive.Indicator
      className="h-full w-full flex-1 bg-primary transition-all"
      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
    />
  </ProgressPrimitive.Root>
))
Progress.displayName = ProgressPrimitive.Root.displayName

export { Progress }
</file>

<file path="frontend/src/components/ui/slider.tsx">
import * as React from "react"
import * as SliderPrimitive from "@radix-ui/react-slider"

import { cn } from "@/lib/utils"

const Slider = React.forwardRef<
  React.ElementRef<typeof SliderPrimitive.Root>,
  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>
>(({ className, ...props }, ref) => (
  <SliderPrimitive.Root
    ref={ref}
    className={cn(
      "relative flex w-full touch-none select-none items-center group",
      className
    )}
    {...props}
  >
    <SliderPrimitive.Track className="relative h-1.5 w-full grow overflow-hidden rounded-full bg-white/10 transition-all duration-300">
      <SliderPrimitive.Range className="absolute h-full bg-gradient-to-r from-mac-accent to-neon-blue transition-all duration-400 ease-luxury" />
    </SliderPrimitive.Track>
    <SliderPrimitive.Thumb className="block h-5 w-5 rounded-full border-2 border-white bg-mac-accent shadow-glow-blue transition-all duration-300 ease-luxury focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-mac-accent focus-visible:ring-offset-2 focus-visible:ring-offset-mac-bg disabled:pointer-events-none disabled:opacity-50 hover:scale-125 hover:shadow-[0_0_30px_rgba(0,122,255,0.8)] cursor-grab active:cursor-grabbing active:scale-100 backface-hidden" />
  </SliderPrimitive.Root>
))
Slider.displayName = SliderPrimitive.Root.displayName

export { Slider }
</file>

<file path="frontend/src/components/ui/switch.tsx">
import * as React from "react"
import * as SwitchPrimitives from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

const Switch = React.forwardRef<
  React.ElementRef<typeof SwitchPrimitives.Root>,
  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>
>(({ className, ...props }, ref) => (
  <SwitchPrimitives.Root
    className={cn(
      "peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-all duration-400 ease-luxury focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input hover:scale-105 active:scale-95 backface-hidden",
      className
    )}
    {...props}
    ref={ref}
  >
    <SwitchPrimitives.Thumb
      className={cn(
        "pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-all duration-400 ease-luxury data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0 backface-hidden"
      )}
    />
  </SwitchPrimitives.Root>
))
Switch.displayName = SwitchPrimitives.Root.displayName

export { Switch }
</file>

<file path="frontend/src/components/ui/tabs.tsx">
import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

const Tabs = TabsPrimitive.Root

const TabsList = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.List>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.List
    ref={ref}
    className={cn(
      "inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground transition-all duration-300",
      className
    )}
    {...props}
  />
))
TabsList.displayName = TabsPrimitive.List.displayName

const TabsTrigger = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Trigger>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Trigger
    ref={ref}
    className={cn(
      "inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all duration-300 ease-luxury focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm hover:scale-105 active:scale-95 backface-hidden",
      className
    )}
    {...props}
  />
))
TabsTrigger.displayName = TabsPrimitive.Trigger.displayName

const TabsContent = React.forwardRef<
  React.ElementRef<typeof TabsPrimitive.Content>,
  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>
>(({ className, ...props }, ref) => (
  <TabsPrimitive.Content
    ref={ref}
    className={cn(
      "mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 animate-fade-in",
      className
    )}
    {...props}
  />
))
TabsContent.displayName = TabsPrimitive.Content.displayName

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="frontend/src/components/ui/textarea.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

export interface TextareaProps
  extends React.TextareaHTMLAttributes<HTMLTextAreaElement> {}

const Textarea = React.forwardRef<HTMLTextAreaElement, TextareaProps>(
  ({ className, ...props }, ref) => {
    return (
      <textarea
        className={cn(
          "flex min-h-[80px] w-full rounded-lg bg-[#1a1a1a] border border-white/20 px-3 py-2 text-sm text-white placeholder:text-gray-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:border-blue-500 disabled:cursor-not-allowed disabled:opacity-50 transition-all duration-200",
          className
        )}
        ref={ref}
        {...props}
      />
    )
  }
)
Textarea.displayName = "Textarea"

export { Textarea }
</file>

<file path="frontend/src/hooks/useAudio.ts">
import { useCallback, useRef, useEffect } from 'react'

export type SoundEffect = 'start' | 'warning' | 'penalty' | 'complete'

const SOUND_URLS: Record<SoundEffect, string> = {
  start: '/sounds/start.mp3',
  warning: '/sounds/warning.mp3', 
  penalty: '/sounds/penalty.mp3',
  complete: '/sounds/complete.mp3',
}

export function useAudio() {
  const audioRefs = useRef<Record<SoundEffect, HTMLAudioElement | null>>({
    start: null,
    warning: null,
    penalty: null,
    complete: null,
  })
  
  const attemptedLoads = useRef<Record<SoundEffect, boolean>>({
    start: false,
    warning: false,
    penalty: false,
    complete: false,
  })

  useEffect(() => {
    // æ¸…ç†å‡½æ•¸
    return () => {
      Object.values(audioRefs.current).forEach(audio => {
        if (audio) {
          audio.pause()
          audio.src = ''
        }
      })
    }
  }, [])
  
  // æ‡¶è¼‰å…¥éŸ³æ•ˆï¼šåªåœ¨é¦–æ¬¡æ’­æ”¾æ™‚æ‰å˜—è©¦è¼‰å…¥
  const loadAudio = useCallback((effect: SoundEffect) => {
    if (audioRefs.current[effect] || attemptedLoads.current[effect]) {
      return // å·²è¼‰å…¥æˆ–å·²å˜—è©¦é
    }
    
    attemptedLoads.current[effect] = true
    const url = SOUND_URLS[effect]
    
    // éœé»˜è¼‰å…¥ï¼Œç™¼ç”ŸéŒ¯èª¤ä¹Ÿä¸é¡¯ç¤ºï¼ˆéŸ³æ•ˆæ˜¯å¯é¸åŠŸèƒ½ï¼‰
    try {
      const audio = new Audio(url)
      audio.preload = 'auto'
      audio.volume = 0.7
      
      audio.addEventListener('error', () => {
        // éœé»˜è™•ç†éŒ¯èª¤ - éŸ³æ•ˆæª”æ¡ˆä¸å­˜åœ¨æ˜¯å¯æ¥å—çš„
        audioRefs.current[effect] = null
      })
      
      audio.addEventListener('canplaythrough', () => {
        audioRefs.current[effect] = audio
      }, { once: true })
    } catch {
      // éœé»˜è™•ç†
    }
  }, [])

  const play = useCallback((effect: SoundEffect) => {
    // å˜—è©¦è¼‰å…¥éŸ³æ•ˆï¼ˆå¦‚æœå°šæœªè¼‰å…¥ï¼‰
    loadAudio(effect)
    
    const audio = audioRefs.current[effect]
    if (audio) {
      audio.currentTime = 0
      audio.play().catch(() => {
        // éœé»˜è™•ç†æ’­æ”¾éŒ¯èª¤
      })
    }
  }, [loadAudio])

  const stop = useCallback((effect: SoundEffect) => {
    const audio = audioRefs.current[effect]
    if (audio) {
      audio.pause()
      audio.currentTime = 0
    }
  }, [])

  const stopAll = useCallback(() => {
    Object.values(audioRefs.current).forEach(audio => {
      if (audio) {
        audio.pause()
        audio.currentTime = 0
      }
    })
  }, [])

  const setVolume = useCallback((volume: number) => {
    const clampedVolume = Math.max(0, Math.min(1, volume))
    Object.values(audioRefs.current).forEach(audio => {
      if (audio) {
        audio.volume = clampedVolume
      }
    })
  }, [])

  return {
    play,
    stop,
    stopAll,
    setVolume,
  }
}
</file>

<file path="frontend/src/index.css">
/* Import Google Fonts */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap');

@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 220 13% 13%;
    --foreground: 0 0% 100%;
    --card: 220 13% 18%;
    --card-foreground: 0 0% 100%;
    --popover: 220 13% 18%;
    --popover-foreground: 0 0% 100%;
    --primary: 212 100% 50%;
    --primary-foreground: 0 0% 100%;
    --secondary: 142 76% 56%;
    --secondary-foreground: 0 0% 0%;
    --muted: 220 13% 25%;
    --muted-foreground: 0 0% 63%;
    --accent: 212 100% 50%;
    --accent-foreground: 0 0% 100%;
    --destructive: 10 100% 60%;
    --destructive-foreground: 0 0% 100%;
    --border: 0 0% 100% / 0.1;
    --input: 0 0% 100% / 0.1;
    --ring: 212 100% 50%;
    --radius: 0.75rem;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  
  body {
    @apply bg-background text-foreground;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  
  #root {
    min-height: 100vh;
  }
  
  /* Hide default cursor globally for custom cursor - with exceptions */
  * {
    cursor: none !important;
  }
  
  /* Allow text cursor for input fields */
  input, textarea, [contenteditable] {
    cursor: text !important;
  }
  
  /* Allow pointer for links and buttons (custom cursor will still show) */
  a, button, [role="button"] {
    cursor: none !important;
  }
}

/* Premium Typography System */
.heading-hero {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight: 700;
  letter-spacing: -0.04em;
  line-height: 0.95;
}

.heading-display {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight: 600;
  letter-spacing: -0.03em;
  line-height: 1.1;
}

.body-text {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight: 400;
  letter-spacing: -0.01em;
  line-height: 1.6;
}

/* macOS Glass Morphism Effect - Enhanced for Luxury */
.glass {
  background: rgba(30, 30, 30, 0.6);
  backdrop-filter: blur(40px) saturate(180%);
  -webkit-backdrop-filter: blur(40px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.08);
  box-shadow: 
    0 8px 32px 0 rgba(0, 0, 0, 0.37),
    inset 0 1px 0 0 rgba(255, 255, 255, 0.05);
}

.glass-light {
  background: rgba(45, 45, 45, 0.4);
  backdrop-filter: blur(20px) saturate(150%);
  -webkit-backdrop-filter: blur(20px) saturate(150%);
  border: 1px solid rgba(255, 255, 255, 0.06);
}

/* macOS Card Style - Premium Feel */
.mac-card {
  @apply glass rounded-2xl shadow-mac;
  transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  -webkit-font-smoothing: subpixel-antialiased;
  -moz-osx-font-smoothing: auto;
  transform: translate3d(0, 0, 0);
}

.mac-card:hover {
  transform: translate3d(0, -4px, 0);
  box-shadow: 
    0 20px 80px rgba(0, 0, 0, 0.35),
    0 0 1px rgba(255, 255, 255, 0.1);
}

/* Buttery Smooth Interactions */
.interactive {
  transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  cursor: pointer;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  -webkit-font-smoothing: subpixel-antialiased;
  -moz-osx-font-smoothing: auto;
  transform: translate3d(0, 0, 0);
}

.interactive:hover {
  transform: translate3d(0, 0, 0) scale(1.03);
}

.interactive:active {
  transform: translate3d(0, 0, 0) scale(0.97);
  transition: all 0.1s cubic-bezier(0.16, 1, 0.3, 1);
}

/* macOS Button Style - Luxury Edition */
.mac-button {
  @apply px-6 py-3 rounded-xl font-medium;
  background: linear-gradient(135deg, rgba(0, 122, 255, 0.95) 0%, rgba(0, 81, 213, 1) 100%);
  box-shadow: 
    0 4px 16px rgba(0, 122, 255, 0.3),
    0 2px 4px rgba(0, 0, 0, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.2);
  transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  transform: translate3d(0, 0, 0);
  backface-visibility: hidden;
  -webkit-font-smoothing: subpixel-antialiased;
}

.mac-button:hover {
  background: linear-gradient(135deg, rgba(0, 81, 213, 1) 0%, rgba(0, 60, 180, 1) 100%);
  box-shadow: 
    0 6px 24px rgba(0, 122, 255, 0.4),
    0 4px 8px rgba(0, 0, 0, 0.25),
    inset 0 1px 0 rgba(255, 255, 255, 0.25);
  transform: translate3d(0, -2px, 0);
}

.mac-button:active {
  transform: translate3d(0, 0, 0);
  transition: all 0.1s cubic-bezier(0.16, 1, 0.3, 1);
}

/* Status Indicators with macOS style */
.status-dot {
  @apply w-3 h-3 rounded-full;
  animation: pulse-glow 2s ease-in-out infinite;
}

/* Timer Display */
.timer-display {
  font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight: 300;
  letter-spacing: -0.02em;
  font-variant-numeric: tabular-nums;
}

/* Mouse Interaction Effects - Premium */
.hover-lift {
  transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  -webkit-font-smoothing: subpixel-antialiased;
  -moz-osx-font-smoothing: auto;
  transform: translate3d(0, 0, 0);
}

.hover-lift:hover {
  transform: translate3d(0, -6px, 0);
  box-shadow: 
    0 24px 80px rgba(0, 0, 0, 0.4),
    0 0 1px rgba(255, 255, 255, 0.1);
}

/* Floating Animation for Interactive Elements */
.float-on-hover {
  transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%, 100% {
    transform: translateY(0px) translateZ(0);
  }
  50% {
    transform: translateY(-8px) translateZ(0);
  }
}

.float-on-hover:hover {
  animation-play-state: paused;
  transform: translateY(-12px) translateZ(0);
}

/* Enhanced Glow Effects for Status */
.glow-blue {
  box-shadow: 
    0 0 30px rgba(0, 122, 255, 0.6), 
    0 0 60px rgba(0, 122, 255, 0.3),
    0 0 90px rgba(0, 122, 255, 0.15);
  animation: pulse-glow-blue 2s ease-in-out infinite;
}

.glow-green {
  box-shadow: 
    0 0 30px rgba(52, 199, 89, 0.6), 
    0 0 60px rgba(52, 199, 89, 0.3),
    0 0 90px rgba(52, 199, 89, 0.15);
  animation: pulse-glow-green 2s ease-in-out infinite;
}

.glow-red {
  box-shadow: 
    0 0 30px rgba(255, 59, 48, 0.6), 
    0 0 60px rgba(255, 59, 48, 0.3),
    0 0 90px rgba(255, 59, 48, 0.15);
  animation: pulse-glow-red 2s ease-in-out infinite;
}

@keyframes pulse-glow-blue {
  0%, 100% {
    box-shadow: 
      0 0 30px rgba(0, 122, 255, 0.6), 
      0 0 60px rgba(0, 122, 255, 0.3);
  }
  50% {
    box-shadow: 
      0 0 40px rgba(0, 122, 255, 0.8), 
      0 0 80px rgba(0, 122, 255, 0.4);
  }
}

@keyframes pulse-glow-green {
  0%, 100% {
    box-shadow: 
      0 0 30px rgba(52, 199, 89, 0.6), 
      0 0 60px rgba(52, 199, 89, 0.3);
  }
  50% {
    box-shadow: 
      0 0 40px rgba(52, 199, 89, 0.8), 
      0 0 80px rgba(52, 199, 89, 0.4);
  }
}

@keyframes pulse-glow-red {
  0%, 100% {
    box-shadow: 
      0 0 30px rgba(255, 59, 48, 0.6), 
      0 0 60px rgba(255, 59, 48, 0.3);
  }
  50% {
    box-shadow: 
      0 0 40px rgba(255, 59, 48, 0.8), 
      0 0 80px rgba(255, 59, 48, 0.4);
  }
}

/* Smooth Gradient Background */
.mac-gradient {
  background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
}

/* Custom Scrollbar - macOS Style */
::-webkit-scrollbar {
  width: 10px;
  height: 10px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 10px;
  border: 2px solid transparent;
  background-clip: padding-box;
}

::-webkit-scrollbar-thumb:hover {
  background: rgba(255, 255, 255, 0.3);
  background-clip: padding-box;
}

/* Ripple Effect */
@keyframes ripple {
  to {
    transform: scale(4);
    opacity: 0;
  }
}

.ripple {
  position: relative;
  overflow: hidden;
}

.ripple::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.5);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}

.ripple:active::after {
  width: 300px;
  height: 300px;
  opacity: 0;
}

/* Smooth Text Rendering */
* {
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

@layer utilities {
  .backface-hidden {
    backface-visibility: hidden;
  }

  /* Magnetic hover effect base */
  [data-magnetic] {
    transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1);
  }

  /* Smooth scroll */
  html {
    scroll-behavior: smooth;
  }
}

@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}

/* Smooth Number Transitions */
.smooth-number {
  transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
  font-variant-numeric: tabular-nums;
}

/* Animated Value Changes */
@keyframes valueUpdate {
  0% {
    transform: scale(1);
  }
  25% {
    transform: scale(1.08);
  }
  50% {
    transform: scale(1.05);
  }
  100% {
    transform: scale(1);
  }
}

.value-update {
  animation: valueUpdate 0.6s cubic-bezier(0.16, 1, 0.3, 1);
}

/* Status Change Animations */
@keyframes statusChange {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  30% {
    transform: scale(0.92);
    opacity: 0.7;
  }
  60% {
    transform: scale(1.06);
    opacity: 0.95;
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

.status-change {
  animation: statusChange 0.5s cubic-bezier(0.16, 1, 0.3, 1);
}

/* Prevent text selection on magnetic elements */
[data-magnetic] {
  user-select: none;
  -webkit-user-select: none;
}

/* Luxury transitions */
.transition-luxury {
  transition-timing-function: cubic-bezier(0.16, 1, 0.3, 1);
}

/* Scanline Effect */
.bg-scanline {
  background: linear-gradient(
    to bottom,
    transparent 50%,
    rgba(0, 0, 0, 0.5) 51%
  );
  background-size: 100% 4px;
  animation: scanline 0.2s linear infinite;
}

@keyframes scanline {
  0% { background-position: 0 0; }
  100% { background-position: 0 4px; }
}
</file>

<file path="frontend/src/lib/utils.ts">
import { type ClassValue, clsx } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

export function formatTime(seconds: number): string {
  const mins = Math.floor(seconds / 60)
  const secs = seconds % 60
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
}

export function formatTimeWithHours(seconds: number): string {
  const hours = Math.floor(seconds / 3600)
  const mins = Math.floor((seconds % 3600) / 60)
  const secs = seconds % 60
  
  if (hours > 0) {
    return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
  }
  return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`
}
</file>

<file path="frontend/src/main.tsx">
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.tsx'
import ErrorBoundary from './components/ErrorBoundary.tsx'
import './index.css'

// å…¨åŸŸéŒ¯èª¤è™•ç† - é˜²æ­¢æœªæ•ç²çš„éŒ¯èª¤å°è‡´é»‘å±
window.addEventListener('error', (event) => {
  console.error('æœªæ•ç²çš„å…¨åŸŸéŒ¯èª¤:', event.error)
  // åœ¨æ§åˆ¶å°é¡¯ç¤ºéŒ¯èª¤ï¼Œä½†ä¸é˜»æ­¢æ‡‰ç”¨é‹è¡Œ
})

window.addEventListener('unhandledrejection', (event) => {
  console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', event.reason)
  // åœ¨æ§åˆ¶å°é¡¯ç¤ºéŒ¯èª¤ï¼Œä½†ä¸é˜»æ­¢æ‡‰ç”¨é‹è¡Œ
})

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <ErrorBoundary>
      <App />
    </ErrorBoundary>
  </React.StrictMode>,
)
</file>

<file path="frontend/tailwind.config.js">
/** @type {import('tailwindcss').Config} */
export default {
  darkMode: ["class"],
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    container: {
      center: true,
      padding: "2rem",
      screens: {
        "2xl": "1400px",
      },
    },
    extend: {
      colors: {
        border: "hsl(var(--border))",
        input: "hsl(var(--input))",
        ring: "hsl(var(--ring))",
        background: "hsl(var(--background))",
        foreground: "hsl(var(--foreground))",
        primary: {
          DEFAULT: "hsl(var(--primary))",
          foreground: "hsl(var(--primary-foreground))",
        },
        secondary: {
          DEFAULT: "hsl(var(--secondary))",
          foreground: "hsl(var(--secondary-foreground))",
        },
        destructive: {
          DEFAULT: "hsl(var(--destructive))",
          foreground: "hsl(var(--destructive-foreground))",
        },
        muted: {
          DEFAULT: "hsl(var(--muted))",
          foreground: "hsl(var(--muted-foreground))",
        },
        accent: {
          DEFAULT: "hsl(var(--accent))",
          foreground: "hsl(var(--accent-foreground))",
        },
        popover: {
          DEFAULT: "hsl(var(--popover))",
          foreground: "hsl(var(--popover-foreground))",
        },
        card: {
          DEFAULT: "hsl(var(--card))",
          foreground: "hsl(var(--card-foreground))",
        },
        // macOS style colors
        mac: {
          bg: "#1e1e1e",
          surface: "#2d2d2d",
          overlay: "#3d3d3d",
          border: "rgba(255, 255, 255, 0.1)",
          text: "#ffffff",
          textSecondary: "#a0a0a0",
          accent: "#007aff",
          accentHover: "#0051d5",
          success: "#34c759",
          warning: "#ff9500",
          danger: "#ff3b30",
          purple: "#af52de",
        },
        // Keep neon colors for penalty states
        neon: {
          red: "#ff3b30",
          green: "#34c759",
          blue: "#007aff",
          purple: "#af52de",
          yellow: "#ff9500",
          orange: "#ff9500",
          // Gradient mix colors
          'green-mix-10': 'rgba(52, 199, 89, 0.1)',
          'green-mix-20': 'rgba(52, 199, 89, 0.2)',
          'green-mix-50': 'rgba(52, 199, 89, 0.5)',
          'yellow-mix-10': 'rgba(255, 149, 0, 0.1)',
          'yellow-mix-20': 'rgba(255, 149, 0, 0.2)',
          'yellow-mix-50': 'rgba(255, 149, 0, 0.5)',
          'orange-mix-10': 'rgba(255, 149, 0, 0.1)',
          'orange-mix-20': 'rgba(255, 149, 0, 0.2)',
          'orange-mix-50': 'rgba(255, 149, 0, 0.5)',
          'red-mix-10': 'rgba(255, 59, 48, 0.1)',
          'red-mix-20': 'rgba(255, 59, 48, 0.2)',
          'red-mix-50': 'rgba(255, 59, 48, 0.5)',
        },
      },
      borderRadius: {
        lg: "var(--radius)",
        md: "calc(var(--radius) - 2px)",
        sm: "calc(var(--radius) - 4px)",
        xl: "1rem",
        "2xl": "1.5rem",
      },
      backdropBlur: {
        xs: "2px",
      },
      boxShadow: {
        'mac': '0 4px 30px rgba(0, 0, 0, 0.1)',
        'mac-lg': '0 10px 40px rgba(0, 0, 0, 0.2)',
        'mac-inner': 'inset 0 1px 0 rgba(255, 255, 255, 0.1)',
        'glow-blue': '0 0 20px rgba(0, 122, 255, 0.5)',
        'glow-green': '0 0 20px rgba(52, 199, 89, 0.5)',
        'glow-red': '0 0 20px rgba(255, 59, 48, 0.5)',
      },
      keyframes: {
        "accordion-down": {
          from: { height: 0 },
          to: { height: "var(--radix-accordion-content-height)" },
        },
        "accordion-up": {
          from: { height: "var(--radix-accordion-content-height)" },
          to: { height: 0 },
        },
        "float": {
          "0%, 100%": { transform: "translateY(0px)" },
          "50%": { transform: "translateY(-10px)" },
        },
        "scale-in": {
          "0%": { transform: "scale(0.95)", opacity: 0 },
          "100%": { transform: "scale(1)", opacity: 1 },
        },
        "slide-up": {
          "0%": { transform: "translateY(10px)", opacity: 0 },
          "100%": { transform: "translateY(0)", opacity: 1 },
        },
        "slide-down": {
          "0%": { transform: "translateY(-10px)", opacity: 0 },
          "100%": { transform: "translateY(0)", opacity: 1 },
        },
        "fade-in": {
          "0%": { opacity: 0 },
          "100%": { opacity: 1 },
        },
        "shimmer": {
          "0%": { backgroundPosition: "-1000px 0" },
          "100%": { backgroundPosition: "1000px 0" },
        },
        "pulse-glow": {
          "0%, 100%": { boxShadow: "0 0 20px rgba(0, 122, 255, 0.5)" },
          "50%": { boxShadow: "0 0 40px rgba(0, 122, 255, 0.8)" },
        },
        "bounce-gentle": {
          "0%, 100%": { transform: "translateY(-5%)" },
          "50%": { transform: "translateY(0)" },
        },
        "bounce-subtle": {
          "0%, 100%": { transform: "translateY(0)" },
          "50%": { transform: "translateY(-3px)" },
        },
        "glow-pulse": {
          "0%, 100%": { opacity: 1 },
          "50%": { opacity: 0.6 },
        },
      },
      animation: {
        "accordion-down": "accordion-down 0.2s ease-out",
        "accordion-up": "accordion-up 0.2s ease-out",
        "float": "float 3s ease-in-out infinite",
        "scale-in": "scale-in 0.3s cubic-bezier(0.16, 1, 0.3, 1)",
        "slide-up": "slide-up 0.4s cubic-bezier(0.16, 1, 0.3, 1)",
        "slide-down": "slide-down 0.4s cubic-bezier(0.16, 1, 0.3, 1)",
        "fade-in": "fade-in 0.5s cubic-bezier(0.16, 1, 0.3, 1)",
        "shimmer": "shimmer 2s linear infinite",
        "pulse-glow": "pulse-glow 2s ease-in-out infinite",
        "bounce-gentle": "bounce-gentle 2s ease-in-out infinite",
        "bounce-subtle": "bounce-subtle 1s ease-in-out infinite",
        "glow": "glow 2s ease-in-out infinite",
        "glow-pulse": "glow-pulse 2s ease-in-out infinite",
        "scan-line": "scan-line 8s linear infinite",
        "flicker": "flicker 0.15s infinite",
      },
      fontFamily: {
        mono: ["JetBrains Mono", "Fira Code", "monospace"],
        chinese: ["Noto Sans TC", "sans-serif"],
        body: ["Inter", "system-ui", "sans-serif"],
      },
      fontSize: {
        'title': ['clamp(1.5rem, 3vw, 3rem)', { lineHeight: '1.2', letterSpacing: '-0.02em' }],
      },
      spacing: {
        '18': '4.5rem',
        '88': '22rem',
        '100': '25rem',
        '120': '30rem',
      },
      transitionTimingFunction: {
        'luxury': 'cubic-bezier(0.16, 1, 0.3, 1)',
        'smooth': 'cubic-bezier(0.4, 0, 0.2, 1)',
        'spring': 'cubic-bezier(0.175, 0.885, 0.32, 1.275)',
        'responsive': 'cubic-bezier(0.33, 1, 0.68, 1)',
      },
      transitionDuration: {
        '400': '400ms',
        '600': '600ms',
        '800': '800ms',
      },
    },
  },
  plugins: [require("tailwindcss-animate")],
}
</file>

<file path="frontend/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "skipLibCheck": true,
    "moduleResolution": "bundler",
    "allowImportingTsExtensions": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "noEmit": true,
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
</file>

<file path="frontend/tsconfig.node.json">
{
  "compilerOptions": {
    "composite": true,
    "skipLibCheck": true,
    "module": "ESNext",
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path="frontend/vite.config.ts">
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
      },
      '/socket.io': {
        target: 'http://localhost:8000',
        changeOrigin: true,
        ws: true,
      },
    },
  },
})
</file>

<file path="GIT_SECURITY_README.md">
# Git å®‰å…¨æ¨é€å·¥å…·

é€™äº›è…³æœ¬å¯å¹«åŠ©ä½ å®‰å…¨åœ°å°‡ä»£ç¢¼æ¨é€åˆ° GitHubï¼Œä¸¦é˜²æ­¢æ•æ„Ÿè³‡æ–™å¤–æ´©ã€‚

## ğŸ“‹ è…³æœ¬èªªæ˜

### 1. **Check-GitSecurity.ps1** - å®‰å…¨æª¢æŸ¥å·¥å…·
å¿«é€Ÿæƒæä¸¦æª¢æŸ¥æ•æ„Ÿè³‡æ–™ï¼š
- âœ… æª¢æŸ¥ `.gitignore` è¨­å®š
- âœ… æƒæ staged files ä¸­çš„æ•æ„Ÿæª”æ¡ˆ
- âœ… æª¢æŸ¥ repository ä¸­å·²è¿½è¹¤çš„æ•æ„Ÿæª”æ¡ˆ
- âœ… åˆ—å‡ºè¢«ä¿è­·çš„æœ¬åœ°æ•æ„Ÿæª”æ¡ˆ

```powershell
.\Check-GitSecurity.ps1
```

### 2. **Git-QuickPush.ps1** - å¿«é€Ÿæ¨é€ï¼ˆæ¨è–¦ï¼‰
äº’å‹•å¼çš„ commit å’Œ push æµç¨‹ï¼š
- è‡ªå‹•åŸ·è¡Œå®‰å…¨æª¢æŸ¥
- é¡¯ç¤ºç•¶å‰ç‹€æ…‹
- äº’å‹•å¼é¸æ“‡è¦ commit çš„å…§å®¹
- ç¢ºèªå¾Œæ¨é€

```powershell
.\Git-QuickPush.ps1
```

### 3. **Git-SafePush.ps1** - å®Œæ•´åŠŸèƒ½ç‰ˆ
é€²éšçš„ Git æ¨é€å·¥å…·ï¼Œæä¾›æ›´å¤šé¸é …å’Œè©³ç´°æª¢æŸ¥ï¼š

```powershell
# åŸºæœ¬ä½¿ç”¨
.\Git-SafePush.ps1 -Message "Update feature"

# åª commit ä¸ push
.\Git-SafePush.ps1 -Message "Fix bug" -NoPush

# è·³éå®‰å…¨æª¢æŸ¥ï¼ˆä¸å»ºè­°ï¼‰
.\Git-SafePush.ps1 -Message "Quick fix" -SkipCheck
```

#### åƒæ•¸èªªæ˜ï¼š
- `-Message`: Commit è¨Šæ¯ï¼ˆå¿…å¡«ï¼‰
- `-NoPush`: åªåŸ·è¡Œ commitï¼Œä¸æ¨é€
- `-SkipCheck`: è·³éå®‰å…¨æª¢æŸ¥ï¼ˆå±éšªï¼ä¸å»ºè­°ä½¿ç”¨ï¼‰

## ğŸ” æ•æ„Ÿè³‡æ–™ä¿è­·

### å·²ä¿è­·çš„æª”æ¡ˆé¡å‹

ä»¥ä¸‹æª”æ¡ˆå·²åœ¨ `.gitignore` ä¸­è¨­å®šï¼Œ**ä¸æœƒ**è¢«ä¸Šå‚³åˆ° GitHubï¼š

```
âœ… backend/credentials.json          # æ†‘è­‰è³‡è¨Š
âœ… backend/browser_contexts/         # ç€è¦½å™¨ç‹€æ…‹
âœ… backend/hostage_evidence/         # äººè³ªè­‰æ“šï¼ˆåœ–ç‰‡ç­‰ï¼‰
âœ… .env, .env.local                  # ç’°å¢ƒè®Šæ•¸
âœ… *.key, *.pem                      # å¯†é‘°æª”æ¡ˆ
âœ… __pycache__/, *.pyc               # Python å¿«å–
âœ… node_modules/, dist/              # å‰ç«¯ä¾è³´å’Œå»ºç½®æª”æ¡ˆ
```

### âš ï¸ é‡è¦æé†’

1. **credentials.json** åŒ…å«ï¼š
   - Gmail æ‡‰ç”¨ç¨‹å¼å¯†ç¢¼
   - Threads access token
   - Discord webhook URL
   - **çµ•å°ä¸å¯ä¸Šå‚³ï¼**

2. **browser_contexts/** åŒ…å«ï¼š
   - ç€è¦½å™¨ session è³‡è¨Š
   - å¯èƒ½åŒ…å«ç™»å…¥ç‹€æ…‹

3. **hostage_evidence/** åŒ…å«ï¼š
   - ä¸Šå‚³çš„äººè³ªåœ–ç‰‡
   - å€‹äººéš±ç§è³‡æ–™

## ğŸš€ ä½¿ç”¨æµç¨‹

### æ—¥å¸¸ Commit & Pushï¼ˆæ¨è–¦ï¼‰

```powershell
# æ–¹æ³• 1: ä½¿ç”¨å¿«é€Ÿæ¨é€è…³æœ¬ï¼ˆæœ€ç°¡å–®ï¼‰
.\Git-QuickPush.ps1

# æ–¹æ³• 2: ä½¿ç”¨å®Œæ•´åŠŸèƒ½ç‰ˆ
.\Git-SafePush.ps1 -Message "Add new feature"
```

### åƒ…æª¢æŸ¥å®‰å…¨æ€§

```powershell
.\Check-GitSecurity.ps1
```

### ä¿®å¾©ï¼šç§»é™¤å·²è¿½è¹¤çš„æ•æ„Ÿæª”æ¡ˆ

å¦‚æœæ•æ„Ÿæª”æ¡ˆå·²ç¶“è¢« git è¿½è¹¤ï¼Œéœ€è¦ç§»é™¤ï¼š

```powershell
# å¾ git ç§»é™¤ä½†ä¿ç•™æœ¬åœ°æª”æ¡ˆ
git rm --cached backend/credentials.json

# Commit é€™å€‹è®Šæ›´
git commit -m "Remove sensitive file from tracking"

# æ¨é€
git push
```

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å•é¡Œ 1: æ•æ„Ÿæª”æ¡ˆå·²åœ¨ repository ä¸­

**ç—‡ç‹€**ï¼šæª¢æŸ¥å·¥å…·å ±å‘Šã€Œç™¼ç¾æ•æ„Ÿæª”æ¡ˆå·²åœ¨ repository ä¸­ã€

**è§£æ±ºæ–¹æ³•**ï¼š
```powershell
# 1. ç§»é™¤è¿½è¹¤ï¼ˆä½†ä¿ç•™æœ¬åœ°æª”æ¡ˆï¼‰
git rm --cached path/to/sensitive/file

# 2. ç¢ºèª .gitignore å·²åŒ…å«è©²æª”æ¡ˆ
# 3. Commit ä¸¦æ¨é€
git commit -m "Stop tracking sensitive files"
git push
```

### å•é¡Œ 2: .gitignore ä¸ç”Ÿæ•ˆ

**å¯èƒ½åŸå› **ï¼šæª”æ¡ˆå·²è¢«è¿½è¹¤

**è§£æ±ºæ–¹æ³•**ï¼š
```powershell
# æ¸…é™¤å¿«å–é‡æ–°è¿½è¹¤
git rm -r --cached .
git add .
git commit -m "Fix .gitignore"
```

### å•é¡Œ 3: æ¨é€è¢«æ‹’çµ•

```powershell
# å…ˆæ‹‰å–é ç«¯è®Šæ›´
git pull origin main

# è§£æ±ºè¡çªï¼ˆå¦‚æœæœ‰ï¼‰
# ç„¶å¾Œé‡æ–°æ¨é€
git push origin main
```

## ğŸ“– ç¯„ä¾‹ä½¿ç”¨æƒ…å¢ƒ

### æƒ…å¢ƒ 1: æ–°å¢åŠŸèƒ½

```powershell
# 1. ä¿®æ”¹ç¨‹å¼ç¢¼...
# 2. æª¢æŸ¥å®‰å…¨æ€§
.\Check-GitSecurity.ps1

# 3. å¦‚æœé€šéï¼Œä½¿ç”¨å¿«é€Ÿæ¨é€
.\Git-QuickPush.ps1
# è¼¸å…¥ commit è¨Šæ¯: "Add sensor monitoring feature"
```

### æƒ…å¢ƒ 2: ä¿®å¾© Bug

```powershell
.\Git-SafePush.ps1 -Message "Fix: Resolve timer reset issue"
```

### æƒ…å¢ƒ 3: åªæƒ³ Commitï¼Œç¨å¾Œå† Push

```powershell
.\Git-SafePush.ps1 -Message "WIP: Implementing social media integration" -NoPush
```

## ğŸ” å®‰å…¨æª¢æŸ¥é …ç›®

æ¯æ¬¡æ¨é€å‰ï¼Œè…³æœ¬æœƒè‡ªå‹•æª¢æŸ¥ï¼š

1. âœ… `.gitignore` æª”æ¡ˆæ˜¯å¦å­˜åœ¨
2. âœ… å¿…è¦çš„æ•æ„Ÿæ¨¡å¼æ˜¯å¦åœ¨ `.gitignore` ä¸­
3. âœ… Staged files ä¸­æ˜¯å¦æœ‰æ•æ„Ÿæª”æ¡ˆ
4. âœ… Repository ä¸­æ˜¯å¦å·²è¿½è¹¤æ•æ„Ÿæª”æ¡ˆ
5. âœ… åˆ—å‡ºè¢«ä¿è­·çš„æœ¬åœ°æ•æ„Ÿæª”æ¡ˆï¼ˆè³‡è¨Šæ€§ï¼‰

## ğŸ’¡ æœ€ä½³å¯¦è¸

1. **æ¯æ¬¡æ¨é€å‰éƒ½åŸ·è¡Œæª¢æŸ¥**
   ```powershell
   .\Check-GitSecurity.ps1
   ```

2. **ä½¿ç”¨æœ‰æ„ç¾©çš„ commit è¨Šæ¯**
   - âŒ "update"
   - âŒ "fix"
   - âœ… "Add hardware status monitoring to dashboard"
   - âœ… "Fix: Resolve WebSocket connection timeout issue"

3. **å®šæœŸæª¢æŸ¥ `.gitignore`**
   - æ–°å¢æ•æ„Ÿæª”æ¡ˆæ™‚ï¼Œè¨˜å¾—æ›´æ–° `.gitignore`

4. **ä¸è¦ä½¿ç”¨ `-SkipCheck`**
   - é™¤éä½ å®Œå…¨çŸ¥é“è‡ªå·±åœ¨åšä»€éº¼

5. **æœ¬åœ°ä¿ç•™ credentials.example.json**
   - ä½œç‚ºè¨­å®šç¯„æœ¬
   - ä¸åŒ…å«çœŸå¯¦æ†‘è­‰

## ğŸ“ å¿«é€Ÿåƒè€ƒ

```powershell
# å¿«é€Ÿæª¢æŸ¥
.\Check-GitSecurity.ps1

# å¿«é€Ÿæ¨é€ï¼ˆæ¨è–¦æ–°æ‰‹ï¼‰
.\Git-QuickPush.ps1

# å®Œæ•´åŠŸèƒ½æ¨é€
.\Git-SafePush.ps1 -Message "Your message"

# åª commit
.\Git-SafePush.ps1 -Message "Your message" -NoPush

# ç§»é™¤æ•æ„Ÿæª”æ¡ˆè¿½è¹¤
git rm --cached path/to/file
git commit -m "Stop tracking sensitive file"

# æŸ¥çœ‹ç•¶å‰ç‹€æ…‹
git status

# æŸ¥çœ‹ staged files
git diff --cached --name-only
```

## âš™ï¸ è‡ªè¨‚è¨­å®š

å¦‚éœ€ä¿®æ”¹æ•æ„Ÿæª”æ¡ˆæ¨¡å¼ï¼Œç·¨è¼¯è…³æœ¬ä¸­çš„ `$sensitivePatterns` é™£åˆ—ï¼š

```powershell
$sensitivePatterns = @(
    "credentials.json",
    "*.key",
    "*.pem",
    # æ–°å¢ä½ çš„æ¨¡å¼...
)
```

## ğŸ†˜ ç·Šæ€¥æƒ…æ³

å¦‚æœä¸å°å¿ƒæ¨é€äº†æ•æ„Ÿè³‡æ–™ï¼š

1. **ç«‹å³æ›´æ”¹æ‰€æœ‰å¤–æ´©çš„æ†‘è­‰**ï¼ˆGmail å¯†ç¢¼ã€Token ç­‰ï¼‰
2. **å¾ Git æ­·å²ä¸­ç§»é™¤**ï¼š
   ```powershell
   # ä½¿ç”¨ BFG Repo-Cleaner æˆ– git filter-branch
   # é€™éœ€è¦å¼·åˆ¶æ¨é€ï¼Œæœƒé‡å¯«æ­·å²ï¼
   ```
3. **è¯çµ¡ GitHub æ”¯æ´**è«‹æ±‚å”åŠ©æ¸…é™¤å¿«å–

---

**è¨˜ä½**ï¼šé é˜²å‹æ–¼æ²»ç™‚ï¼æ¯æ¬¡æ¨é€å‰éƒ½åŸ·è¡Œå®‰å…¨æª¢æŸ¥ã€‚ ğŸ”’
</file>

<file path="MARKDOWN/SOCKET_COMMUNICATION.md">
# ğŸ“¡ Socket.IO é€šè¨Šæ¶æ§‹å®Œæ•´æ–‡ä»¶

**æ–‡ä»¶ç‰ˆæœ¬**: 1.0  
**æœ€å¾Œæ›´æ–°**: 2025-12-22  
**ç‹€æ…‹**: âœ… å·²é©—è­‰å¯é‹è¡Œ

æœ¬æ–‡ä»¶è©³ç´°è¨˜éŒ„ Focus Enforcer v1.0 çš„ Socket.IO é€šè¨Šæ¶æ§‹ï¼ŒåŒ…å«æˆåŠŸé‹è¡Œçš„é…ç½®ã€é€šè¨Šå”å®šã€æ•…éšœæ’é™¤æŒ‡å—ç­‰å®Œæ•´è³‡è¨Šã€‚

---

## ğŸ“‹ ç›®éŒ„

1. [ç³»çµ±æ¶æ§‹æ¦‚è¦½](#ç³»çµ±æ¶æ§‹æ¦‚è¦½)
2. [æŠ€è¡“æ£§èˆ‡ç‰ˆæœ¬](#æŠ€è¡“æ£§èˆ‡ç‰ˆæœ¬)
3. [é€£ç·šé…ç½®](#é€£ç·šé…ç½®)
4. [é€šè¨Šå”å®š](#é€šè¨Šå”å®š)
5. [é€£ç·šæµç¨‹](#é€£ç·šæµç¨‹)
6. [é—œéµå¯¦ä½œç´°ç¯€](#é—œéµå¯¦ä½œç´°ç¯€)
7. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)
8. [é–‹ç™¼ç’°å¢ƒè¨­ç½®](#é–‹ç™¼ç’°å¢ƒè¨­ç½®)

---

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹æ¦‚è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend (React)  â”‚         â”‚  Backend (FastAPI)  â”‚         â”‚  Hardware (ESP32)   â”‚
â”‚   Port: 5173        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Port: 8000         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤  WebSocket Client   â”‚
â”‚                     â”‚         â”‚                     â”‚         â”‚                     â”‚
â”‚  socket.io-client   â”‚         â”‚  python-socketio    â”‚         â”‚  Custom Protocol    â”‚
â”‚  ^4.7.4             â”‚         â”‚  v5.11.0            â”‚         â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                 â”‚
         â”‚   Socket.IO over WebSocket      â”‚
         â”‚   /socket.io/                   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         
é–‹ç™¼ç’°å¢ƒ:
- Frontend: Vite dev server with proxy
- Backend: Uvicorn ASGI server
- Windows: éœ€è¦ç‰¹æ®Šè™•ç† (ProactorEventLoop + Safe Print)
```

---

## ğŸ”§ æŠ€è¡“æ£§èˆ‡ç‰ˆæœ¬

### å¾Œç«¯ (Backend)
```python
# requirements.txt (é—œéµå¥—ä»¶)
fastapi==0.109.0
uvicorn[standard]==0.27.0
python-socketio==5.11.0         # âš ï¸ ç‰ˆæœ¬å¾ˆé‡è¦ï¼
websockets>=12.0
aiohttp>=3.9.0

# Python ç‰ˆæœ¬: 3.13.0
# äº‹ä»¶å¾ªç’°: asyncio.WindowsProactorEventLoopPolicy (Windows)
```

### å‰ç«¯ (Frontend)
```json
{
  "socket.io-client": "^4.7.4",  // âš ï¸ å¿…é ˆèˆ‡å¾Œç«¯ç›¸å®¹
  "react": "^18.2.0",
  "vite": "^5.0.0"
}
```

### é—œéµç›¸å®¹æ€§
- `python-socketio` v5.11.0 ä½¿ç”¨ Engine.IO v4
- `socket.io-client` v4.x ä¹Ÿä½¿ç”¨ Engine.IO v4
- âš ï¸ ç‰ˆæœ¬ä¸åŒ¹é…æœƒå°è‡´é€£ç·šå¤±æ•—

---

## âš™ï¸ é€£ç·šé…ç½®

### 1. å¾Œç«¯ Socket.IO åˆå§‹åŒ–

**æª”æ¡ˆ**: `backend/app/socket_manager.py`

```python
class SocketManager:
    def __init__(self):
        # âœ… æ­£ç¢ºçš„åˆå§‹åŒ–æ–¹å¼
        self.sio = socketio.AsyncServer(
            async_mode='asgi',              # âš ï¸ å¿…é ˆä½¿ç”¨ 'asgi' æ¨¡å¼
            cors_allowed_origins='*',       # é–‹ç™¼ç’°å¢ƒå…è¨±æ‰€æœ‰ä¾†æº
            logger=False,                   # é—œé–‰è©³ç´°æ—¥èªŒ
            engineio_logger=False           # é—œé–‰ engine.io æ—¥èªŒ
        )
        # å»ºç«‹ ASGI æ‡‰ç”¨
        self.app = socketio.ASGIApp(self.sio)
```

**æ•´åˆè‡³ FastAPI**:

**æª”æ¡ˆ**: `backend/app/main.py`

```python
# âœ… æ­£ç¢ºçš„æ•´åˆæ–¹å¼
fastapi_app = FastAPI(...)

# ä½¿ç”¨ socketio.ASGIApp åŒ…è£ FastAPI
app = socketio.ASGIApp(
    socket_manager.sio,
    other_asgi_app=fastapi_app,
    socketio_path='socket.io'    # âš ï¸ ä¸è¦åŠ  '/' å‰ç¶´ï¼
)

# âŒ éŒ¯èª¤æ–¹å¼: app = socket_manager.app
# âŒ éŒ¯èª¤æ–¹å¼: socketio_path='/socket.io'  (æœƒå°è‡´è·¯å¾‘éŒ¯èª¤)
```

### 2. Uvicorn å•Ÿå‹•é…ç½®

**æª”æ¡ˆ**: `backend/run.py`

```python
# âœ… Windows å¿…è¦è¨­å®š
if sys.platform == 'win32':
    asyncio.set_event_loop_policy(asyncio.WindowsProactorEventLoopPolicy())

uvicorn.run(
    "app.main:app",              # âš ï¸ æŒ‡å‘åŒ…è£å¾Œçš„ appï¼Œä¸æ˜¯ fastapi_app
    host="0.0.0.0",
    port=8000,
    loop="asyncio",
    workers=1,                    # âš ï¸ å¿…é ˆä½¿ç”¨å–®ä¸€é€²ç¨‹
    reload=False                  # ç”Ÿç”¢ç’°å¢ƒé—œé–‰
)
```

### 3. å‰ç«¯é€£ç·šé…ç½®

**æª”æ¡ˆ**: `frontend/vite.config.ts`

```typescript
// âœ… Vite ä»£ç†é…ç½® (é–‹ç™¼ç’°å¢ƒ)
export default defineConfig({
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://localhost:8000',
        changeOrigin: true,
      },
      '/socket.io': {            // âš ï¸ ä»£ç† Socket.IO è·¯å¾‘
        target: 'http://localhost:8000',
        changeOrigin: true,
        ws: true,                 // âš ï¸ å•Ÿç”¨ WebSocket æ”¯æ´
      },
    },
  },
})
```

**æª”æ¡ˆ**: `frontend/src/hooks/useSocket.ts`

```typescript
// âœ… é–‹ç™¼ç’°å¢ƒç›´é€£å¾Œç«¯ï¼Œé¿å…ä»£ç†å•é¡Œ
const isDev = window.location.hostname === 'localhost' || 
              window.location.hostname === '127.0.0.1'
const socketUrl = isDev ? 'http://localhost:8000' : undefined

const socketInstance = io(socketUrl, {
  path: '/socket.io/',           // âš ï¸ å¿…é ˆèˆ‡å¾Œç«¯ä¸€è‡´
  transports: ['polling', 'websocket'],  // å…ˆ polling å†å‡ç´š
  reconnection: true,
  reconnectionDelay: 1000,
  reconnectionAttempts: 10,
  timeout: 20000,
  autoConnect: true,
})
```

**é‡è¦**: é–‹ç™¼ç’°å¢ƒä¸­ï¼Œç›´æ¥é€£æ¥ `http://localhost:8000` è€Œéä¾è³´ Vite ä»£ç†ï¼Œå› ç‚º Vite çš„ WebSocket ä»£ç†åœ¨æŸäº›æƒ…æ³ä¸‹ä¸ç©©å®šã€‚

---

## ğŸ“¡ é€šè¨Šå”å®š

### Client â†’ Server äº‹ä»¶

#### 1. `start_session`
é–‹å§‹æ–°çš„å°ˆæ³¨éšæ®µ
```typescript
socket.emit('start_session', {
  duration_minutes: 25  // å°ˆæ³¨æ™‚é–“ï¼ˆåˆ†é˜ï¼‰
})
```

#### 2. `stop_session`
å¼·åˆ¶åœæ­¢ç•¶å‰éšæ®µ
```typescript
socket.emit('stop_session')
```

#### 3. `pause_session` / `resume_session`
æš«åœ/æ¢å¾©éšæ®µ
```typescript
socket.emit('pause_session')
socket.emit('resume_session')
```

#### 4. `update_penalty_config`
æ›´æ–°é•è¦æ‡²ç½°é…ç½®
```typescript
socket.emit('update_penalty_config', {
  enable_phone_penalty: true,
  enable_presence_penalty: true,
  enable_noise_penalty: false,
  enable_box_open_penalty: true,
  noise_threshold_db: 70
})
```

#### 5. `toggle_mock_mode`
åˆ‡æ›æ¨¡æ“¬ç¡¬é«”æ¨¡å¼
```typescript
socket.emit('toggle_mock_mode', {
  enabled: true  // true=å•Ÿç”¨æ¨¡æ“¬, false=ä½¿ç”¨å¯¦é«”ç¡¬é«”
})
```

#### 6. `mock_sensor_update`
ï¼ˆæ¨¡æ“¬æ¨¡å¼é™å®šï¼‰æ›´æ–°æ„Ÿæ¸¬å™¨ç‹€æ…‹
```typescript
socket.emit('mock_sensor_update', {
  sensor_type: 'phone' | 'presence' | 'box',
  value: true | false
})
```

### Server â†’ Client äº‹ä»¶

#### 1. `system_state`
ç³»çµ±ç‹€æ…‹å»£æ’­ï¼ˆæ¯ 200ms æˆ–ç‹€æ…‹è®ŠåŒ–æ™‚ï¼‰
```json
{
  "session": {
    "id": "uuid",
    "status": "IDLE" | "ACTIVE" | "PAUSED" | "VIOLATED" | "COMPLETED",
    "duration_minutes": 25,
    "start_time": "2025-12-22T10:00:00Z",
    "end_time": null,
    "violations": 0,
    "penalties_executed": 0
  },
  "hardware_state": "IDLE" | "PREPARING" | "FOCUSING" | "PAUSED" | "VIOLATION" | "ERROR",
  "phone_status": "LOCKED" | "REMOVED" | "UNKNOWN",
  "presence_status": "DETECTED" | "AWAY" | "UNKNOWN",
  "box_status": "CLOSED" | "OPEN" | "UNKNOWN",
  "noise_status": "QUIET" | "NOISY" | "UNKNOWN",
  "current_db": 45,
  "prepare_remaining_ms": 9500,
  "last_sensor_data": {
    "nfc_id": "PHONE_001",
    "box_open": false,
    "radar_presence": true,
    "mic_db": 45,
    "timestamp": 1703241600000
  },
  "penalty_config": { ... }
}
```

#### 2. `hardware_status`
ç¡¬é«”é€£ç·šç‹€æ…‹
```json
{
  "connected": true,
  "mock_mode": false,
  "mock_state": {
    "phone_inserted": true,
    "person_present": true,
    "box_open": false
  },
  "nfc_detected": true,
  "ldr_detected": true,
  "hall_detected": true,    // KY-033 IR æ„Ÿæ¸¬å™¨
  "ir_detected": true,
  "radar_detected": true,
  "lcd_detected": false,
  "hardware_state": "IDLE",
  "firmware_version": "1.0.0",
  "features": "hall,lcd,radar"
}
```

#### 3. `penalty_triggered`
æ‡²ç½°åŸ·è¡Œé€šçŸ¥
```json
{
  "type": "PHONE_REMOVED" | "PRESENCE_AWAY" | "BOX_OPEN",
  "timestamp": 1703241600000
}
```

### Hardware (ESP32) â†’ Server äº‹ä»¶

ç¡¬é«”é€éå°ˆç”¨ WebSocket é€£æ¥è‡³ `/ws/hardware`

#### `sensor_data`
æ„Ÿæ¸¬å™¨æ•¸æ“šä¸Šå ±ï¼ˆæ¯ 1 ç§’ï¼‰
```json
{
  "state": "FOCUSING",
  "box_open": false,
  "radar_presence": true,
  "nfc_id": "PHONE_001",
  "mic_db": 45,
  "timestamp": 1703241600000,
  "nfc_detected": true,
  "ldr_detected": true
}
```

---

## ğŸ”„ é€£ç·šæµç¨‹

### æˆåŠŸé€£ç·šçš„å®Œæ•´æµç¨‹

```
1. å‰ç«¯åˆå§‹åŒ–
   â”œâ”€ useSocket hook å»ºç«‹ Socket.IO client
   â”œâ”€ é€£æ¥åˆ° http://localhost:8000 (é–‹ç™¼ç’°å¢ƒ)
   â””â”€ è¨­å®šäº‹ä»¶ç›£è½å™¨

2. Socket.IO æ¡æ‰‹
   â”œâ”€ GET /socket.io/?EIO=4&transport=polling
   â”‚  â””â”€ å¾Œç«¯è¿”å› session ID
   â”œâ”€ POST /socket.io/?EIO=4&transport=polling&sid=xxx
   â”‚  â””â”€ å®¢æˆ¶ç«¯ç™¼é€ upgrade è«‹æ±‚
   â””â”€ WebSocket /socket.io/?EIO=4&transport=websocket&sid=xxx
      â””â”€ å‡ç´šç‚º WebSocket é€£ç·š âœ…

3. å¾Œç«¯è™•ç† connect äº‹ä»¶
   â”œâ”€ è¨˜éŒ„å®¢æˆ¶ç«¯ SID
   â”œâ”€ emit('system_state') â†’ ç™¼é€åˆå§‹ç‹€æ…‹
   â””â”€ emit('hardware_status') â†’ ç™¼é€ç¡¬é«”ç‹€æ…‹

4. å‰ç«¯æ¥æ”¶åˆå§‹æ•¸æ“š
   â”œâ”€ on('connect') â†’ setConnected(true)
   â”œâ”€ on('system_state') â†’ æ›´æ–°ç³»çµ±ç‹€æ…‹
   â”œâ”€ on('hardware_status') â†’ æ›´æ–°ç¡¬é«”ç‹€æ…‹
   â””â”€ fetch('/api/hardware/status') â†’ ç²å–é¡å¤–è³‡è¨Š

5. æŒçºŒé€šè¨Š
   â”œâ”€ å‰ç«¯ç™¼é€æ§åˆ¶æŒ‡ä»¤ (start_session, etc.)
   â”œâ”€ å¾Œç«¯å®šæœŸå»£æ’­ system_state (200ms ç¯€æµ)
   â””â”€ ç¡¬é«”ä¸Šå ± sensor_data â†’ å¾Œç«¯è™•ç† â†’ å»£æ’­æ›´æ–°
```

### ç¶²è·¯è«‹æ±‚ç¯„ä¾‹

**æˆåŠŸçš„æ¡æ‰‹åºåˆ—**:
```http
GET /socket.io/?EIO=4&transport=polling&t=28vwpw73 HTTP/1.1
Host: localhost:8000
â†’ 200 OK
  Content-Type: text/plain
  0{"sid":"DjBLpr1Y048zJcPRAAAA","upgrades":["websocket"],...}

POST /socket.io/?EIO=4&transport=polling&t=28wiwni3&sid=DjBLpr1Y048zJcPRAAAA
â†’ 200 OK

WebSocket /socket.io/?EIO=4&transport=websocket&sid=DjBLpr1Y048zJcPRAAAA
â†’ 101 Switching Protocols
  Upgrade: websocket
  Connection: Upgrade
```

---

## ğŸ” é—œéµå¯¦ä½œç´°ç¯€

### 1. Windows ç›¸å®¹æ€§è™•ç†

**å•é¡Œ**: Windows çš„ `asyncio` é è¨­ä½¿ç”¨ `SelectorEventLoop`ï¼Œä½† Playwright å’Œéƒ¨åˆ†ç•°æ­¥æ“ä½œéœ€è¦ `ProactorEventLoop`ã€‚

**è§£æ±ºæ–¹æ¡ˆ**:
```python
# backend/run.py å’Œ backend/app/main.py
if sys.platform == 'win32':
    asyncio.set_event_loop_policy(asyncio.WindowsProactorEventLoopPolicy())
```

### 2. Windows Broken Pipe è™•ç†

**å•é¡Œ**: åœ¨ Windows ä¸­ä»¥ç¨ç«‹è¦–çª—åŸ·è¡Œæ™‚ï¼Œstdout å¯èƒ½è¢«é—œé–‰ï¼Œå°è‡´ `print()` æ‹‹å‡º `BrokenPipeError`ã€‚

**è§£æ±ºæ–¹æ¡ˆ**:
```python
# backend/app/logger.py
def safe_print(*args, **kwargs):
    try:
        print(*args, **kwargs)
        sys.stdout.flush()
    except (OSError, IOError, BrokenPipeError):
        pass  # éœé»˜å¿½ç•¥

# å…¨å°ˆæ¡ˆä½¿ç”¨ safe_print æ›¿ä»£ print
from .logger import safe_print
safe_print("[LOG] Message")
```

### 3. API è·¯å¾‘è™•ç†

**å•é¡Œ**: å‰ç«¯ç›´é€£å¾Œç«¯æ™‚ï¼Œç›¸å°è·¯å¾‘ `/api/*` æœƒæŒ‡å‘å‰ç«¯ä¼ºæœå™¨ã€‚

**è§£æ±ºæ–¹æ¡ˆ**:
```typescript
// frontend/src/hooks/useSocket.ts
const isDev = window.location.hostname === 'localhost'
const apiBase = isDev ? 'http://localhost:8000' : ''
fetch(`${apiBase}/api/hardware/status`)  // âœ… çµ•å°è·¯å¾‘
```

### 4. ç‹€æ…‹å»£æ’­ç¯€æµ

**å•é¡Œ**: é«˜é »ç‡å»£æ’­æœƒå°è‡´ç¶²è·¯æ“å¡å’Œæ€§èƒ½å•é¡Œã€‚

**è§£æ±ºæ–¹æ¡ˆ**:
```python
# backend/app/socket_manager.py
self.broadcast_throttle_ms = 200  # æœ€å° 200ms é–“éš”

async def broadcast_state(self, force=False):
    now = datetime.now()
    if not force and self.last_broadcast_time:
        elapsed = (now - self.last_broadcast_time).total_seconds() * 1000
        if elapsed < self.broadcast_throttle_ms:
            return  # è·³ééæ–¼é »ç¹çš„å»£æ’­
    
    self.last_broadcast_time = now
    await self.sio.emit('system_state', self._serialize_state())
```

### 5. å¤šé€²ç¨‹å•é¡Œ

**å•é¡Œ**: Uvicorn çš„ `--workers > 1` æœƒå°è‡´ Socket.IO ç‹€æ…‹ä¸åŒæ­¥ã€‚

**è§£æ±ºæ–¹æ¡ˆ**:
```python
# backend/run.py
uvicorn.run(
    ...,
    workers=1,  # âš ï¸ Socket.IO å¿…é ˆä½¿ç”¨å–®ä¸€é€²ç¨‹
)
```

---

## ğŸ› æ•…éšœæ’é™¤æŒ‡å—

### å•é¡Œ 1: å‰ç«¯é¡¯ç¤º "é€šè¨Šä¸­æ–·"

**ç—‡ç‹€**:
- Header é¡¯ç¤ºç´…è‰² "é€šè¨Šä¸­æ–·"
- ç€è¦½å™¨ Console æœ‰ `[WS] âŒ Connection error`

**è¨ºæ–·æ­¥é©Ÿ**:
```powershell
# 1. æª¢æŸ¥å¾Œç«¯æ˜¯å¦é‹è¡Œ
Invoke-RestMethod -Uri "http://localhost:8000/"
# é æœŸ: {"name": "The Focus Enforcer v1.0", "status": "OPERATIONAL"}

# 2. æª¢æŸ¥ Socket.IO ç‹€æ…‹
Invoke-RestMethod -Uri "http://localhost:8000/test-socket"
# é æœŸ: {"socket_io_active": true, "connected_clients": N}

# 3. æª¢æŸ¥ç«¯å£ä½”ç”¨
netstat -ano | Select-String "8000|5173"
# é æœŸ: å…©å€‹ç«¯å£éƒ½æœ‰ LISTENING
```

**å¸¸è¦‹åŸå› èˆ‡è§£æ±º**:

1. **å¤šå€‹å¾Œç«¯å¯¦ä¾‹è¡çª**
   ```powershell
   # é—œé–‰æ‰€æœ‰ Python é€²ç¨‹
   Get-Process python* | Stop-Process -Force
   
   # é‡æ–°å•Ÿå‹•å–®ä¸€å¯¦ä¾‹
   Start-Process -FilePath "D:/Coding/IoTProject/.venv/Scripts/python.exe" `
                 -ArgumentList "d:\Coding\IoTProject\backend\run.py" `
                 -WindowStyle Hidden
   ```

2. **å‰ç«¯é€£ç·šé…ç½®éŒ¯èª¤**
   - æª¢æŸ¥ `useSocket.ts` ä¸­çš„ `socketUrl` æ˜¯å¦æ­£ç¢º
   - é–‹ç™¼ç’°å¢ƒæ‡‰ç›´é€£ `http://localhost:8000`

3. **ç‰ˆæœ¬ä¸ç›¸å®¹**
   ```powershell
   # å¾Œç«¯æª¢æŸ¥
   pip show python-socketio  # æ‡‰ç‚º 5.11.0
   
   # å‰ç«¯æª¢æŸ¥
   npm list socket.io-client  # æ‡‰ç‚º ^4.7.4
   ```

### å•é¡Œ 2: å¾Œç«¯ç«‹å³é—œé–‰

**ç—‡ç‹€**:
- å•Ÿå‹•å¾Œç«‹å³é€€å‡º
- çµ‚ç«¯é¡¯ç¤º `[Errno 2] No such file or directory`

**è§£æ±º**:
```powershell
# âŒ éŒ¯èª¤: ç›¸å°è·¯å¾‘
cd backend
python run.py

# âœ… æ­£ç¢º: çµ•å°è·¯å¾‘
D:/Coding/IoTProject/.venv/Scripts/python.exe d:\Coding\IoTProject\backend\run.py
```

### å•é¡Œ 3: WebSocket æ¡æ‰‹å¤±æ•—

**ç—‡ç‹€**:
- Console: `WebSocket connection failed`
- åªæœ‰ pollingï¼Œæ²’æœ‰å‡ç´šåˆ° WebSocket

**è¨ºæ–·**:
```javascript
// ç€è¦½å™¨ Console
socket.io.engine.transport.name  // æ‡‰ç‚º 'websocket'ï¼Œä¸æ˜¯ 'polling'
```

**è§£æ±º**:
1. æª¢æŸ¥ Vite proxy é…ç½®çš„ `ws: true`
2. æª¢æŸ¥é˜²ç«ç‰†æˆ–åå‘ä»£ç†è¨­å®š
3. VS Code Simple Browser å° WebSocket æ”¯æ´æœ‰é™ï¼Œæ”¹ç”¨ Chrome/Firefox

### å•é¡Œ 4: BrokenPipeError

**ç—‡ç‹€**:
```
BrokenPipeError: [Errno 32] Broken pipe
```

**è§£æ±º**:
- ç¢ºèªæ‰€æœ‰ `print()` å·²æ›¿æ›ç‚º `safe_print()`
- æª¢æŸ¥æª”æ¡ˆ:
  - `backend/app/socket_manager.py`
  - `backend/app/main.py`
  - `backend/run.py`
  - `backend/app/routers/*.py`

### å•é¡Œ 5: CORS éŒ¯èª¤

**ç—‡ç‹€**:
```
Access to XMLHttpRequest at 'http://localhost:8000' from origin 'http://localhost:5173' 
has been blocked by CORS policy
```

**è§£æ±º**:
```python
# backend/app/main.py
fastapi_app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],        # âš ï¸ ç”Ÿç”¢ç’°å¢ƒæ”¹ç‚ºå…·é«”åŸŸå
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

## ğŸš€ é–‹ç™¼ç’°å¢ƒè¨­ç½®

### å®Œæ•´å•Ÿå‹•æµç¨‹

#### 1. å¾Œç«¯å•Ÿå‹•
```powershell
# æ–¹æ³• A: PowerShell è…³æœ¬ï¼ˆæ¨è–¦ï¼‰
.\Start-FocusEnforcer.ps1

# æ–¹æ³• B: æ‰‹å‹•å•Ÿå‹•
D:/Coding/IoTProject/.venv/Scripts/python.exe d:\Coding\IoTProject\backend\run.py

# æ–¹æ³• C: èƒŒæ™¯åŸ·è¡Œ
Start-Process -FilePath "D:/Coding/IoTProject/.venv/Scripts/python.exe" `
              -ArgumentList "d:\Coding\IoTProject\backend\run.py" `
              -WindowStyle Hidden
```

#### 2. å‰ç«¯å•Ÿå‹•
```powershell
cd frontend
npm run dev
# æˆ–
cd d:\Coding\IoTProject\frontend
npm run dev
```

#### 3. é©—è­‰é€£ç·š
```powershell
# å¾Œç«¯å¥åº·æª¢æŸ¥
curl http://localhost:8000/

# Socket.IO æª¢æŸ¥
curl http://localhost:8000/test-socket

# å‰ç«¯è¨ªå•
Start-Process "http://localhost:5173"
```

### ç’°å¢ƒè®Šæ•¸é…ç½®

**æª”æ¡ˆ**: `backend/.env` (å¯é¸)
```env
# ä¼ºæœå™¨é…ç½®
HOST=0.0.0.0
PORT=8000
DEBUG=False

# ç¡¬é«”æ¨¡å¼
MOCK_HARDWARE=False
MOCK_INTERVAL_MS=1000

# ç¤¾äº¤åª’é«”æ•´åˆ
GMAIL_SMTP_SERVER=smtp.gmail.com
GMAIL_SMTP_PORT=587
# ... (å…¶ä»–æ†‘è­‰)
```

### ä¾è³´å®‰è£

```powershell
# å¾Œç«¯
cd backend
pip install -r requirements.txt
playwright install  # å®‰è£ç€è¦½å™¨é©…å‹•

# å‰ç«¯
cd frontend
npm install
```

---

## ğŸ“Š é€£ç·šç‹€æ…‹ç›£æ§

### å¾Œç«¯æ—¥èªŒ
```
======================================================================
Starting The Focus Enforcer v1.0
Host: 0.0.0.0:8000
Debug Mode: False
Mock Hardware: False
======================================================================
[Socket.IO] Server initialized
INFO:     Started server process [24304]
INFO:     Uvicorn running on http://0.0.0.0:8000
INFO:     127.0.0.1:62347 - "GET /socket.io/?EIO=4&transport=polling&t=29hyq4ta HTTP/1.1" 200 OK
[WS] Client connected: VHNGvrRX04VYvofkAAAB
INFO:     ('127.0.0.1', 62729) - "WebSocket /socket.io/?EIO=4&transport=websocket&sid=DjBLpr1Y048zJcPRAAAA" [accepted]
INFO:     connection open
```

### å‰ç«¯ Console
```javascript
[WS] Initializing Socket.IO client...
[WS] Connecting to: http://localhost:8000
[WS] Socket instance created
[WS] âœ… Connected to Focus Enforcer v1.0
[WS] Socket ID: DjBLpr1Y048zJcPRAAAA
[WS] Setting connected = true
[WS] Initial hardware status: {connected: true, mock_mode: false, ...}
```

### å¥åº·æª¢æŸ¥ API
```powershell
# ç³»çµ±ç‹€æ…‹
curl http://localhost:8000/ | ConvertFrom-Json

# Socket.IO ç‹€æ…‹
curl http://localhost:8000/test-socket | ConvertFrom-Json

# ç¡¬é«”ç‹€æ…‹
curl http://localhost:8000/api/hardware/status | ConvertFrom-Json
```

---

## ğŸ“ é‡è¦æ³¨æ„äº‹é …

### âœ… æˆåŠŸé‹è¡Œçš„é—œéµè¦ç´ 

1. **å–®ä¸€å¾Œç«¯å¯¦ä¾‹**: é¿å…å¤šé€²ç¨‹ç«¶çˆ­
2. **æ­£ç¢ºçš„äº‹ä»¶å¾ªç’°**: Windows å¿…é ˆä½¿ç”¨ `ProactorEventLoop`
3. **ç‰ˆæœ¬ç›¸å®¹æ€§**: `python-socketio` 5.11.0 + `socket.io-client` 4.7.4
4. **ç›´é€£å¾Œç«¯**: é–‹ç™¼ç’°å¢ƒç›´æ¥é€£æ¥ `localhost:8000`ï¼Œä¸ä¾è³´ Vite ä»£ç†
5. **å®‰å…¨åˆ—å°**: æ‰€æœ‰ `print()` ä½¿ç”¨ `safe_print()` åŒ…è£
6. **ASGI æ•´åˆ**: ä½¿ç”¨ `socketio.ASGIApp` æ­£ç¢ºåŒ…è£ FastAPI
7. **è·¯å¾‘ä¸€è‡´**: å‰å¾Œç«¯çš„ `path` å¿…é ˆç‚º `/socket.io/`

### âš ï¸ å¸¸è¦‹é™·é˜±

1. **ä¸è¦ä½¿ç”¨å¤š worker**: `uvicorn --workers > 1` æœƒç ´å£ Socket.IO ç‹€æ…‹
2. **ä¸è¦ä¾è³´ Simple Browser**: VS Code å…§å»ºç€è¦½å™¨å° WebSocket æ”¯æ´æœ‰é™
3. **ä¸è¦æ··ç”¨äº‹ä»¶å¾ªç’°**: ç¢ºä¿æ•´å€‹å°ˆæ¡ˆä½¿ç”¨ç›¸åŒçš„äº‹ä»¶å¾ªç’°ç­–ç•¥
4. **ä¸è¦åœ¨ç›¸å°è·¯å¾‘ä¸­ä½¿ç”¨ API**: ç›´é€£æ™‚å¿…é ˆä½¿ç”¨çµ•å° URL

---

## ğŸ”— åƒè€ƒè³‡æº

- [Socket.IO Server (Python) æ–‡ä»¶](https://python-socketio.readthedocs.io/)
- [Socket.IO Client (JavaScript) æ–‡ä»¶](https://socket.io/docs/v4/client-api/)
- [FastAPI WebSocket æ–‡ä»¶](https://fastapi.tiangolo.com/advanced/websockets/)
- [Uvicorn éƒ¨ç½²æŒ‡å—](https://www.uvicorn.org/deployment/)

---

**æ–‡ä»¶ç¶­è­·**: ç•¶ä¿®æ”¹ Socket.IO ç›¸é—œä»£ç¢¼æ™‚ï¼Œè«‹åŒæ­¥æ›´æ–°æœ¬æ–‡ä»¶ã€‚  
**é©—è­‰ç‹€æ…‹**: æœ¬æ–‡ä»¶åŸºæ–¼ 2025-12-22 çš„æˆåŠŸé‹è¡Œé…ç½®ç·¨å¯«ã€‚
</file>

<file path="Setup-GitRemote.ps1">
# Git Remote Setup Helper
# Help configure origin remote

Write-Host "======================================" -ForegroundColor Cyan
Write-Host "  Git Remote Configuration Tool" -ForegroundColor Cyan
Write-Host "======================================" -ForegroundColor Cyan
Write-Host ""

# Check current remotes
Write-Host "[1] Current Remote Configuration:" -ForegroundColor Yellow
$remotes = git remote -v
if ([string]::IsNullOrWhiteSpace($remotes)) {
    Write-Host "   No remotes configured" -ForegroundColor Red
} else {
    Write-Host $remotes -ForegroundColor Green
}

Write-Host ""
Write-Host "[2] Configure Origin Remote:" -ForegroundColor Yellow
Write-Host ""
Write-Host "Example GitHub URL:" -ForegroundColor Cyan
Write-Host "  - HTTPS: https://github.com/username/repository.git" -ForegroundColor Cyan
Write-Host "  - SSH:   git@github.com:username/repository.git" -ForegroundColor Cyan
Write-Host ""

$url = Read-Host "Enter your repository URL"

if ([string]::IsNullOrWhiteSpace($url)) {
    Write-Host "[X] URL cannot be empty" -ForegroundColor Red
    exit 1
}

# Check if origin already exists
$existingOrigin = git config --get remote.origin.url
if ($null -ne $existingOrigin) {
    Write-Host ""
    Write-Host "[!] Origin already exists: $existingOrigin" -ForegroundColor Yellow
    $replace = Read-Host "Replace it? (yes/no)"
    
    if ($replace -ne "yes") {
        Write-Host "Cancelled" -ForegroundColor Yellow
        exit 0
    }
    
    git remote remove origin
    Write-Host "[OK] Removed existing origin" -ForegroundColor Green
}

# Add origin
Write-Host ""
Write-Host "[3] Adding origin..." -ForegroundColor Yellow

git remote add origin $url

if ($LASTEXITCODE -eq 0) {
    Write-Host "[OK] Origin configured successfully!" -ForegroundColor Green
    Write-Host ""
    Write-Host "New configuration:" -ForegroundColor Cyan
    git remote -v
} else {
    Write-Host "[X] Failed to add origin" -ForegroundColor Red
    exit 1
}

Write-Host ""
Write-Host "[4] Next Steps:" -ForegroundColor Cyan
Write-Host "   1. Run: git fetch origin" -ForegroundColor Cyan
Write-Host "   2. Run: git branch -u origin/master master" -ForegroundColor Cyan
Write-Host "   3. Or use: .\Git-QuickPush.ps1" -ForegroundColor Cyan
Write-Host ""

# Optional: Check connectivity
$checkConnection = Read-Host "Test connection to repository? (yes/no)"
if ($checkConnection -eq "yes") {
    Write-Host ""
    Write-Host "[*] Testing connection..." -ForegroundColor Yellow
    
    git ls-remote origin HEAD
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "[OK] Connection successful!" -ForegroundColor Green
    } else {
        Write-Host "[!] Connection test failed - check your credentials" -ForegroundColor Yellow
    }
}

Write-Host ""
</file>

<file path="Setup.ps1">
# Focus Enforcer - Setup Script
# This script sets up the development environment

$ErrorActionPreference = "Stop"

Write-Host ""
Write-Host "============================================" -ForegroundColor Cyan
Write-Host "  Focus Enforcer - Environment Setup" -ForegroundColor Cyan
Write-Host "============================================" -ForegroundColor Cyan
Write-Host ""

$BackendPath = Join-Path $PSScriptRoot "backend"
$FrontendPath = Join-Path $PSScriptRoot "frontend"

# Check Python
Write-Host "[1/6] Checking Python..." -ForegroundColor Green
try {
    $pythonVersion = python --version 2>&1
    Write-Host "      Found: $pythonVersion" -ForegroundColor White
} catch {
    Write-Host "[ERROR] Python not found! Please install Python 3.8+" -ForegroundColor Red
    Write-Host "        Download: https://www.python.org/downloads/" -ForegroundColor Yellow
    exit 1
}

# Check Node.js
Write-Host "[2/6] Checking Node.js..." -ForegroundColor Green
try {
    $nodeVersion = node --version 2>&1
    $npmVersion = npm --version 2>&1
    Write-Host "      Found: Node $nodeVersion, npm $npmVersion" -ForegroundColor White
} catch {
    Write-Host "[ERROR] Node.js not found! Please install Node.js 18+" -ForegroundColor Red
    Write-Host "        Download: https://nodejs.org/" -ForegroundColor Yellow
    exit 1
}

# Create Python virtual environment
Write-Host "[3/6] Setting up Python virtual environment..." -ForegroundColor Green
Push-Location $BackendPath
if (Test-Path "venv") {
    Write-Host "      Virtual environment already exists" -ForegroundColor Gray
} else {
    python -m venv venv
    Write-Host "      Virtual environment created" -ForegroundColor White
}

# Install Python dependencies
Write-Host "[4/6] Installing Python dependencies..." -ForegroundColor Green
& "venv\Scripts\python.exe" -m pip install --upgrade pip --quiet
& "venv\Scripts\pip.exe" install -r requirements.txt --quiet
Write-Host "      Python packages installed" -ForegroundColor White

# Install Playwright browsers
Write-Host "      Installing Playwright browsers (Chromium)..." -ForegroundColor Gray
& "venv\Scripts\playwright.exe" install chromium --quiet
Write-Host "      Playwright browsers installed" -ForegroundColor White

Pop-Location

# Install frontend dependencies
Write-Host "[5/6] Installing frontend dependencies..." -ForegroundColor Green
Push-Location $FrontendPath
npm install --silent
Write-Host "      Node packages installed" -ForegroundColor White
Pop-Location

# Create config files
Write-Host "[6/6] Creating configuration files..." -ForegroundColor Green

# Copy .env.example to .env
$EnvPath = Join-Path $BackendPath ".env"
$EnvExamplePath = Join-Path $BackendPath ".env.example"
if (-not (Test-Path $EnvPath)) {
    Copy-Item $EnvExamplePath $EnvPath
    Write-Host "      Created .env file" -ForegroundColor White
    Write-Host "      [ACTION REQUIRED] Edit backend/.env to configure settings" -ForegroundColor Yellow
} else {
    Write-Host "      .env already exists" -ForegroundColor Gray
}

# Copy credentials.example.json to credentials.json
$CredPath = Join-Path $BackendPath "credentials.json"
$CredExamplePath = Join-Path $BackendPath "credentials.example.json"
if (-not (Test-Path $CredPath)) {
    Copy-Item $CredExamplePath $CredPath
    Write-Host "      Created credentials.json file" -ForegroundColor White
} else {
    Write-Host "      credentials.json already exists" -ForegroundColor Gray
}

Write-Host ""
Write-Host "============================================" -ForegroundColor Green
Write-Host "  Setup Complete!" -ForegroundColor Green
Write-Host "============================================" -ForegroundColor Green
Write-Host ""
Write-Host "Next steps:" -ForegroundColor White
Write-Host "  1. Edit backend/.env to configure your settings" -ForegroundColor Yellow
Write-Host "  2. Run .\Start-FocusEnforcer.ps1 to start the system" -ForegroundColor Yellow
Write-Host ""
Write-Host "For hardware setup, see MARKDOWN/SETUP.md" -ForegroundColor Gray
Write-Host ""

Read-Host "Press Enter to exit"
</file>

<file path="Stop-FocusEnforcer.ps1">
# Focus Enforcer - Stop Script
# This script stops all running servers

Write-Host ""
Write-Host "============================================" -ForegroundColor Cyan
Write-Host "  Focus Enforcer - Stopping Services" -ForegroundColor Cyan
Write-Host "============================================" -ForegroundColor Cyan
Write-Host ""

$BackendPath = Join-Path $PSScriptRoot "backend"
$FrontendPath = Join-Path $PSScriptRoot "frontend"

# Find and kill backend processes
Write-Host "Stopping backend servers..." -ForegroundColor Yellow
$BackendProcesses = Get-WmiObject Win32_Process | Where-Object {
    ($_.CommandLine -like "*uvicorn*" -or $_.CommandLine -like "*python*run.py*") -and 
    $_.CommandLine -like "*$BackendPath*"
}

if ($BackendProcesses) {
    foreach ($proc in $BackendProcesses) {
        Stop-Process -Id $proc.ProcessId -Force -ErrorAction SilentlyContinue
        Write-Host "  Stopped process $($proc.ProcessId)" -ForegroundColor Gray
    }
    Write-Host "  Backend stopped" -ForegroundColor Green
} else {
    Write-Host "  No backend processes found" -ForegroundColor Gray
}

# Find and kill frontend processes
Write-Host "Stopping frontend servers..." -ForegroundColor Yellow
$FrontendProcesses = Get-WmiObject Win32_Process | Where-Object {
    ($_.CommandLine -like "*vite*" -or $_.CommandLine -like "*npm*run*dev*") -and 
    $_.CommandLine -like "*$FrontendPath*"
}

if ($FrontendProcesses) {
    foreach ($proc in $FrontendProcesses) {
        Stop-Process -Id $proc.ProcessId -Force -ErrorAction SilentlyContinue
        Write-Host "  Stopped process $($proc.ProcessId)" -ForegroundColor Gray
    }
    Write-Host "  Frontend stopped" -ForegroundColor Green
} else {
    Write-Host "  No frontend processes found" -ForegroundColor Gray
}

# Kill any processes using the default ports
Write-Host "Checking default ports..." -ForegroundColor Yellow
$Connections = Get-NetTCPConnection -LocalPort 8000,5173 -ErrorAction SilentlyContinue
if ($Connections) {
    foreach ($conn in $Connections) {
        $proc = Get-Process -Id $conn.OwningProcess -ErrorAction SilentlyContinue
        if ($proc) {
            Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
            Write-Host "  Stopped process $($proc.Id) on port $($conn.LocalPort)" -ForegroundColor Gray
        }
    }
}

Write-Host ""
Write-Host "============================================" -ForegroundColor Green
Write-Host "  All services stopped" -ForegroundColor Green
Write-Host "============================================" -ForegroundColor Green
Write-Host ""
</file>

<file path="test_socket_client.py">
import socketio

# Create Socket.IO client
sio = socketio.Client(logger=True, engineio_logger=True)

@sio.on('connect')
def on_connect():
    print('âœ… Connected to server!')
    print(f'Socket ID: {sio.sid}')

@sio.on('disconnect')
def on_disconnect():
    print('âŒ Disconnected from server')

@sio.on('system_state')
def on_system_state(data):
    print('ğŸ“¡ Received system_state event')

@sio.on('hardware_status')
def on_hardware_status(data):
    print('ğŸ”§ Received hardware_status event')

try:
    print('Connecting to http://localhost:8000...')
    sio.connect('http://localhost:8000', socketio_path='/socket.io/')
    print('Waiting for events...')
    sio.wait()
except Exception as e:
    print(f'âŒ Connection failed: {e}')
</file>

<file path="test-socket.html">
<!DOCTYPE html>
<html>
<head>
    <title>Socket.IO Connection Test</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
</head>
<body>
    <h1>Socket.IO Connection Test</h1>
    <div id="status">Connecting...</div>
    <div id="log" style="font-family: monospace; white-space: pre;"></div>
    
    <script>
        const log = document.getElementById('log');
        const status = document.getElementById('status');
        
        function addLog(msg) {
            log.textContent += new Date().toLocaleTimeString() + ' - ' + msg + '\n';
            console.log(msg);
        }
        
        addLog('Starting Socket.IO client...');
        
        // Test connection to backend
        const socket = io('http://localhost:8000', {
            transports: ['websocket', 'polling'],
            path: '/socket.io/',
            reconnection: true,
        });
        
        socket.on('connect', () => {
            status.textContent = 'âœ… CONNECTED';
            status.style.color = 'green';
            addLog('âœ… Connected! Socket ID: ' + socket.id);
        });
        
        socket.on('disconnect', (reason) => {
            status.textContent = 'âŒ DISCONNECTED: ' + reason;
            status.style.color = 'red';
            addLog('âŒ Disconnected: ' + reason);
        });
        
        socket.on('connect_error', (error) => {
            status.textContent = 'âŒ CONNECTION ERROR';
            status.style.color = 'red';
            addLog('âŒ Connection error: ' + error.message);
            addLog('Error details: ' + JSON.stringify(error));
        });
        
        socket.on('system_state', (data) => {
            addLog('ğŸ“¡ Received system_state event');
        });
        
        socket.on('hardware_status', (data) => {
            addLog('ğŸ”§ Received hardware_status event');
        });
    </script>
</body>
</html>
</file>

<file path=".gitignore">
# PlatformIO
.pio
.vscode/.browse.c_cpp.db*
.vscode/c_cpp_properties.json
.vscode/launch.json
.vscode/ipch

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
.venv/
venv/
ENV/
env/

# Sensitive data - DO NOT COMMIT
backend/credentials.json
backend/browser_contexts/
backend/hostage_evidence/
backend/.env.example
.env
.env.local
*.key
*.pem

# Node.js / Frontend
node_modules/
dist/
.cache/
*.log

# OS files
.DS_Store
Thumbs.db
*.swp
*.swo
*~

# IDE
.vscode/settings.json
.idea/
</file>

<file path="backend/app/main.py">
"""
THE FOCUS ENFORCER v1.0
========================
Zero-Trust Focus Monitoring with Social Shaming Enforcement

A hardware-software integrated system designed to enforce focus through
"Zero-Trust" monitoring and "Social Shaming" penalties.
"""

import asyncio
import sys
from contextlib import asynccontextmanager
from fastapi import FastAPI, WebSocket, WebSocketDisconnect, Request, Response
from fastapi.middleware.cors import CORSMiddleware
from starlette.middleware.base import BaseHTTPMiddleware
import socketio
import uvicorn
import json
from datetime import datetime

# Fix for Windows - Playwright requires ProactorEventLoop on all Python versions
if sys.platform == 'win32':
    asyncio.set_event_loop_policy(asyncio.WindowsProactorEventLoopPolicy())

from .config import settings
from .logger import safe_print
from .socket_manager import socket_manager
from .automation.social_manager import social_manager
from .routers import sessions, social, hardware, hostage


@asynccontextmanager
async def lifespan(app: FastAPI):
    """Application lifespan handler."""
    safe_print("=" * 65)
    safe_print(" " * 10 + "THE FOCUS ENFORCER v1.0")
    safe_print(" " * 5 + "Zero-Trust Monitoring | Social Shame Protocol")
    safe_print(" " * 10 + "Direct API Integration")
    safe_print("=" * 65)
    
    # Register social manager as penalty callback (Direct API integration)
    socket_manager.register_penalty_callback(social_manager.execute_penalty)
    
    # Start mock hardware if configured
    if settings.MOCK_HARDWARE:
        safe_print("[SYSTEM] Mock hardware mode enabled - starting simulation...")
        await socket_manager.start_mock_hardware()
    
    safe_print(f"[SYSTEM] Server running at http://{settings.HOST}:{settings.PORT}")
    safe_print(f"[SYSTEM] Socket.IO endpoint: http://{settings.HOST}:{settings.PORT}/socket.io/")
    safe_print(f"[SYSTEM] Direct integrations: Gmail âœ‰ï¸  | Threads ğŸ§µ")
    
    yield
    
    # Cleanup
    safe_print("[SYSTEM] Shutting down...")
    await socket_manager.stop_mock_hardware()
    await social_manager.shutdown()


# Create FastAPI app
fastapi_app = FastAPI(
    title=settings.APP_NAME,
    description="Zero-Trust Focus Monitoring with Social Shaming Enforcement",
    version="1.0.0",
    lifespan=lifespan
)

# CORS middleware for frontend
fastapi_app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Include routers
fastapi_app.include_router(sessions.router)
fastapi_app.include_router(social.router)
fastapi_app.include_router(hardware.router)
fastapi_app.include_router(hostage.router)

# Socket.IO integration - Wrap FastAPI app with Socket.IO
# This is the CORRECT way for python-socketio with FastAPI
app = socketio.ASGIApp(
    socket_manager.sio,
    other_asgi_app=fastapi_app,
    socketio_path='socket.io'  # Path WITHOUT leading slash!
)


@fastapi_app.get("/test-socket")
async def test_socket():
    """Test endpoint to verify Socket.IO server status."""
    return {
        "socket_io_active": True,
        "connected_clients": len(socket_manager.connected_clients),
        "mock_mode": socket_manager.mock_mode_active,
        "hardware_connected": socket_manager.hardware_connected
    }


@fastapi_app.websocket("/ws/hardware")
async def hardware_websocket(websocket: WebSocket):
    """Native WebSocket endpoint for D1-mini hardware."""
    await websocket.accept()
    hardware_id = "UNKNOWN"
    hardware_registered = False  # Track if hardware_connect event was received
    safe_print(f"[HARDWARE WS] âœ… D1-mini connected from {websocket.client}")
    
    # Mark physical hardware WebSocket as connected
    socket_manager.physical_hardware_ws_connected = True
    
    # If mock mode is active, we still accept connection but ignore all data
    if socket_manager.mock_mode_active:
        safe_print("[HARDWARE WS] âš ï¸ Mock mode active - physical hardware data will be ignored")
    else:
        # Set hardware connected immediately, but wait for hardware_connect event for sensor info
        socket_manager.hardware_connected = True
    
    try:
        while True:
            # Receive sensor data from D1-mini
            try:
                data_str = await websocket.receive_text()
            except Exception as e:
                safe_print(f"[HARDWARE WS] Error receiving data: {e}")
                break
            
            # If mock mode is active, ignore all physical hardware data
            if socket_manager.mock_mode_active:
                continue
            
            try:
                raw_data = json.loads(data_str)
            except json.JSONDecodeError as e:
                safe_print(f"[HARDWARE WS] JSON decode error: {e}")
                continue
            
            # Parse Socket.IO format: ["event_name", {data}]
            if isinstance(raw_data, list) and len(raw_data) >= 2:
                event_name = raw_data[0]
                event_data = raw_data[1]
            elif isinstance(raw_data, dict):
                # Fallback for dict format
                event_name = raw_data.get('event', 'sensor_data')
                event_data = raw_data
            else:
                if settings.DEBUG:
                    safe_print(f"[HARDWARE WS] Unknown data format: {type(raw_data)}")
                continue
            
            # Check if it's a heartbeat or hardware_connect event
            if event_name == 'heartbeat':
                # Heartbeats are now silent - no logging
                continue
            elif event_name == 'hardware_connect':
                hardware_id = event_data.get('hardware_id', 'UNKNOWN')
                board = event_data.get('board', 'D1-mini')
                version = event_data.get('version', '1.0')
                nfc_detected = event_data.get('nfc_detected', True)
                gyro_detected = event_data.get('gyro_detected', True)
                radar_detected = event_data.get('radar_detected', True)
                safe_print(f"[HARDWARE WS] ğŸ’» {hardware_id} | {board} v{version} | NFC: {nfc_detected} | Gyro: {gyro_detected} | Radar: {radar_detected}")
                
                # Update physical hardware sensor detection status
                socket_manager.hardware_connected = True
                socket_manager.physical_nfc_detected = nfc_detected
                socket_manager.physical_gyro_detected = gyro_detected
                socket_manager.physical_radar_detected = radar_detected
                hardware_registered = True
                
                # Broadcast updated hardware status with sensor info
                await socket_manager.broadcast_event('hardware_status', {
                    'connected': True,
                    'mock_mode': False,
                    'hardware_id': hardware_id,
                    'version': version,
                    'board': board,
                    'nfc_detected': nfc_detected,
                    'gyro_detected': gyro_detected,
                    'ldr_detected': gyro_detected,
                    'hall_detected': gyro_detected,
                    'ir_detected': gyro_detected,
                    'radar_detected': radar_detected,
                    'lcd_detected': False,
                    'mock_state': socket_manager.mock_state.to_dict()
                })
                continue
            
            # Process sensor data
            if event_name == 'sensor_data':
                # If hardware hasn't registered yet, extract sensor info from data
                if not hardware_registered:
                    nfc_det = event_data.get('nfc_detected', True)
                    gyro_det = event_data.get('gyro_detected', True)
                    radar_det = event_data.get('radar_detected', True)
                    socket_manager.physical_nfc_detected = nfc_det
                    socket_manager.physical_gyro_detected = gyro_det
                    socket_manager.physical_radar_detected = radar_det
                    hardware_registered = True
                    
                    # Broadcast initial status from sensor data
                    await socket_manager.broadcast_event('hardware_status', {
                        'connected': True,
                        'mock_mode': False,
                        'hardware_id': event_data.get('hardware_id', 'UNKNOWN'),
                        'nfc_detected': nfc_det,
                        'gyro_detected': gyro_det,
                        'ldr_detected': gyro_det,
                        'hall_detected': gyro_det,
                        'ir_detected': gyro_det,
                        'radar_detected': radar_det,
                        'lcd_detected': False,
                        'mock_state': socket_manager.mock_state.to_dict()
                    })
                
                now = datetime.now()
                last_log = socket_manager.last_log_time.get('hw_sensor_data')
                if last_log is None or (now - last_log).total_seconds() >= 5.0:  # Log every 5 seconds
                    safe_print(f"[HARDWARE WS] ğŸ“Š Sensor data flowing...")
                    socket_manager.last_log_time['hw_sensor_data'] = now
            
            await socket_manager.process_sensor_data(event_data)
            
    except WebSocketDisconnect:
        safe_print(f"[HARDWARE WS] ğŸ”Œ {hardware_id} disconnected")
    except Exception as e:
        safe_print(f"[HARDWARE WS] âŒ Error: {e}")
    finally:
        # Mark physical hardware WebSocket as disconnected
        socket_manager.physical_hardware_ws_connected = False
        
        # Only update status if mock mode is not active
        if not socket_manager.mock_mode_active:
            socket_manager.hardware_connected = False
            socket_manager.physical_nfc_detected = False
            socket_manager.physical_gyro_detected = False
            
            # Broadcast hardware disconnect
            await socket_manager.broadcast_event('hardware_status', {
                'connected': False,
                'mock_mode': False,
                'mock_state': socket_manager.mock_state.to_dict(),
                'nfc_detected': False,
                'gyro_detected': False,
                'ldr_detected': False,
                'hall_detected': False,
                'ir_detected': False,
                'radar_detected': False,
                'lcd_detected': False
            })
        
        safe_print("[HARDWARE WS] â¹ï¸  Connection closed")


@fastapi_app.get("/")
async def root():
    """Health check endpoint."""
    return {
        "name": settings.APP_NAME,
        "version": "1.0.0",
        "status": "OPERATIONAL",
        "hardware_connected": socket_manager.hardware_connected,
        "active_session": socket_manager.state.session is not None
    }


@fastapi_app.get("/api/state")
async def get_system_state():
    """Get complete system state."""
    state = socket_manager.state.model_dump()
    if socket_manager.state.session:
        if socket_manager.state.session.start_time:
            state['session']['start_time'] = socket_manager.state.session.start_time.isoformat()
        if socket_manager.state.session.end_time:
            state['session']['end_time'] = socket_manager.state.session.end_time.isoformat()
    if socket_manager.state.person_away_since:
        state['person_away_since'] = socket_manager.state.person_away_since.isoformat()
    return state


if __name__ == "__main__":
    uvicorn.run(
        "app.main:app",
        host=settings.HOST,
        port=settings.PORT,
        reload=settings.DEBUG
    )
</file>

<file path="backend/app/models.py">
from pydantic import BaseModel
from typing import Optional, List
from enum import Enum
from datetime import datetime


class PhoneStatus(str, Enum):
    LOCKED = "LOCKED"
    REMOVED = "REMOVED"
    UNKNOWN = "UNKNOWN"


class PresenceStatus(str, Enum):
    DETECTED = "DETECTED"
    AWAY = "AWAY"
    UNKNOWN = "UNKNOWN"


class BoxStatus(str, Enum):
    CLOSED = "CLOSED"
    OPEN = "OPEN"
    UNKNOWN = "UNKNOWN"


class NoiseStatus(str, Enum):
    QUIET = "QUIET"
    NOISY = "NOISY"
    UNKNOWN = "UNKNOWN"


class SessionStatus(str, Enum):
    IDLE = "IDLE"
    ACTIVE = "ACTIVE"
    PAUSED = "PAUSED"
    VIOLATED = "VIOLATED"
    COMPLETED = "COMPLETED"


# ============================================================================
# v1.0 æ–°å¢: ç¡¬é«”ç‹€æ…‹æ©Ÿç‹€æ…‹ (èˆ‡éŸŒé«”åŒæ­¥)
# ============================================================================
class HardwareState(str, Enum):
    """Hardware state machine states - synced with firmware."""
    IDLE = "IDLE"               # å¾…æ©Ÿç‹€æ…‹ - ç­‰å¾…é–‹å§‹æŒ‡ä»¤
    PREPARING = "PREPARING"     # æº–å‚™ä¸­ - 10 ç§’å¯¬é™æœŸ
    FOCUSING = "FOCUSING"       # å°ˆæ³¨ä¸­ - ç›£æ¸¬é•è¦è¡Œç‚º
    PAUSED = "PAUSED"           # æš«åœä¸­ - æš«æ™‚åœæ­¢ç›£æ¸¬
    VIOLATION = "VIOLATION"     # é•è¦ç‹€æ…‹ - åµæ¸¬åˆ°é•è¦è¡Œç‚º
    ERROR = "ERROR"             # éŒ¯èª¤ç‹€æ…‹ - ç³»çµ±ç•°å¸¸


# ============================================================================
# æ„Ÿæ¸¬å™¨è³‡æ–™æ¨¡å‹
# ============================================================================
class SensorData(BaseModel):
    """Sensor data from hardware - v1.0 format."""
    # ç¡¬é«”ç‹€æ…‹æ©Ÿç‹€æ…‹ (v1.0 æ–°å¢)
    state: Optional[str] = None  # HardwareState enum value
    
    # éœçˆ¾æ„Ÿæ¸¬å™¨ (v1.0 æ–°å¢, å–ä»£ LDR)
    box_open: bool = False      # Hall sensor - True = box is open (violation)
    
    # é›·é”æ„Ÿæ¸¬å™¨
    radar_presence: bool = False
    
    # æ™‚é–“æˆ³è¨˜
    timestamp: Optional[int] = None
    uptime: Optional[int] = None  # ç¡¬é«”é‹è¡Œæ™‚é–“ (ç§’)
    
    # Legacy ç›¸å®¹æ€§æ¬„ä½ (ä¿ç•™çµ¦èˆŠç‰ˆéŸŒé«”)
    nfc_id: Optional[str] = None
    gyro_x: float = 0.0
    gyro_y: float = 0.0
    gyro_z: float = 0.0
    mic_db: int = 40
    box_locked: bool = False
    nfc_detected: bool = False
    gyro_detected: bool = False
    ldr_detected: bool = False
    radar_detected: bool = False


class PenaltyConfig(BaseModel):
    """Granular penalty configuration - which sensors trigger violations."""
    enable_phone_penalty: bool = True     # NFC - phone removal triggers penalty
    enable_presence_penalty: bool = True  # Radar - leaving seat triggers penalty
    enable_noise_penalty: bool = False    # Mic - noise triggers penalty (default off for cafes)
    enable_box_open_penalty: bool = True  # Hall - opening box triggers penalty
    noise_threshold_db: int = 70          # dB threshold for noise violation


class FocusSession(BaseModel):
    id: str
    duration_minutes: int
    start_time: Optional[datetime] = None
    end_time: Optional[datetime] = None
    status: SessionStatus = SessionStatus.IDLE
    violations: int = 0
    penalties_executed: int = 0
    penalty_config: PenaltyConfig = PenaltyConfig()
    # v1.0: Pause/Resume tracking
    paused_at: Optional[datetime] = None  # When the session was paused
    total_paused_seconds: int = 0  # Total time spent paused


class SocialPlatform(str, Enum):
    DISCORD = "discord"
    THREADS = "threads"
    GMAIL = "gmail"


class PenaltySettings(BaseModel):
    enabled_platforms: List[SocialPlatform] = []
    custom_messages: dict = {
        "discord": "ğŸš¨ è­¦å ±ï¼šæˆ‘æ˜¯ä¸€å€‹æ²’æœ‰æ¯…åŠ›çš„å»¢ç‰©ï¼Œå‰›æ‰çš„å°ˆæ³¨æŒ‘æˆ°å¤±æ•—äº†ã€‚è«‹ç›¡æƒ…å˜²ç¬‘æˆ‘ã€‚ ğŸš¨",
        "threads": "ğŸ“¢ ç³»çµ±å…¬å‘Šï¼šä½¿ç”¨è€…è‡ªå¾‹å”å®šé•è¦ï¼Œå°ˆæ³¨ä»»å‹™åŸ·è¡Œå¤±æ•—ã€‚é€™æ˜¯æ¥è¾±çš„å°è¨˜ã€‚",
        "gmail": "ğŸ“§ å°ˆæ³¨åŸ·æ³•è€…é€šå ±ï¼šæˆ‘ç„¡æ³•å®Œæˆå°ˆæ³¨ä»»å‹™ï¼Œé€™æ˜¯æˆ‘çš„æ¥è¾±ã€‚"
    }
    gmail_recipients: List[str] = []
    include_timestamp: bool = True
    include_violation_count: bool = True


# ============================================================================
# ç³»çµ±ç‹€æ…‹æ¨¡å‹ (v1.0 æ›´æ–°)
# ============================================================================
class SystemState(BaseModel):
    session: Optional[FocusSession] = None
    phone_status: PhoneStatus = PhoneStatus.UNKNOWN
    presence_status: PresenceStatus = PresenceStatus.UNKNOWN
    box_status: BoxStatus = BoxStatus.UNKNOWN
    noise_status: NoiseStatus = NoiseStatus.UNKNOWN
    current_db: int = 40
    last_sensor_data: Optional[SensorData] = None
    
    # v1.0 æ–°å¢: ç¡¬é«”ç‹€æ…‹æ©Ÿ
    hardware_state: HardwareState = HardwareState.IDLE
    
    # v1.0 æ–°å¢: æº–å‚™å€’æ•¸
    prepare_remaining_ms: int = 0  # æº–å‚™å¯¬é™æœŸå‰©é¤˜æ™‚é–“ (æ¯«ç§’)
    
    # Legacy ç›¸å®¹æ€§
    person_away_since: Optional[datetime] = None
    penalty_settings: PenaltySettings = PenaltySettings()
    penalty_config: PenaltyConfig = PenaltyConfig()  # Global default penalty config


class WebSocketMessage(BaseModel):
    type: str
    payload: dict
</file>

<file path="backend/app/routers/hardware.py">
from fastapi import APIRouter
from pydantic import BaseModel

from ..socket_manager import socket_manager

router = APIRouter(prefix="/api/hardware", tags=["hardware"])


class MockControlRequest(BaseModel):
    enabled: bool


@router.get("/status")
async def get_hardware_status():
    """Get current hardware connection status (v1.0)."""
    # Use helper method to get consistent sensor detection status
    nfc_detected, ldr_detected, radar_detected = socket_manager.get_sensor_detection_status()
    
    return {
        "connected": socket_manager.hardware_connected,
        "mock_mode": socket_manager.mock_mode_active,
        "mock_state": socket_manager.mock_state.to_dict(),
        "last_sensor_data": socket_manager.state.last_sensor_data.model_dump() 
            if socket_manager.state.last_sensor_data else None,
        "nfc_detected": nfc_detected,
        "ldr_detected": ldr_detected,
        "hall_detected": ldr_detected,  # v1.0: Hall sensor maps to ldr_detected
        "ir_detected": ldr_detected,    # Also provide ir_detected for frontend compatibility
        "radar_detected": radar_detected,
        "lcd_detected": 'lcd' in socket_manager.hardware_features,
        "hardware_state": socket_manager.state.hardware_state.value,
        "firmware_version": socket_manager.hardware_firmware_version
    }


@router.post("/mock/start")
async def start_mock_hardware():
    """Start mock hardware simulation."""
    await socket_manager.start_mock_hardware()
    return {"success": True, "message": "Mock hardware started"}


@router.post("/mock/stop")
async def stop_mock_hardware():
    """Stop mock hardware simulation."""
    await socket_manager.stop_mock_hardware()
    return {"success": True, "message": "Mock hardware stopped"}


@router.post("/command/lock")
async def send_lock_command():
    """Send lock command to hardware."""
    await socket_manager.sio.emit('command', {'command': 'LOCK_BOX'})
    return {"success": True, "command": "LOCK_BOX"}


@router.post("/command/unlock")
async def send_unlock_command():
    """Send unlock command to hardware."""
    await socket_manager.sio.emit('command', {'command': 'UNLOCK_BOX'})
    return {"success": True, "command": "UNLOCK_BOX"}


class ManualSensorData(BaseModel):
    phone_inserted: bool
    person_present: bool
    nfc_valid: bool = True
    box_open: bool = False


class MockStateUpdate(BaseModel):
    phone_inserted: bool | None = None
    person_present: bool | None = None
    nfc_valid: bool | None = None
    box_locked: bool | None = None
    box_open: bool | None = None


@router.post("/mock/manual")
async def send_manual_sensor_data(data: ManualSensorData):
    """Set persistent mock hardware state. State persists until changed."""
    # Update persistent mock state
    new_state = await socket_manager.set_mock_state(
        phone_inserted=data.phone_inserted,
        person_present=data.person_present,
        nfc_valid=data.nfc_valid,
        box_locked=data.phone_inserted,  # box_locked follows phone_inserted
        box_open=data.box_open
    )
    
    return {
        "success": True, 
        "message": "Mock state updated (persistent)", 
        "mock_state": new_state
    }


@router.post("/mock/state")
async def update_mock_state(data: MockStateUpdate):
    """Update specific mock hardware state fields."""
    updates = {k: v for k, v in data.model_dump().items() if v is not None}
    new_state = await socket_manager.set_mock_state(**updates)
    return {"success": True, "mock_state": new_state}


@router.get("/mock/state")
async def get_mock_state():
    """Get current mock hardware state."""
    return {
        "mock_mode_active": socket_manager.mock_mode_active,
        "mock_state": socket_manager.mock_state.to_dict()
    }
</file>

<file path="backend/app/socket_manager.py">
import asyncio
import random
from datetime import datetime
from typing import Optional, Callable, List
import socketio

from .config import settings
from .logger import safe_print
from .models import (
    SensorData, SystemState, PhoneStatus, PresenceStatus, BoxStatus, 
    NoiseStatus, SessionStatus, PenaltySettings, PenaltyConfig, FocusSession,
    HardwareState
)


class MockHardwareState:
    """Persistent state for mock hardware simulation."""
    def __init__(self):
        self.phone_inserted: bool = True
        self.person_present: bool = True
        self.nfc_valid: bool = True
        self.box_locked: bool = True
        self.box_open: bool = False  # KY-033 IR sensor - box open state
        self.manual_mode: bool = False
    
    def to_dict(self) -> dict:
        return {
            'phone_inserted': self.phone_inserted,
            'person_present': self.person_present,
            'nfc_valid': self.nfc_valid,
            'box_locked': self.box_locked,
            'box_open': self.box_open,
            'manual_mode': self.manual_mode
        }


class SocketManager:
    def __init__(self):
        self.sio = socketio.AsyncServer(
            async_mode='asgi',
            cors_allowed_origins='*',
            logger=False,  # Disable verbose logging
            engineio_logger=False  # Disable engine.io logging
        )
        self.app = socketio.ASGIApp(self.sio)
        
        print("[Socket.IO] Server initialized")
        
        self.state = SystemState()
        self.connected_clients: List[str] = []
        self.hardware_connected: bool = False
        self.physical_hardware_ws_connected: bool = False  # Track if physical hardware WebSocket is connected
        self.mock_mode_active: bool = False
        self.mock_task: Optional[asyncio.Task] = None
        self.mock_state: MockHardwareState = MockHardwareState()
        self.penalty_callbacks: List[Callable] = []
        self.current_hostage_path: Optional[str] = None
        self.last_penalty_time: Optional[datetime] = None
        self.penalty_cooldown_seconds: int = 30
        self.last_broadcast_time: Optional[datetime] = None
        self.broadcast_throttle_ms: int = 200
        
        # Physical hardware sensor detection status
        self.physical_nfc_detected: bool = False
        self.physical_ldr_detected: bool = False
        self.physical_radar_detected: bool = True  # v1.0: radar always present
        
        # v1.0: Hardware state tracking
        self.hardware_firmware_version: str = "unknown"
        self.hardware_features: str = ""
        
        # Logging throttle
        self.last_log_time: dict[str, datetime] = {}
        self.log_throttle_seconds: float = 5.0
        
        self._setup_handlers()
    
    def _setup_handlers(self):
        @self.sio.event
        async def connect(sid, environ):
            self.connected_clients.append(sid)
            self._throttled_log('client_connect', f"[WS] Client connected: {sid}", force=True)
            await self.sio.emit('system_state', self._serialize_state(), room=sid)
            nfc_detected, ldr_detected, radar_detected = self.get_sensor_detection_status()
            
            await self.sio.emit('hardware_status', {
                'connected': self.hardware_connected,
                'mock_mode': self.mock_mode_active,
                'mock_state': self.mock_state.to_dict(),
                'nfc_detected': nfc_detected,
                'ldr_detected': ldr_detected,
                'hall_detected': ldr_detected,  # v1.0: KY-033 IR sensor maps to ldr_detected field for backward compatibility
                'radar_detected': radar_detected,
                'lcd_detected': False,  # Will be updated when hardware connects
                'hardware_state': self.state.hardware_state.value,
                'firmware_version': self.hardware_firmware_version
            }, room=sid)
        
        @self.sio.event
        async def disconnect(sid):
            if sid in self.connected_clients:
                self.connected_clients.remove(sid)
            self._throttled_log('client_disconnect', f"[WS] Client disconnected: {sid}", force=True)
        
        @self.sio.event
        async def hardware_connect(sid, data):
            """Handle physical hardware connection (v1.0 format)."""
            hardware_id = data.get('hardware_id', 'UNKNOWN')
            version = data.get('version', 'N/A')
            board = data.get('board', 'D1-mini')
            features = data.get('features', '')  # v1.0: "hall,lcd,radar"
            
            # v1.0: KY-033 IR sensor (åå°„å¼ç´…å¤–ç·šæ„Ÿæ¸¬å™¨) replaces LDR for box open/close detection
            hall_detected = 'hall' in features or data.get('hall_detected', True)
            radar_detected = 'radar' in features or data.get('radar_detected', True)
            lcd_detected = 'lcd' in features
            
            # Legacy compatibility
            nfc_detected = data.get('nfc_detected', False)
            ldr_detected = data.get('ldr_detected', hall_detected)  # Map IR sensor to ldr field for frontend
            
            if self.mock_mode_active:
                self._throttled_log('hw_ignored', f"[HARDWARE] Ignoring physical hardware (Mock mode is active)", force=False)
                return
            
            self._throttled_log('hw_connect', f"[HARDWARE] v1.0 Connected - ID: {hardware_id}, Version: {version}, Board: {board}", force=True)
            self._throttled_log('hw_features', f"[HARDWARE] Features: {features}", force=True)
            
            self.hardware_connected = True
            self.physical_hardware_ws_connected = True  # Mark physical hardware as connected
            self.hardware_firmware_version = version
            self.hardware_features = features
            self.physical_nfc_detected = nfc_detected
            self.physical_ldr_detected = hall_detected  # KY-033 IR sensor maps to ldr_detected field
            self.physical_radar_detected = radar_detected
            
            await self.broadcast_event('hardware_status', {
                'connected': True, 
                'mock_mode': False,
                'hardware_id': hardware_id,
                'version': version,
                'board': board,
                'features': features,
                'nfc_detected': nfc_detected,
                'ldr_detected': hall_detected,
                'hall_detected': hall_detected,  # v1.0: KY-033 IR sensor field
                'ir_detected': hall_detected,    # Also provide ir_detected for frontend compatibility
                'radar_detected': radar_detected,
                'lcd_detected': lcd_detected,
                'mock_state': self.mock_state.to_dict()
            })
        
        @self.sio.event
        async def heartbeat(sid, data):
            """Handle heartbeat from physical hardware (v1.0 format)."""
            hardware_id = data.get('hardware_id', 'UNKNOWN')
            state = data.get('state', 'IDLE')  # v1.0: hardware state machine
            uptime = data.get('uptime', 0)
            wifi_rssi = data.get('wifi_rssi', 0)
            free_heap = data.get('free_heap', 0)
        
        @self.sio.event
        async def state_change(sid, data):
            """Handle hardware state machine changes (v1.0 new event)."""
            hardware_id = data.get('hardware_id', 'UNKNOWN')
            previous_state = data.get('previous_state', 'IDLE')
            current_state = data.get('current_state', 'IDLE')
            total_focus_time_ms = data.get('total_focus_time_ms', 0)
            
            self._throttled_log('state_change', f"[HARDWARE STATE] {previous_state} â†’ {current_state}", force=True)
            
            # Update system state
            try:
                self.state.hardware_state = HardwareState(current_state)
            except ValueError:
                self.state.hardware_state = HardwareState.IDLE
            
            # Handle state transitions
            if current_state == 'VIOLATION':
                # Hardware detected violation (box opened during focus)
                if self.state.session and self.state.session.status == SessionStatus.ACTIVE:
                    self._throttled_log('hw_violation', "[HARDWARE] Violation detected by hardware!", force=True)
                    self.state.box_status = BoxStatus.OPEN
                    await self._check_violations()
            
            elif current_state == 'FOCUSING':
                # Hardware entered focus mode
                self.state.box_status = BoxStatus.CLOSED
            
            elif current_state == 'IDLE':
                # Hardware returned to idle
                pass
            
            await self.broadcast_state(force=True)
            await self.broadcast_event('hardware_state_change', {
                'previous_state': previous_state,
                'current_state': current_state,
                'total_focus_time_ms': total_focus_time_ms
            })
        
        @self.sio.event
        async def sensor_data(sid, data):
            if self.mock_mode_active:
                return
            
            # v1.0: Extract new fields
            nfc_detected = data.get('nfc_detected', False)
            ldr_detected = data.get('ldr_detected', False)  # Actually KY-033 IR sensor in v1.0
            if ldr_detected is not None:
                data['ldr_detected'] = ldr_detected
            
            # Don't log routine sensor data - happens 10 times per second
            # Only important state changes are logged in process_sensor_data
                
            await self.process_sensor_data(data)
        
        @self.sio.event
        async def start_session(sid, data):
            duration = data.get('duration_minutes', 25)
            await self.start_focus_session(duration)
        
        @self.sio.event
        async def stop_session(sid, data):
            await self.stop_focus_session()
        
        @self.sio.event
        async def update_penalty_settings(sid, data):
            try:
                self.state.penalty_settings = PenaltySettings(**data)
                await self.broadcast_state(force=True)
            except Exception as e:
                print(f"[ERROR] Failed to update penalty settings: {e}")
        
        @self.sio.event
        async def update_penalty_config(sid, data):
            """Update granular penalty configuration."""
            try:
                self.state.penalty_config = PenaltyConfig(**data)
                # Also update active session's penalty config if session exists
                if self.state.session:
                    self.state.session.penalty_config = self.state.penalty_config
                print(f"[PENALTY CONFIG] Updated: {self.state.penalty_config.model_dump()}")
                await self.broadcast_state(force=True)
            except Exception as e:
                print(f"[ERROR] Failed to update penalty config: {e}")
        
        @self.sio.event
        async def toggle_mock_hardware(sid, data):
            enabled = data.get('enabled', False)
            print(f"[MOCK] Toggle request: enabled={enabled}, current_state={self.mock_mode_active}")
            if enabled:
                await self.start_mock_hardware()
            else:
                await self.stop_mock_hardware()
    
    async def process_sensor_data(self, data: dict):
        try:
            # Normalize nfc_id: convert empty string to None
            if 'nfc_id' in data and data['nfc_id'] == '':
                data['nfc_id'] = None
            
            # Handle box_open field (v1.0: KY-033 IR sensor, v2.0: LDR)
            if 'box_open' not in data:
                # Legacy compatibility: infer from box_locked
                data['box_open'] = not data.get('box_locked', True)
            
            sensor = SensorData(**data)
            self.state.last_sensor_data = sensor
            self.state.current_db = sensor.mic_db
            
            # v1.0: Update hardware state from sensor data
            if sensor.state:
                try:
                    self.state.hardware_state = HardwareState(sensor.state)
                except ValueError:
                    pass
            
            # Update phone status based on NFC
            # In mock mode: nfc_id alone determines phone status, box_open is independent
            # In physical mode: box_open can affect phone detection
            if self.mock_mode_active:
                # Mock mode: box_open doesn't affect phone status
                if sensor.nfc_id:
                    if self.state.phone_status != PhoneStatus.LOCKED:
                        self._throttled_log('phone_locked', "[STATUS] âœ“ Phone locked in box", force=True)
                    self.state.phone_status = PhoneStatus.LOCKED
                else:
                    if self.state.phone_status == PhoneStatus.LOCKED:
                        self.state.phone_status = PhoneStatus.REMOVED
                        self._throttled_log('phone_removed', "[ALERT] âš ï¸  Phone removed from box!", force=True)
                    else:
                        self.state.phone_status = PhoneStatus.REMOVED
            else:
                # Physical mode: box_open can affect phone detection (legacy logic)
                if sensor.nfc_id and not sensor.box_open:
                    if self.state.phone_status != PhoneStatus.LOCKED:
                        self._throttled_log('phone_locked', "[STATUS] âœ“ Phone locked in box", force=True)
                    self.state.phone_status = PhoneStatus.LOCKED
                elif not sensor.nfc_id or sensor.box_open:
                    if self.state.phone_status == PhoneStatus.LOCKED:
                        self.state.phone_status = PhoneStatus.REMOVED
                        self._throttled_log('phone_removed', "[ALERT] âš ï¸  Phone removed from box!", force=True)
                    else:
                        self.state.phone_status = PhoneStatus.REMOVED
            
            # Update presence status based on radar
            if sensor.radar_presence:
                if self.state.presence_status != PresenceStatus.DETECTED:
                    self._throttled_log('person_detected', "[STATUS] âœ“ Person detected", force=True)
                self.state.presence_status = PresenceStatus.DETECTED
                self.state.person_away_since = None
            else:
                if self.state.presence_status == PresenceStatus.DETECTED:
                    self.state.person_away_since = datetime.now()
                    self._throttled_log('person_away', "[STATUS] âš ï¸  Person away - monitoring...", force=True)
                self.state.presence_status = PresenceStatus.AWAY
            
            # Update box status based on LDR (new in v2.0)
            if sensor.box_open:
                if self.state.box_status != BoxStatus.OPEN:
                    self._throttled_log('box_open', "[ALERT] âš ï¸  Box opened!", force=True)
                self.state.box_status = BoxStatus.OPEN
            else:
                if self.state.box_status != BoxStatus.CLOSED:
                    self._throttled_log('box_closed', "[STATUS] âœ“ Box closed", force=True)
                self.state.box_status = BoxStatus.CLOSED
            
            # Update noise status based on mic
            noise_threshold = self.state.penalty_config.noise_threshold_db
            if sensor.mic_db >= noise_threshold:
                if self.state.noise_status != NoiseStatus.NOISY:
                    self._throttled_log('noise_detected', f"[ALERT] âš ï¸  Noise detected ({sensor.mic_db} dB)", force=True)
                self.state.noise_status = NoiseStatus.NOISY
            else:
                self.state.noise_status = NoiseStatus.QUIET
            
            # Check for violations during active session
            await self._check_violations()
            
            # Broadcast updated state to all clients
            await self.broadcast_state()
            
        except Exception as e:
            import traceback
            print(f"[ERROR] Processing sensor data: {e}")
            print(f"[ERROR] Traceback: {traceback.format_exc()}")
            print(f"[ERROR] Data received: {data}")
    
    async def _check_violations(self):
        if self.state.session and self.state.session.status == SessionStatus.ACTIVE:
            violation_detected = False
            violation_reason = ""
            
            # Get penalty config from session (which inherits from global if not overridden)
            config = self.state.session.penalty_config
            
            # Check if phone was removed (only if penalty enabled)
            if config.enable_phone_penalty and self.state.phone_status == PhoneStatus.REMOVED:
                violation_detected = True
                violation_reason = "Phone removed"
                self._throttled_log('violation_phone', "[VIOLATION] âš ï¸  Phone removed during focus session!")
            
            # Check if person has been away too long (only if penalty enabled)
            if config.enable_presence_penalty and self.state.person_away_since:
                away_duration = (datetime.now() - self.state.person_away_since).total_seconds()
                if away_duration > settings.PERSON_AWAY_THRESHOLD_SEC:
                    violation_detected = True
                    violation_reason = f"Person away for {away_duration:.1f}s"
                    self._throttled_log('violation_away', f"[VIOLATION] âš ï¸  Person away for {away_duration:.1f}s!")
            
            # Check if box is open (only if penalty enabled) - NEW in v2.0
            if config.enable_box_open_penalty and self.state.box_status == BoxStatus.OPEN:
                violation_detected = True
                violation_reason = "Box opened"
                self._throttled_log('violation_box_open', "[VIOLATION] âš ï¸  Box opened during focus session!")
            
            # Check if environment is too noisy (only if penalty enabled)
            if config.enable_noise_penalty and self.state.noise_status == NoiseStatus.NOISY:
                violation_detected = True
                violation_reason = f"Noise detected ({self.state.current_db} dB)"
                self._throttled_log('violation_noise', f"[VIOLATION] âš ï¸  Noise violation ({self.state.current_db} dB)!")
            
            if violation_detected:
                # Check penalty cooldown to prevent spam
                now = datetime.now()
                if self.last_penalty_time is None or \
                   (now - self.last_penalty_time).total_seconds() >= self.penalty_cooldown_seconds:
                    self.state.session.violations += 1
                    self.state.session.status = SessionStatus.VIOLATED
                    self.last_penalty_time = now
                    print(f"[VIOLATION] Triggering penalty: {violation_reason}")
                    await self._trigger_penalty()
                else:
                    cooldown_remaining = self.penalty_cooldown_seconds - (now - self.last_penalty_time).total_seconds()
                    print(f"[VIOLATION] Penalty on cooldown ({cooldown_remaining:.1f}s remaining)")
    
    async def _trigger_penalty(self):
        print("[æ‡²ç½°å”å®š] å•Ÿå‹•ç¤¾äº¤ç¾æ¥åŸ·è¡Œç¨‹åº...")
        await self.broadcast_event('penalty_triggered', {
            'timestamp': datetime.now().isoformat(),
            'violations': self.state.session.violations if self.state.session else 0,
            'has_hostage': self.current_hostage_path is not None
        })
        
        # Execute registered penalty callbacks with hostage path
        for callback in self.penalty_callbacks:
            try:
                await callback(self.state, self.current_hostage_path)
            except Exception as e:
                print(f"[éŒ¯èª¤] æ‡²ç½°å›èª¿åŸ·è¡Œå¤±æ•—: {e}")
        
        if self.state.session:
            self.state.session.penalties_executed += 1
    
    def register_penalty_callback(self, callback: Callable):
        self.penalty_callbacks.append(callback)
    
    async def start_focus_session(self, duration_minutes: int, hostage_path: Optional[str] = None):
        import uuid
        
        self.current_hostage_path = hostage_path
        self.last_penalty_time = None
        self.state.session = FocusSession(
            id=str(uuid.uuid4()),
            duration_minutes=duration_minutes,
            start_time=datetime.now(),
            status=SessionStatus.ACTIVE,
            penalty_config=self.state.penalty_config
        )
        print(f"[å°ˆæ³¨å”å®š] å·²å•Ÿå‹• {duration_minutes} åˆ†é˜å°ˆæ³¨ä»»å‹™")
        print(f"[å°ˆæ³¨å”å®š] æ‡²ç½°é…ç½®: {self.state.penalty_config.model_dump()}")
        if hostage_path:
            print(f"[äººè³ªå”å®š] äººè³ªç…§ç‰‡å·²ç¶å®š: {hostage_path}")
        await self.broadcast_state(force=True)
        
        # v1.0: Send START command to hardware state machine
        await self.sio.emit('command', {'command': 'START'})
    
    async def stop_focus_session(self):
        if self.state.session:
            self.state.session.status = SessionStatus.COMPLETED
            self.state.session.end_time = datetime.now()
            print("[å°ˆæ³¨å”å®š] å°ˆæ³¨ä»»å‹™å·²çµæŸ")
            self.state.session = None
        
        self.current_hostage_path = None
        
        # v1.0: Send STOP command to hardware state machine
        await self.sio.emit('command', {'command': 'STOP'})
        
        await self.broadcast_state(force=True)
    
    async def pause_focus_session(self):
        """Pause the current focus session (v1.0 new feature)."""
        if self.state.session and self.state.session.status == SessionStatus.ACTIVE:
            # Record the pause time
            self.state.session.paused_at = datetime.now()
            self.state.session.status = SessionStatus.PAUSED
            await self.sio.emit('command', {'command': 'PAUSE'})
            print(f"[å°ˆæ³¨å”å®š] å°ˆæ³¨ä»»å‹™å·²æš«åœ - æš«åœæ™‚é–“: {self.state.session.paused_at.isoformat()}")
            await self.broadcast_state(force=True)
    
    async def resume_focus_session(self):
        """Resume a paused focus session (v1.0 new feature)."""
        if self.state.session and self.state.session.status == SessionStatus.PAUSED:
            if self.state.session.paused_at:
                # Calculate paused duration and add to total
                paused_duration = (datetime.now() - self.state.session.paused_at).total_seconds()
                self.state.session.total_paused_seconds += int(paused_duration)
                print(f"[å°ˆæ³¨å”å®š] æœ¬æ¬¡æš«åœæ™‚é•·: {int(paused_duration)}ç§’, ç´¯è¨ˆæš«åœ: {self.state.session.total_paused_seconds}ç§’")
                self.state.session.paused_at = None
            
            self.state.session.status = SessionStatus.ACTIVE
            await self.sio.emit('command', {'command': 'RESUME'})
            print("[å°ˆæ³¨å”å®š] å°ˆæ³¨ä»»å‹™å·²æ¢å¾©")
            await self.broadcast_state(force=True)
    
    async def acknowledge_violation(self):
        """Acknowledge a violation and return to idle (v1.0 new feature)."""
        if self.state.session and self.state.session.status == SessionStatus.VIOLATED:
            await self.sio.emit('command', {'command': 'ACKNOWLEDGE'})
            print("[å°ˆæ³¨å”å®š] é•è¦å·²ç¢ºèªï¼Œè¿”å›å¾…æ©Ÿç‹€æ…‹")
    
    def _serialize_state(self) -> dict:
        """Serialize system state for transmission."""
        state_dict = self.state.model_dump()
        # Convert datetime objects to ISO format
        if self.state.session:
            if self.state.session.start_time:
                state_dict['session']['start_time'] = self.state.session.start_time.isoformat()
            if self.state.session.end_time:
                state_dict['session']['end_time'] = self.state.session.end_time.isoformat()
            if self.state.session.paused_at:
                state_dict['session']['paused_at'] = self.state.session.paused_at.isoformat()
        if self.state.person_away_since:
            state_dict['person_away_since'] = self.state.person_away_since.isoformat()
        # Convert enums to values
        state_dict['hardware_state'] = self.state.hardware_state.value
        return state_dict
    
    async def broadcast_state(self, force: bool = False):
        now = datetime.now()
        if not force and self.last_broadcast_time:
            elapsed_ms = (now - self.last_broadcast_time).total_seconds() * 1000
            if elapsed_ms < self.broadcast_throttle_ms:
                return
        
        self.last_broadcast_time = now
        await self.sio.emit('system_state', self._serialize_state())
    
    async def broadcast_event(self, event: str, data: dict):
        await self.sio.emit(event, data)
    
    def get_sensor_detection_status(self) -> tuple:
        """Get current sensor detection status (nfc_detected, ldr_detected, radar_detected)."""
        if self.mock_mode_active:
            return True, True, True
        elif self.hardware_connected:
            return self.physical_nfc_detected, self.physical_ldr_detected, self.physical_radar_detected
        else:
            return False, False, False
    
    def _throttled_log(self, log_key: str, message: str, force: bool = False):
        """Log a message but throttle repeated messages."""
        if force:
            print(message)
            return
        
        now = datetime.now()
        last_time = self.last_log_time.get(log_key)
        
        if last_time is None or (now - last_time).total_seconds() >= self.log_throttle_seconds:
            print(message)
            self.last_log_time[log_key] = now
    
    async def _reset_system_state(self):
        """Reset system state when switching hardware modes"""
        self.state.last_sensor_data = None
        self.state.current_db = 40  # Default noise level
        self.state.phone_status = PhoneStatus.UNKNOWN
        self.state.presence_status = PresenceStatus.UNKNOWN
        self.state.box_status = BoxStatus.UNKNOWN
        self.state.noise_status = NoiseStatus.UNKNOWN
        self.state.person_away_since = None
        await self.broadcast_state(force=True)
        print("[SYSTEM] State reset due to hardware mode change")

    async def start_mock_hardware(self):
        """Start mock hardware simulation. Can override physical hardware if requested."""
        # Check if mock mode is already running
        if self.mock_mode_active:
            print("[MOCK] Hardware simulation already running")
            await self.broadcast_event('hardware_status', {
                'connected': True, 
                'mock_mode': True,
                'mock_state': self.mock_state.to_dict(),
                'nfc_detected': True,
                'ldr_detected': True,
                'hall_detected': True,
                'ir_detected': True,
                'radar_detected': True,
                'lcd_detected': 'lcd' in self.hardware_features
            })
            return
        
        # If physical hardware is connected, we will override it
        if self.hardware_connected:
            print("[MOCK] Physical hardware detected - switching to mock mode")
            print("[MOCK] Real hardware data will be completely ignored")
        
        try:
            # Set mock mode FIRST to prevent any incoming hardware data from being processed
            self.mock_mode_active = True
            
            await self._reset_system_state()  # Reset state before starting mock
            
            # Cancel any existing mock task
            if self.mock_task and not self.mock_task.done():
                self.mock_task.cancel()
                try:
                    await self.mock_task
                except asyncio.CancelledError:
                    pass
            
            self.mock_task = asyncio.create_task(self._mock_hardware_loop())
            self.hardware_connected = True  # Mock hardware is now "connected"
            print("[MOCK] Hardware simulation started")
            
            # Broadcast immediately with full status
            await self.broadcast_event('hardware_status', {
                'connected': True, 
                'mock_mode': True,
                'mock_state': self.mock_state.to_dict(),
                'nfc_detected': True,  # Mock hardware always has NFC
                'ldr_detected': True,  # Mock hardware always has LDR
                'hall_detected': True,  # v1.0: KY-033 IR sensor field
                'ir_detected': True,   # Also provide ir_detected for frontend compatibility
                'radar_detected': True,  # Mock hardware always has radar
                'lcd_detected': 'lcd' in self.hardware_features
            })
            
            # Send initial sensor data immediately for instant feedback
            initial_mock_data = {
                'nfc_id': 'PHONE_MOCK_001' if (self.mock_state.phone_inserted and self.mock_state.nfc_valid) else None,
                'gyro_x': 0.0,
                'gyro_y': 0.0,
                'gyro_z': 0.0,
                'radar_presence': self.mock_state.person_present,
                'mic_db': 45,
                'box_locked': not self.mock_state.box_open,
                'box_open': self.mock_state.box_open,
                'timestamp': int(datetime.now().timestamp() * 1000),
                'nfc_detected': True,
                'gyro_detected': False,
                'ldr_detected': True
            }
            await self.process_sensor_data(initial_mock_data)
            
        except Exception as e:
            print(f"[MOCK ERROR] Failed to start mock hardware: {e}")
            self.mock_mode_active = False
            self.hardware_connected = False
            await self.broadcast_event('error', {
                'message': f'Failed to start mock hardware: {str(e)}',
                'type': 'MOCK_START_FAILED'
            })

    async def stop_mock_hardware(self):
        """Stop mock hardware simulation."""
        if self.mock_task:
            self.mock_task.cancel()
            try:
                await self.mock_task
            except asyncio.CancelledError:
                pass
            except Exception as e:
                print(f"[MOCK] Error during task cancellation: {e}")
            self.mock_task = None
        
        try:
            # Set mock_mode_active to False BEFORE resetting state
            self.mock_mode_active = False
            
            # Reset mock state when stopping
            self.mock_state = MockHardwareState()
            
            await self._reset_system_state()  # Reset state after stopping mock
            
            # Check if physical hardware is still connected
            if self.physical_hardware_ws_connected:
                # Physical hardware is connected, keep hardware_connected = True
                self.hardware_connected = True
                print("[MOCK] Hardware simulation stopped - Switching back to physical hardware")
                await self.broadcast_event('hardware_status', {
                    'connected': True,
                    'mock_mode': False,
                    'mock_state': self.mock_state.to_dict(),
                    'nfc_detected': self.physical_nfc_detected,
                    'ldr_detected': self.physical_ldr_detected,
                    'hall_detected': self.physical_ldr_detected,
                    'ir_detected': self.physical_ldr_detected,
                    'radar_detected': self.physical_radar_detected,
                    'lcd_detected': 'lcd' in self.hardware_features,
                    'last_sensor_data': self.state.last_sensor_data.model_dump() if self.state.last_sensor_data else None
                })
            else:
                # No physical hardware, set disconnected
                self.hardware_connected = False
                print("[MOCK] Hardware simulation stopped")
                await self.broadcast_event('hardware_status', {
                    'connected': False,
                    'mock_mode': False,
                    'mock_state': self.mock_state.to_dict(),
                    'nfc_detected': False,
                    'ldr_detected': False,
                    'hall_detected': False,
                    'ir_detected': False,
                    'radar_detected': False,
                    'lcd_detected': False
                })
        except Exception as e:
            print(f"[MOCK ERROR] Error during stop: {e}")
    
    async def _mock_hardware_loop(self):
        self._throttled_log('mock_start', "[MOCK] â–¶ï¸  Sensor simulation running...", force=True)
        
        loop_count = 0
        while True:
            try:
                loop_count += 1
                # Log status every 20 iterations (every ~2 seconds at 100ms interval)
                if loop_count % 20 == 0:
                    self._throttled_log('mock_running', f"[MOCK] ğŸ“Š Simulation active - phone: {self.mock_state.phone_inserted}, person: {self.mock_state.person_present}, box_open: {self.mock_state.box_open}")
                
                # Use persistent mock_state for sensor data
                mock_data = {
                    'nfc_id': 'PHONE_MOCK_001' if (self.mock_state.phone_inserted and self.mock_state.nfc_valid) else None,
                    'gyro_x': 0.0,  # Legacy, kept for compatibility
                    'gyro_y': 0.0,
                    'gyro_z': 0.0,
                    'radar_presence': self.mock_state.person_present,
                    'mic_db': random.randint(35, 55),
                    'box_locked': not self.mock_state.box_open,  # Legacy compatibility
                    'box_open': self.mock_state.box_open,  # New: LDR sensor
                    'timestamp': int(datetime.now().timestamp() * 1000),
                    'nfc_detected': True,
                    'gyro_detected': False,  # Removed in v2.0
                    'ldr_detected': True  # New: LDR sensor
                }
                
                await self.process_sensor_data(mock_data)
                await asyncio.sleep(settings.MOCK_INTERVAL_MS / 1000)
                
            except asyncio.CancelledError:
                self._throttled_log('mock_cancel', "[MOCK] â¹ï¸  Simulation stopped", force=True)
                break
            except Exception as e:
                import traceback
                self._throttled_log('mock_error', f"[MOCK ERROR] âŒ {e}")
                await asyncio.sleep(1)  # Wait before retrying
    
    async def set_mock_state(self, **kwargs) -> dict:
        """Update mock hardware state and broadcast changes."""
        try:
            # Track if any state actually changed
            state_changed = False
            for key, value in kwargs.items():
                if hasattr(self.mock_state, key):
                    old_value = getattr(self.mock_state, key)
                    if old_value != value:
                        setattr(self.mock_state, key, value)
                        state_changed = True
                else:
                    self._throttled_log('mock_unknown_attr', f"[MOCK] Warning: Unknown attribute '{key}'")
            
            # Only process if state actually changed
            if not state_changed:
                return self.mock_state.to_dict()
            
            self._throttled_log('mock_state_update', f"[MOCK] ğŸ”„ State: phone={self.mock_state.phone_inserted}, person={self.mock_state.person_present}, box_open={self.mock_state.box_open}", force=True)
            
            # Broadcast updated hardware status using helper method
            nfc_detected, ldr_detected, radar_detected = self.get_sensor_detection_status()
            await self.broadcast_event('hardware_status', {
                'connected': self.hardware_connected,
                'mock_mode': self.mock_mode_active,
                'mock_state': self.mock_state.to_dict(),
                'nfc_detected': nfc_detected,
                'ldr_detected': ldr_detected,
                'hall_detected': ldr_detected,  # v1.0: KY-033 IR sensor field
                'ir_detected': ldr_detected,    # Also provide ir_detected for frontend compatibility
                'radar_detected': radar_detected,
                'lcd_detected': 'lcd' in self.hardware_features
            })
            
            # If mock mode is active, immediately send sensor data with new state
            if self.mock_mode_active:
                mock_data = {
                    'nfc_id': 'PHONE_MOCK_001' if (self.mock_state.phone_inserted and self.mock_state.nfc_valid) else None,
                    'gyro_x': 0.0,
                    'gyro_y': 0.0,
                    'gyro_z': 0.0,
                    'radar_presence': self.mock_state.person_present,
                    'mic_db': random.randint(35, 55),
                    'box_locked': not self.mock_state.box_open,
                    'box_open': self.mock_state.box_open,
                    'timestamp': int(datetime.now().timestamp() * 1000),
                    'nfc_detected': True,
                    'gyro_detected': False,
                    'ldr_detected': True
                }
                await self.process_sensor_data(mock_data)
                await self.broadcast_state(force=True)
            
            return self.mock_state.to_dict()
        except Exception as e:
            print(f"[MOCK ERROR] Failed to set mock state: {e}")
            return self.mock_state.to_dict()


# Global socket manager instance
socket_manager = SocketManager()
</file>

<file path="frontend/src/components/Dashboard/DashboardPage.tsx">
import { useSocket } from '@/hooks/useSocket'
import { Header } from '@/components/Dashboard/Header'
import { Timer } from '@/components/Dashboard/Timer'
import { StatusPanel } from '@/components/Dashboard/StatusPanel'
import { SocialSettings } from '@/components/Dashboard/SocialSettings'
import { DevPanel } from '@/components/Dashboard/DevPanel'
import { PenaltyProgress } from '@/components/Dashboard/PenaltyProgress'
import { PenaltyConfigPanel } from '@/components/Dashboard/PenaltyConfigPanel'
import { StateTransitionOverlay } from '@/components/Dashboard/StateTransitionOverlay'
import { useAudio } from '@/hooks/useAudio'
import { useEffect, useRef, useLayoutEffect } from 'react'
import gsap from 'gsap'

export function Dashboard() {
  const {
    connected,
    systemState,
    hardwareStatus,
    sensorHistory,
    penaltyTriggered,
    mockModeLoading,
    startSession,
    stopSession,
    pauseSession,
    resumeSession,
    toggleMockHardware,
    updatePenaltySettings,
    updatePenaltyConfig,
    sendManualSensorData,
  } = useSocket()
  
  const { play } = useAudio()
  const warningPlayedRef = useRef(false)
  const containerRef = useRef<HTMLDivElement>(null)

  useLayoutEffect(() => {
    const ctx = gsap.context(() => {
      gsap.from(".dashboard-card", {
        y: 50,
        opacity: 0,
        duration: 0.8,
        stagger: 0.1,
        ease: "back.out(1.7)",
        clearProps: "all"
      })
    }, containerRef)
    return () => ctx.revert()
  }, [])

  useEffect(() => {
    if (systemState?.session?.status === 'ACTIVE') {
      const isViolationState = 
        systemState.phone_status === 'REMOVED' || 
        systemState.presence_status === 'AWAY'
      
      if (isViolationState && !warningPlayedRef.current) {
        play('warning')
        warningPlayedRef.current = true
      } else if (!isViolationState) {
        warningPlayedRef.current = false
      }
    } else {
      warningPlayedRef.current = false
    }
  }, [systemState, play])

  return (
    <div className="min-h-screen bg-gradient-to-br from-mac-bg via-mac-surface to-mac-bg transition-all duration-1000">
      {/* State Transition Overlay */}
      <StateTransitionOverlay state={systemState?.hardware_state || 'IDLE'} />

      {/* Penalty Progress Modal */}
      <PenaltyProgress 
        isExecuting={penaltyTriggered}
        currentStep={penaltyTriggered ? 'auth' : undefined}
      />

      {/* Header */}
      <Header
        connected={connected}
        hardwareConnected={hardwareStatus.connected}
        isMock={hardwareStatus.mock_mode || false}
        mockModeLoading={mockModeLoading}
        onToggleMock={toggleMockHardware}
      />

      {/* Main Dashboard */}
      <main ref={containerRef} className="container mx-auto px-4 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Left Column - Timer & Settings */}
          <div className="lg:col-span-2 space-y-6">
            {/* Main Timer */}
            <div className="dashboard-card">
              <Timer
                session={systemState?.session || null}
                onStart={startSession}
                onStop={stopSession}
                onPause={pauseSession}
                onResume={resumeSession}
                penaltyTriggered={penaltyTriggered}
                prepareRemainingMs={systemState?.prepare_remaining_ms || 0}
              />
            </div>

            {/* Penalty Configuration Panel - NEW in v2.0 */}
            <div className="dashboard-card">
              <PenaltyConfigPanel
                config={systemState?.penalty_config || {
                  enable_phone_penalty: true,
                  enable_presence_penalty: true,
                  enable_noise_penalty: false,
                  enable_box_open_penalty: true,
                  noise_threshold_db: 70
                }}
                onConfigChange={updatePenaltyConfig}
                isSessionActive={systemState?.session?.status === 'ACTIVE'}
              />
            </div>

            {/* Social Settings */}
            <div className="dashboard-card">
              <SocialSettings
                settings={systemState?.penalty_settings || {
                  enabled_platforms: [],
                  custom_messages: {},
                  gmail_recipients: [],
                  include_timestamp: true,
                  include_violation_count: true,
                }}
                onSave={updatePenaltySettings}
              />
            </div>
          </div>

          {/* Right Column - Status & Sensors & Dev */}
          <div className="space-y-6">
            {/* Developer Panel - Only show in mock mode */}
            {hardwareStatus.mock_mode && (
              <div className="dashboard-card">
                <DevPanel
                  onManualControl={sendManualSensorData}
                  isVisible={hardwareStatus.mock_mode}
                  mockState={hardwareStatus.mock_state}
                />
              </div>
            )}

            {/* Status Panel */}
            <div className="dashboard-card">
              <StatusPanel
                phoneStatus={systemState?.phone_status || 'UNKNOWN'}
                presenceStatus={systemState?.presence_status || 'UNKNOWN'}
                boxStatus={systemState?.box_status || 'UNKNOWN'}
                currentDb={systemState?.current_db || 40}
                hardwareConnected={hardwareStatus.connected}
                isMock={hardwareStatus.mock_mode}
                hardwareBoard={hardwareStatus.board || 'D1-mini'}
                nfcDetected={hardwareStatus.nfc_detected}
                ldrDetected={hardwareStatus.ldr_detected}
                radarDetected={hardwareStatus.radar_detected}
                // v1.0: New state props
                hardwareState={systemState?.hardware_state || 'IDLE'}
                prepareRemainingMs={systemState?.prepare_remaining_ms || 0}
                irDetected={hardwareStatus.ir_detected}
                lcdDetected={hardwareStatus.lcd_detected}
              />
            </div>
          </div>
        </div>

        {/* Footer */}
        <footer className="mt-12 text-center text-xs text-mac-textSecondary border-t border-white/10 pt-6 animate-fade-in" style={{ animationDelay: '0.3s' }}>
          <p className="flex items-center justify-center gap-2 transition-all duration-300 hover:scale-105">
            <span className="inline-block w-2 h-2 rounded-full bg-neon-red animate-pulse-glow" />
            <span className="font-semibold text-white">å°ˆæ³¨åŸ·æ³•è€…</span> 
            <span>v1.0</span> 
            <span className="mx-2">|</span>
            <span>é›¶ä¿¡ä»»ç›£æ§ç³»çµ±</span> 
            <span className="mx-2">|</span>
            <span className="text-neon-green">ç¤¾æ­»å”å®šå·²å•Ÿå‹•</span>
          </p>
          <p className="mt-2 text-mac-textSecondary/70 italic transition-all duration-300 hover:text-mac-textSecondary">
            ã€Œä»¥å•è²¬é”æˆç´€å¾‹ï¼Œä»¥ææ‡¼é”æˆå°ˆæ³¨ã€‚ã€
          </p>
        </footer>
      </main>
    </div>
  )
}
</file>

<file path="frontend/src/components/Dashboard/DevPanel.tsx">
import { useState } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { 
  Smartphone, 
  User, 
  CreditCard, 
  Box,
  ChevronDown,
  ChevronUp,
  Zap
} from 'lucide-react'
import type { MockState } from '@/hooks/useSocket'

interface DevPanelProps {
  onManualControl: (data: ManualSensorData) => void
  isVisible?: boolean
  mockState?: MockState  // Backend's persistent mock state
}

export interface ManualSensorData {
  phone_inserted: boolean
  person_present: boolean
  nfc_valid: boolean
  box_open: boolean
}

export function DevPanel({ onManualControl, isVisible = true, mockState }: DevPanelProps) {
  const [collapsed, setCollapsed] = useState(false)
  
  // Use backend state directly - no local state needed!
  const phoneInserted = mockState?.phone_inserted ?? true
  const personPresent = mockState?.person_present ?? true
  const nfcValid = mockState?.nfc_valid ?? true
  const boxOpen = mockState?.box_open ?? false

  const sendManualData = (data: Partial<ManualSensorData>) => {
    // Send full state with overrides
    const fullData: ManualSensorData = {
      phone_inserted: data.phone_inserted ?? phoneInserted,
      person_present: data.person_present ?? personPresent,
      nfc_valid: data.nfc_valid ?? nfcValid,
      box_open: data.box_open ?? boxOpen,
    }
    onManualControl(fullData)
  }

  const togglePhoneInserted = () => {
    sendManualData({ phone_inserted: !phoneInserted })
  }

  const togglePersonPresent = () => {
    sendManualData({ person_present: !personPresent })
  }

  const toggleBoxOpen = () => {
    sendManualData({ box_open: !boxOpen })
  }

  const triggerNfcValid = () => {
    // Only set nfc_valid, don't change phone_inserted or box_open
    sendManualData({ nfc_valid: true })
  }

  const triggerNfcInvalid = () => {
    // Only set nfc_valid to false, don't change other states
    sendManualData({ nfc_valid: false })
  }

  if (!isVisible) return null

  return (
    <Card className="border-neon-purple/30 bg-cyber-dark/50 backdrop-blur-sm">
      <CardHeader 
        className="cursor-pointer select-none hover:bg-cyber-darker/50 transition-colors"
        onClick={() => setCollapsed(!collapsed)}
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Zap className="h-5 w-5 text-neon-purple" />
            <CardTitle className="text-lg font-chinese">é–‹ç™¼è€…é¢æ¿</CardTitle>
            <Badge variant="outline" className="border-neon-purple text-neon-purple font-chinese">
              è™›æ“¬æ¨¡å¼
            </Badge>
          </div>
          {collapsed ? (
            <ChevronDown className="h-5 w-5 text-muted-foreground" />
          ) : (
            <ChevronUp className="h-5 w-5 text-muted-foreground" />
          )}
        </div>
        <CardDescription className="font-chinese">
          æ‰‹å‹•ç¡¬é«”æ¨¡æ“¬æ§åˆ¶ï¼ˆæ¸¬è©¦ç”¨ï¼‰
        </CardDescription>
      </CardHeader>

      {!collapsed && (
        <CardContent className="space-y-3 pt-0">
          <div className="grid grid-cols-3 gap-3">
            {/* Phone Status Control */}
            <div className="space-y-2 p-2 border border-border/30 rounded-md bg-black/20">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-1.5">
                  <Smartphone className="h-3.5 w-3.5 text-muted-foreground" />
                  <span className="text-xs font-medium font-chinese">æ‰‹æ©Ÿ</span>
                </div>
                <Badge variant={phoneInserted ? "default" : "destructive"} className="text-[10px] h-5 px-1.5 font-chinese">
                  {phoneInserted ? "å·²æ”¾å…¥" : "å·²ç§»é™¤"}
                </Badge>
              </div>
              <Button
                onClick={togglePhoneInserted}
                variant={phoneInserted ? "outline" : "destructive"}
                className="w-full h-7 text-xs"
                size="sm"
              >
                {phoneInserted ? "ç§»é™¤" : "æ”¾å…¥"}
              </Button>
            </div>

            {/* Person Presence Control */}
            <div className="space-y-2 p-2 border border-border/30 rounded-md bg-black/20">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-1.5">
                  <User className="h-3.5 w-3.5 text-muted-foreground" />
                  <span className="text-xs font-medium font-chinese">äººå“¡</span>
                </div>
                <Badge variant={personPresent ? "default" : "destructive"} className="text-[10px] h-5 px-1.5 font-chinese">
                  {personPresent ? "åœ¨åº§" : "é›¢åº§"}
                </Badge>
              </div>
              <Button
                onClick={togglePersonPresent}
                variant={personPresent ? "outline" : "destructive"}
                className="w-full h-7 text-xs"
                size="sm"
              >
                {personPresent ? "é›¢é–‹" : "è¿”å›"}
              </Button>
            </div>

            {/* Box Status Control */}
            <div className="space-y-2 p-2 border border-border/30 rounded-md bg-black/20">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-1.5">
                  <Box className="h-3.5 w-3.5 text-muted-foreground" />
                  <span className="text-xs font-medium font-chinese">ç›’è“‹</span>
                </div>
                <Badge variant={boxOpen ? "destructive" : "default"} className="text-[10px] h-5 px-1.5 font-chinese">
                  {boxOpen ? "å·²é–‹å•Ÿ" : "å·²é—œé–‰"}
                </Badge>
              </div>
              <Button
                onClick={toggleBoxOpen}
                variant={boxOpen ? "destructive" : "outline"}
                className="w-full h-7 text-xs"
                size="sm"
              >
                {boxOpen ? "é—œé–‰" : "é–‹å•Ÿ"}
              </Button>
            </div>
          </div>

          {/* Action Buttons */}
          <div className="space-y-2">
            <div className="flex items-center gap-2 mb-1">
              <CreditCard className="h-3.5 w-3.5 text-muted-foreground" />
              <span className="text-xs font-medium text-muted-foreground font-chinese">æ„Ÿæ¸¬å™¨è§¸ç™¼</span>
            </div>
            <div className="grid grid-cols-2 gap-2">
              <Button
                onClick={triggerNfcValid}
                variant="outline"
                className="h-8 text-xs border-neon-green/30 text-neon-green hover:bg-neon-green/10"
                size="sm"
              >
                æœ‰æ•ˆ NFC
              </Button>
              <Button
                onClick={triggerNfcInvalid}
                variant="outline"
                className="h-8 text-xs border-neon-red/30 text-neon-red hover:bg-neon-red/10"
                size="sm"
              >
                ç„¡æ•ˆ NFC
              </Button>
            </div>
          </div>
        </CardContent>
      )}
    </Card>
  )
}
</file>

<file path="frontend/src/components/Dashboard/PenaltyConfigPanel.tsx">
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Switch } from '@/components/ui/switch'
import { Label } from '@/components/ui/label'
import { Slider } from '@/components/ui/slider'
import { 
  Smartphone, 
  User, 
  Volume2, 
  Box,
  Shield
} from 'lucide-react'
import { PenaltyConfig } from '@/hooks/useSocket'

interface PenaltyConfigPanelProps {
  config: PenaltyConfig
  onConfigChange: (config: PenaltyConfig) => void
  isSessionActive?: boolean
}

export function PenaltyConfigPanel({ 
  config, 
  onConfigChange,
  isSessionActive = false 
}: PenaltyConfigPanelProps) {
  
  const handleToggle = (key: keyof PenaltyConfig, value: boolean) => {
    onConfigChange({
      ...config,
      [key]: value
    })
  }

  const handleThresholdChange = (value: number[]) => {
    onConfigChange({
      ...config,
      noise_threshold_db: value[0]
    })
  }

  const penalties = [
    {
      id: 'enable_phone_penalty',
      label: 'æ‰‹æ©Ÿé–å®š',
      description: 'NFC åµæ¸¬æ‰‹æ©Ÿç§»é™¤',
      icon: Smartphone,
      color: 'text-blue-400',
      enabled: true,
      required: true
    },
    {
      id: 'enable_box_open_penalty',
      label: 'ç›’è“‹é—œé–‰',
      description: 'LDR åµæ¸¬é–‹è“‹',
      icon: Box,
      color: 'text-purple-400',
      enabled: true,
      required: true
    },
    {
      id: 'enable_presence_penalty',
      label: 'äººå“¡åœ¨åº§',
      description: 'é›·é”åµæ¸¬é›¢åº§',
      icon: User,
      color: 'text-green-400',
      enabled: config.enable_presence_penalty,
      required: false
    },
    {
      id: 'enable_noise_penalty',
      label: 'ç’°å¢ƒå®‰éœ',
      description: 'éº¥å…‹é¢¨åµæ¸¬å™ªéŸ³',
      icon: Volume2,
      color: 'text-yellow-400',
      enabled: config.enable_noise_penalty,
      required: false
    }
  ]

  return (
    <Card className="mac-card border-white/10">
      <CardHeader className="pb-3">
        <CardTitle className="text-base font-medium flex items-center gap-2">
          <Shield className="w-5 h-5 text-neon-red" />
          <span>æ‡²ç½°æ„Ÿæ¸¬å™¨é…ç½®</span>
          {isSessionActive && (
            <span className="text-xs px-2 py-0.5 bg-neon-red/20 text-neon-red rounded-full ml-auto">
              å°ˆæ³¨ä¸­ - ç„¡æ³•ä¿®æ”¹
            </span>
          )}
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <p className="text-xs text-mac-textSecondary mb-4">
          é¸æ“‡å“ªäº›æ„Ÿæ¸¬å™¨é•è¦æœƒè§¸ç™¼ç¤¾æ­»æ‡²ç½°ã€‚æœªé¸å–çš„æ„Ÿæ¸¬å™¨ä»æœƒé¡¯ç¤ºç‹€æ…‹ï¼Œä½†ä¸æœƒè§¸ç™¼æ‡²ç½°ã€‚
        </p>
        
        <div className="space-y-3">
          {penalties.map((penalty) => {
            const Icon = penalty.icon
            const isRequired = penalty.required
            const isDisabled = isSessionActive || isRequired
            
            return (
              <div 
                key={penalty.id}
                className={`flex items-center justify-between p-3 rounded-lg transition-all duration-200 ${
                  penalty.enabled 
                    ? `bg-white/5 border ${isRequired ? 'border-neon-green/50' : 'border-white/10'}` 
                    : 'bg-transparent border border-transparent opacity-60'
                } ${isDisabled && !isRequired ? 'pointer-events-none' : isRequired ? '' : 'hover:bg-white/5'}`}
              >
                <div className="flex items-center gap-3">
                  <div className={`p-2 rounded-lg ${penalty.enabled ? 'bg-white/10' : 'bg-white/5'}`}>
                    <Icon className={`w-4 h-4 ${penalty.enabled ? penalty.color : 'text-gray-500'}`} />
                  </div>
                  <div>
                    <div className="flex items-center gap-2">
                      <Label 
                        htmlFor={penalty.id} 
                        className={`font-medium ${isRequired ? 'cursor-default' : 'cursor-pointer'} ${penalty.enabled ? 'text-white' : 'text-gray-400'}`}
                      >
                        {penalty.label}
                      </Label>
                      {isRequired && (
                        <span className="text-xs px-2 py-0.5 bg-neon-green/20 text-neon-green rounded-full">
                          å¿…è¦
                        </span>
                      )}
                    </div>
                    <p className="text-xs text-mac-textSecondary">{penalty.description}</p>
                  </div>
                </div>
                <Switch
                  id={penalty.id}
                  checked={penalty.enabled}
                  onCheckedChange={(checked) => handleToggle(penalty.id as keyof PenaltyConfig, checked)}
                  disabled={isDisabled}
                  className="data-[state=checked]:bg-neon-green"
                />
              </div>
            )
          })}
        </div>

        {/* Noise Threshold Slider - Only show if noise penalty is enabled */}
        {config.enable_noise_penalty && (
          <div className="pt-4 border-t border-white/10">
            <div className="flex items-center justify-between mb-2">
              <Label className="text-sm text-mac-textSecondary">å™ªéŸ³é–¾å€¼</Label>
              <span className="text-sm font-mono text-neon-yellow">{config.noise_threshold_db} dB</span>
            </div>
            <Slider
              value={[config.noise_threshold_db]}
              onValueChange={handleThresholdChange}
              min={40}
              max={90}
              step={5}
              disabled={isSessionActive}
              className="w-full"
            />
            <div className="flex justify-between text-xs text-mac-textSecondary mt-1">
              <span>40 dB (å®‰éœ)</span>
              <span>90 dB (éå¸¸åµ)</span>
            </div>
          </div>
        )}

        {/* Active Sensors Summary */}
        <div className="pt-4 border-t border-white/10">
          <p className="text-xs text-mac-textSecondary">
            <span className="text-neon-green font-medium">
              {penalties.filter(p => p.enabled).length}
            </span>
            {' '}/ {penalties.length} æ„Ÿæ¸¬å™¨å•Ÿç”¨æ‡²ç½°
          </p>
        </div>
      </CardContent>
    </Card>
  )
}
</file>

<file path="frontend/src/components/Dashboard/StatusPanel.tsx">
import React, { useRef } from 'react';
import { 
  Smartphone, 
  User, 
  Volume2, 
  Activity,
  Cpu,
  Zap,
  ScanLine
} from 'lucide-react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';
import { AnimatedNumber } from '@/components/ui/animated-number';
import { useSystemLock } from '@/hooks/usePhysics';
import { cn } from '@/lib/utils';

// v1.0: Hardware state machine states
type HardwareState = 'IDLE' | 'PREPARING' | 'FOCUSING' | 'PAUSED' | 'VIOLATION' | 'ERROR';

interface StatusPanelProps {
  phoneStatus: 'LOCKED' | 'REMOVED' | 'UNKNOWN'
  presenceStatus: 'DETECTED' | 'AWAY' | 'UNKNOWN'
  boxStatus: 'CLOSED' | 'OPEN' | 'UNKNOWN'
  currentDb: number
  hardwareConnected: boolean
  isMock?: boolean
  hardwareBoard?: string
  nfcDetected?: boolean
  ldrDetected?: boolean
  radarDetected?: boolean
  hardwareState?: HardwareState
  prepareRemainingMs?: number
  irDetected?: boolean
  lcdDetected?: boolean
}

const StatusModule = ({ 
  icon: Icon, 
  label, 
  value, 
  status, 
  subValue 
}: { 
  icon: any, 
  label: string, 
  value: React.ReactNode, 
  status: 'active' | 'inactive' | 'warning' | 'error',
  subValue?: string
}) => {
  const colorMap = {
    active: "text-neon-green border-neon-green/30 bg-neon-green/5",
    inactive: "text-mac-textSecondary border-white/10 bg-white/5",
    warning: "text-neon-yellow border-neon-yellow/30 bg-neon-yellow/5",
    error: "text-neon-red border-neon-red/30 bg-neon-red/5"
  };

  return (
    <div className={cn(
      "relative overflow-hidden rounded-xl border p-4 transition-all duration-500",
      colorMap[status]
    )}>
      <div className="flex items-start justify-between">
        <div className="space-y-1">
          <p className="text-xs font-medium uppercase tracking-wider opacity-70">{label}</p>
          <div className="text-lg font-semibold tracking-tight">{value}</div>
          {subValue && <p className="text-xs opacity-50">{subValue}</p>}
        </div>
        <div className={cn(
          "rounded-full p-2",
          status === 'active' ? "bg-neon-green/10 text-neon-green" : 
          status === 'error' ? "bg-neon-red/10 text-neon-red" :
          "bg-white/5 text-mac-textSecondary"
        )}>
          <Icon className="h-4 w-4" />
        </div>
      </div>
      
      {/* Scanline effect for active modules */}
      {status === 'active' && (
        <div className="absolute inset-0 pointer-events-none bg-scanline opacity-10" />
      )}
    </div>
  );
};

export function StatusPanel({ 
  phoneStatus, 
  presenceStatus,
  currentDb,
  hardwareConnected,
  isMock,
  hardwareBoard = 'D1-mini',
  nfcDetected = false,
  radarDetected = false,
  irDetected = false,
  hardwareState = 'IDLE',
}: StatusPanelProps) {
  const panelRef = useRef<HTMLDivElement>(null);
  
  // Apply system lock effect when in FOCUSING state
  useSystemLock(panelRef, hardwareState === 'FOCUSING');

  return (
    <Card ref={panelRef} className="h-full border-white/10 bg-black/40 backdrop-blur-xl">
      <CardHeader className="pb-2">
        <div className="flex items-center justify-between">
          <CardTitle className="text-sm font-medium text-mac-textSecondary uppercase tracking-widest">
            ç³»çµ±ç‹€æ…‹ç›£æ§
          </CardTitle>
          <div className="flex items-center gap-2">
            <div className={cn(
              "h-2 w-2 rounded-full animate-pulse",
              hardwareConnected ? "bg-neon-green" : "bg-neon-red"
            )} />
            <span className="text-xs font-mono text-mac-textSecondary">
              {hardwareConnected ? "é€£ç·šä¸­" : "é›¢ç·š"}
            </span>
          </div>
        </div>
      </CardHeader>
      <CardContent className="space-y-4 pt-4">
        
        {/* Primary Status Grid */}
        <div className="grid grid-cols-2 gap-3">
          <StatusModule 
            icon={Smartphone}
            label="æ‰‹æ©Ÿé–å®š"
            value={phoneStatus === 'LOCKED' ? "å®‰å…¨" : "æœªé–å®š"}
            status={phoneStatus === 'LOCKED' ? 'active' : 'error'}
            subValue={nfcDetected ? "NFC è¨Šè™Ÿé–å®š" : "ç„¡è¨Šè™Ÿ"}
          />
          
          <StatusModule 
            icon={User}
            label="ä½¿ç”¨è€…åµæ¸¬"
            value={presenceStatus === 'DETECTED' ? "åœ¨ä½" : "é›¢å¸­"}
            status={presenceStatus === 'DETECTED' ? 'active' : 'error'}
            subValue={radarDetected ? "é›·é”é–å®š" : "æœå°‹ä¸­..."}
          />

          {/* KY-033 IR Sensor Module */}
          <StatusModule 
            icon={ScanLine}
            label="ç´…å¤–ç·šæ„Ÿæ¸¬ (KY-033)"
            value={irDetected ? "è§¸ç™¼" : "å¾…æ©Ÿ"}
            status={irDetected ? 'warning' : 'inactive'}
            subValue="å¾ªè·¡æ¨¡çµ„ç›£æ§ä¸­"
          />

          <StatusModule 
            icon={Activity}
            label="ç³»çµ±ç‹€æ…‹"
            value={hardwareState}
            status={hardwareState === 'FOCUSING' ? 'active' : 'inactive'}
            subValue={isMock ? "æ¨¡æ“¬æ¨¡å¼" : "ç¡¬é«”é€£ç·š"}
          />
        </div>

        {/* Noise Level - Special Animated Module */}
        <div className="relative overflow-hidden rounded-xl border border-white/10 bg-white/5 p-4">
          <div className="flex items-center justify-between mb-2">
            <span className="text-xs font-medium uppercase tracking-wider text-mac-textSecondary">ç’°å¢ƒå™ªéŸ³</span>
            <Volume2 className={cn(
              "h-4 w-4 transition-colors duration-300",
              currentDb > 70 ? "text-neon-red" : "text-neon-blue"
            )} />
          </div>
          
          <div className="flex items-baseline gap-1">
            <AnimatedNumber 
              value={currentDb} 
              precision={1} 
              className={cn(
                "text-3xl font-bold font-mono transition-colors duration-300",
                currentDb > 70 ? "text-neon-red" : "text-white"
              )}
            />
            <span className="text-sm text-mac-textSecondary">dB</span>
          </div>
          
          {/* Visualizer Bar */}
          <div className="mt-3 h-1.5 w-full rounded-full bg-white/10 overflow-hidden">
            <div 
              className={cn(
                "h-full transition-all duration-300 ease-out",
                currentDb > 70 ? "bg-neon-red" : "bg-neon-blue"
              )}
              style={{ width: `${Math.min((currentDb / 100) * 100, 100)}%` }}
            />
          </div>
        </div>

        {/* Hardware Info Footer */}
        <div className="pt-2 border-t border-white/5">
          <div className="grid grid-cols-3 gap-2 text-[10px] font-mono text-mac-textSecondary/60">
            <div className="flex items-center gap-1">
              <Cpu className="h-3 w-3" />
              <span>{hardwareBoard}</span>
            </div>
            <div className="flex items-center gap-1">
              <Activity className="h-3 w-3" />
              <span>{hardwareState}</span>
            </div>
            <div className="flex items-center gap-1">
              <Zap className="h-3 w-3" />
              <span>{isMock ? "MOCK" : "LIVE"}</span>
            </div>
          </div>
        </div>

      </CardContent>
    </Card>
  );
}
</file>

<file path="frontend/src/components/Dashboard/Timer.tsx">
import { useEffect, useState, useCallback, useRef } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { formatTimeWithHours } from '@/lib/utils'
import { Play, Square, AlertTriangle, Pause, PlayCircle, Clock, Aperture } from 'lucide-react'
import { HostageManager } from './HostageManager'
import { useAudio } from '@/hooks/useAudio'
import { AnimatedNumber } from '@/components/ui/animated-number'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { useSystemLock } from '@/hooks/usePhysics'
import { cn } from '@/lib/utils'
import gsap from 'gsap'

interface TimerProps {
  session: {
    status: string
    duration_minutes: number
    start_time: string | null
    violations: number
    paused_at?: string | null
    total_paused_seconds?: number
  } | null
  onStart: (minutes: number) => void
  onStop: () => void
  onPause?: () => void
  onResume?: () => void
  penaltyTriggered: boolean
  prepareRemainingMs?: number
}

export function Timer({ session, onStart, onStop, onPause, onResume, penaltyTriggered, prepareRemainingMs = 0 }: TimerProps) {
  const [duration, setDuration] = useState(25)
  const [remainingSeconds, setRemainingSeconds] = useState(0)
  const [isEditingDuration, setIsEditingDuration] = useState(false)
  const [hours, setHours] = useState(0)
  const [minutes, setMinutes] = useState(25)
  const { play } = useAudio()
  const cardRef = useRef<HTMLDivElement>(null)
  const apertureRef = useRef<HTMLDivElement>(null)

  const isActive = session?.status === 'ACTIVE'
  const isPaused = session?.status === 'PAUSED'
  const isViolated = session?.status === 'VIOLATED'
  const isPreparing = prepareRemainingMs > 0

  // Apply system lock effect when active
  useSystemLock(cardRef, isActive);

  // Aperture Lock Animation
  useEffect(() => {
    if (!apertureRef.current) return;

    if (isActive) {
      gsap.to(apertureRef.current, {
        scale: 1,
        opacity: 1,
        rotation: 180,
        duration: 1.5,
        ease: "expo.out"
      });
    } else {
      gsap.to(apertureRef.current, {
        scale: 1.5,
        opacity: 0,
        rotation: 0,
        duration: 1,
        ease: "power2.in"
      });
    }
  }, [isActive]);

  const handleStart = useCallback(() => {
    play('start')
    onStart(duration)
  }, [duration, onStart, play])

  useEffect(() => {
    if (penaltyTriggered) {
      play('penalty')
    }
  }, [penaltyTriggered, play])

  useEffect(() => {
    if (session?.status === 'ACTIVE' && session.start_time) {
      const startTime = new Date(session.start_time).getTime()
      const totalPausedMs = (session.total_paused_seconds || 0) * 1000
      const endTime = startTime + session.duration_minutes * 60 * 1000 + totalPausedMs

      const updateTimer = () => {
        const now = Date.now()
        const remaining = Math.max(0, Math.floor((endTime - now) / 1000))
        setRemainingSeconds(remaining)
        
        if (remaining === 0 && session.status === 'ACTIVE') {
          play('complete')
          setTimeout(() => {
            onStop()
          }, 1000)
        }
      }

      updateTimer()
      const interval = setInterval(updateTimer, 1000)
      return () => clearInterval(interval)
    } else if (session?.status === 'PAUSED' && session.start_time) {
      const startTime = new Date(session.start_time).getTime()
      const pausedAt = session.paused_at ? new Date(session.paused_at).getTime() : Date.now()
      const totalPausedMs = (session.total_paused_seconds || 0) * 1000
      const endTime = startTime + session.duration_minutes * 60 * 1000 + totalPausedMs
      const remaining = Math.max(0, Math.floor((endTime - pausedAt) / 1000))
      setRemainingSeconds(remaining)
    } else {
      setRemainingSeconds(duration * 60)
    }
  }, [session, duration, play, onStop])

  const progress = isActive 
    ? ((session!.duration_minutes * 60 - remainingSeconds) / (session!.duration_minutes * 60)) * 100 
    : 0

  return (
    <Card ref={cardRef} className="relative overflow-hidden border-white/10 bg-black/40 backdrop-blur-xl transition-all duration-700 min-h-[500px] flex flex-col justify-between">
      
      {/* Fluid Backdrop & Aperture Effect */}
      <div className="absolute inset-0 pointer-events-none overflow-hidden">
        {/* Aperture Ring */}
        <div 
          ref={apertureRef}
          className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] border-[40px] border-neon-green/5 rounded-full opacity-0"
          style={{ transformOrigin: "center center" }}
        >
          <div className="absolute inset-0 border-[2px] border-neon-green/20 rounded-full animate-pulse" />
        </div>
        
        {/* Fluid Gradient */}
        <div 
          className={cn(
            "absolute inset-0 transition-opacity duration-1000",
            isActive ? "opacity-30" : "opacity-0"
          )}
          style={{
            background: `radial-gradient(circle at 50% 50%, ${
              isViolated ? 'rgba(255, 59, 48, 0.2)' : 'rgba(52, 199, 89, 0.1)'
            }, transparent 70%)`,
            filter: "blur(40px)"
          }}
        />
      </div>

      <CardHeader className="pb-2 relative z-10">
        <div className="flex items-center justify-between">
          <CardTitle className="text-sm font-medium text-mac-textSecondary uppercase tracking-widest flex items-center gap-2">
            <Clock className="w-4 h-4" />
            å°ˆæ³¨æœƒè©±æ§åˆ¶
          </CardTitle>
          {isActive && (
            <div className="flex items-center gap-2 px-2 py-0.5 rounded-full bg-neon-green/10 border border-neon-green/20 text-[10px] text-neon-green animate-pulse">
              <Aperture className="w-3 h-3 animate-spin-slow" />
              <span>åŸ·è¡Œä¸­</span>
            </div>
          )}
        </div>
      </CardHeader>

      <CardContent className="pt-6 pb-8 relative z-10 flex-1 flex flex-col justify-center">
        {/* Timer Display */}
        <div className="text-center mb-8">
          <h2 className={cn(
            "text-xs uppercase tracking-wider mb-3 font-medium transition-colors duration-300",
            isPreparing ? "text-neon-yellow" :
            isViolated ? "text-neon-red" :
            isActive ? "text-neon-green" : "text-mac-textSecondary"
          )}>
            {isPreparing ? `ç³»çµ±æ­¦è£ä¸­... ${Math.ceil(prepareRemainingMs / 1000)}s` : 
             isActive ? 'å‰©é¤˜æ™‚é–“' : 
             isPaused ? 'æœƒè©±æš«åœ' :
             isViolated ? 'åµæ¸¬åˆ°é•è¦' : 'è¨­å®šæ™‚é•·'}
          </h2>

          {isEditingDuration ? (
            <div className="flex items-center justify-center gap-4 animate-scale-in">
              <div className="flex flex-col items-center">
                <Input
                  type="number"
                  value={hours}
                  onChange={(e) => setHours(Math.max(0, parseInt(e.target.value) || 0))}
                  className="w-24 h-24 text-6xl text-center bg-white/5 border-white/10 focus:border-mac-accent focus:ring-mac-accent/20 rounded-2xl"
                />
                <span className="text-xs text-mac-textSecondary mt-2">å°æ™‚</span>
              </div>
              <span className="text-6xl text-white/20 pb-8">:</span>
              <div className="flex flex-col items-center">
                <Input
                  type="number"
                  value={minutes}
                  onChange={(e) => setMinutes(Math.max(0, parseInt(e.target.value) || 0))}
                  className="w-24 h-24 text-6xl text-center bg-white/5 border-white/10 focus:border-mac-accent focus:ring-mac-accent/20 rounded-2xl"
                />
                <span className="text-xs text-mac-textSecondary mt-2">åˆ†é˜</span>
              </div>
            </div>
          ) : (
            <div 
              className={cn(
                "text-8xl font-light tracking-tight transition-all duration-500 cursor-pointer select-none font-mono",
                isPreparing ? 'text-neon-yellow drop-shadow-[0_0_15px_rgba(255,255,0,0.5)]' :
                isViolated ? 'text-neon-red drop-shadow-[0_0_20px_rgba(255,0,0,0.6)]' :
                isPaused ? 'text-neon-blue opacity-70' :
                isActive ? 'text-neon-green drop-shadow-[0_0_15px_rgba(0,255,0,0.4)]' : 
                'text-white hover:text-mac-accent hover:scale-105'
              )}
              onClick={() => {
                if (!isActive && !isPaused) {
                  setHours(Math.floor(duration / 60))
                  setMinutes(duration % 60)
                  setIsEditingDuration(true)
                }
              }}
            >
              {isActive || isViolated || isPaused ? (
                <AnimatedNumber 
                  value={remainingSeconds} 
                  format={formatTimeWithHours} 
                  className="justify-center"
                />
              ) : (
                `${Math.floor(duration / 60)}:${(duration % 60).toString().padStart(2, '0')}`
              )}
            </div>
          )}
        </div>
        
        {/* Progress Bar */}
        <div className="relative h-2 bg-white/5 rounded-full overflow-hidden mb-8 mx-8">
          <div 
            className={cn(
              "absolute top-0 left-0 h-full transition-all duration-1000 ease-linear",
              isViolated ? 'bg-neon-red shadow-[0_0_10px_rgba(255,0,0,0.5)]' : 
              'bg-neon-green shadow-[0_0_10px_rgba(0,255,0,0.5)]'
            )}
            style={{ width: `${progress}%` }}
          />
        </div>

        {/* Controls */}
        <div className="flex justify-center gap-4">
          {isEditingDuration ? (
            <div className="flex gap-4">
              <Button
                onClick={() => {
                  setDuration(hours * 60 + minutes)
                  setIsEditingDuration(false)
                }}
                className="bg-mac-accent hover:bg-mac-accentHover text-white px-8 py-6 rounded-xl text-lg font-medium transition-all duration-300 hover:scale-105 hover:shadow-lg hover:shadow-mac-accent/20"
              >
                ç¢ºèª
              </Button>
              <Button
                variant="outline"
                onClick={() => setIsEditingDuration(false)}
                className="px-8 py-6 rounded-xl text-lg border-white/10 hover:bg-white/5 transition-all duration-300"
              >
                å–æ¶ˆ
              </Button>
            </div>
          ) : !isActive && !isPaused ? (
            <Button
              onClick={handleStart}
              disabled={isPreparing}
              className="group relative overflow-hidden bg-white text-black hover:bg-white/90 px-12 py-8 rounded-2xl text-xl font-semibold transition-all duration-500 hover:scale-105 hover:shadow-[0_0_30px_rgba(255,255,255,0.3)]"
            >
              <span className="relative z-10 flex items-center gap-3">
                <PlayCircle className="w-6 h-6" />
                å•Ÿå‹•å°ˆæ³¨å”å®š
              </span>
              <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/50 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000" />
            </Button>
          ) : (
            <div className="flex gap-4">
              {isPaused ? (
                <Button
                  onClick={onResume}
                  className="bg-neon-blue/20 text-neon-blue border border-neon-blue/50 hover:bg-neon-blue/30 px-8 py-6 rounded-xl text-lg transition-all duration-300"
                >
                  <Play className="w-5 h-5 mr-2" />
                  ç¹¼çºŒ
                </Button>
              ) : (
                <Button
                  onClick={onPause}
                  className="bg-white/5 text-white border border-white/10 hover:bg-white/10 px-8 py-6 rounded-xl text-lg transition-all duration-300"
                >
                  <Pause className="w-5 h-5 mr-2" />
                  æš«åœ
                </Button>
              )}
              
              <Button
                onClick={onStop}
                variant="destructive"
                className="bg-neon-red/20 text-neon-red border border-neon-red/50 hover:bg-neon-red/30 px-8 py-6 rounded-xl text-lg transition-all duration-300 hover:shadow-[0_0_20px_rgba(255,0,0,0.2)]"
              >
                <Square className="w-5 h-5 mr-2" />
                ä¸­æ­¢
              </Button>
            </div>
          )}
        </div>

        {/* Hostage Manager (File Upload) */}
        <div className="mt-8 pt-8 border-t border-white/5">
           <HostageManager 
             sessionActive={isActive} 
             onUploadComplete={(files) => console.log('Files uploaded:', files)}
           />
        </div>

        {session?.violations ? (
          <div className="mt-6 flex items-center justify-center gap-2 p-3 rounded-lg bg-neon-red/10 border border-neon-red/30 animate-slide-down">
            <AlertTriangle className="w-5 h-5 text-neon-red animate-bounce" />
            <span className="text-neon-red font-mono font-bold tracking-wider">
              åµæ¸¬åˆ°é•è¦æ¬¡æ•¸: {session.violations}
            </span>
          </div>
        ) : null}
      </CardContent>
    </Card>
  )
}
</file>

<file path="frontend/src/hooks/useSocket.ts">
import { useEffect, useState, useCallback, useRef } from 'react'
import { io, Socket } from 'socket.io-client'

// ============================================================================
// v1.0 Hardware State Machine
// ============================================================================
export type HardwareState = 'IDLE' | 'PREPARING' | 'FOCUSING' | 'PAUSED' | 'VIOLATION' | 'ERROR'

export interface SensorData {
  // v1.0: Hardware state machine
  state?: HardwareState
  
  // Hall sensor (v1.0 replaces LDR)
  box_open: boolean
  
  // Radar
  radar_presence: boolean
  
  // Timestamps
  timestamp: number
  uptime?: number
  
  // Legacy fields
  nfc_id: string | null
  mic_db: number
  box_locked: boolean
  nfc_detected?: boolean
  ldr_detected?: boolean
}

export interface PenaltyConfig {
  enable_phone_penalty: boolean
  enable_presence_penalty: boolean
  enable_noise_penalty: boolean
  enable_box_open_penalty: boolean
  noise_threshold_db: number
}

export interface FocusSession {
  id: string
  duration_minutes: number
  start_time: string | null
  end_time: string | null
  status: 'IDLE' | 'ACTIVE' | 'PAUSED' | 'VIOLATED' | 'COMPLETED'
  violations: number
  penalties_executed: number
  penalty_config?: PenaltyConfig
}

export interface PenaltySettings {
  enabled_platforms: string[]
  custom_messages: Record<string, string>
  gmail_recipients: string[]
  include_timestamp: boolean
  include_violation_count: boolean
}

export interface SystemState {
  session: FocusSession | null
  phone_status: 'LOCKED' | 'REMOVED' | 'UNKNOWN'
  presence_status: 'DETECTED' | 'AWAY' | 'UNKNOWN'
  box_status: 'CLOSED' | 'OPEN' | 'UNKNOWN'
  noise_status: 'QUIET' | 'NOISY' | 'UNKNOWN'
  current_db: number
  last_sensor_data: SensorData | null
  
  // v1.0: Hardware state machine
  hardware_state: HardwareState
  
  // v1.0: Preparation countdown
  prepare_remaining_ms: number
  
  // Legacy
  person_away_since: string | null
  penalty_settings: PenaltySettings
  penalty_config: PenaltyConfig
}

export interface MockState {
  phone_inserted: boolean
  person_present: boolean
  nfc_valid: boolean
  box_locked: boolean
  box_open: boolean
  manual_mode: boolean
}

interface HardwareStatus {
  connected: boolean
  mock_mode?: boolean
  mock_state?: MockState
  hardware_id?: string
  version?: string
  board?: string
  features?: string  // v1.0: "hall,lcd,radar"
  nfc_detected?: boolean
  ldr_detected?: boolean
  hall_detected?: boolean  // v1.0: Hall sensor / KY-033 IR sensor
  radar_detected?: boolean
  ir_detected?: boolean    // v1.0: IR sensor detected
  lcd_detected?: boolean
  hardware_state?: HardwareState
  firmware_version?: string
}

export function useSocket() {
  const [socket, setSocket] = useState<Socket | null>(null)
  const [connected, setConnected] = useState(false)
  const [systemState, setSystemState] = useState<SystemState | null>(null)
  const [hardwareStatus, setHardwareStatus] = useState<HardwareStatus>({
    connected: false,
    mock_mode: false,
    mock_state: {
      phone_inserted: true,
      person_present: true,
      nfc_valid: true,
      box_locked: true,
      box_open: false,
      manual_mode: false
    },
    nfc_detected: false,
    ldr_detected: false,
    radar_detected: false,
    ir_detected: false,
    lcd_detected: false,
    hardware_state: 'IDLE'
  })
  const [sensorHistory, setSensorHistory] = useState<SensorData[]>([])
  const [penaltyTriggered, setPenaltyTriggered] = useState(false)
  const [mockModeLoading, setMockModeLoading] = useState(false)
  
  const historyRef = useRef<SensorData[]>([])
  const previousMockMode = useRef<boolean>(false)

  useEffect(() => {
    console.log('[WS] Initializing Socket.IO client...')
    
    // Determine Socket.IO connection URL
    // In development, try direct connection to backend to avoid proxy issues
    const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    const socketUrl = isDev ? 'http://localhost:8000' : undefined
    
    console.log('[WS] Connecting to:', socketUrl || 'same origin')
    
    const socketInstance = io(socketUrl, {
      path: '/socket.io/',
      transports: ['polling', 'websocket'],  // Try polling first, then upgrade
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionAttempts: 10,
      timeout: 20000,
      autoConnect: true,
    })
    
    console.log('[WS] Socket instance created')

    socketInstance.on('connect', () => {
      console.log('[WS] âœ… Connected to Focus Enforcer v1.0')
      console.log('[WS] Socket ID:', socketInstance.id)
      console.log('[WS] Setting connected = true')
      setConnected(true)
      
      // Use absolute URL for API calls when connecting directly to backend
      const apiBase = isDev ? 'http://localhost:8000' : ''
      fetch(`${apiBase}/api/hardware/status`)
        .then(res => res.json())
        .then(data => {
          if (import.meta.env.DEV) {
            console.log('[WS] Initial hardware status:', data)
          }
          setHardwareStatus({
            connected: data.connected,
            mock_mode: data.mock_mode,
            mock_state: data.mock_state,
            nfc_detected: data.nfc_detected,
            ldr_detected: data.ldr_detected,
            radar_detected: data.radar_detected,
            ir_detected: data.hall_detected || data.ir_detected,
            lcd_detected: data.lcd_detected,
            hardware_state: data.hardware_state || 'IDLE'
          })
        })
        .catch(err => console.error('[WS] Failed to fetch initial hardware status:', err))
    })

    socketInstance.on('disconnect', () => {
      console.log('[WS] âŒ Disconnected')
      setConnected(false)
    })

    socketInstance.on('connect_error', (err) => {
      console.error('[WS] âŒ Connection error:', err.message)
      console.error('[WS] Error details:', err)
    })

    socketInstance.on('connect_timeout', () => {
      console.error('[WS] âŒ Connection timeout')
    })

    socketInstance.on('reconnect_attempt', (attempt) => {
      console.log(`[WS] ğŸ”„ Reconnection attempt ${attempt}`)
    })

    socketInstance.on('reconnect_failed', () => {
      console.error('[WS] âŒ Reconnection failed - all attempts exhausted')
      setTimeout(() => {
        if (!socketInstance.connected) {
          console.log('[WS] Attempting manual reconnect...')
          socketInstance.connect()
        }
      }, 2000)
    })

    socketInstance.on('system_state', (state: SystemState) => {
      setSystemState(state)
      
      if (state.last_sensor_data) {
        historyRef.current = [...historyRef.current.slice(-59), state.last_sensor_data]
        setSensorHistory([...historyRef.current])
      }
    })

    socketInstance.on('hardware_status', (status: HardwareStatus) => {
      console.log('[WS] Received hardware_status:', status)
      
      if ((socketInstance as any)._mockToggleTimeout) {
        clearTimeout((socketInstance as any)._mockToggleTimeout)
        ;(socketInstance as any)._mockToggleTimeout = null
      }
      
      if (previousMockMode.current === true && status.mock_mode === false) {
        console.log('[WS] Mock mode disabled - clearing all sensor data')
        historyRef.current = []
        setSensorHistory([])
        setSystemState(prev => prev ? {
          ...prev,
          last_sensor_data: null
        } : null)
      }
      
      previousMockMode.current = status.mock_mode || false
      setMockModeLoading(false)
      
      setHardwareStatus({
        connected: status.connected,
        mock_mode: status.mock_mode,
        mock_state: status.mock_state,
        hardware_id: status.hardware_id,
        version: status.version,
        board: status.board,
        features: status.features,
        nfc_detected: status.nfc_detected,
        ldr_detected: status.ldr_detected,
        radar_detected: status.radar_detected,
        ir_detected: status.hall_detected || status.ir_detected,
        lcd_detected: status.lcd_detected,
        hardware_state: status.hardware_state || 'IDLE',
        firmware_version: status.firmware_version
      })
    })

    socketInstance.on('penalty_triggered', () => {
      setPenaltyTriggered(true)
      setTimeout(() => setPenaltyTriggered(false), 5000)
    })
    
    // v1.0: Hardware state machine change event
    socketInstance.on('hardware_state_change', (data: {
      previous_state: HardwareState
      current_state: HardwareState
      total_focus_time_ms: number
    }) => {
      console.log('[WS] Hardware state change:', data.previous_state, 'â†’', data.current_state)
      setHardwareStatus(prev => ({
        ...prev,
        hardware_state: data.current_state
      }))
    })
    
    socketInstance.on('error', (error: any) => {
      console.error('[WS] Socket error:', error)
      setMockModeLoading(false)
      if ((socketInstance as any)._mockToggleTimeout) {
        clearTimeout((socketInstance as any)._mockToggleTimeout)
        ;(socketInstance as any)._mockToggleTimeout = null
      }
    })

    setSocket(socketInstance)

    return () => {
      socketInstance.disconnect()
    }
  }, [])

  const startSession = useCallback(async (durationMinutes: number) => {
    socket?.emit('start_session', { duration_minutes: durationMinutes })
  }, [socket])

  const stopSession = useCallback(async () => {
    try {
      const response = await fetch('/api/sessions/stop', {
        method: 'POST',
      })
      if (!response.ok) {
        console.error('[å°ˆæ³¨å”å®š] åœæ­¢å¤±æ•—:', await response.text())
      }
    } catch (error) {
      console.error('[å°ˆæ³¨å”å®š] åœæ­¢å¤±æ•—:', error)
    }
  }, [])

  // v1.0: Pause session
  const pauseSession = useCallback(async () => {
    try {
      const response = await fetch('/api/sessions/pause', { method: 'POST' })
      if (!response.ok) {
        console.error('[å°ˆæ³¨å”å®š] æš«åœå¤±æ•—:', await response.text())
      }
    } catch (error) {
      console.error('[å°ˆæ³¨å”å®š] æš«åœå¤±æ•—:', error)
    }
  }, [])

  // v1.0: Resume session
  const resumeSession = useCallback(async () => {
    try {
      const response = await fetch('/api/sessions/resume', { method: 'POST' })
      if (!response.ok) {
        console.error('[å°ˆæ³¨å”å®š] æ¢å¾©å¤±æ•—:', await response.text())
      }
    } catch (error) {
      console.error('[å°ˆæ³¨å”å®š] æ¢å¾©å¤±æ•—:', error)
    }
  }, [])

  const toggleMockHardware = useCallback((enabled: boolean) => {
    console.log('[WS] Toggling mock hardware:', enabled, 'socket connected:', socket?.connected)
    if (!socket?.connected) {
      console.error('[WS] Cannot toggle mock hardware: socket not connected')
      return
    }
    setMockModeLoading(true)
    socket.emit('toggle_mock_hardware', { enabled })
    
    const timeoutId = setTimeout(() => {
      console.warn('[WS] Mock hardware toggle timeout - clearing loading state')
      setMockModeLoading(false)
    }, 5000)
    
    ;(socket as any)._mockToggleTimeout = timeoutId
  }, [socket])

  const updatePenaltySettings = useCallback((settings: PenaltySettings) => {
    socket?.emit('update_penalty_settings', settings)
  }, [socket])

  const updatePenaltyConfig = useCallback((config: PenaltyConfig) => {
    socket?.emit('update_penalty_config', config)
  }, [socket])

  const sendManualSensorData = useCallback(async (data: {
    phone_inserted: boolean
    person_present: boolean
    nfc_valid: boolean
    box_open: boolean
  }) => {
    try {
      const response = await fetch('/api/hardware/mock/manual', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      })
      if (!response.ok) {
        console.error('[DEV] Manual sensor control failed:', await response.text())
      }
    } catch (error) {
      console.error('[DEV] Manual sensor control error:', error)
    }
  }, [])

  return {
    connected,
    systemState,
    hardwareStatus,
    sensorHistory,
    penaltyTriggered,
    mockModeLoading,
    startSession,
    stopSession,
    pauseSession,
    resumeSession,
    toggleMockHardware,
    updatePenaltySettings,
    updatePenaltyConfig,
    sendManualSensorData,
  }
}
</file>

<file path="Git-QuickPush.ps1">
# Quick Git Push Script
# Interactive commit and push with security checks

# Check if in git repository
if (-not (Test-Path ".git")) {
    Write-Host "[X] Not in a Git repository" -ForegroundColor Red
    exit 1
}

# Check if origin remote exists
$originUrl = git config --get remote.origin.url 2>$null
if ([string]::IsNullOrWhiteSpace($originUrl)) {
    Write-Host "[X] No 'origin' remote configured" -ForegroundColor Red
    Write-Host ""
    Write-Host "Run this first:" -ForegroundColor Yellow
    Write-Host "   .\Setup-GitRemote.ps1" -ForegroundColor Yellow
    Write-Host ""
    exit 1
}

# 1. Run security check
Write-Host "Security Check..." -ForegroundColor Cyan
& "$PSScriptRoot\Check-GitSecurity.ps1"

if ($LASTEXITCODE -ne 0) {
    $continue = Read-Host "`nSecurity issues found. Continue anyway? (yes/no)"
    if ($continue -ne "yes") {
        Write-Host "Cancelled" -ForegroundColor Yellow
        exit 0
    }
}

# 2. Show status
Write-Host "`nCurrent Status:" -ForegroundColor Cyan
git status --short

# 3. Add files
Write-Host ""
$addChoice = Read-Host "Add changes? (yes/no)"
if ($addChoice -ne "yes") {
    Write-Host "Cancelled" -ForegroundColor Yellow
    exit 0
}

git add .
Write-Host "[OK] Changes added" -ForegroundColor Green

# 4. Commit
Write-Host ""
$commitMsg = Read-Host "Enter commit message"
if ([string]::IsNullOrWhiteSpace($commitMsg)) {
    Write-Host "[X] Commit message cannot be empty" -ForegroundColor Red
    exit 1
}

git commit -m $commitMsg

if ($LASTEXITCODE -ne 0) {
    Write-Host "[X] Commit failed" -ForegroundColor Red
    exit 1
}

Write-Host "[OK] Commit successful" -ForegroundColor Green

# 5. Push
Write-Host ""
$currentBranch = git rev-parse --abbrev-ref HEAD
Write-Host "Current branch: $currentBranch" -ForegroundColor Cyan

$pushChoice = Read-Host "Push to remote? (yes/no)"
if ($pushChoice -eq "yes") {
    git push origin $currentBranch
    
    if ($LASTEXITCODE -eq 0) {
        Write-Host "`n[SUCCESS] Push completed!" -ForegroundColor Green
    } else {
        Write-Host "`n[X] Push failed" -ForegroundColor Red
        exit 1
    }
} else {
    Write-Host "`n[OK] Commit completed (not pushed)" -ForegroundColor Yellow
}
</file>

<file path="Git-SafePush.ps1">
# Safe Git Push Script
# Comprehensive security checks before commit and push

param(
    [Parameter(Mandatory=$true, HelpMessage="Enter commit message")]
    [string]$Message,
    
    [Parameter(Mandatory=$false)]
    [switch]$SkipCheck = $false,
    
    [Parameter(Mandatory=$false)]
    [switch]$NoPush = $false
)

function Write-ColorOutput {
    param(
        [string]$Message,
        [string]$Type = "Info"
    )
    
    switch ($Type) {
        "Success" { Write-Host "[OK] $Message" -ForegroundColor Green }
        "Error"   { Write-Host "[X] $Message" -ForegroundColor Red }
        "Warning" { Write-Host "[!] $Message" -ForegroundColor Yellow }
        "Info"    { Write-Host "[i] $Message" -ForegroundColor Cyan }
        default   { Write-Host $Message }
    }
}

$sensitivePatterns = @(
    "credentials.json",
    "*.key",
    "*.pem",
    "*.env",
    ".env.local",
    "*password*",
    "*secret*",
    "*token*",
    "browser_contexts/",
    "hostage_evidence/"
)

$requiredIgnorePatterns = @(
    "backend/credentials.json",
    "backend/browser_contexts/",
    "backend/hostage_evidence/",
    ".env",
    "*.key",
    "*.pem"
)

Write-ColorOutput "Safe Git Push Process..." "Info"
Write-Host ""

# Check if in git repository
if (-not (Test-Path ".git")) {
    Write-ColorOutput "Not in a Git repository!" "Error"
    exit 1
}

# Check if origin remote exists
$originUrl = git config --get remote.origin.url 2>$null
if ([string]::IsNullOrWhiteSpace($originUrl)) {
    Write-ColorOutput "No 'origin' remote configured!" "Error"
    Write-Host ""
    Write-Host "Run this first:" -ForegroundColor Yellow
    Write-Host "   .\Setup-GitRemote.ps1" -ForegroundColor Yellow
    Write-Host ""
    exit 1
}

# Security checks
if (-not $SkipCheck) {
    Write-ColorOutput "Running security checks..." "Info"
    $hasIssues = $false
    
    # Check .gitignore
    if (-not (Test-Path ".gitignore")) {
        Write-ColorOutput ".gitignore file does not exist!" "Error"
        $hasIssues = $true
    } else {
        $gitignoreContent = Get-Content ".gitignore" -Raw
        $missingPatterns = @()
        
        foreach ($pattern in $requiredIgnorePatterns) {
            if ($gitignoreContent -notmatch [regex]::Escape($pattern)) {
                $missingPatterns += $pattern
            }
        }
        
        if ($missingPatterns.Count -gt 0) {
            Write-ColorOutput ".gitignore missing sensitive items:" "Warning"
            foreach ($pattern in $missingPatterns) {
                Write-Host "  - $pattern" -ForegroundColor Yellow
            }
            $hasIssues = $true
        } else {
            Write-ColorOutput ".gitignore configured correctly" "Success"
        }
    }
    
    # Check staged files
    Write-ColorOutput "Checking staged files..." "Info"
    $stagedFiles = git diff --cached --name-only
    
    if ($stagedFiles) {
        $dangerousFiles = @()
        
        foreach ($file in $stagedFiles) {
            foreach ($pattern in $sensitivePatterns) {
                if ($file -like $pattern -or $file -match $pattern) {
                    $dangerousFiles += $file
                    break
                }
            }
        }
        
        if ($dangerousFiles.Count -gt 0) {
            Write-ColorOutput "WARNING! Sensitive files in staging area:" "Error"
            foreach ($file in $dangerousFiles) {
                Write-Host "  - $file" -ForegroundColor Red
            }
            Write-ColorOutput "These files should not be committed!" "Error"
            $hasIssues = $true
        } else {
            Write-ColorOutput "Staged files check passed" "Success"
        }
    }
    
    # Check tracked files
    Write-ColorOutput "Checking repository..." "Info"
    $trackedSensitive = @()
    $allTrackedFiles = git ls-files
    
    foreach ($file in $allTrackedFiles) {
        foreach ($pattern in $sensitivePatterns) {
            if ($file -like $pattern -or $file -match $pattern) {
                $trackedSensitive += $file
                break
            }
        }
    }
    
    if ($trackedSensitive.Count -gt 0) {
        Write-ColorOutput "WARNING! Sensitive files in repository:" "Error"
        foreach ($file in $trackedSensitive) {
            Write-Host "  - $file" -ForegroundColor Red
        }
        Write-ColorOutput "Recommend: git rm --cached <file>" "Warning"
        $hasIssues = $true
    } else {
        Write-ColorOutput "Repository check passed" "Success"
    }
    
    Write-Host ""
    
    if ($hasIssues) {
        Write-ColorOutput "Security issues found!" "Error"
        $response = Read-Host "Continue anyway? (yes/no)"
        if ($response -ne "yes") {
            Write-ColorOutput "Operation cancelled" "Info"
            exit 1
        }
    }
} else {
    Write-ColorOutput "Security check skipped" "Warning"
}

# Git Add
Write-Host ""
Write-ColorOutput "Adding changes to staging area..." "Info"
git status --short

Write-Host ""
$addResponse = Read-Host "Add all changes? (yes/no/select)"

if ($addResponse -eq "select") {
    Write-ColorOutput "Use 'git add <file>' to manually select files" "Info"
    Write-ColorOutput "Then run this script again" "Info"
    exit 0
} elseif ($addResponse -eq "yes") {
    git add .
    Write-ColorOutput "All changes added" "Success"
} else {
    Write-ColorOutput "Operation cancelled" "Info"
    exit 0
}

# Git Commit
Write-Host ""
Write-ColorOutput "Creating commit..." "Info"
git commit -m $Message

if ($LASTEXITCODE -ne 0) {
    Write-ColorOutput "Commit failed!" "Error"
    exit 1
}

Write-ColorOutput "Commit successful!" "Success"

# Git Push
if (-not $NoPush) {
    Write-Host ""
    Write-ColorOutput "Preparing to push..." "Info"
    
    $currentBranch = git rev-parse --abbrev-ref HEAD
    Write-Host "Current branch: $currentBranch" -ForegroundColor Cyan
    
    $pushResponse = Read-Host "Confirm push? (yes/no)"
    
    if ($pushResponse -eq "yes") {
        git push origin $currentBranch
        
        if ($LASTEXITCODE -eq 0) {
            Write-ColorOutput "Push successful!" "Success"
        } else {
            Write-ColorOutput "Push failed! Check network and permissions" "Error"
            exit 1
        }
    } else {
        Write-ColorOutput "Push cancelled (commit completed)" "Warning"
    }
} else {
    Write-ColorOutput "Push skipped (using -NoPush)" "Info"
}

Write-Host ""
Write-ColorOutput "Complete!" "Success"
</file>

<file path="MARKDOWN/CHECKLIST.md">
# âœ… é–‹ç™¼èˆ‡ç¶­è­·æª¢æŸ¥æ¸…å–® (Checklist)

## æ¯æ—¥å•Ÿå‹•æª¢æŸ¥
- [ ] åŸ·è¡Œ `Start-FocusEnforcer.ps1` ç¢ºä¿æœå‹™æ­£å¸¸å•Ÿå‹•ã€‚
- [ ] ç¢ºèªå„€è¡¨æ¿é¡¯ç¤º "Hardware Connected" (æˆ–é–‹å•Ÿ Mock Mode)ã€‚
- [ ] æ¸¬è©¦ Socket é€£ç·š (è§€å¯Ÿ Timer æ˜¯å¦åŒæ­¥)ã€‚

## ç¡¬é«”ç¶­è­·
- [ ] **KY-033 æ ¡æº–**: æ¯é€±æª¢æŸ¥ä¸€æ¬¡ç´…å¤–ç·šæ„Ÿæ¸¬å™¨çš„è§¸ç™¼è·é›¢ï¼Œç¢ºä¿ç›’è“‹é–‹é—œåµæ¸¬éˆæ•ã€‚
- [ ] **æ¥ç·šæª¢æŸ¥**: ç¢ºèªæœé‚¦ç·šç„¡é¬†è„«ï¼Œç‰¹åˆ¥æ˜¯ I2C (SDA/SCL) ç·šè·¯ã€‚
- [ ] **é›»æº**: ç¢ºèª D1 Mini ä¾›é›»ç©©å®š (å»ºè­°ä½¿ç”¨ç¨ç«‹ USB ä¾›é›»æˆ–å„ªè³ª Hub)ã€‚

## è»Ÿé«”ç™¼å¸ƒå‰æª¢æŸ¥
- [ ] **Git Security**: åŸ·è¡Œ `Check-GitSecurity.ps1` ç¢ºä¿ç„¡æ†‘è­‰æ´©æ¼ã€‚
- [ ] **Credentials**: ç¢ºèª `credentials.json` åŒ…å«æœ‰æ•ˆçš„æ¸¬è©¦å¸³è™Ÿã€‚
- [ ] **Clean Build**: åˆªé™¤ `backend/__pycache__` èˆ‡ `frontend/dist` ç¢ºä¿ä¹¾æ·¨å»ºç½®ã€‚

## åŠŸèƒ½æ¸¬è©¦ (Release Testing)
- [ ] **æµç¨‹æ¸¬è©¦**: å®Œæ•´åŸ·è¡Œä¸€æ¬¡ 25 åˆ†é˜å°ˆæ³¨æµç¨‹ (IDLE -> PREPARING -> FOCUSING -> COMPLETED)ã€‚
- [ ] **é•è¦æ¸¬è©¦**: 
    - [ ] æ¸¬è©¦æ‰“é–‹ç›’è“‹æ˜¯å¦è§¸ç™¼ VIOLATIONã€‚
    - [ ] æ¸¬è©¦ç§»é–‹æ‰‹æ©Ÿæ˜¯å¦è§¸ç™¼ VIOLATIONã€‚
    - [ ] æ¸¬è©¦é›¢é–‹åº§ä½æ˜¯å¦è§¸ç™¼ VIOLATIONã€‚
- [ ] **æ‡²ç½°æ¸¬è©¦**: ç¢ºèª Threads ç™¼æ–‡åŠŸèƒ½æ˜¯å¦æ­£å¸¸é‹ä½œ (å»ºè­°ä½¿ç”¨æ¸¬è©¦å¸³è™Ÿ)ã€‚
- [ ] **äººè³ªç³»çµ±**: ç¢ºèªåœ–ç‰‡ä¸Šå‚³ã€åˆªé™¤èˆ‡éš¨æ©Ÿé¸å–åŠŸèƒ½æ­£å¸¸ã€‚
</file>

<file path="MARKDOWN/STRUCTURE.md">
# ğŸ“‚ å°ˆæ¡ˆçµæ§‹èªªæ˜ (Project Structure)

æœ¬æ–‡ä»¶è©³ç´°æè¿° **Focus Enforcer** å°ˆæ¡ˆçš„å®Œæ•´ç›®éŒ„çµæ§‹èˆ‡æª”æ¡ˆåŠŸèƒ½ã€‚æœ¬å°ˆæ¡ˆæ¡ç”¨ **å‰å¾Œç«¯åˆ†é›¢** æ¶æ§‹ï¼Œä¸¦æ•´åˆ **ESP8266 ç¡¬é«”éŸŒé«”**ã€‚

---

## ğŸ—ï¸ é ‚å±¤ç›®éŒ„ (Root Directory)

| æª”æ¡ˆ/è³‡æ–™å¤¾ | èªªæ˜ |
| :--- | :--- |
| `Start-FocusEnforcer.ps1` | **ä¸»å•Ÿå‹•è…³æœ¬**ã€‚ä¸€éµå•Ÿå‹•å¾Œç«¯ã€å‰ç«¯èˆ‡ç’°å¢ƒæª¢æŸ¥ã€‚ |
| `Setup.ps1` | **ç’°å¢ƒè¨­ç½®è…³æœ¬**ã€‚å»ºç«‹ Python è™›æ“¬ç’°å¢ƒã€å®‰è£ä¾è³´ã€‚ |
| `Stop-FocusEnforcer.ps1` | **åœæ­¢è…³æœ¬**ã€‚é—œé–‰æ‰€æœ‰ç›¸é—œæœå‹™èˆ‡ç«¯å£ã€‚ |
| `Check-Health.ps1` | ç³»çµ±å¥åº·æª¢æŸ¥è…³æœ¬ã€‚ |
| `Check-GitSecurity.ps1` | Git å®‰å…¨æª¢æŸ¥è…³æœ¬ï¼Œé˜²æ­¢æ†‘è­‰æ´©æ¼ã€‚ |
| `Git-SafePush.ps1` | å®‰å…¨æ¨é€è…³æœ¬ï¼ŒåŸ·è¡Œæ¨é€å‰æª¢æŸ¥ã€‚ |
| `platformio.ini` | **PlatformIO è¨­å®šæª”**ã€‚å®šç¾©ç¡¬é«”é–‹ç™¼æ¿ (D1 Mini) èˆ‡ä¾è³´åº«ã€‚ |
| `backend/` | å¾Œç«¯ä¼ºæœå™¨åŸå§‹ç¢¼ã€‚ |
| `frontend/` | å‰ç«¯ç¶²é æ‡‰ç”¨ç¨‹å¼åŸå§‹ç¢¼ã€‚ |
| `src/` | **ç¡¬é«”éŸŒé«”åŸå§‹ç¢¼** (C++)ã€‚ |
| `MARKDOWN/` | å°ˆæ¡ˆæ–‡ä»¶ã€‚ |

---

## ğŸ å¾Œç«¯çµæ§‹ (backend/)

åŸºæ–¼ **Python FastAPI**ï¼Œè² è²¬æ¥­å‹™é‚è¼¯ã€ç¡¬é«”é€šè¨Šèˆ‡è‡ªå‹•åŒ–ã€‚

### æ ¸å¿ƒæª”æ¡ˆ
| æª”æ¡ˆ | èªªæ˜ |
| :--- | :--- |
| `run.py` | å¾Œç«¯å•Ÿå‹•å…¥å£ (Uvicorn)ã€‚ |
| `requirements.txt` | Python ä¾è³´æ¸…å–®ã€‚ |
| `credentials.json` | **(æ•æ„Ÿ)** å„²å­˜ç¤¾äº¤å¹³å°å¸³è™Ÿå¯†ç¢¼èˆ‡ Tokenã€‚ |

### æ‡‰ç”¨ç¨‹å¼ (backend/app/)
| è³‡æ–™å¤¾/æª”æ¡ˆ | èªªæ˜ |
| :--- | :--- |
| `main.py` | **FastAPI ä¸»ç¨‹å¼**ã€‚è·¯ç”±æ›è¼‰ã€ç”Ÿå‘½é€±æœŸç®¡ç†ã€‚ |
| `socket_manager.py` | **Socket.IO ç®¡ç†å™¨**ã€‚è™•ç† WebSocket é€£ç·šã€ç¡¬é«”æ•¸æ“šåŒæ­¥ã€æ¨¡æ“¬æ¨¡å¼é‚è¼¯ã€‚ |
| `models.py` | **è³‡æ–™æ¨¡å‹**ã€‚å®šç¾© `SensorData`, `HardwareState`, `FocusSession` ç­‰ Pydantic æ¨¡å‹ã€‚ |
| `config.py` | è¨­å®šæª”ç®¡ç†ã€‚ |
| `credential_store.py` | æ†‘è­‰å­˜å–ç®¡ç†ã€‚ |

### è·¯ç”± (backend/app/routers/)
| æª”æ¡ˆ | èªªæ˜ |
| :--- | :--- |
| `sessions.py` | å°ˆæ³¨éšæ®µç®¡ç† (é–‹å§‹ã€æš«åœã€çµæŸ)ã€‚ |
| `hardware.py` | ç¡¬é«”ç‹€æ…‹æŸ¥è©¢èˆ‡æ§åˆ¶ APIã€‚ |
| `hostage.py` | äººè³ªç…§ç‰‡ä¸Šå‚³èˆ‡ç®¡ç† APIã€‚ |
| `social.py` | ç¤¾äº¤å¹³å°è¨­å®šèˆ‡æ¸¬è©¦ APIã€‚ |

### è‡ªå‹•åŒ– (backend/app/automation/)
| æª”æ¡ˆ | èªªæ˜ |
| :--- | :--- |
| `social_manager.py` | ç¤¾äº¤å¹³å°è‡ªå‹•åŒ–é‚è¼¯ (Threads ç™¼æ–‡ã€Gmail ç™¼ä¿¡)ã€‚ |

---

## âš›ï¸ å‰ç«¯çµæ§‹ (frontend/)

åŸºæ–¼ **React + Vite + TypeScript**ã€‚

### æ ¸å¿ƒè¨­å®š
| æª”æ¡ˆ | èªªæ˜ |
| :--- | :--- |
| `vite.config.ts` | Vite è¨­å®šæª” (åŒ…å« Proxy è¨­å®š)ã€‚ |
| `tailwind.config.js` | Tailwind CSS è¨­å®šã€‚ |
| `package.json` | å‰ç«¯ä¾è³´æ¸…å–®ã€‚ |

### åŸå§‹ç¢¼ (frontend/src/)
| è³‡æ–™å¤¾/æª”æ¡ˆ | èªªæ˜ |
| :--- | :--- |
| `main.tsx` | React å…¥å£é»ã€‚ |
| `App.tsx` | ä¸»æ‡‰ç”¨å…ƒä»¶ã€‚ |
| `hooks/useSocket.ts` | **Socket Hook**ã€‚å°è£ WebSocket é€£ç·šèˆ‡ç‹€æ…‹åŒæ­¥é‚è¼¯ã€‚ |
| `hooks/useAudio.ts` | éŸ³æ•ˆæ’­æ”¾ Hookã€‚ |

### å…ƒä»¶ (frontend/src/components/Dashboard/)
| æª”æ¡ˆ | èªªæ˜ |
| :--- | :--- |
| `DashboardPage.tsx` | å„€è¡¨æ¿ä¸»é é¢ã€‚ |
| `HostageManager.tsx` | **äººè³ªç®¡ç†å™¨**ã€‚åœ–ç‰‡ä¸Šå‚³èˆ‡é è¦½ä»‹é¢ã€‚ |
| `PenaltyConfigPanel.tsx` | **æ‡²ç½°è¨­å®šé¢æ¿**ã€‚é–‹é—œå„é …æ„Ÿæ¸¬å™¨æ‡²ç½°æ¢ä»¶ã€‚ |
| `StatusPanel.tsx` | é¡¯ç¤ºç¡¬é«”é€£ç·šç‹€æ…‹èˆ‡æ„Ÿæ¸¬å™¨æ•¸å€¼ã€‚ |
| `Timer.tsx` | å°ˆæ³¨è¨ˆæ™‚å™¨èˆ‡æ§åˆ¶æŒ‰éˆ•ã€‚ |
| `SensorChart.tsx` | æ„Ÿæ¸¬å™¨æ•¸æ“šåœ–è¡¨ã€‚ |
| `SocialSettings.tsx` | ç¤¾äº¤å¹³å°å¸³è™Ÿè¨­å®šä»‹é¢ã€‚ |

---

## ğŸ”Œ ç¡¬é«”éŸŒé«” (src/)

| æª”æ¡ˆ | èªªæ˜ |
| :--- | :--- |
| `main.cpp` | **éŸŒé«”ä¸»ç¨‹å¼**ã€‚åŒ…å«ç‹€æ…‹æ©Ÿé‚è¼¯ã€æ„Ÿæ¸¬å™¨è®€å– (KY-033, LD2410, PN532)ã€LCD é¡¯ç¤ºèˆ‡ WebSocket Client å¯¦ä½œã€‚ |
</file>

<file path="MARKDOWN/TROUBLESHOOTING.md">
# â“ ç–‘é›£æ’è§£ (Troubleshooting)

## ğŸ”Œ ç¡¬é«”é€£ç·šå•é¡Œ

### Q: å„€è¡¨æ¿é¡¯ç¤º "Hardware Disconnected"
1. **æª¢æŸ¥é›»æº**: ç¢ºèª D1 Mini å·²é€é USB é€£æ¥è‡³é›»è…¦æˆ–é›»æºã€‚
2. **æª¢æŸ¥ WiFi**: ç¢ºèª `src/main.cpp` ä¸­çš„ `WIFI_SSID` èˆ‡ `WIFI_PASS` è¨­å®šæ­£ç¢ºï¼Œä¸” D1 Mini èˆ‡é›»è…¦åœ¨åŒä¸€å€åŸŸç¶²è·¯ä¸‹ã€‚
3. **æª¢æŸ¥ IP**: ç¢ºèª `src/main.cpp` ä¸­çš„ `WS_HOST` å·²è¨­å®šç‚ºé›»è…¦çš„æ­£ç¢º IP ä½å€ (å¯ç”¨ `ipconfig` æŸ¥è©¢)ã€‚
4. **é˜²ç«ç‰†**: ç¢ºä¿é›»è…¦é˜²ç«ç‰†æœªé˜»æ“‹ 8000 åŸ  (Python å¾Œç«¯)ã€‚

### Q: æ„Ÿæ¸¬å™¨æ•¸å€¼ç•°å¸¸
- **KY-033 (ç›’è“‹)**: èª¿æ•´æ¨¡çµ„ä¸Šçš„è—è‰²é›»ä½å™¨ï¼Œç›´åˆ°åœ¨ç›’è“‹é—œé–‰æ™‚æŒ‡ç¤ºç‡ˆç†„æ»…/äº®èµ· (è¦–é‚è¼¯è€Œå®š)ï¼Œç¢ºä¿è§¸ç™¼è·é›¢æ­£ç¢ºã€‚
- **NFC**: ç¢ºä¿æ‰‹æ©Ÿæœ‰ NFC åŠŸèƒ½ä¸”å·²é–‹å•Ÿï¼Œä¸¦ç·Šè²¼ PN532 ç·šåœˆã€‚
- **é›·é”**: LD2410 éœ€é ç†±ç´„ 1-2 ç§’ï¼Œä¸”é¿å…å‰æ–¹æœ‰é‡‘å±¬é®è”½ç‰©ã€‚

---

## ğŸ å¾Œç«¯å•é¡Œ

### Q: å•Ÿå‹•æ™‚å‡ºç¾ "Module not found"
è«‹é‡æ–°åŸ·è¡Œå®‰è£è…³æœ¬ï¼š
```powershell
.\Setup.ps1
```
ç¢ºä¿æ‰€æœ‰ä¾è³´å¥—ä»¶å·²æ­£ç¢ºå®‰è£æ–¼è™›æ“¬ç’°å¢ƒä¸­ã€‚

### Q: Playwright éŒ¯èª¤ / ç€è¦½å™¨ç„¡æ³•å•Ÿå‹•
é¦–æ¬¡åŸ·è¡Œå¯èƒ½éœ€è¦å®‰è£ç€è¦½å™¨äºŒé€²ä½æª”ï¼š
```powershell
playwright install chromium
```
(Setup.ps1 é€šå¸¸æœƒè‡ªå‹•è™•ç†æ­¤æ­¥é©Ÿ)

---

## âš›ï¸ å‰ç«¯å•é¡Œ

### Q: é é¢ä¸€ç‰‡ç©ºç™½æˆ–è¼‰å…¥å¤±æ•—
1. æª¢æŸ¥çµ‚ç«¯æ©Ÿæ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯ã€‚
2. ç¢ºèª Node.js ç‰ˆæœ¬æ˜¯å¦ç‚º 18+ã€‚
3. å˜—è©¦åˆªé™¤ `frontend/node_modules` ä¸¦é‡æ–°åŸ·è¡Œ `npm install`ã€‚

### Q: ç„¡æ³•ä¸Šå‚³äººè³ªç…§ç‰‡
- æª¢æŸ¥ `backend/hostage_evidence` è³‡æ–™å¤¾æ˜¯å¦å­˜åœ¨ä¸”æœ‰å¯«å…¥æ¬Šé™ã€‚
- ç¢ºèªåœ–ç‰‡æ ¼å¼ç‚º JPG æˆ– PNGã€‚
- å–®æ¬¡ä¸Šå‚³æ•¸é‡é™åˆ¶ç‚º 30 å¼µã€‚
</file>

<file path="MARKDOWN/USAGE.md">
# ğŸ® ä½¿ç”¨æŒ‡å— (User Guide)

æœ¬æ–‡ä»¶èªªæ˜å¦‚ä½•æ“ä½œ **Focus Enforcer** å„€è¡¨æ¿èˆ‡åŸ·è¡Œå°ˆæ³¨éšæ®µã€‚

---

## ğŸ–¥ï¸ å„€è¡¨æ¿ä»‹é¢æ¦‚è¦½

å„€è¡¨æ¿åˆ†ç‚ºä¸‰å€‹ä¸»è¦å€å¡Šï¼š

1. **å·¦å´æ§åˆ¶å€**:
    - **Timer**: é¡¯ç¤ºå‰©é¤˜æ™‚é–“ã€é–‹å§‹/æš«åœ/åœæ­¢æŒ‰éˆ•ã€‚
    - **Penalty Configuration**: è¨­å®šå“ªäº›é•è¦è¡Œç‚ºæœƒè§¸ç™¼æ‡²ç½°ã€‚
    - **Social Settings**: è¨­å®šç¤¾äº¤å¹³å°å¸³è™Ÿã€‚
2. **å³å´ç‹€æ…‹å€**:
    - **Status Panel**: é¡¯ç¤ºç¡¬é«”é€£ç·šç‹€æ…‹ã€å„æ„Ÿæ¸¬å™¨å³æ™‚ç‹€æ…‹ (Phone, Presence, Box, Noise)ã€‚
    - **Sensor Chart**: å³æ™‚ç¹ªè£½æ„Ÿæ¸¬å™¨æ•¸å€¼æ³¢å½¢åœ–ã€‚
    - **Hostage Manager**: ç®¡ç†äººè³ªç…§ç‰‡ã€‚
3. **é ‚éƒ¨å°è¦½åˆ—**:
    - **Mock Mode é–‹é—œ**: åˆ‡æ›æ¨¡æ“¬æ¨¡å¼/å¯¦é«”æ¨¡å¼ã€‚
    - **é€£ç·šç‹€æ…‹æŒ‡ç¤ºç‡ˆ**: é¡¯ç¤º WebSocket é€£ç·šç‹€æ³ã€‚

---

## â±ï¸ åŸ·è¡Œå°ˆæ³¨éšæ®µ (Focus Session)

### 1. æº–å‚™å·¥ä½œ
1. ç¢ºä¿ç¡¬é«”å·²é€£ç·š (Hardware Connected äº®ç¶ ç‡ˆ) æˆ–é–‹å•Ÿ Mock Modeã€‚
2. åœ¨ **Hostage Manager** ä¸Šå‚³è‡³å°‘ä¸€å¼µç…§ç‰‡ã€‚
3. åœ¨ **Penalty Configuration** å‹¾é¸æ¬²å•Ÿç”¨çš„æ‡²ç½°æ¢ä»¶ (å¦‚ Phone Penalty, Presence Penalty)ã€‚

### 2. é–‹å§‹å°ˆæ³¨
1. è¨­å®šå°ˆæ³¨æ™‚é–“ (é è¨­ 25 åˆ†é˜)ã€‚
2. é»æ“Š **Start Focus** æŒ‰éˆ•ã€‚
3. **é€²å…¥æº–å‚™æœŸ (PREPARING)**:
    - ç³»çµ±çµ¦äºˆ 10 ç§’å€’æ•¸ã€‚
    - è«‹åœ¨æ­¤æ™‚å°‡æ‰‹æ©Ÿæ”¾å…¥ç›’å­ã€é—œä¸Šç›’è“‹ã€ä¸¦åå®šä½ç½®ã€‚
    - LCD é¡¯ç¤º "PREPARING..."ã€‚

### 3. å°ˆæ³¨é€²è¡Œä¸­ (FOCUSING)
- å€’æ•¸çµæŸå¾Œï¼Œé€²å…¥ **FOCUSING** ç‹€æ…‹ã€‚
- ç³»çµ±é–‹å§‹åš´æ ¼ç›£æ§ï¼š
    - **æ‰‹æ©Ÿ**: å¿…é ˆä¿æŒåœ¨ NFC/ç›’è“‹åµæ¸¬ç¯„åœå…§ã€‚
    - **äººé«”**: é›·é”å¿…é ˆåµæ¸¬åˆ°æœ‰äººåœ¨åº§ã€‚
    - **ç›’è“‹**: å¿…é ˆä¿æŒé—œé–‰ã€‚
    - **å™ªéŸ³**: (è‹¥å•Ÿç”¨) å¿…é ˆä½æ–¼è¨­å®šåˆ†è²æ•¸ã€‚

### 4. é•è¦èˆ‡æ‡²ç½° (VIOLATION)
- è‹¥åµæ¸¬åˆ°é•è¦ (å¦‚æ‰“é–‹ç›’å­)ï¼š
    - ç‹€æ…‹è®Šç‚º **VIOLATION**ã€‚
    - å„€è¡¨æ¿é¡¯ç¤ºç´…è‰²è­¦ç¤ºã€‚
    - è§¸ç™¼ **Social Shame Protocol**ï¼š
        - éš¨æ©ŸæŒ‘é¸ä¸€å¼µäººè³ªç…§ç‰‡ã€‚
        - è‡ªå‹•ç™¼å¸ƒè‡³ Threadsã€‚
        - (å¯é¸) ç™¼é€ Email é€šçŸ¥ã€‚
- æ‡²ç½°åŸ·è¡Œå¾Œï¼Œç‹€æ…‹å¯èƒ½éœ€æ‰‹å‹•é‡ç½®æˆ–è‡ªå‹•æ¢å¾© (è¦–è¨­å®šè€Œå®š)ã€‚

### 5. æš«åœèˆ‡çµæŸ
- **æš«åœ**: é»æ“Š **Pause** å¯æš«æ™‚åœæ­¢ç›£æ¸¬ (ç‹€æ…‹è®Šç‚º PAUSED)ã€‚
- **çµæŸ**: è¨ˆæ™‚çµæŸæˆ–é»æ“Š **Stop**ï¼Œç‹€æ…‹å›åˆ° IDLEã€‚

---

## ğŸ§ª æ¨¡æ“¬æ¨¡å¼ (Mock Mode)

è‹¥ç„¡å¯¦é«”ç¡¬é«”ï¼Œå¯ä½¿ç”¨æ¨¡æ“¬æ¨¡å¼æ¸¬è©¦åŠŸèƒ½ï¼š

1. é»æ“Šé ‚éƒ¨çš„ **Enable Mock Mode**ã€‚
2. **Dev Panel** æœƒå‡ºç¾åœ¨å³ä¸‹è§’ (æˆ–ç‹€æ…‹å€)ã€‚
3. æ‚¨å¯ä»¥æ‰‹å‹•åˆ‡æ›æ„Ÿæ¸¬å™¨ç‹€æ…‹ï¼š
    - **Toggle Phone**: æ¨¡æ“¬æ‰‹æ©Ÿæ”¾å…¥/å–å‡ºã€‚
    - **Toggle Presence**: æ¨¡æ“¬äººé›¢é–‹/å›ä¾†ã€‚
    - **Toggle Box**: æ¨¡æ“¬ç›’è“‹é–‹å•Ÿ/é—œé–‰ã€‚
4. è§€å¯Ÿå„€è¡¨æ¿èˆ‡ç‹€æ…‹æ©Ÿçš„åæ‡‰ã€‚

---

## ğŸ“¸ äººè³ªç®¡ç† (Hostage Manager)

ä½æ–¼å„€è¡¨æ¿å³å´æˆ–ä¸‹æ–¹ Tabï¼š

- **ä¸Šå‚³**: é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡è‡³ä¸Šå‚³å€ (æ”¯æ´ JPG/PNG)ã€‚
- **é è¦½**: æŸ¥çœ‹å·²ä¸Šå‚³çš„åœ–ç‰‡ã€‚
- **åˆªé™¤**: ç§»é™¤ä¸æƒ³ä½¿ç”¨çš„åœ–ç‰‡ã€‚
- **æ©Ÿåˆ¶**: é•è¦æ™‚ï¼Œå¾Œç«¯æœƒå¾æ­¤åˆ—è¡¨ä¸­éš¨æ©ŸæŒ‘é¸ä¸€å¼µåœ–ç‰‡é€²è¡Œç™¼å¸ƒã€‚
</file>

<file path="platformio.ini">
; ============================================================================
; THE FOCUS ENFORCER v1.0 - PlatformIO Configuration
; Platform: Wemos D1 mini (ESP8266)
; ============================================================================

[env:d1_mini]
platform = espressif8266
board = d1_mini
framework = arduino

; Serial Monitor & Upload
monitor_speed = 115200
upload_speed = 921600

; Build flags
build_flags = 
    -D PIO_FRAMEWORK_ARDUINO_ENABLE_STORAGE
    -D ARDUINOJSON_ENABLE_PROGMEM=1

; Library Dependencies
lib_deps = 
    bblanchon/ArduinoJson @ ^6.21.3
    links2004/WebSockets @ ^2.4.1
    marcoschwartz/LiquidCrystal_I2C @ ^1.1.4
    EspSoftwareSerial
    adafruit/Adafruit PN532 @ ^1.3.0
</file>

<file path="README.md">
# ğŸ›¡ï¸ THE FOCUS ENFORCER v1.0

**Zero-Trust Focus Monitoring with Social Shaming Enforcement**
**é›¶ä¿¡ä»»å°ˆæ³¨ç›£æ§èˆ‡ç¤¾äº¤ç¾è¾±åŸ·æ³•ç³»çµ±**

---

## ğŸ“– å°ˆæ¡ˆæ–‡æª”å°è¦½ (Documentation)

æœ¬å°ˆæ¡ˆåŒ…å«å®Œæ•´çš„æŠ€è¡“æ–‡ä»¶ï¼Œè«‹åƒé–± `MARKDOWN/` è³‡æ–™å¤¾ï¼š

- **[å°ˆæ¡ˆç¸½è¦½ (Overview)](MARKDOWN/OVERVIEW.md)**: äº†è§£æ ¸å¿ƒæ¦‚å¿µã€åŠŸèƒ½èˆ‡æ¶æ§‹ã€‚
- **[å®‰è£æŒ‡å— (Setup)](MARKDOWN/SETUP.md)**: å¾é›¶é–‹å§‹çš„è»Ÿç¡¬é«”å»ºç½®æ•™å­¸ã€‚
- **[ä½¿ç”¨æŒ‡å— (Usage)](MARKDOWN/USAGE.md)**: å„€è¡¨æ¿æ“ä½œèˆ‡å°ˆæ³¨æµç¨‹èªªæ˜ã€‚
- **[å°ˆæ¡ˆçµæ§‹ (Structure)](MARKDOWN/STRUCTURE.md)**: æª”æ¡ˆç›®éŒ„èˆ‡ç¨‹å¼ç¢¼èªªæ˜ã€‚
- **[é€šè¨Šå”å®š (Socket)](MARKDOWN/SOCKET_COMMUNICATION.md)**: å‰å¾Œç«¯èˆ‡ç¡¬é«”çš„é€šè¨Šè¦æ ¼ã€‚
- **[ç–‘é›£æ’è§£ (Troubleshooting)](MARKDOWN/TROUBLESHOOTING.md)**: å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆã€‚

---

## ğŸš€ å¿«é€Ÿå•Ÿå‹• (Quick Start)

### 1. ç’°å¢ƒè¨­ç½® (é¦–æ¬¡åŸ·è¡Œ)
åœ¨ PowerShell ä¸­åŸ·è¡Œï¼š
```powershell
.\Setup.ps1
```

### 2. å•Ÿå‹•ç³»çµ±
ä¸€éµå•Ÿå‹•å¾Œç«¯ã€å‰ç«¯èˆ‡ç€è¦½å™¨ï¼š
```powershell
.\Start-FocusEnforcer.ps1
```

### 3. å­˜å–ä»‹é¢
- **å„€è¡¨æ¿**: [http://localhost:5173](http://localhost:5173)
- **API æ–‡ä»¶**: [http://localhost:8000/docs](http://localhost:8000/docs)

---

## âš ï¸ å®‰å…¨æ€§è­¦å‘Š (Security Warning)

æœ¬å°ˆæ¡ˆåŒ…å« **Git å®‰å…¨æ€§æ©Ÿåˆ¶**ï¼Œé˜²æ­¢æ†‘è­‰æ´©æ¼ï¼š
- æ¨é€å‰è«‹å‹™å¿…åŸ·è¡Œ `Git-SafePush.ps1`ã€‚
- æ•æ„Ÿè³‡è¨Š (å¦‚ `credentials.json`) å·²è¢« `.gitignore` æ’é™¤ã€‚
- è©³æƒ…è«‹åƒé–± [GIT_SECURITY_README.md](GIT_SECURITY_README.md)ã€‚

---

## ğŸ› ï¸ æŠ€è¡“å †ç–Š (Tech Stack)

- **Frontend**: React, Vite, TypeScript, Tailwind CSS
- **Backend**: Python FastAPI, Socket.IO, Playwright
- **Hardware**: ESP8266 (Wemos D1 Mini), PlatformIO, C++
- **Sensors**: LD2410 (Radar), KY-033 (IR), PN532 (NFC), MAX9418 (Mic)
</file>

<file path="src/main.cpp">
/*
 * ============================================================================
 * THE FOCUS ENFORCER v1.0 - å°ˆæ³¨åŸ·æ³•è€…ç¡¬é«”æ§åˆ¶å™¨ (D1-mini é‡æ§‹ç‰ˆ)
 * ============================================================================
 * 
 * ã€ç³»çµ±èªªæ˜ã€‘
 * æ­¤ç‚º Wemos D1-mini (ESP8266) ç¡¬é«”æ§åˆ¶ç¨‹å¼ã€‚
 * å¯¦ä½œå®Œæ•´ç‹€æ…‹æ©Ÿæ¶æ§‹ã€10 ç§’æº–å‚™å¯¬é™æœŸåŠ 1602 LCD é¡¯ç¤ºã€‚
 * é€é WebSocket èˆ‡å¾Œç«¯ä¼ºæœå™¨é€²è¡Œå³æ™‚é€šè¨Šã€‚
 * 
 * v1.0 æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - ç‹€æ…‹æ©Ÿæ¶æ§‹: IDLE â†’ PREPARING (10s) â†’ FOCUSING â†’ PAUSED/VIOLATION
 * - KY-033 ç´…å¤–ç·šåå°„å¼æ„Ÿæ¸¬å™¨ä¸­æ–·åµæ¸¬ (ç›’è“‹é–‹é—œåµæ¸¬)
 * - 1602 I2C LCD å³æ™‚ç‹€æ…‹é¡¯ç¤º
 * - LD2410 mmWave é›·é”äººé«”åµæ¸¬
 * 
 * ã€ç¡¬é«”æ¥ç·šæŒ‡å— - D1-mini GPIO åˆ†é…è¡¨ã€‘
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ æ¨¡çµ„              â”‚ åŠŸèƒ½       â”‚ D1-mini â”‚ GPIO  â”‚ å‚™è¨»                  â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ 1602 LCD (I2C)    â”‚ SDA        â”‚ D2      â”‚ GPIO4 â”‚ I2C è³‡æ–™ç·š (å…±ç”¨)     â”‚
 * â”‚                   â”‚ SCL        â”‚ D1      â”‚ GPIO5 â”‚ I2C æ™‚è„ˆç·š (å…±ç”¨)     â”‚
 * â”‚                   â”‚ VCC        â”‚ 5V      â”‚ -     â”‚ éœ€ 5V ä¾›é›»            â”‚
 * â”‚                   â”‚ GND        â”‚ GND     â”‚ -     â”‚                       â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ ç´…å¤–ç·šæ„Ÿæ¸¬å™¨      â”‚ DO         â”‚ D3      â”‚ GPIO0 â”‚ ä¸­æ–·è…³ä½ (CHANGE)     â”‚
 * â”‚ (KY-033)          â”‚ VCC        â”‚ 3V3     â”‚ -     â”‚ 3.3V ä¾›é›»             â”‚
 * â”‚                   â”‚ GND        â”‚ GND     â”‚ -     â”‚ åå°„é¢=LOW            â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ LD2410 mmWave     â”‚ TX         â”‚ D5      â”‚ GPIO14â”‚ SoftwareSerial RX     â”‚
 * â”‚                   â”‚ RX         â”‚ D6      â”‚ GPIO12â”‚ SoftwareSerial TX     â”‚
 * â”‚                   â”‚ VCC        â”‚ 5V      â”‚ -     â”‚ éœ€ 5V ä¾›é›»            â”‚
 * â”‚                   â”‚ GND        â”‚ GND     â”‚ -     â”‚                       â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ è²éŸ³æ„Ÿæ¸¬å™¨        â”‚ AO         â”‚ A0      â”‚ ADC0  â”‚ é¡æ¯”è¼¸å…¥              â”‚
 * â”‚ (MAX9418)         â”‚ VCC        â”‚ 3V3/5V  â”‚ -     â”‚                       â”‚
 * â”‚                   â”‚ GND        â”‚ GND     â”‚ -     â”‚                       â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ PN532 NFC æ¨¡çµ„    â”‚ SDA        â”‚ D2      â”‚ GPIO4 â”‚ I2C è³‡æ–™ç·š (å…±ç”¨)     â”‚
 * â”‚ (I2C æ¨¡å¼)        â”‚ SCL        â”‚ D1      â”‚ GPIO5 â”‚ I2C æ™‚è„ˆç·š (å…±ç”¨)     â”‚
 * â”‚                   â”‚ VCC        â”‚ 3V3/5V  â”‚ -     â”‚                       â”‚
 * â”‚                   â”‚ GND        â”‚ GND     â”‚ -     â”‚                       â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * 
 * ã€KY-033 ç´…å¤–ç·šæ„Ÿæ¸¬å™¨é‚è¼¯ã€‘
 * - åµæ¸¬åˆ°åå°„é¢ (ç›’è“‹é—œé–‰): DO = LOW  â†’ æ­£å¸¸ç‹€æ…‹
 * - ç„¡åå°„/è·é›¢éé  (ç›’è“‹é–‹å•Ÿ): DO = HIGH â†’ è§¸ç™¼é•è¦
 * - æœ‰æ•ˆåµæ¸¬è·é›¢: 2~30mm (å¯é€éé›»ä½å™¨èª¿æ•´)
 * - ä½¿ç”¨ä¸­æ–·åµæ¸¬ï¼Œç¢ºä¿å³æ™‚éŸ¿æ‡‰
 * 
 * ã€ç‹€æ…‹æ©Ÿèªªæ˜ã€‘
 *   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   START_CMD    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   10ç§’å¾Œ   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *   â”‚  IDLE   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ PREPARING â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ FOCUSING â”‚
 *   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *        â–²                          â”‚                        â”‚
 *        â”‚         CANCEL_CMD       â”‚                        â”‚ é•è¦
 *        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â–¼
 *        â”‚                                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 *        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STOP_CMD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ VIOLATION â”‚
 *        â”‚                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *        â”‚         PAUSE_CMD        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
 *        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ PAUSED â”‚â—„â”€â”€â”€â”€ FOCUSING + PAUSE_CMD
 *                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 */

#include <ESP8266WiFi.h>
#include <WebSocketsClient.h>
#include <ArduinoJson.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>
#include <SoftwareSerial.h>
#include <Adafruit_PN532.h>

// ============================================================================
// ç‰ˆæœ¬è³‡è¨Š
// ============================================================================
#define FIRMWARE_VERSION "1.0.0"
#define HARDWARE_ID "D1MINI_FOCUS_001"

// ============================================================================
// WiFi è¨­å®š
// ============================================================================
const char* WIFI_SSID = "Andy";
const char* WIFI_PASS = "1QazxsW2";

// ============================================================================
// WebSocket ä¼ºæœå™¨è¨­å®š
// ============================================================================
const char* WS_HOST = "192.168.0.55";
const uint16_t WS_PORT = 8000;
const char* WS_PATH = "/ws/hardware";

// ============================================================================
// GPIO è…³ä½å®šç¾© - D1-mini (ESP8266)
// ============================================================================
// I2C åŒ¯æµæ’ (LCD å…±ç”¨)
#define PIN_I2C_SDA     D2      // GPIO4  - I2C è³‡æ–™ç·š
#define PIN_I2C_SCL     D1      // GPIO5  - I2C æ™‚è„ˆç·š

// KY-033 ç´…å¤–ç·šæ„Ÿæ¸¬å™¨ (åå°„å¼, ä¸­æ–·)
#define PIN_HALL        D3      // GPIO0  - KY-033 æ•¸ä½è¼¸å‡º (DO) - ä¸­æ–·è…³ä½

// LD2410 mmWave é›·é” (SoftwareSerial)
#define PIN_RADAR_RX    D5      // GPIO14 - é›·é” TX â†’ D1 RX
#define PIN_RADAR_TX    D6      // GPIO12 - é›·é” RX â† D1 TX

// MAX9418 è²éŸ³æ„Ÿæ¸¬å™¨
#define PIN_MIC         A0      // ADC0 - é¡æ¯”è¼¸å…¥

// PN532 NFC è¨­å®š (I2C)
#define PN532_IRQ       (2)     // é€™è£¡æš«ä¸ä½¿ç”¨ IRQï¼Œæ¡è¼ªè©¢æ¨¡å¼
#define PN532_RESET     (3)     // é€™è£¡æš«ä¸ä½¿ç”¨ RESET

// ============================================================================
// LCD è¨­å®š
// ============================================================================
#define LCD_ADDR        0x27    // PCF8574 I2C åœ°å€ (å¸¸è¦‹: 0x27 æˆ– 0x3F)
#define LCD_COLS        16
#define LCD_ROWS        2

// ============================================================================
// ç‹€æ…‹æ©Ÿå®šç¾©
// ============================================================================
enum SystemState {
    STATE_IDLE,         // å¾…æ©Ÿç‹€æ…‹ - ç­‰å¾…é–‹å§‹æŒ‡ä»¤
    STATE_PREPARING,    // æº–å‚™ä¸­ - 10 ç§’å¯¬é™æœŸ
    STATE_FOCUSING,     // å°ˆæ³¨ä¸­ - ç›£æ¸¬é•è¦è¡Œç‚º
    STATE_PAUSED,       // æš«åœä¸­ - æš«æ™‚åœæ­¢ç›£æ¸¬
    STATE_VIOLATION,    // é•è¦ç‹€æ…‹ - åµæ¸¬åˆ°é•è¦è¡Œç‚º
    STATE_ERROR         // éŒ¯èª¤ç‹€æ…‹ - ç³»çµ±ç•°å¸¸
};

// ç‹€æ…‹åç¨± (ç”¨æ–¼é™¤éŒ¯è¼¸å‡º)
const char* STATE_NAMES[] = {
    "IDLE", "PREPARING", "FOCUSING", "PAUSED", "VIOLATION", "ERROR"
};

// ============================================================================
// æ™‚é–“å¸¸æ•¸ (æ¯«ç§’)
// ============================================================================
#define PREPARE_DURATION_MS     10000   // æº–å‚™å¯¬é™æœŸ: 10 ç§’
#define SENSOR_INTERVAL_MS      100     // æ„Ÿæ¸¬å™¨è®€å–é–“éš”: 100ms (10Hz)
#define LCD_UPDATE_INTERVAL_MS  250     // LCD æ›´æ–°é–“éš”: 250ms (4Hz)
#define HEARTBEAT_INTERVAL_MS   5000    // å¿ƒè·³é–“éš”: 5 ç§’
#define WIFI_RECONNECT_TIMEOUT  30000   // WiFi é‡é€£è¶…æ™‚: 30 ç§’
#define IR_DEBOUNCE_MS          50      // ç´…å¤–ç·šæ„Ÿæ¸¬å™¨é˜²æŠ–å‹•: 50ms

// ============================================================================
// é›·é”é˜²æŠ–å‹•è¨­å®š
// ============================================================================
#define RADAR_DEBOUNCE_MS   3000    // äººé«”é›¢é–‹é˜²æŠ–å‹•: 3 ç§’

// ============================================================================
// å…¨åŸŸè®Šæ•¸ - ç³»çµ±ç‹€æ…‹
// ============================================================================
volatile SystemState currentState = STATE_IDLE;
SystemState previousState = STATE_IDLE;
unsigned long stateEnterTime = 0;           // é€²å…¥ç•¶å‰ç‹€æ…‹çš„æ™‚é–“
unsigned long focusStartTime = 0;           // å°ˆæ³¨é–‹å§‹æ™‚é–“
unsigned long totalFocusTime = 0;           // ç´¯è¨ˆå°ˆæ³¨æ™‚é–“

// ============================================================================
// å…¨åŸŸè®Šæ•¸ - KY-033 ç´…å¤–ç·šæ„Ÿæ¸¬å™¨ (ä¸­æ–·ç›¸é—œ)
// ============================================================================
volatile bool irTriggered = false;          // ä¸­æ–·è§¸ç™¼æ——æ¨™
volatile unsigned long irTriggerTime = 0;   // è§¸ç™¼æ™‚é–“
bool boxOpen = false;                       // ç›’è“‹ç‹€æ…‹ (true = é–‹å•Ÿ)

// ============================================================================
// å…¨åŸŸè®Šæ•¸ - é›·é”åµæ¸¬
// ============================================================================
bool radarPresence = false;                 // é›·é”åµæ¸¬åˆ°äººé«”
bool radarRawReading = false;               // åŸå§‹é›·é”è®€æ•¸
unsigned long radarLowStartTime = 0;        // é–‹å§‹åµæ¸¬åˆ°ç„¡äººçš„æ™‚é–“

// ============================================================================
// å…¨åŸŸè®Šæ•¸ - è²éŸ³åµæ¸¬
// ============================================================================
int micDb = 40;                             // ç•¶å‰åˆ†è²å€¼ (é è¨­ 40dB)

// ============================================================================
// å…¨åŸŸè®Šæ•¸ - NFC åµæ¸¬
// ============================================================================
bool nfcDetected = false;                   // æ˜¯å¦åµæ¸¬åˆ° NFC æ¨™ç±¤
String nfcId = "";                          // åµæ¸¬åˆ°çš„ NFC ID

// ============================================================================
// å…¨åŸŸè®Šæ•¸ - ç¶²è·¯èˆ‡é€£ç·š
// ============================================================================
bool isConnectedToBackend = false;
unsigned long lastSensorRead = 0;
unsigned long lastLcdUpdate = 0;
unsigned long lastHeartbeat = 0;
bool wifiReconnecting = false;
unsigned long wifiReconnectStart = 0;

// ============================================================================
// å…¨åŸŸç‰©ä»¶
// ============================================================================
WebSocketsClient webSocket;
LiquidCrystal_I2C lcd(LCD_ADDR, LCD_COLS, LCD_ROWS);
SoftwareSerial radarSerial(PIN_RADAR_RX, PIN_RADAR_TX);
Adafruit_PN532 nfc(PIN_I2C_SDA, PIN_I2C_SCL);

// ============================================================================
// å‡½å¼å‰å‘å®£å‘Š
// ============================================================================
// åˆå§‹åŒ–å‡½å¼
void initHardware();
void initLCD();
void initIRSensor();     // KY-033 ç´…å¤–ç·šæ„Ÿæ¸¬å™¨åˆå§‹åŒ–
void initRadar();
void initMic();          // MAX9418 è²éŸ³æ„Ÿæ¸¬å™¨åˆå§‹åŒ–
void initNFC();          // PN532 NFC åˆå§‹åŒ–
void initWiFi();
void initWebSocket();

// ç‹€æ…‹æ©Ÿå‡½å¼
void updateStateMachine();
void enterState(SystemState newState);
void handleIdleState();
void handlePreparingState();
void handleFocusingState();
void handlePausedState();
void handleViolationState();

// æ„Ÿæ¸¬å™¨è®€å–å‡½å¼
void readSensors();
void readRadar();
void readMic();          // è®€å–è²éŸ³æ„Ÿæ¸¬å™¨
void readNFC();          // è®€å– NFC
void processIRInterrupt();

// é¡¯ç¤ºå‡½å¼
void updateLCD();
void lcdShowIdle();
void lcdShowPreparing();
void lcdShowFocusing();
void lcdShowPaused();
void lcdShowViolation();

// ç¶²è·¯å‡½å¼
void handleWiFiReconnect();
void sendSensorData();
void sendStateChange();
void sendHeartbeat();
void webSocketEvent(WStype_t type, uint8_t* payload, size_t length);
void handleCommand(const char* payload);

// å·¥å…·å‡½å¼
String formatTime(unsigned long ms);
void IRAM_ATTR irISR();

// ============================================================================
// setup() - ç³»çµ±åˆå§‹åŒ–
// ============================================================================
void setup() {
    Serial.begin(115200);
    delay(500);
    
    Serial.println("\n");
    Serial.println(F("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"));
    Serial.println(F("â•‘     THE FOCUS ENFORCER v1.0 - å°ˆæ³¨åŸ·æ³•è€…                 â•‘"));
    Serial.println(F("â•‘     Wemos D1-mini (ESP8266) Firmware                     â•‘"));
    Serial.println(F("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"));
    Serial.print(F("[SYS] Hardware ID: "));
    Serial.println(HARDWARE_ID);
    Serial.print(F("[SYS] Firmware Version: "));
    Serial.println(FIRMWARE_VERSION);
    
    // åˆå§‹åŒ–æ‰€æœ‰ç¡¬é«”
    initHardware();
    
    // åˆå§‹åŒ– WiFi
    initWiFi();
    
    // åˆå§‹åŒ– WebSocket
    initWebSocket();
    
    // é€²å…¥å¾…æ©Ÿç‹€æ…‹
    enterState(STATE_IDLE);
    
    Serial.println(F("[SYS] âœ“ System ready - Waiting for focus session..."));
    Serial.println(F("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"));
}

// ============================================================================
// loop() - ä¸»è¿´åœˆ (éé˜»å¡è¨­è¨ˆ)
// ============================================================================
void loop() {
    unsigned long currentMillis = millis();
    
    // WebSocket ç¶­è­·
    webSocket.loop();
    
    // WiFi é€£ç·šæª¢æŸ¥èˆ‡é‡é€£
    if (WiFi.status() != WL_CONNECTED) {
        handleWiFiReconnect();
        return;
    } else if (wifiReconnecting) {
        // WiFi é‡é€£æˆåŠŸ
        Serial.println(F("\n[WiFi] âœ“ Reconnected!"));
        Serial.print(F("[WiFi] IP: "));
        Serial.println(WiFi.localIP());
        wifiReconnecting = false;
        webSocket.disconnect();
        delay(100);
        webSocket.begin(WS_HOST, WS_PORT, WS_PATH);
    }
    
    // è™•ç†ç´…å¤–ç·šæ„Ÿæ¸¬å™¨ä¸­æ–·
    processIRInterrupt();
    
    // æ„Ÿæ¸¬å™¨è®€å– (10Hz)
    if (currentMillis - lastSensorRead >= SENSOR_INTERVAL_MS) {
        readSensors();
        sendSensorData();
        lastSensorRead = currentMillis;
    }
    
    // LCD æ›´æ–° (4Hz)
    if (currentMillis - lastLcdUpdate >= LCD_UPDATE_INTERVAL_MS) {
        updateLCD();
        lastLcdUpdate = currentMillis;
    }
    
    // ç‹€æ…‹æ©Ÿæ›´æ–°
    updateStateMachine();
    
    // å¿ƒè·³ç™¼é€
    if (isConnectedToBackend && currentMillis - lastHeartbeat >= HEARTBEAT_INTERVAL_MS) {
        sendHeartbeat();
        lastHeartbeat = currentMillis;
    }
}

// ============================================================================
// initHardware() - åˆå§‹åŒ–æ‰€æœ‰ç¡¬é«”
// ============================================================================
void initHardware() {
    Serial.println(F("[HW] Initializing hardware..."));
    
    initLCD();
    initIRSensor();  // KY-033 ç´…å¤–ç·šæ„Ÿæ¸¬å™¨
    initRadar();
    initMic();       // MAX9418 è²éŸ³æ„Ÿæ¸¬å™¨
    initNFC();       // PN532 NFC æ¨¡çµ„
    
    Serial.println(F("[HW] âœ“ All hardware initialized"));
}

// ============================================================================
// initLCD() - åˆå§‹åŒ– 1602 I2C LCD
// ============================================================================
void initLCD() {
    Serial.print(F("[LCD] Initializing 1602 LCD @ 0x"));
    Serial.print(LCD_ADDR, HEX);
    Serial.print(F("..."));
    
    Wire.begin(PIN_I2C_SDA, PIN_I2C_SCL);
    lcd.init();
    lcd.backlight();
    
    // é¡¯ç¤ºå•Ÿå‹•ç•«é¢
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print(F("Focus Enforcer"));
    lcd.setCursor(0, 1);
    lcd.print(F("v1.0 Starting..."));
    
    Serial.println(F(" OK"));
}

// ============================================================================
// initIRSensor() - åˆå§‹åŒ– KY-033 ç´…å¤–ç·šæ„Ÿæ¸¬å™¨ (ä¸­æ–·æ¨¡å¼)
// èªªæ˜: KY-033 æ˜¯ç´…å¤–ç·šåå°„å¼æ„Ÿæ¸¬å™¨ï¼Œå¸¸ç”¨æ–¼å¾ªè·¡æˆ–é¿éšœ
//      - ç™½è‰²/åå…‰è¡¨é¢: åå°„ç´…å¤–ç·š â†’ DO è¼¸å‡º LOW
//      - é»‘è‰²/å¸å…‰è¡¨é¢: å¸æ”¶ç´…å¤–ç·š â†’ DO è¼¸å‡º HIGH
//      - æœ¬å°ˆæ¡ˆç”¨æ–¼åµæ¸¬ç›’è“‹: è“‹å­é—œé–‰æ™‚åå°„é¢é è¿‘ = LOW (æ­£å¸¸)
//                             è“‹å­é–‹å•Ÿæ™‚ç„¡åå°„ = HIGH (é•è¦)
// ============================================================================
void initIRSensor() {
    Serial.print(F("[IR] Initializing KY-033 IR sensor on D3 (GPIO0)..."));
    
    pinMode(PIN_HALL, INPUT_PULLUP);
    
    // è®€å–åˆå§‹ç‹€æ…‹ (HIGH = ç„¡åå°„/ç›’è“‹é–‹å•Ÿ, LOW = æœ‰åå°„/ç›’è“‹é—œé–‰)
    boxOpen = (digitalRead(PIN_HALL) == HIGH);
    
    // è¨­å®šä¸­æ–· (CHANGE æ¨¡å¼: åµæ¸¬åå°„ç‹€æ…‹è®ŠåŒ–)
    // LOWâ†’HIGH: åå°„é¢é›¢é–‹ (ç›’è“‹é–‹å•Ÿ)
    // HIGHâ†’LOW: åå°„é¢é è¿‘ (ç›’è“‹é—œé–‰)
    attachInterrupt(digitalPinToInterrupt(PIN_HALL), irISR, CHANGE);
    
    Serial.println(F(" OK"));
    Serial.print(F("[IR] Initial state: Box "));
    Serial.println(boxOpen ? F("OPEN (No reflection)") : F("CLOSED (Reflecting)"));
}

// ============================================================================
// initRadar() - åˆå§‹åŒ– LD2410 mmWave é›·é”
// ============================================================================
void initRadar() {
    Serial.print(F("[RADAR] Initializing LD2410 mmWave radar..."));
    
    radarSerial.begin(256000);  // LD2410 é è¨­ baud rate
    
    // çµ¦é›·é”ä¸€é»å•Ÿå‹•æ™‚é–“
    delay(100);
    
    Serial.println(F(" OK"));
}

// ============================================================================
// initMic() - åˆå§‹åŒ– MAX9418 è²éŸ³æ„Ÿæ¸¬å™¨
// ============================================================================
void initMic() {
    Serial.print(F("[MIC] Initializing MAX9418 sound sensor on A0..."));
    
    // ESP8266 A0 ä¸éœ€è¦ç‰¹åˆ¥åˆå§‹åŒ–ï¼Œç›´æ¥ analogRead å³å¯
    micDb = 40;
    
    Serial.println(F(" OK"));
}

// ============================================================================
// initNFC() - åˆå§‹åŒ– PN532 NFC æ¨¡çµ„
// ============================================================================
void initNFC() {
    Serial.print(F("[NFC] Initializing PN532 NFC module..."));
    
    nfc.begin();
    
    uint32_t versiondata = nfc.getFirmwareVersion();
    if (!versiondata) {
        Serial.println(F(" âœ— PN532 not found!"));
        return;
    }
    
    // è¨­å®šç‚ºè®€å–æ¨¡å¼
    nfc.SAMConfig();
    
    Serial.println(F(" OK"));
    Serial.print(F("[NFC] Found chip PN5"));
    Serial.println((versiondata >> 24) & 0xFF, HEX);
}

// ============================================================================
// initWiFi() - åˆå§‹åŒ– WiFi é€£ç·š
// ============================================================================
void initWiFi() {
    Serial.print(F("[WiFi] Connecting to "));
    Serial.print(WIFI_SSID);
    
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print(F("WiFi Connecting"));
    lcd.setCursor(0, 1);
    lcd.print(WIFI_SSID);
    
    WiFi.mode(WIFI_STA);
    WiFi.begin(WIFI_SSID, WIFI_PASS);
    
    int attempts = 0;
    while (WiFi.status() != WL_CONNECTED && attempts < 30) {
        delay(500);
        Serial.print(F("."));
        attempts++;
    }
    Serial.println();
    
    if (WiFi.status() == WL_CONNECTED) {
        Serial.print(F("[WiFi] âœ“ Connected! IP: "));
        Serial.println(WiFi.localIP());
        
        lcd.clear();
        lcd.setCursor(0, 0);
        lcd.print(F("WiFi Connected"));
        lcd.setCursor(0, 1);
        lcd.print(WiFi.localIP());
        delay(1000);
    } else {
        Serial.println(F("[WiFi] âœ— Connection failed!"));
        lcd.clear();
        lcd.setCursor(0, 0);
        lcd.print(F("WiFi Failed!"));
    }
}

// ============================================================================
// initWebSocket() - åˆå§‹åŒ– WebSocket
// ============================================================================
void initWebSocket() {
    Serial.print(F("[WS] Connecting to ws://"));
    Serial.print(WS_HOST);
    Serial.print(F(":"));
    Serial.println(WS_PORT);
    
    webSocket.begin(WS_HOST, WS_PORT, WS_PATH);
    webSocket.onEvent(webSocketEvent);
    webSocket.setReconnectInterval(10000);
    webSocket.enableHeartbeat(15000, 3000, 2);
}

// ============================================================================
// handleWiFiReconnect() - è™•ç† WiFi é‡é€£
// ============================================================================
void handleWiFiReconnect() {
    if (!wifiReconnecting) {
        Serial.println(F("[WiFi] Connection lost, reconnecting..."));
        wifiReconnecting = true;
        wifiReconnectStart = millis();
        isConnectedToBackend = false;
        WiFi.disconnect();
        delay(100);
        WiFi.begin(WIFI_SSID, WIFI_PASS);
    } else {
        if (millis() - wifiReconnectStart > WIFI_RECONNECT_TIMEOUT) {
            Serial.println(F("[WiFi] Reconnect timeout, restarting..."));
            ESP.restart();
        }
    }
}

// ============================================================================
// irISR() - KY-033 ç´…å¤–ç·šæ„Ÿæ¸¬å™¨ä¸­æ–·æœå‹™å¸¸å¼
// ============================================================================
void IRAM_ATTR irISR() {
    irTriggered = true;
    irTriggerTime = millis();
}

// ============================================================================
// processIRInterrupt() - è™•ç† KY-033 ç´…å¤–ç·šæ„Ÿæ¸¬å™¨ä¸­æ–· (ä¸»è¿´åœˆä¸­å‘¼å«)
// ============================================================================
void processIRInterrupt() {
    if (!irTriggered) return;
    
    // é˜²æŠ–å‹•æª¢æŸ¥
    if (millis() - irTriggerTime < IR_DEBOUNCE_MS) return;
    
    irTriggered = false;
    
    // è®€å–ç•¶å‰ç‹€æ…‹
    bool newState = (digitalRead(PIN_HALL) == HIGH);
    
    if (newState != boxOpen) {
        boxOpen = newState;
        
        Serial.print(F("[IR] Box "));
        Serial.println(boxOpen ? F("OPENED! âš ï¸") : F("CLOSED âœ“"));
        
        // å°ˆæ³¨ç‹€æ…‹ä¸‹é–‹ç›’ = é•è¦
        if (boxOpen && currentState == STATE_FOCUSING) {
            Serial.println(F("[VIOLATION] Box opened during focus session!"));
            enterState(STATE_VIOLATION);
        }
    }
}

// ============================================================================
// readSensors() - è®€å–æ‰€æœ‰æ„Ÿæ¸¬å™¨
// ============================================================================
void readSensors() {
    readRadar();
    readMic();
    readNFC();
}

// ============================================================================
// readRadar() - è®€å– LD2410 é›·é” (é˜²æŠ–å‹•)
// ============================================================================
void readRadar() {
    // ç°¡åŒ–ç‰ˆï¼šä½¿ç”¨ GPIO è¼¸å‡ºæ¨¡å¼
    // LD2410 çš„ OUT è…³ä½ï¼šHIGH = åµæ¸¬åˆ°äººé«”, LOW = ç„¡äºº
    // é€™è£¡å‡è¨­ LD2410 OUT æ¥åˆ°æŸå€‹ GPIO (å¯é¸)
    // è‹¥ä½¿ç”¨ UART æ¨¡å¼ï¼Œéœ€è¦è§£æé›·é”å”å®š
    
    // æš«æ™‚æ¨¡æ“¬/æˆ–é€é SoftwareSerial è®€å–
    // é€™è£¡ç°¡åŒ–ç‚ºä¸åµæ¸¬ (ä¿ç•™æ“´å±•ç©ºé–“)
    bool rawReading = radarPresence;  // ç¶­æŒç•¶å‰ç‹€æ…‹
    
    // TODO: å¯¦ä½œ LD2410 UART å”å®šè§£æ
    // æˆ–ä½¿ç”¨ç°¡å–®çš„ GPIO OUT æ¨¡å¼
    
    // é˜²æŠ–å‹•é‚è¼¯ï¼šäººé›¢é–‹éœ€è¦ 3 ç§’ç¢ºèª
    if (rawReading) {
        radarPresence = true;
        radarLowStartTime = 0;
    } else {
        if (radarPresence && radarLowStartTime == 0) {
            radarLowStartTime = millis();
        }
        if (radarLowStartTime > 0 && millis() - radarLowStartTime >= RADAR_DEBOUNCE_MS) {
            radarPresence = false;
        }
    }
}

// ============================================================================
// readMic() - è®€å– MAX9418 è²éŸ³æ„Ÿæ¸¬å™¨ (é¡æ¯”è½‰åˆ†è²)
// ============================================================================
void readMic() {
    // è®€å–é¡æ¯”æ•¸å€¼ (0-1023)
    int raw = analogRead(PIN_MIC);
    
    // ç°¡æ˜“è½‰æ›é‚è¼¯ (åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›éœ€æ ¡æº–)
    // å‡è¨­ 0-1023 å°æ‡‰ 30-100 dB
    micDb = map(raw, 0, 1023, 30, 100);
    
    // é™åˆ¶ç¯„åœ
    if (micDb < 30) micDb = 30;
    if (micDb > 110) micDb = 110;
}

// ============================================================================
// readNFC() - è®€å– PN532 NFC æ¨™ç±¤
// ============================================================================
void readNFC() {
    uint8_t success;
    uint8_t uid[] = { 0, 0, 0, 0, 0, 0, 0 };  // Buffer to store the returned UID
    uint8_t uidLength;                        // Length of the UID (4 or 7 bytes depending on ISO14443A card type)
    
    // éé˜»å¡è®€å– (ç­‰å¾…æ™‚é–“æ¥µçŸ­)
    success = nfc.readPassiveTargetID(PN532_MIFARE_ISO14443A, uid, &uidLength, 10);
    
    if (success) {
        nfcDetected = true;
        nfcId = "";
        for (uint8_t i = 0; i < uidLength; i++) {
            if (uid[i] < 0x10) nfcId += "0";
            nfcId += String(uid[i], HEX);
        }
        nfcId.toUpperCase();
    } else {
        nfcDetected = false;
        nfcId = "";
    }
}

// ============================================================================
// ç‹€æ…‹æ©Ÿï¼šenterState() - é€²å…¥æ–°ç‹€æ…‹
// ============================================================================
void enterState(SystemState newState) {
    if (newState == currentState) return;
    
    previousState = currentState;
    currentState = newState;
    stateEnterTime = millis();
    
    Serial.print(F("[STATE] "));
    Serial.print(STATE_NAMES[previousState]);
    Serial.print(F(" â†’ "));
    Serial.println(STATE_NAMES[currentState]);
    
    // ç‹€æ…‹é€²å…¥å‹•ä½œ
    switch (newState) {
        case STATE_IDLE:
            totalFocusTime = 0;
            break;
            
        case STATE_PREPARING:
            // æº–å‚™éšæ®µï¼š10 ç§’å€’æ•¸
            Serial.println(F("[PREPARE] 10-second grace period started"));
            break;
            
        case STATE_FOCUSING:
            focusStartTime = millis();
            Serial.println(F("[FOCUS] Focus session started!"));
            break;
            
        case STATE_PAUSED:
            // æš«åœæ™‚ç´¯è¨ˆå°ˆæ³¨æ™‚é–“
            if (previousState == STATE_FOCUSING) {
                totalFocusTime += millis() - focusStartTime;
            }
            Serial.println(F("[PAUSE] Session paused"));
            break;
            
        case STATE_VIOLATION:
            // é•è¦æ™‚ç´¯è¨ˆå°ˆæ³¨æ™‚é–“
            if (previousState == STATE_FOCUSING) {
                totalFocusTime += millis() - focusStartTime;
            }
            Serial.println(F("[VIOLATION] Violation detected!"));
            break;
            
        default:
            break;
    }
    
    // é€šçŸ¥å¾Œç«¯ç‹€æ…‹è®Šæ›´
    sendStateChange();
}

// ============================================================================
// ç‹€æ…‹æ©Ÿï¼šupdateStateMachine() - æ›´æ–°ç‹€æ…‹æ©Ÿ
// ============================================================================
void updateStateMachine() {
    switch (currentState) {
        case STATE_IDLE:
            handleIdleState();
            break;
        case STATE_PREPARING:
            handlePreparingState();
            break;
        case STATE_FOCUSING:
            handleFocusingState();
            break;
        case STATE_PAUSED:
            handlePausedState();
            break;
        case STATE_VIOLATION:
            handleViolationState();
            break;
        default:
            break;
    }
}

// ============================================================================
// handleIdleState() - å¾…æ©Ÿç‹€æ…‹è™•ç†
// ============================================================================
void handleIdleState() {
    // å¾…æ©Ÿç‹€æ…‹ï¼šç­‰å¾…ä¾†è‡ªå¾Œç«¯çš„ START æŒ‡ä»¤
    // ç„¡éœ€ä¸»å‹•è™•ç†
}

// ============================================================================
// handlePreparingState() - æº–å‚™ç‹€æ…‹è™•ç† (10 ç§’å¯¬é™æœŸ)
// ============================================================================
void handlePreparingState() {
    unsigned long elapsed = millis() - stateEnterTime;
    
    // 10 ç§’å¯¬é™æœŸçµæŸ
    if (elapsed >= PREPARE_DURATION_MS) {
        enterState(STATE_FOCUSING);
    }
}

// ============================================================================
// handleFocusingState() - å°ˆæ³¨ç‹€æ…‹è™•ç†
// ============================================================================
void handleFocusingState() {
    // æª¢æŸ¥é•è¦æ¢ä»¶
    // 1. ç›’è“‹é–‹å•Ÿ (ç”±ä¸­æ–·è™•ç†)
    // 2. å…¶ä»–é•è¦æ¢ä»¶å¯åœ¨æ­¤æ·»åŠ 
}

// ============================================================================
// handlePausedState() - æš«åœç‹€æ…‹è™•ç†
// ============================================================================
void handlePausedState() {
    // æš«åœç‹€æ…‹ï¼šç­‰å¾… RESUME æˆ– STOP æŒ‡ä»¤
}

// ============================================================================
// handleViolationState() - é•è¦ç‹€æ…‹è™•ç†
// ============================================================================
void handleViolationState() {
    // é•è¦ç‹€æ…‹ï¼šç­‰å¾…å¾Œç«¯è™•ç†
}

// ============================================================================
// updateLCD() - æ›´æ–° LCD é¡¯ç¤º
// ============================================================================
void updateLCD() {
    switch (currentState) {
        case STATE_IDLE:
            lcdShowIdle();
            break;
        case STATE_PREPARING:
            lcdShowPreparing();
            break;
        case STATE_FOCUSING:
            lcdShowFocusing();
            break;
        case STATE_PAUSED:
            lcdShowPaused();
            break;
        case STATE_VIOLATION:
            lcdShowViolation();
            break;
        default:
            break;
    }
}

// ============================================================================
// lcdShowIdle() - LCD å¾…æ©Ÿç•«é¢
// ============================================================================
void lcdShowIdle() {
    lcd.setCursor(0, 0);
    lcd.print(F("  READY TO GO   "));
    lcd.setCursor(0, 1);
    lcd.print(F("  Waiting...    "));
}

// ============================================================================
// lcdShowPreparing() - LCD æº–å‚™ç•«é¢
// ============================================================================
void lcdShowPreparing() {
    unsigned long remaining = PREPARE_DURATION_MS - (millis() - stateEnterTime);
    int seconds = remaining / 1000;
    
    lcd.setCursor(0, 0);
    lcd.print(F("  PREPARING...  "));
    lcd.setCursor(0, 1);
    lcd.print(F("  Start in: "));
    lcd.print(seconds);
    lcd.print(F("s  "));
}

// ============================================================================
// lcdShowFocusing() - LCD å°ˆæ³¨ç•«é¢
// ============================================================================
void lcdShowFocusing() {
    unsigned long elapsed = millis() - focusStartTime + totalFocusTime;
    
    lcd.setCursor(0, 0);
    lcd.print(F("   FOCUSING     "));
    lcd.setCursor(0, 1);
    lcd.print(F("Time: "));
    lcd.print(formatTime(elapsed));
    lcd.print(F("    "));
}

// ============================================================================
// lcdShowPaused() - LCD æš«åœç•«é¢
// ============================================================================
void lcdShowPaused() {
    lcd.setCursor(0, 0);
    lcd.print(F("    PAUSED      "));
    lcd.setCursor(0, 1);
    lcd.print(F("Total: "));
    lcd.print(formatTime(totalFocusTime));
}

// ============================================================================
// lcdShowViolation() - LCD é•è¦ç•«é¢
// ============================================================================
void lcdShowViolation() {
    // é–ƒçˆæ•ˆæœ
    static bool blink = false;
    blink = !blink;
    
    lcd.setCursor(0, 0);
    if (blink) {
        lcd.print(F("!! VIOLATION !! "));
    } else {
        lcd.print(F("                "));
    }
    lcd.setCursor(0, 1);
    lcd.print(F("Box was opened! "));
}

// ============================================================================
// formatTime() - æ ¼å¼åŒ–æ™‚é–“ (æ¯«ç§’ â†’ MM:SS)
// ============================================================================
String formatTime(unsigned long ms) {
    unsigned long totalSec = ms / 1000;
    int minutes = totalSec / 60;
    int seconds = totalSec % 60;
    
    String result = "";
    if (minutes < 10) result += "0";
    result += String(minutes);
    result += ":";
    if (seconds < 10) result += "0";
    result += String(seconds);
    
    return result;
}

// ============================================================================
// sendSensorData() - ç™¼é€æ„Ÿæ¸¬å™¨è³‡æ–™
// ============================================================================
void sendSensorData() {
    if (!isConnectedToBackend) return;
    
    StaticJsonDocument<512> doc;
    doc[0] = "sensor_data";
    
    JsonObject data = doc.createNestedObject();
    data["hardware_id"] = HARDWARE_ID;
    data["state"] = STATE_NAMES[currentState];
    data["box_open"] = boxOpen;
    data["radar_presence"] = radarPresence;
    data["mic_db"] = micDb;
    data["nfc_detected"] = nfcDetected;
    data["nfc_id"] = nfcId;
    data["uptime"] = millis() / 1000;
    data["timestamp"] = millis();
    
    String payload;
    serializeJson(doc, payload);
    webSocket.sendTXT(payload);
}

// ============================================================================
// sendStateChange() - ç™¼é€ç‹€æ…‹è®Šæ›´é€šçŸ¥
// ============================================================================
void sendStateChange() {
    if (!isConnectedToBackend) return;
    
    StaticJsonDocument<256> doc;
    doc[0] = "state_change";
    
    JsonObject data = doc.createNestedObject();
    data["hardware_id"] = HARDWARE_ID;
    data["previous_state"] = STATE_NAMES[previousState];
    data["current_state"] = STATE_NAMES[currentState];
    data["timestamp"] = millis();
    
    // å°ˆæ³¨æ™‚é–“è³‡è¨Š
    if (currentState == STATE_VIOLATION || currentState == STATE_PAUSED || currentState == STATE_IDLE) {
        data["total_focus_time_ms"] = totalFocusTime;
    }
    
    String payload;
    serializeJson(doc, payload);
    webSocket.sendTXT(payload);
}

// ============================================================================
// sendHeartbeat() - ç™¼é€å¿ƒè·³
// ============================================================================
void sendHeartbeat() {
    StaticJsonDocument<256> doc;
    doc[0] = "heartbeat";
    
    JsonObject data = doc.createNestedObject();
    data["hardware_id"] = HARDWARE_ID;
    data["state"] = STATE_NAMES[currentState];
    data["uptime"] = millis() / 1000;
    data["wifi_rssi"] = WiFi.RSSI();
    data["free_heap"] = ESP.getFreeHeap();
    
    String payload;
    serializeJson(doc, payload);
    webSocket.sendTXT(payload);
}

// ============================================================================
// webSocketEvent() - WebSocket äº‹ä»¶è™•ç†
// ============================================================================
void webSocketEvent(WStype_t type, uint8_t* payload, size_t length) {
    switch (type) {
        case WStype_DISCONNECTED:
            if (isConnectedToBackend) {
                Serial.println(F("[WS] Disconnected"));
            }
            isConnectedToBackend = false;
            break;
            
        case WStype_CONNECTED:
            Serial.print(F("[WS] âœ“ Connected to: "));
            Serial.println((char*)payload);
            isConnectedToBackend = true;
            
            // ç™¼é€ç¡¬é«”è¨»å†Šè¨Šæ¯
            {
                StaticJsonDocument<256> doc;
                doc[0] = "hardware_connect";
                
                JsonObject data = doc.createNestedObject();
                data["hardware_id"] = HARDWARE_ID;
                data["version"] = FIRMWARE_VERSION;
                data["board"] = "D1-mini";
                data["features"] = "hall,lcd,radar";
                
                String msg;
                serializeJson(doc, msg);
                webSocket.sendTXT(msg);
            }
            break;
            
        case WStype_TEXT:
            handleCommand((char*)payload);
            break;
            
        case WStype_PING:
        case WStype_PONG:
            break;
            
        default:
            break;
    }
}

// ============================================================================
// handleCommand() - è™•ç†å¾Œç«¯æŒ‡ä»¤
// ============================================================================
void handleCommand(const char* payload) {
    if (!payload) return;
    
    StaticJsonDocument<256> doc;
    DeserializationError error = deserializeJson(doc, payload);
    
    if (error) {
        Serial.print(F("[WS] JSON parse error: "));
        Serial.println(error.c_str());
        return;
    }
    
    const char* command = doc["command"];
    if (!command) return;
    
    Serial.print(F("[CMD] Received: "));
    Serial.println(command);
    
    // æŒ‡ä»¤è™•ç†
    if (strcmp(command, "START") == 0) {
        if (currentState == STATE_IDLE) {
            enterState(STATE_PREPARING);
        }
    }
    else if (strcmp(command, "STOP") == 0 || strcmp(command, "CANCEL") == 0) {
        enterState(STATE_IDLE);
    }
    else if (strcmp(command, "PAUSE") == 0) {
        if (currentState == STATE_FOCUSING) {
            enterState(STATE_PAUSED);
        }
    }
    else if (strcmp(command, "RESUME") == 0) {
        if (currentState == STATE_PAUSED) {
            enterState(STATE_FOCUSING);
            focusStartTime = millis();  // é‡æ–°é–‹å§‹è¨ˆæ™‚
        }
    }
    else if (strcmp(command, "ACKNOWLEDGE") == 0) {
        // ç¢ºèªé•è¦å¾Œå›åˆ°å¾…æ©Ÿ
        if (currentState == STATE_VIOLATION) {
            enterState(STATE_IDLE);
        }
    }
    else if (strcmp(command, "PING") == 0) {
        // å›æ‡‰ ping
        StaticJsonDocument<128> response;
        response[0] = "pong";
        response[1]["hardware_id"] = HARDWARE_ID;
        
        String msg;
        serializeJson(response, msg);
        webSocket.sendTXT(msg);
    }
    else {
        Serial.print(F("[CMD] Unknown command: "));
        Serial.println(command);
    }
}
</file>

<file path="Start-FocusEnforcer.ps1">
# Focus Enforcer v1.0 - PowerShell Launcher
# This script starts both the backend and frontend servers

Write-Host ""
Write-Host "============================================" -ForegroundColor Cyan
Write-Host "  Focus Enforcer v1.0 - System Launcher" -ForegroundColor Cyan
Write-Host "============================================" -ForegroundColor Cyan
Write-Host ""

$BackendPath = Join-Path $PSScriptRoot "backend"
$FrontendPath = Join-Path $PSScriptRoot "frontend"
$VenvPath = Join-Path $BackendPath "venv\Scripts\Activate.ps1"

# Global variables for cleanup
$script:BackendJob = $null
$script:FrontendJob = $null

# Cleanup function
function Stop-AllServers {
    Write-Host ""
    Write-Host "============================================" -ForegroundColor Yellow
    Write-Host "  Stopping All Services..." -ForegroundColor Yellow
    Write-Host "============================================" -ForegroundColor Yellow
    Write-Host ""
    
    # Stop Backend
    if ($script:BackendJob -and -not $script:BackendJob.HasExited) {
        Write-Host "[1/2] Stopping Backend (PID: $($script:BackendJob.Id))..." -ForegroundColor Yellow
        
        # Find all child processes of the PowerShell process
        $backendChildren = Get-CimInstance Win32_Process | Where-Object { $_.ParentProcessId -eq $script:BackendJob.Id }
        foreach ($child in $backendChildren) {
            Stop-Process -Id $child.ProcessId -Force -ErrorAction SilentlyContinue
            Write-Host "      Stopped child process $($child.ProcessId)" -ForegroundColor Gray
        }
        
        # Stop the PowerShell process itself
        Stop-Process -Id $script:BackendJob.Id -Force -ErrorAction SilentlyContinue
        Write-Host "      Backend stopped" -ForegroundColor Green
    }
    
    # Stop Frontend
    if ($script:FrontendJob -and -not $script:FrontendJob.HasExited) {
        Write-Host "[2/2] Stopping Frontend (PID: $($script:FrontendJob.Id))..." -ForegroundColor Yellow
        
        # Find all child processes of the PowerShell process
        $frontendChildren = Get-CimInstance Win32_Process | Where-Object { $_.ParentProcessId -eq $script:FrontendJob.Id }
        foreach ($child in $frontendChildren) {
            Stop-Process -Id $child.ProcessId -Force -ErrorAction SilentlyContinue
            Write-Host "      Stopped child process $($child.ProcessId)" -ForegroundColor Gray
        }
        
        # Stop the PowerShell process itself
        Stop-Process -Id $script:FrontendJob.Id -Force -ErrorAction SilentlyContinue
        Write-Host "      Frontend stopped" -ForegroundColor Green
    }
    
    # Also kill any processes on the default ports
    Write-Host ""
    Write-Host "Checking for processes on ports 8000 and 5173..." -ForegroundColor Yellow
    $connections = Get-NetTCPConnection -LocalPort 8000,5173 -ErrorAction SilentlyContinue
    foreach ($conn in $connections) {
        $proc = Get-Process -Id $conn.OwningProcess -ErrorAction SilentlyContinue
        if ($proc) {
            Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
            Write-Host "  Stopped process $($proc.Id) ($($proc.Name)) on port $($conn.LocalPort)" -ForegroundColor Gray
        }
    }
    
    Write-Host ""
    Write-Host "============================================" -ForegroundColor Green
    Write-Host "  All Services Stopped Successfully" -ForegroundColor Green
    Write-Host "============================================" -ForegroundColor Green
    Write-Host ""
}

# Register cleanup on Ctrl+C
[Console]::TreatControlCAsInput = $false
$null = Register-EngineEvent -SourceIdentifier PowerShell.Exiting -Action { Stop-AllServers }

Write-Host ""
Write-Host "============================================" -ForegroundColor Green
Write-Host "  Starting Services..." -ForegroundColor Green
Write-Host "============================================" -ForegroundColor Green
Write-Host ""

# Start Backend
Write-Host "[1/2] Starting Backend Server..." -ForegroundColor Green
$script:BackendJob = Start-Process -FilePath "powershell" -ArgumentList "-NoExit", "-Command", "Set-Location '$BackendPath'; & '$VenvPath'; python run.py" -PassThru -WindowStyle Minimized

Write-Host "      Backend started (PID: $($script:BackendJob.Id))" -ForegroundColor Green
Write-Host "      Waiting 5 seconds before starting frontend..." -ForegroundColor Gray

# Wait 5 seconds before starting frontend
Start-Sleep -Seconds 5

# Start Frontend
Write-Host "[2/2] Starting Frontend Server..." -ForegroundColor Green
$script:FrontendJob = Start-Process -FilePath "powershell" -ArgumentList "-NoExit", "-Command", "Set-Location '$FrontendPath'; npm run dev" -PassThru -WindowStyle Minimized

Write-Host "      Frontend started (PID: $($script:FrontendJob.Id))" -ForegroundColor Green

Write-Host ""
Write-Host "============================================" -ForegroundColor Green
Write-Host "  System Started Successfully!" -ForegroundColor Green
Write-Host "============================================" -ForegroundColor Green
Write-Host ""
Write-Host "  Backend:  http://localhost:8000" -ForegroundColor White
Write-Host "  Frontend: http://localhost:5173" -ForegroundColor White
Write-Host "  Docs:     http://localhost:8000/docs" -ForegroundColor White
Write-Host ""
Write-Host "  Press Ctrl+C to stop the system..." -ForegroundColor Yellow
Write-Host ""

# Wait for user interrupt
try {
    while ($true) {
        Start-Sleep -Seconds 1
        
        # Check if child processes are still running
        if ($script:BackendJob.HasExited -or $script:FrontendJob.HasExited) {
            Write-Host ""
            Write-Host "One or more services exited unexpectedly." -ForegroundColor Red
            break
        }
    }
} catch {
    # Handle exceptions
    Write-Host ""
    Write-Host "Exception caught: $_" -ForegroundColor Red
} finally {
    Stop-AllServers
}
</file>

<file path="MARKDOWN/OVERVIEW.md">
# ğŸ›¡ï¸ THE FOCUS ENFORCER v1.0 - å°ˆæ³¨åŸ·æ³•è€…

## ğŸ“– å°ˆæ¡ˆç°¡ä»‹
**THE FOCUS ENFORCER** æ˜¯ä¸€å€‹çµåˆç¡¬é«”ç›£æ§èˆ‡ç¤¾äº¤æ‡²ç½°æ©Ÿåˆ¶çš„ã€Œé›¶ä¿¡ä»»ã€å°ˆæ³¨åŠ›å¼·åŒ–ç³»çµ±ã€‚ä¸åŒæ–¼ä¸€èˆ¬çš„å°ˆæ³¨ App åªèƒ½åœ¨è»Ÿé«”å±¤é¢æé†’ï¼Œæœ¬ç³»çµ±é€éå¯¦é«”ç¡¬é«”ç›’å­èˆ‡å¤šé‡æ„Ÿæ¸¬å™¨ï¼Œå¼·åˆ¶ä½¿ç”¨è€…å°‡æ‰‹æ©Ÿé–å®šæˆ–ä¿æŒåœ¨ç‰¹å®šå€åŸŸã€‚

ä¸€æ—¦ç³»çµ±åµæ¸¬åˆ°ä½¿ç”¨è€…åœ¨å°ˆæ³¨æœŸé–“é•è¦ï¼ˆå¦‚ï¼šæå‰å–å‡ºæ‰‹æ©Ÿã€é›¢é–‹åº§ä½ã€æ‰“é–‹ç›’è“‹ï¼‰ï¼Œç³»çµ±å°‡æœƒç«‹å³åŸ·è¡Œã€Œç¤¾äº¤ç¾è¾±å”å®š (Social Shame Protocol)ã€ï¼Œå°‡ä½¿ç”¨è€…é å…ˆä¸Šå‚³çš„ã€Œäººè³ªç…§ç‰‡ã€ç™¼å¸ƒè‡³ç¤¾äº¤å¹³å° (Threads) æˆ–å‚³é€çµ¦æŒ‡å®šè¯çµ¡äººã€‚

---

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. é›¶ä¿¡ä»»ç¡¬é«”ç›£æ§ (Zero-Trust Monitoring)
ç³»çµ±æ¡ç”¨åš´æ ¼çš„ç¡¬é«”ç‹€æ…‹æ©Ÿæ¶æ§‹ï¼Œç¢ºä¿ç›£æ§çš„æº–ç¢ºæ€§èˆ‡ä¸å¯ç¹éæ€§ã€‚

- **ç‹€æ…‹æ©Ÿæ¶æ§‹**: 6 ç¨®ç¡¬é«”ç‹€æ…‹ (IDLE â†’ PREPARING â†’ FOCUSING â†’ PAUSED â†’ VIOLATION â†’ ERROR)
- **10 ç§’æº–å‚™å¯¬é™æœŸ**: é–‹å§‹å°ˆæ³¨å‰æœ‰ 10 ç§’ç·©è¡æ™‚é–“ (PREPARING)ï¼Œè®“ä½¿ç”¨è€…å®‰ç½®æ‰‹æ©Ÿèˆ‡èª¿æ•´ç’°å¢ƒã€‚
- **å¤šé‡æ„Ÿæ¸¬èåˆ**: 
    - **KY-033 ç´…å¤–ç·šæ„Ÿæ¸¬å™¨**: ç”¨æ–¼åµæ¸¬ç›’è“‹é–‹é—œç‹€æ…‹ (Box Open/Closed)ã€‚
        - *è¨»ï¼šå¾Œç«¯é‚è¼¯ä¸­å°æ‡‰ `box_open` æˆ– `hall_detected` æ¬„ä½ã€‚*
    - **æ¯«ç±³æ³¢é›·é” (LD2410)**: ç²¾ç¢ºåµæ¸¬ä½¿ç”¨è€…æ˜¯å¦åœ¨åº§ä½ä¸Š (Presence Detection)ã€‚
    - **MAX9418 è²éŸ³æ„Ÿæ¸¬å™¨**: ç›£æ¸¬ç’°å¢ƒå™ªéŸ³ (Noise Detection)ï¼Œé˜²æ­¢åœ¨å®‰éœå ´æ‰€ç™¼å‡ºå™ªéŸ³ã€‚
    - **PN532 NFC æ¨¡çµ„**: åµæ¸¬æ‰‹æ©Ÿæ˜¯å¦å·²æ”¾å…¥ç›’å­ä¸­ (Phone Detection)ï¼Œç¢ºä¿ã€Œç‰©ç†é–å®šã€ã€‚
- **1602 LCD é¡¯ç¤º**: æœ¬åœ°å³æ™‚é¡¯ç¤ºç•¶å‰ç‹€æ…‹ã€å€’æ•¸è¨ˆæ™‚èˆ‡é•è¦è³‡è¨Šã€‚

### 2. å½ˆæ€§å°ˆæ³¨æ§åˆ¶
- **æš«åœ/ç¹¼çºŒåŠŸèƒ½**: æ”¯æ´æš«æ™‚åœæ­¢ç›£æ¸¬ (PAUSED)ï¼Œä¸è§¸ç™¼æ‡²ç½°ï¼Œé©ç”¨æ–¼çŸ­æš«ä¼‘æ¯æˆ–ç·Šæ€¥ç‹€æ³ã€‚
- **å³æ™‚åŒæ­¥**: å‰ç«¯å„€è¡¨æ¿èˆ‡ç¡¬é«”ç‹€æ…‹é€é WebSocket æ¯«ç§’ç´šåŒæ­¥ã€‚

### 3. ç¤¾äº¤ç¾è¾±å”å®š (Social Shame Protocol)
é€™æ˜¯æœ¬ç³»çµ±æœ€å¼·å¤§çš„ç´„æŸåŠ›ä¾†æºã€‚

- **äººè³ªç³»çµ± (Hostage System)**: 
    - ä½¿ç”¨è€…éœ€å…ˆä¸Šå‚³ã€Œäººè³ªç…§ç‰‡ã€ï¼ˆå¦‚ï¼šå°·å°¬çš„è‡ªæ‹ã€é»‘æ­·å²ç…§ç‰‡ï¼‰ã€‚
    - æ”¯æ´æ‹–æ›³ä¸Šå‚³ï¼Œæœ€å¤š 30 å¼µã€‚
    - é•è¦æ™‚éš¨æ©ŸæŒ‘é¸ä¸€å¼µé€²è¡Œã€Œè™•æ±ºã€ã€‚
- **è‡ªå‹•åŒ–æ‡²ç½°**: 
    - **Threads**: è‡ªå‹•ç™¼æ–‡ä¸¦é™„ä¸Šäººè³ªç…§ç‰‡ã€‚
    - **Gmail**: ç™¼é€ç¾è¾±éƒµä»¶çµ¦æŒ‡å®šè¯çµ¡äºº (å¦‚è¦ªå‹ã€è€é—†)ã€‚
- **æ‡²ç½°è¨­å®š**: å¯è‡ªè¨‚è§¸ç™¼æ¢ä»¶ (å¦‚ï¼šæ˜¯å¦å•Ÿç”¨å™ªéŸ³æ‡²ç½°ã€æ˜¯å¦å•Ÿç”¨é›¢åº§æ‡²ç½°)ã€‚

### 4. ç¾ä»£åŒ–å„€è¡¨æ¿ (Dashboard)
- **å³æ™‚æ•¸æ“š**: è¦–è¦ºåŒ–é¡¯ç¤ºæ‰€æœ‰æ„Ÿæ¸¬å™¨æ•¸å€¼ (é›·é”ã€å…‰æ„Ÿã€å™ªéŸ³)ã€‚
- **æ‡²ç½°é€²åº¦**: é•è¦æ™‚é¡¯ç¤ºç´…è‰²è­¦ç¤ºèˆ‡æ‡²ç½°åŸ·è¡Œé€²åº¦æ¢ã€‚
- **æ¨¡æ“¬æ¨¡å¼ (Mock Mode)**: å…§å»ºè»Ÿé«”æ¨¡æ“¬å™¨ï¼Œç„¡éœ€é€£æ¥å¯¦é«”ç¡¬é«”å³å¯æ¸¬è©¦æ‰€æœ‰åŠŸèƒ½ã€‚

---

## ğŸ› ï¸ æŠ€è¡“æ¶æ§‹

### å¾Œç«¯ (Backend)
- **FastAPI**: é«˜æ€§èƒ½ Python Web æ¡†æ¶ï¼Œæä¾› REST API èˆ‡ WebSocket æœå‹™ã€‚
- **Socket.IO**: å¯¦ç¾å³æ™‚é›™å‘é€šè¨Šï¼Œé€£æ¥å‰ç«¯èˆ‡ç¡¬é«”ã€‚
- **Playwright**: ç”¨æ–¼ç€è¦½å™¨è‡ªå‹•åŒ–ï¼ŒåŸ·è¡Œ Threads ç™¼æ–‡æ“ä½œã€‚
- **Pydantic**: åš´æ ¼çš„è³‡æ–™æ¨¡å‹é©—è­‰ã€‚

### å‰ç«¯ (Frontend)
- **React 18 + TypeScript**: ç¾ä»£åŒ–å‰ç«¯æ¡†æ¶ã€‚
- **Vite**: æ¥µé€Ÿå»ºç½®å·¥å…·ã€‚
- **Tailwind CSS**: å¯¦ç”¨å„ªå…ˆçš„ CSS æ¡†æ¶ï¼Œæ‰“é€ ç²¾ç¾ UIã€‚
- **Shadcn/ui**: é«˜å“è³ª UI å…ƒä»¶åº«ã€‚

### ç¡¬é«” (Hardware)
- **PlatformIO (C++)**: éŸŒé«”é–‹ç™¼ç’°å¢ƒã€‚
- **ESP8266 (Wemos D1 Mini)**: ä¸»æ§æ™¶ç‰‡ã€‚
- **ç‹€æ…‹æ©Ÿè¨­è¨ˆ**: éŸŒé«”å±¤ç´šå¯¦ä½œç‹€æ…‹æ©Ÿï¼Œç¢ºä¿é‚è¼¯ç©©å¥ã€‚
</file>

<file path="MARKDOWN/SETUP.md">
# ğŸ› ï¸ ç³»çµ±å®‰è£èˆ‡è¨­å®šæŒ‡å—

æœ¬æŒ‡å—å°‡å¼•å°æ‚¨å®Œæˆ **THE FOCUS ENFORCER v1.0** çš„è»Ÿç¡¬é«”å»ºç½®ã€‚

---

## ğŸ“‹ éœ€æ±‚æ¸…å–®

### è»Ÿé«”ç’°å¢ƒ
- **OS**: Windows 10/11 (æ¨è–¦)
- **Python**: 3.10 æˆ–ä»¥ä¸Š
- **Node.js**: 18.0 æˆ–ä»¥ä¸Š
- **Git**: ç‰ˆæœ¬æ§åˆ¶å·¥å…·
- **VS Code**: æ¨è–¦ç·¨è¼¯å™¨ (éœ€å®‰è£ PlatformIO æ“´å……åŠŸèƒ½)

### ç¡¬é«”æ¸…å–® (v1.0)
| å…ƒä»¶ | æ•¸é‡ | ç”¨é€” |
|------|------|------|
| **Wemos D1 Mini (ESP8266)** | 1 | ä¸»æ§æ¿ |
| **1602 LCD (å« I2C è½‰æ¿)** | 1 | ç‹€æ…‹é¡¯ç¤º |
| **KY-033 ç´…å¤–ç·šæ„Ÿæ¸¬å™¨** | 1 | ç›’è“‹é–‹é—œåµæ¸¬ (åå°„å¼) |
| **LD2410 mmWave é›·é”** | 1 | äººé«”å­˜åœ¨åµæ¸¬ |
| **MAX9418 è²éŸ³æ„Ÿæ¸¬å™¨** | 1 | ç’°å¢ƒå™ªéŸ³åµæ¸¬ |
| **PN532 NFC æ¨¡çµ„** | 1 | æ‰‹æ©Ÿæ”¾å…¥åµæ¸¬ (I2C æ¨¡å¼) |
| **éºµåŒ…æ¿èˆ‡æœé‚¦ç·š** | è‹¥å¹² | é€£æ¥é›»è·¯ |

---

## ğŸ”Œ ç¡¬é«”æ¥ç·šæŒ‡å—

è«‹ä¾ç…§ä¸‹è¡¨å°‡å„æ¨¡çµ„é€£æ¥è‡³ Wemos D1 Miniã€‚

### GPIO åˆ†é…è¡¨

| æ¨¡çµ„ | æ¥è…³ | D1 Mini | GPIO | å‚™è¨» |
| :--- | :--- | :--- | :--- | :--- |
| **1602 LCD** | SDA | D2 | GPIO4 | I2C Bus |
| | SCL | D1 | GPIO5 | I2C Bus |
| | VCC | 5V | - | |
| | GND | GND | - | |
| **PN532 NFC** | SDA | D2 | GPIO4 | I2C Bus (å…±ç”¨) |
| | SCL | D1 | GPIO5 | I2C Bus (å…±ç”¨) |
| | VCC | 3V3/5V | - | |
| | GND | GND | - | |
| **KY-033 IR** | DO | D3 | GPIO0 | æ•¸ä½è¼¸å‡º (ä¸­æ–·) |
| | VCC | 3V3 | - | |
| | GND | GND | - | |
| **LD2410 Radar** | TX | D5 | GPIO14 | æ¥è»Ÿé«”ä¸²åˆ— RX |
| | RX | D6 | GPIO12 | æ¥è»Ÿé«”ä¸²åˆ— TX |
| | VCC | 5V | - | |
| | GND | GND | - | |
| **MAX9418 Mic** | AO | A0 | ADC0 | é¡æ¯”è¼¸å‡º |
| | VCC | 3V3 | - | |
| | GND | GND | - | |

---

## ğŸ’» è»Ÿé«”å®‰è£æ­¥é©Ÿ

### 1. å°ˆæ¡ˆåˆå§‹åŒ–
åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„é–‹å•Ÿ PowerShellï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ä»¥è‡ªå‹•è¨­å®šç’°å¢ƒï¼š

```powershell
.\Setup.ps1
```
æ­¤è…³æœ¬æœƒï¼š
- å»ºç«‹ Python è™›æ“¬ç’°å¢ƒ (`.venv`)
- å®‰è£ Python ä¾è³´ (`backend/requirements.txt`)
- å®‰è£ Node.js ä¾è³´ (`frontend/package.json`)
- å»ºç«‹åˆå§‹è¨­å®šæª”

### 2. ç‡’éŒ„éŸŒé«”
1. é–‹å•Ÿ VS Codeã€‚
2. å®‰è£ **PlatformIO IDE** æ“´å……åŠŸèƒ½ã€‚
3. é–‹å•Ÿ `src/main.cpp`ã€‚
4. ä¿®æ”¹ WiFi è¨­å®šï¼š
   ```cpp
   const char* WIFI_SSID = "Your_SSID";
   const char* WIFI_PASS = "Your_Password";
   const char* WS_HOST = "Your_PC_IP"; // é›»è…¦çš„å€åŸŸç¶²è·¯ IP
   ```
5. é€£æ¥ D1 Mini è‡³é›»è…¦ USBã€‚
6. é»æ“Š PlatformIO ä¸‹æ–¹çš„ **Upload** (â¡ï¸) æŒ‰éˆ•é€²è¡Œç·¨è­¯èˆ‡ç‡’éŒ„ã€‚

### 3. å•Ÿå‹•ç³»çµ±
åŸ·è¡Œä¸»å•Ÿå‹•è…³æœ¬ï¼š

```powershell
.\Start-FocusEnforcer.ps1
```
ç³»çµ±å°‡æœƒï¼š
1. å•Ÿå‹•å¾Œç«¯ä¼ºæœå™¨ (http://localhost:8000)
2. å•Ÿå‹•å‰ç«¯é–‹ç™¼ä¼ºæœå™¨ (http://localhost:5173)
3. è‡ªå‹•é–‹å•Ÿç€è¦½å™¨é€²å…¥å„€è¡¨æ¿

---

## âš™ï¸ ç¤¾äº¤å¹³å°è¨­å®š

è‹¥è¦å•Ÿç”¨ç¤¾äº¤ç¾è¾±åŠŸèƒ½ï¼Œéœ€è¨­å®šæ†‘è­‰ï¼š

1. å•Ÿå‹•ç³»çµ±å¾Œï¼Œé€²å…¥å„€è¡¨æ¿çš„ **Social Settings** å€å¡Šã€‚
2. è¼¸å…¥ Threads å¸³è™Ÿå¯†ç¢¼ (ç”¨æ–¼è‡ªå‹•ç™¼æ–‡)ã€‚
3. è¼¸å…¥ Gmail å¸³è™Ÿèˆ‡æ‡‰ç”¨ç¨‹å¼å¯†ç¢¼ (ç”¨æ–¼ç™¼ä¿¡)ã€‚
4. é»æ“Š **Save Credentials**ã€‚
5. ç³»çµ±æœƒå°‡æ†‘è­‰åŠ å¯†å„²å­˜æ–¼ `backend/credentials.json`ã€‚

> **æ³¨æ„**: å»ºè­°ä½¿ç”¨åˆ†èº«å¸³è™Ÿé€²è¡Œæ¸¬è©¦ï¼Œä»¥å…ç™¼ç”Ÿæ„å¤–ã€‚
</file>

</files>
